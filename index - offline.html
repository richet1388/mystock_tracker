<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📈成本紀錄儀表板 📊 (離線版)</title>
    
    <!-- 
        注意： 'ElienOnly.ico' 是一個本地文件。
        如果這個 .ico 檔案沒有和 .html 檔案放在同一個資料夾中，圖示將會遺失。
        為了完全離線，您必須確保 'ElienOnly.ico' 檔案存在於本地。
    -->
    <link rel="icon" href="ElienOnly.ico" type="image/ico">

    <!-- 
        已移除： <script src="https://cdn.tailwindcss.com"></script> (Tailwind CSS 腳本)
        
        已移除： <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> (Google Fonts)
    -->
    
    <!-- 
        重要提示：
        由於 Tailwind CSS (cdn.tailwindcss.com) 腳本已被移除，
        所有 Tailwind class (例如 bg-stone-800, p-4, grid 等) 將會失效。
        您必須手動將 Tailwind 產生的 CSS 貼到這裡才能正常顯示。
        (請參考我後續的說明)
    -->
    <style>
        /* --- 莫蘭迪深色系配色 --- */
        body {
            /* 已修改：字體變更為離線安全的系統字體 
                (原為 'Inter', 'Noto Sans TC', sans-serif)
            */
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            background-color: #1c1917; /* 石墨棕 */
            color: #f5f5f4; /* 暖石灰 */
        }
        /* --- 美化滾動條 --- */
        .table-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #292524; /* 深石灰 */
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #57534e; /* 中石灰 */
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #78716c; /* 淺石灰 */
        }
        /* --- Modal 動畫 --- */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
             transition: transform 0.3s ease;
        }
        /* --- 日期選擇器圖標顏色 --- */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8); /* 反轉顏色使圖標在深色背景下可見 */
            cursor: pointer; 
        }
        /* --- 可摺疊內容動畫 --- */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        /* --- 日期輸入框文字大小 --- */
        input[type="date"]::-webkit-datetime-edit {
            font-size: 0.85rem; /* 等同於 Tailwind 的 text-xs */
        }
        /* --- 隱藏數字輸入框的上下箭頭 --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        
    </style>
    <style>
        /* ************************************************
           *** 您必須將 Tailwind CSS 內容複製並貼到這裡 ***
           *** (請參考檔案外的說明)                     ***
           ************************************************
        */
        *, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width: 640px){.container{max-width:640px}}@media (min-width: 768px){.container{max-width:768px}}@media (min-width: 1024px){.container{max-width:1024px}}@media (min-width: 1280px){.container{max-width:1280px}}@media (min-width: 1536px){.container{max-width:1536px}}.pointer-events-none{pointer-events:none}.fixed{position:fixed}.inset-0{inset:0px}.z-50{z-index:50}.col-span-2{grid-column:span 2 / span 2}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-4{height:1rem}.w-full{width:100%}.min-w-full{min-width:100%}.max-w-5xl{max-width:64rem}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-shrink-0{flex-shrink:0}.scale-95{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.select-none{-webkit-user-select:none;user-select:none}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.flex-col{flex-direction:column}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-4{gap:1rem}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-3 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.75rem * var(--tw-space-x-reverse));margin-left:calc(0.75rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-8 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.divide-y > :not([hidden]) ~ :not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px * var(--tw-divide-y-reverse))}.divide-stone-700 > :not([hidden]) ~ :not([hidden]){--tw-divide-opacity:1;border-color:rgb(68 64 60 / var(--tw-divide-opacity, 1))}.self-end{align-self:flex-end}.overflow-x-auto{overflow-x:auto}.rounded-2xl{border-radius:1rem}.rounded-lg{border-radius:0.5rem}.border{border-width:1px}.border-stone-700{--tw-border-opacity:1;border-color:rgb(68 64 60 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-rose-500{--tw-bg-opacity:1;background-color:rgb(244 63 94 / var(--tw-bg-opacity, 1))}.bg-sky-500{--tw-bg-opacity:1;background-color:rgb(14 165 233 / var(--tw-bg-opacity, 1))}.bg-stone-500{--tw-bg-opacity:1;background-color:rgb(120 113 108 / var(--tw-bg-opacity, 1))}.bg-stone-600{--tw-bg-opacity:1;background-color:rgb(87 83 78 / var(--tw-bg-opacity, 1))}.bg-stone-800{--tw-bg-opacity:1;background-color:rgb(41 37 36 / var(--tw-bg-opacity, 1))}.bg-stone-900{--tw-bg-opacity:1;background-color:rgb(28 25 23 / var(--tw-bg-opacity, 1))}.bg-opacity-70{--tw-bg-opacity:0.7}.p-2\.5{padding:0.625rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-8{padding-left:2rem;padding-right:2rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-2\.5{padding-top:0.625rem;padding-bottom:0.625rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-8{padding-top:2rem;padding-bottom:2rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.pt-0{padding-top:0px}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.tracking-tight{letter-spacing:-0.025em}.tracking-wider{letter-spacing:0.05em}.text-amber-400{--tw-text-opacity:1;color:rgb(251 191 36 / var(--tw-text-opacity, 1))}.text-rose-400{--tw-text-opacity:1;color:rgb(251 113 133 / var(--tw-text-opacity, 1))}.text-sky-400{--tw-text-opacity:1;color:rgb(56 189 248 / var(--tw-text-opacity, 1))}.text-stone-100{--tw-text-opacity:1;color:rgb(245 245 244 / var(--tw-text-opacity, 1))}.text-stone-300{--tw-text-opacity:1;color:rgb(214 211 209 / var(--tw-text-opacity, 1))}.text-stone-400{--tw-text-opacity:1;color:rgb(168 162 158 / var(--tw-text-opacity, 1))}.text-stone-500{--tw-text-opacity:1;color:rgb(120 113 108 / var(--tw-text-opacity, 1))}.text-transparent{color:transparent}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.opacity-0{opacity:0}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:bg-rose-600:hover{--tw-bg-opacity:1;background-color:rgb(225 29 72 / var(--tw-bg-opacity, 1))}.hover\:bg-sky-600:hover{--tw-bg-opacity:1;background-color:rgb(2 132 199 / var(--tw-bg-opacity, 1))}.hover\:bg-stone-600:hover{--tw-bg-opacity:1;background-color:rgb(87 83 78 / var(--tw-bg-opacity, 1))}.hover\:bg-stone-700:hover{--tw-bg-opacity:1;background-color:rgb(68 64 60 / var(--tw-bg-opacity, 1))}.focus\:border-sky-400:focus{--tw-border-opacity:1;border-color:rgb(56 189 248 / var(--tw-border-opacity, 1))}.focus\:border-stone-500:focus{--tw-border-opacity:1;border-color:rgb(120 113 108 / var(--tw-border-opacity, 1))}.focus\:ring-sky-400:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(56 189 248 / var(--tw-ring-opacity, 1))}.focus\:ring-stone-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(120 113 108 / var(--tw-ring-opacity, 1))}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:opacity-50:disabled{opacity:0.5}@media (min-width: 640px){.sm\:mt-0{margin-top:0px}.sm\:flex-row{flex-direction:row}.sm\:p-6{padding:1.5rem}.sm\:text-4xl{font-size:2.25rem;line-height:2.5rem}}@media (min-width: 768px){.md\:col-span-1{grid-column:span 1 / span 1}.md\:col-span-2{grid-column:span 2 / span 2}.md\:col-span-3{grid-column:span 3 / span 3}.md\:col-span-5{grid-column:span 5 / span 5}.md\:grid-cols-12{grid-template-columns:repeat(12, minmax(0, 1fr))}.md\:grid-cols-6{grid-template-columns:repeat(6, minmax(0, 1fr))}}@media (min-width: 1024px){.lg\:p-8{padding:2rem}}
        
    </style>
</head>
<body class="antialiased">

    <!-- 登入/驗證區塊 (隱藏) -->
    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl text-center hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈雲端儀表板📊</h1>
        <p class="mt-4 text-stone-400">使用 Google 帳戶登入以跨裝置同步持股資料</p>
        <button id="login-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">使用 Google 登入</button>
    </div>

    <!-- 主應用程式容器 (顯示) -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl"> 
        <!-- 登出按鈕 (隱藏) -->
        <div class="flex justify-between items-center mb-6 hidden">
             <p id="user-display" class="text-sm text-stone-400"></p>
             <button id="logout-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">登出</button>
        </div>
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈成本紀錄儀表板📊</h1>
            <p class="mt-2 text-lg text-stone-400">🇹🇼  🇺🇸 ➡️ 🥦 🔥 (離線單機版)</p>
        </header>

        <main class="space-y-8">
            <!-- 帳戶選擇區塊 -->
            <div class="bg-stone-800 p-4 rounded-2xl shadow-lg border border-stone-700 space-y-3">
                <!-- *** 修改 ***: 調整 Grid 系統為 12 欄，以便容納新欄位 -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <!-- Column 1: Account Select -->
                    <div class="md:col-span-5">
                        <label for="account-filter" class="block text-sm font-medium text-stone-300 mb-1">目前帳戶</label>
                        <select id="account-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <!-- *** 新增 ***: 市場類型 -->
                    <div class="md:col-span-2">
                        <label for="account-market-type" class="block text-sm font-medium text-stone-300 mb-1">市場</label>
                        <select id="account-market-type" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                            <option value="TW">台股 🇹🇼</option>
                            <option value="US">美股 🇺🇸</option>
                        </select>
                    </div>
                    <!-- Column 2: Fee Discount -->
                     <div class="md:col-span-2"> <!-- *** 修改 ***: 調整 col-span -->
                        <label for="account-fee-discount" class="block text-sm font-medium text-stone-300 mb-1">手續費折數/費率</label>
                         <input type="number" id="account-fee-discount" min="0" step="any" required value="0.28" class="block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <!-- Column 3: Buttons -->
                    <div class="flex items-center space-x-2 self-end md:col-span-3"> <!-- *** 修改 ***: 調整 col-span -->
                            <button id="add-account-btn" title="新增帳戶" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">＋</button>
                            <button id="edit-account-btn" title="編輯帳戶" class="flex-shrink-0 bg-stone-500 hover:bg-stone-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">✏️</button>
                            <button id="delete-account-btn" title="刪除帳戶" class="flex-shrink-0 bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md hidden">－</button>
                    </div>
                </div>
            </div>

            <!-- 總覽與篩選區塊 -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700 space-y-4">
                <h2 id="view-title" class="text-2xl font-bold text-stone-100 tracking-tight">總覽</h2>
                <!-- *** 修改 ***: 調整 Grid 系統為 12 欄 -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <!-- *** 修改 ***: 縮短搜尋框 -->
                    <div class="md:col-span-2">
                        <label for="stock-search" class="block text-sm font-medium text-stone-300 mb-2">搜尋或選擇檢視項目</label>
                        <input type="text" id="stock-search" placeholder="輸入代號篩選..." class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                    </div>
                    <!-- *** 修改 ***: 加寬下拉選單 -->
                    <div class="md:col-span-5">
                        <label for="stock-filter" class="block text-sm font-medium text-transparent mb-2 select-none">.</label>
                        <select id="stock-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <!-- *** 修改 ***: col-span-1 (相對變窄) -->
                    <div class="md:col-span-1">
                        <label id="shares-title" class="block text-sm font-medium text-stone-300 mb-2">全部檔數</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalShares" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="avg-cost-box" class="md:col-span-2">
                        <label id="avg-cost-title" class="block text-sm font-medium text-stone-300 mb-2">平均成本</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="avgCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="total-cost-box" class="md:col-span-2">
                        <label id="total-cost-title" class="block text-sm font-medium text-stone-300 mb-2">總成本</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 合併新增交易紀錄 -->
            <div class="bg-stone-800 rounded-2xl shadow-lg border border-stone-700">
                <div id="collapsible-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-stone-100">新增交易紀錄</h2>
                    <span id="collapse-icon" class="text-stone-400 transform transition-transform duration-300">▼</span>
                </div>
                <div id="collapsible-content" class="collapsible-content">
                    <div class="p-4 pt-0">
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-stone-700">
                            <form id="add-transaction-form" class="space-y-4">
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label for="tx-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                                        <input type="text" id="tx-symbol" required placeholder="例如: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="tx-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="tx-date" class="block text-sm font-medium text-stone-300">日期</label>
                                        <input type="date" id="tx-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-shares" class="block text-sm font-medium text-stone-300">股數</label>
                                        <input type="number" id="tx-shares" min="0" step="any" required placeholder="1000" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-price" class="block text-sm font-medium text-stone-300">價格(均價)</label>
                                        <input type="number" id="tx-price" min="0" step="any" required placeholder="600.5" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                            </form>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <button type="button" id="add-buy-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">買入</button>
                                <button type="button" id="add-sell-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">賣出</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 交易歷史/庫存明細區塊 -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="history-title" class="text-xl font-semibold text-stone-100">交易歷史紀錄</h2>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <button id="import-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯入資料</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="export-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯出資料</button>
                    </div>
                </div>
                <div class="overflow-x-auto table-scrollbar">
                    <table class="min-w-full divide-y divide-stone-700">
                        <thead class="bg-stone-900">
                            </thead>
                        <tbody id="transaction-list" class="divide-y divide-stone-700">
                            </tbody>
                    </table>
                    <p id="no-data-msg" class="text-center py-8 text-stone-500">尚無交易紀錄</p>
                </div>
                 <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-stone-400 hidden">
                    <button id="prev-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">&lt; 上一頁</button>
                    <span id="page-info">第 1 / 1 頁</span>
                    <button id="next-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">下一頁 &gt;</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 以下是各種彈出式視窗 (Modal) -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="message-modal-title" class="text-lg font-semibold text-stone-100">提示</h3>
            <p id="message-modal-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">確認</button>
            </div>
        </div>
    </div>

    <div id="add-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">新增帳戶</h3>
            <form id="add-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="new-account-name" class="block text-sm font-medium text-stone-300">帳戶名稱</label>
                    <input type="text" id="new-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <!-- *** 新增 ***: 市場類型 -->
                <div>
                    <label for="new-account-market-type" class="block text-sm font-medium text-stone-300">市場類型</label>
                    <select id="new-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                        <option value="TW">台股 (TW)</option>
                        <option value="US">美股 (US)</option>
                    </select>
                </div>
                <div>
                    <label for="new-account-fee-discount" class="block text-sm font-medium text-stone-300">手續費折數/費率</label>
                    <input type="number" id="new-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">建立</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">修改帳戶</h3>
            <form id="edit-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="edit-account-name" class="block text-sm font-medium text-stone-300">新帳戶名稱</label>
                    <input type="text" id="edit-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <!-- *** 新增 ***: 市場類型 -->
                 <div>
                    <label for="edit-account-market-type" class="block text-sm font-medium text-stone-300">市場類型</label>
                    <select id="edit-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                        <option value="TW">台股 (TW)</option>
                        <option value="US">美股 (US)</option>
                    </select>
                </div>
                 <div>
                    <label for="edit-account-fee-discount" class="block text-sm font-medium text-stone-300">手續費折數/費率</label>
                    <input type="number" id="edit-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-4 rounded-lg transition">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-md w-full shadow-2xl transform scale-95">
            <h3 id="edit-modal-title" class="text-lg font-semibold text-stone-100">編輯交易紀錄</h3>
            <form id="edit-transaction-form" class="mt-4 space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label for="edit-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                        <input type="text" id="edit-symbol" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                        <small id="edit-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                    </div>
                    <div class="col-span-2">
                         <label for="edit-date" class="block text-sm font-medium text-stone-300">日期</label>
                         <input type="date" id="edit-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="col-span-2">
                         <label for="edit-shares" class="block text-sm font-medium text-stone-300">股數</label>
                         <input type="number" id="edit-shares" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="col-span-2">
                         <label for="edit-price" class="block text-sm font-medium text-stone-300">價格</label>
                         <input type="number" id="edit-price" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-transaction-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-rose-400">確認刪除帳戶</h3>
            <p id="delete-account-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="delete-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                <button type="button" id="delete-account-confirm" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">確認刪除</button>
            </div>
        </div>
    </div>
    
    <div id="clear-history-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-amber-400">確認清除紀錄</h3>
            <p id="clear-history-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="clear-history-later-btn" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">否 (10天後清除)</button>
                <button type="button" id="clear-history-now-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">是 (立即清除)</button>
            </div>
        </div>
    </div>

    <!-- 
        以下是應用程式的主要 JavaScript 邏輯。
        這部分完全沒有變更，以確保所有功能、註解和邏輯都和您原始檔案一致。
    -->
    <script>
        // DOMContentLoaded 事件確保在執行腳本前，HTML 已完全載入和解析
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- 常數定義 ---
            const FEE_RATE = 0.001425; // 證交稅手續費率 (券商收取, 僅台股)
            const TAX_RATE = 0.003;    // 證券交易稅率 (賣出時政府收取, 僅台股)

            // --- DOM 元素宣告 ---
            // 將 HTML 頁面上的元素與 JavaScript 變數連結，方便操作
            const addTransactionForm = document.getElementById('add-transaction-form'); // 新增交易的表單
            const addBuyBtn = document.getElementById('add-buy-btn'); // "買入" 按鈕
            const addSellBtn = document.getElementById('add-sell-btn'); // "賣出" 按鈕
            const addAccountForm = document.getElementById('add-account-form'); // 新增帳戶的表單 (Modal 內)
            const editAccountForm = document.getElementById('edit-account-form'); // 編輯帳戶的表單 (Modal 內)
            const transactionList = document.getElementById('transaction-list'); // 交易列表的 tbody
            const totalSharesEl = document.getElementById('totalShares'); // 顯示總股數/檔數的元素
            const avgCostEl = document.getElementById('avgCost'); // 顯示平均成本/總成本(不含費用)的元素
            const totalCostEl = document.getElementById('totalCost'); // 顯示總成本(含費用)的元素
            const avgCostTitle = document.getElementById('avg-cost-title'); // 平均成本標題元素
            const totalCostTitle = document.getElementById('total-cost-title'); // 總成本標題元素
            const avgCostBox = document.getElementById('avg-cost-box'); // 平均成本顯示區塊
            const totalCostBox = document.getElementById('total-cost-box'); // 總成本顯示區塊
            const exportBtn = document.getElementById('export-btn'); // 匯出按鈕
            const importBtn = document.getElementById('import-btn'); // 匯入按鈕
            const importFile = document.getElementById('import-file'); // 檔案選擇輸入框 (隱藏)
            const noDataMsg = document.getElementById('no-data-msg'); // "尚無交易紀錄" 的提示訊息
            const accountFilter = document.getElementById('account-filter'); // 帳戶選擇下拉選單
            const accountFeeDiscountInput = document.getElementById('account-fee-discount'); // 主畫面顯示/修改帳戶手續費折數的輸入框
            const accountMarketTypeInput = document.getElementById('account-market-type'); // *** 新增 ***: 主畫面市場類型
            const stockFilter = document.getElementById('stock-filter'); // 股票選擇下拉選單
            const stockSearch = document.getElementById('stock-search'); // 股票搜尋輸入框
            const viewTitle = document.getElementById('view-title'); // 主標題 (總覽/個別檢視)
            const sharesTitle = document.getElementById('shares-title'); // 總股數/檔數區塊的標題
            const historyTitle = document.getElementById('history-title'); // 交易歷史/庫存明細區塊的標題
            // Modal 相關元素
            const messageModal = document.getElementById('message-modal'); // 通用訊息 Modal
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalMessage = document.getElementById('message-modal-message');
            const messageModalClose = document.getElementById('message-modal-close');
            const addAccountModal = document.getElementById('add-account-modal'); // 新增帳戶 Modal
            const addAccountBtn = document.getElementById('add-account-btn');
            const addAccountCancelBtn = document.getElementById('add-account-cancel');
            const newAccountFeeDiscountInput = document.getElementById('new-account-fee-discount'); // 新增帳戶 Modal 內的折數輸入
            const newAccountMarketTypeInput = document.getElementById('new-account-market-type'); // *** 新增 ***: 新增帳戶 Modal 市場類型
            const editAccountModal = document.getElementById('edit-account-modal'); // 編輯帳戶 Modal
            const editAccountBtn = document.getElementById('edit-account-btn');
            const editAccountCancelBtn = document.getElementById('edit-account-cancel');
            const editAccountNameInput = document.getElementById('edit-account-name'); // 編輯帳戶 Modal 內的名稱輸入
            const editAccountFeeDiscountInput = document.getElementById('edit-account-fee-discount'); // 編輯帳戶 Modal 內的折數輸入
            const editAccountMarketTypeInput = document.getElementById('edit-account-market-type'); // *** 新增 ***: 編輯帳戶 Modal 市場類型
            const deleteAccountBtn = document.getElementById('delete-account-btn'); // 刪除帳戶按鈕
            const deleteAccountModal = document.getElementById('delete-account-modal'); // 刪除帳戶確認 Modal
            const deleteAccountMessage = document.getElementById('delete-account-message');
            const deleteAccountCancelBtn = document.getElementById('delete-account-cancel');
            const deleteAccountConfirmBtn = document.getElementById('delete-account-confirm');
            const clearHistoryModal = document.getElementById('clear-history-modal'); // 清除歷史紀錄確認 Modal
            const clearHistoryMessage = document.getElementById('clear-history-message');
            const clearHistoryLaterBtn = document.getElementById('clear-history-later-btn'); // 10天後清除按鈕
            const clearHistoryNowBtn = document.getElementById('clear-history-now-btn'); // 立即清除按鈕
            // 分頁相關元素
            const paginationControls = document.getElementById('pagination-controls'); // 分頁控制區塊
            const prevPageBtn = document.getElementById('prev-page-btn'); // 上一頁按鈕
            const nextPageBtn = document.getElementById('next-page-btn'); // 下一頁按鈕
            const pageInfo = document.getElementById('page-info'); // 頁碼資訊
            // 可摺疊區塊相關元素
            const collapsibleHeader = document.getElementById('collapsible-header'); // 新增交易區塊的標頭
            const collapsibleContent = document.getElementById('collapsible-content'); // 新增交易區塊的內容
            const collapseIcon = document.getElementById('collapse-icon'); // 摺疊圖標
            // 編輯交易 Modal 相關元素
            const editTransactionModal = document.getElementById('edit-transaction-modal'); // 編輯交易 Modal
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const editModalTitle = document.getElementById('edit-modal-title');
            const editTransactionCancelBtn = document.getElementById('edit-transaction-cancel');
            // 登入/主應用容器 (保留宣告，即使在本機版隱藏)
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            // --- 應用程式狀態變數 ---
            let appData = {}; // 存放所有應用程式資料 (帳戶、交易紀錄等)
            let currentPage = 1; // 目前顯示的交易歷史頁碼
            let symbolToClear = null; // 暫存等待確認是否清除歷史紀錄的股票代號
            let debounceTimer; // 用於輸入延遲處理的計時器

            // --- 股票代號與名稱對應表 ---
            // *** 修改 ***: 格式調整為每行一個項目
            const stockNameMap = {
				"0050": "元大台灣50",
                "0051": "元大中型100",
                "0052": "富邦科技",
                "0053": "元大電子",
                "0055": "元大MSCI金融",
                "0056": "元大高股息",
                "0057": "富邦摩台",
                "0061": "元大寶滬深",
                "006201": "元大寶櫃50",
                "006203": "元大MSCI台灣",
                "006204": "永豐臺灣加權",
                "006205": "富邦上証",
                "006206": "元大上證50",
                "006207": "復華滬深",
                "006208": "富邦台50",
                "00631L": "元大台灣50正2",
                "00632R": "元大台灣50反1",
                "00633L": "富邦上証正2",
                "00634R": "富邦上証反1",
                "00635U": "期元大S&P黃金",
                "00636": "國泰中國A50",
                "00637L": "元大滬深300正2",
                "00638R": "元大滬深300反1",
                "00639": "富邦深100",
                "00640L": "富邦日本正2",
                "00641R": "富邦日本反1",
                "00642U": "期元大S&P石油",
                "00643": "群益深証中小",
                "00645": "富邦日本",
                "00646": "元大S&P500",
                "00647L": "元大S&P500正2",
                "00648R": "元大S&P500反1",
                "00650L": "復華香港正2",
                "00651R": "復華香港反1",
                "00652": "富邦印度",
                "00653L": "富邦印度正2",
                "00654R": "富邦印度反1",
                "00655L": "國泰中國A50正2",
                "00656R": "國泰中國A50反1",
                "00657": "國泰日經225",
                "00660": "元大歐洲50",
                "00661": "元大日經225",
                "00662": "富邦NASDAQ",
                "00663L": "國泰臺灣加權正2",
                "00664R": "國泰臺灣加權反1",
                "00665L": "富邦恒生國企正2",
                "00666R": "富邦恒生國企反1",
                "00668": "國泰美國道瓊",
                "00669R": "國泰美國道瓊反1",
                "00670L": "富邦NASDAQ正2",
                "00671R": "富邦NASDAQ反1",
                "00673R": "期元大S&P原油反1",
                "00674R": "期元大S&P黃金反1",
                "00675L": "富邦臺灣加權正2",
                "00676R": "富邦臺灣加權反1",
                "00678": "群益那斯達క్生技",
                "00679B": "元大美債20年",
                "00680L": "元大美債20正2",
                "00681R": "元大美債20反1",
                "00682U": "期元大美元指數",
                "00683L": "期元大美元指正2",
                "00684R": "期元大美元指反1",
                "00685L": "群益臺灣加權正2",
                "00686R": "群益臺灣加權反1",
                "00687B": "國泰20年美債",
                "00688L": "國泰20年美債正2",
                "00689R": "國泰20年美債反1",
                "00690": "兆豐台灣藍籌30",
                "00692": "富邦公司治理",
                "00693U": "期街口S&P黃豆",
                "00695B": "富邦美債7-10年",
                "00696B": "富邦美債20年",
                "00697B": "元大美債7-10",
                "00700": "富邦恆生國企",
                "00701": "國泰股利精選30",
                "00702": "國泰標普低波高息",
                "00703": "台新MSCI中國",
                "00706L": "期元大S&P日圓正2",
                "00707R": "期元大S&P日圓反1",
                "00708L": "期元大S&P黃金正2",
                "00709": "富邦歐洲",
                "00710B": "復華彭博非投等債",
                "00711B": "復華彭博新興債",
                "00712": "復華富時不動產",
                "00713": "元大台灣高息低波",
                "00714": "群益道瓊美國地產",
                "00715L": "期街口布蘭特正2",
                "00717": "富邦美國特別股",
                "00719B": "元大美債1-3",
                "00720B": "元大投資級公司債",
                "00722B": "群益投資級電信債",
                "00723B": "群益投資級科技債",
                "00724B": "群益投資級金融債",
                "00725B": "國泰投資級公司債",
                "00726B": "國泰新興投等債",
                "00727B": "國泰優選投頭等債",
                "00728": "第一金工業30",
                "00730": "富邦臺灣優質高息",
                "00731": "復華富時高息低波",
                "00733": "富邦臺灣中小",
                "00734B": "台新JPM新興債",
                "00735": "國泰臺韓科技",
                "00736": "國泰新興市場",
                "00737": "國泰AI機器人",
                "00738U": "期元大道瓊白銀",
                "00739": "元大MSCI A股",
                "00740B": "富邦全球投等債",
                "00741B": "富邦全球非投等債",
                "00746B": "富邦A級公司債",
                "00749B": "凱基新興債10+",
                "00750B": "凱基科技債10+",
                "00751B": "元大AAA至A公司債",
                "00752": "中信中國5G",
                "00753L": "中信中國5G正2",
                "00757": "統一FANG+",
                "00758B": "復華能源債",
                "00759B": "復華製藥債",
                "00760B": "復華新興企業債",
                "00761B": "國泰A級公司債",
                "00762": "元大全球AI",
                "00764B": "復華20年美債",
                "00770": "國泰北美科技",
                "00771": "元大US高息特別股",
                "00772B": "中信高評級公司債",
                "00773B": "中信優先金融債",
                "00775B": "新光投等債15+",
                "00777B": "凱基AAA至A公司債",
                "00778B": "凱基金融債20+",
                "00779B": "凱基美債25+",
                "00780B": "國泰A級金融債",
                "00781B": "國泰A級科技債",
                "00782B": "國泰A級公用債",
                "00783": "富邦中証500",
                "00785B": "富邦金融投等債",
                "00786B": "元大10年IG銀行債",
                "00787B": "元大10年IG醫療債",
                "00788B": "元大10年IG電能債",
                "00789B": "復華公司債A3",
                "00791B": "復華信用債1-5",
                "00792B": "群益A級公司債",
                "00793B": "群益AAA-A醫療債",
                "00795B": "中信美國公債20年",
                "00799B": "國泰A級醫療債",
                "00830": "國泰費城半導體",
                "00834B": "第一金融債10+",
                "00836B": "永豐10年A公司債",
                "00850": "元大臺灣ESG永續",
                "00851": "台新全球AI",
                "00858": "永豐美國500大",
                "00861": "元大全球未來通訊",
                "00870B": "元大15年EM主權債",
                "00875": "國泰網路資安",
                "00876": "元大全球5G",
                "00877": "復華中國5G",
                "00878": "國泰永續高股息",
                "00881": "國泰台灣科技龍頭",
                "00882": "中信中國高股息",
                "00885": "富邦越南",
                "00886": "永豐美國科技",
                "00888": "永豐台灣ESG",
                "00891": "中信關鍵半導體",
                "00892": "富邦台灣半導體",
                "00893": "國泰智能電動車",
                "00894": "中信小資高價30",
                "00895": "富邦未來車",
                "00896": "中信綠能及電動車",
                "00897": "富邦基因免疫生技",
                "00898": "國泰基因免疫革命",
                "00899": "FT潔淨能源",
                "00900": "富邦特選高股息30",
                "00901": "永豐智能車供應鏈",
                "00902": "中信電池及儲能",
                "00903": "富邦元宇宙",
                "00904": "新光臺灣半導體30",
                "00905": "FT臺灣Smart",
                "00907": "永豐優息存股",
                "00908": "富邦入息REITs+",
                "00909": "國泰數位支付服務",
                "00910": "第一金太空衛星",
                "00911": "兆豐洲際半導體",
                "00912": "中信臺灣智慧50",
                "00913": "兆豐台灣晶圓製造",
                "00915": "凱基優選高股息30",
                "00917": "中信特選金融",
                "00918": "大華優利高填息30",
                "00919": "群益台灣精選高息",
                "00920": "富邦ESG綠色電力",
                "00921": "兆豐龍頭等權重",
                "00922": "國泰台灣領袖50",
                "00923": "群益台灣ESG低碳",
                "00924": "復華S&P500成長",
                "00926": "凱基全球菁英55",
                "00927": "群益半導體收益",
                "00928": "中信上櫃ESG 30",
                "00929": "復華台灣科技優息",
                "00930": "永豐ESG低碳高息",
                "00932": "兆豐永續高息等權",
                "00933B": "國泰10Y+金融債",
                "00934": "中信成長高股息",
                "00935": "野村臺灣新科技50",
                "00936": "台新永續高息中小",
                "00937B": "群益ESG投等債20+",
                "00938": "凱基優選30",
                "00939": "統一台灣高息動能",
                "00940": "元大台灣價值高息",
                "00941": "中信上游半導體",
                "00943": "兆豐電子高息等權",
                "00944": "野村趨勢動能高息",
                "00946": "群益科技高息成長",
                "00947": "台新台灣IC設計",
                "00949": "復華日本龍頭",
                "00951": "台新日本半導體",
                "00952": "凱基台灣AI50",
                "00954": "中信日本半導體",
                "00955": "中信日本商社",
                "00956": "中信日經高股息",
                "00960": "野村全球航運龍頭",
                "00961": "FT台灣永續高息",
                "00962": "台新AI優息動能",
                "00963": "中信全球高股息",
                "00964": "中信亞太高股息",
                "00965": "元大航太防衛科技",
                "00971": "野村美國研發龍頭",
                "00972": "野村日本動neng高息",
                "009800": "中信NASDAQ",
                "009801": "中信美國創新科技",
                "009802": "富邦旗艦50",
                "009803": "保德信市值動能50",
                "009804": "聯邦台精彩50",
                "009805": "新光美國電力基礎",
                "009806": "台新標普500",
                "009807": "台新標普科技精選",
                "009808": "華南永昌優選50",
                "00980A": "主動野村臺灣優選",
                "009810": "保德信全球藍籌",
                "0D9811": "統一美國50",
                "009812": "野村日本東証",
                "00981A": "主動統一台股增長",
                "00982A": "主動群益臺灣強棒",
                "00983A": "主動中信ARK創新",
                "00984A": "主動安聯臺灣高息",
                "00985A": "主動野村臺灣50",
                "00986A": "主動台新龍頭成長",
                
			};
            
            /**
             * 從 localStorage 載入資料並初始化應用程式。
             * 包含資料結構遷移邏輯，以處理舊格式資料。
             */
            function initializeApp_Local() {
                // 從 localStorage 讀取名為 'stockTrackerData_LocalTest' 的資料
                const storedDataJSON = localStorage.getItem('stockTrackerData_LocalTest');
                let storedData = null; // 暫存解析後的資料
                if (storedDataJSON) {
                    try {
                        // 嘗試將 JSON 字串解析為 JavaScript 物件
                        storedData = JSON.parse(storedDataJSON);
                    } catch (e) {
                        // 如果解析失敗，輸出錯誤訊息
                        console.error("無法解析 localStorage 資料:", e);
                        storedData = null;
                    }
                }
                
                // --- 初始化或載入應用程式資料 (appData) ---
                if (storedData && storedData.accounts) {
                    // 如果 localStorage 有資料且包含 accounts 屬性，則使用它
                    appData = storedData;
                } else {
                    // 否則，初始化一個包含預設帳戶的新資料結構
                    appData = { 
                        accounts: { 
                            // *** 修改 ***: 加入 marketType
                            '預設帳戶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } 
                        }, 
                        currentAccount: '預設帳戶' // 目前選中的帳戶名稱
                    };
                }
                
                // --- 確保目前選中的帳戶 (currentAccount) 是有效的 ---
                if (!appData.accounts[appData.currentAccount]) {
                    // 如果目前帳戶無效 (可能已被刪除)，則選取第一個帳戶或創建預設帳戶
                    appData.currentAccount = Object.keys(appData.accounts)[0] || '預設帳戶';
                    if (!appData.accounts[appData.currentAccount]) {
                            // 如果連第一個帳戶都沒有，確保預設帳戶存在
                            // *** 修改 ***: 加入 marketType
                            appData.accounts['預設帳戶'] = { transactions: [], feeDiscount: 0.28, marketType: 'TW' }; 
                    }
                }
                
                // --- 資料遷移與清理 ---
                // 這個迴圈遍歷所有帳戶，進行資料格式檢查與遷移
                let needsSave = false; // 標記是否需要將遷移後的資料存回 localStorage
                for (const accountName in appData.accounts) {
                    const accountData = appData.accounts[accountName]; // 取得帳戶資料

                    // --- 遷移舊的帳戶結構 (如果帳戶資料直接是陣列) ---
                    if (Array.isArray(accountData)) {
                        console.log(`偵測到帳戶 ${accountName} 為舊格式，進行遷移...`);
                        let initialFeeDiscount = 0.28; // 預設手續費折數
                        // 嘗試從舊資料的第一筆交易中讀取手續費折數
                        if (accountData.length > 0 && accountData[0].feeDiscount !== undefined) {
                            initialFeeDiscount = accountData[0].feeDiscount;
                        }
                        // 將舊的陣列結構轉換為新的物件結構
                        // *** 修改 ***: 加入 marketType
                        appData.accounts[accountName] = { 
                            transactions: accountData, // 保留原有的交易紀錄陣列
                            feeDiscount: initialFeeDiscount, // 添加手續費折數屬性
                            marketType: 'TW' // 舊資料預設為台股
                        };
                        needsSave = true; // 標記需要儲存
                    } 
                    // --- 處理無效或需要初始化的帳戶結構 ---
                    else if (typeof accountData !== 'object' || accountData === null) {
                        // 如果帳戶資料不是物件或為 null，則重設為標準結構
                         // *** 修改 ***: 加入 marketType
                         appData.accounts[accountName] = { transactions: [], feeDiscount: 0.28, marketType: 'TW' };
                         needsSave = true;
                    } 
                    // --- 確保新的帳戶結構完整 ---
                    else {
                         // 如果帳戶物件缺少 transactions 陣列，則補上
                         if (!Array.isArray(accountData.transactions)) {
                            accountData.transactions = [];
                            needsSave = true;
                         }
                         // 如果帳戶物件缺少 feeDiscount 屬性，則補上預設值
                         if (accountData.feeDiscount === undefined) {
                             accountData.feeDiscount = 0.28;
                             needsSave = true;
                         }
                         // *** 新增 ***: 如果帳戶物件缺少 marketType 屬性，則補上預設值 'TW'
                         if (accountData.marketType === undefined) {
                             accountData.marketType = 'TW';
                             needsSave = true;
                         }
                    }

                    // --- 處理帳戶內的交易紀錄 (補齊舊資料欄位、重新計算費用) ---
                    const transactions = appData.accounts[accountName].transactions; // 取得該帳戶的交易紀錄陣列
                    // *** 修改 ***: 獲取帳戶的手續費折數和市場類型
                    const accountFeeDiscount = appData.accounts[accountName].feeDiscount; 
                    const accountMarketType = appData.accounts[accountName].marketType || 'TW';

                    transactions.forEach(tx => {
                        // 補齊股票名稱 (如果不存在)
                        if (!tx.name) tx.name = stockNameMap[tx.symbol] || '';
                        // 補齊 reviewed 狀態 (如果不存在)
                        if (tx.reviewed === undefined) tx.reviewed = false; 
                        
                        // 補齊 price (如果不存在)
                        if (tx.price === undefined) { tx.price = 0; needsSave = true; }

                        // 計算交易金額 (股數 * 價格)
                        const amount = tx.price * tx.shares;

                        // 如果費用 (fee) 不存在，或者交易紀錄中有舊的 feeDiscount 欄位 (代表是舊資料需要重新計算)
                        if (tx.fee === undefined || tx.feeDiscount !== undefined) {
                            
                            // *** 修改 ***: 根據市場類型重新計算費用
                            let fee = 0;
                            if (accountMarketType === 'TW') {
                                // 舊資料遷移時，使用帳戶當前的折數重新計算
                                fee = amount * FEE_RATE * accountFeeDiscount; 
                                // 如果是賣出交易，加上證交稅
                                if (tx.type === 'SELL') {
                                    fee += (amount * TAX_RATE);
                                }
                            } else { // 'US'
                                // 假設舊資料如果是美股(雖然不太可能，但為求邏輯完整)，費用 = 金額 * 費率
                                fee = amount * accountFeeDiscount;
                                // 美股賣出不加稅 (根據使用者要求)
                            }
                            tx.fee = fee;
                            
                            // 如果是買入交易，且總交易成本 (totalTxCost) 不存在，或者有舊的 feeDiscount 欄位
                            if (tx.type === 'BUY') {
                                // 重新計算買入總成本 (交易金額 + 手續費)
                                tx.totalTxCost = amount + tx.fee; 
                            }
                            needsSave = true; // 標記需要儲存
                        }
                        
                        // *** 遷移完成後移除交易紀錄中的舊 feeDiscount 欄位 ***
                        if (tx.feeDiscount !== undefined) {
                            delete tx.feeDiscount;
                            needsSave = true; // 標記需要儲存
                        }
                    });
                }
                
                // --- 如果在遷移過程中資料有變動，則存回 localStorage ---
                if (needsSave) {
                    saveDataToLocalStorage();
                    console.log("資料結構已更新或遷移完成。");
                }
                
                // --- 清理過期的待刪除交易 ---
                cleanupExpiredTransactions(); 
                
                // --- 恢復摺疊狀態 ---
                const isCollapsed = localStorage.getItem('isFormCollapsed_SharesOnly') === 'true';
                if (isCollapsed) {
                    // 如果之前是摺疊的，保持摺疊
                    collapsibleContent.style.maxHeight = null;
                    collapseIcon.style.transform = 'rotate(-90deg)';
                } else {
                    // 否則，展開並設定正確的高度
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                    collapseIcon.style.transform = 'rotate(0deg)';
                }
                
                // --- 更新介面元件 ---
                updateAccountFilterOptions(); // 更新帳戶下拉選單
                updateAccountFeeDiscountDisplay(); // 更新帳戶手續費折數顯示
                updateAccountMarketTypeDisplay(); // *** 新增 ***: 更新市場類型顯示
                updateStockFilterOptions(); // 更新股票下拉選單
                render(); // 重新渲染主要內容區域
            }

            /**
             * 將 appData 物件轉換為 JSON 字串並儲存到 localStorage。
             */
            function saveDataToLocalStorage() {
                try {
                    // 使用 'stockTrackerData_LocalTest' 作為 key 儲存資料
                    localStorage.setItem('stockTrackerData_LocalTest', JSON.stringify(appData));
                } catch (error) {
                    // 如果儲存失敗 (例如 localStorage 空間已滿)，顯示錯誤訊息
                    console.error("資料儲存至 localStorage 失敗:", error);
                    showModal(messageModal, '儲存失敗', '無法將資料儲存至瀏覽器，空間可能已滿。');
                }
            }
            
            /**
             * 將新增交易表單中的日期欄位預設為今天。
             */
            function setDateToToday() {
                // 獲取今天的日期並格式化為 YYYY-MM-DD
                const today = new Date().toISOString().slice(0, 10);
                // 設定日期輸入框的值
                document.getElementById('tx-date').value = today;
            }

            /**
             * 清理標記為 "10天後刪除" 且已過期的交易紀錄。
             */
            function cleanupExpiredTransactions() {
                let changed = false; // 標記是否有資料變動
                const now = Date.now(); // 獲取當前時間戳
                // 遍歷所有帳戶
                for (const accountName in appData.accounts) {
                    const account = appData.accounts[accountName]; 
                    const transactions = account.transactions; 
                    if (!Array.isArray(transactions)) continue; // 如果沒有交易紀錄，跳過

                    // 找出所有 deletionTimestamp 已過期的交易紀錄所屬的股票代號 (去重)
                    const symbolsWithExpiredTimestamp = [...new Set(
                        transactions
                            .filter(tx => tx.deletionTimestamp && tx.deletionTimestamp <= now)
                            .map(tx => tx.symbol)
                    )];

                    // 遍歷這些需要清理的股票代號
                    symbolsWithExpiredTimestamp.forEach(symbol => {
                        // 重新計算該股票目前的持股 (排除已標記刪除的)
                        const holdings = getCurrentHoldings(symbol, transactions); 
                        const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);

                        // 如果清理後持股為 0，則直接刪除該股票的所有相關交易紀錄
                        if (currentShares === 0) {
                            account.transactions = transactions.filter(tx => tx.symbol !== symbol); 
                        } 
                        // 如果清理後仍有持股，僅移除交易紀錄中的 deletionTimestamp 標記
                        else {
                            account.transactions.forEach(tx => { 
                                if (tx.symbol === symbol) {
                                    delete tx.deletionTimestamp;
                                }
                            });
                        }
                        changed = true; // 標記資料已變動
                    });
                }
                // 如果資料有變動，則存回 localStorage
                if (changed) saveDataToLocalStorage(); 
            }
            
            /**
             * 更新帳戶選擇下拉選單的選項，並根據帳戶數量顯示/隱藏刪除按鈕。
             */
            function updateAccountFilterOptions() {
                // 確保 appData.accounts 存在
                if (!appData.accounts) {
                    // *** 修改 ***: 加入 marketType
                    appData.accounts = { '預設帳戶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } }; 
                    appData.currentAccount = '預設帳戶';
                }
                const accountNames = Object.keys(appData.accounts); // 獲取所有帳戶名稱
                accountFilter.innerHTML = ''; // 清空下拉選單
                // 為每個帳戶名稱創建一個 <option> 元素並添加到下拉選單中
                accountNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    accountFilter.appendChild(option);
                });
                // 設定下拉選單的選中值為目前帳戶
                accountFilter.value = appData.currentAccount;
                // 如果帳戶數量少於等於 1，隱藏刪除按鈕
                deleteAccountBtn.classList.toggle('hidden', accountNames.length <= 1);
                // 更新主畫面上顯示的手續費折數
                updateAccountFeeDiscountDisplay(); 
                // *** 新增 ***: 更新市場類型顯示
                updateAccountMarketTypeDisplay();
            }

             /**
             * 更新主畫面帳戶區塊的手續費折數輸入框的值，使其與目前選中帳戶的設定同步。
             */
            function updateAccountFeeDiscountDisplay() {
                 // 確保目前帳戶存在於 appData 中
                 if (appData.accounts && appData.accounts[appData.currentAccount]) {
                     // 更新輸入框的值
                     accountFeeDiscountInput.value = appData.accounts[appData.currentAccount].feeDiscount;
                 } else {
                      // 如果帳戶不存在 (異常情況)，使用預設值
                      accountFeeDiscountInput.value = 0.28; 
                 }
            }
            
            /**
             * *** 新增 ***: 更新主畫面帳戶區塊的市場類型下拉選單的值。
             */
            function updateAccountMarketTypeDisplay() {
                 if (appData.accounts && appData.accounts[appData.currentAccount]) {
                     accountMarketTypeInput.value = appData.accounts[appData.currentAccount].marketType || 'TW';
                 } else {
                      accountMarketTypeInput.value = 'TW';
                 }
            }

            /**
             * 更新股票選擇下拉選單的選項，根據搜尋框內容進行篩選。
             */
            function updateStockFilterOptions() {
                // 獲取目前帳戶的交易紀錄
                const currentAccountData = appData.accounts[appData.currentAccount];
                const currentTransactions = currentAccountData ? currentAccountData.transactions : []; 
                
                const selectedValue = stockFilter.value; // 目前下拉選單選中的值
                const searchTerm = stockSearch.value.trim().toUpperCase(); // 搜尋框的值 (轉大寫)
                
                if (!Array.isArray(currentTransactions)) return; // 防錯

                // 獲取目前帳戶交易紀錄中所有不重複的股票代號
                let symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                
                // 如果搜尋框有內容，則篩選股票代號
                if (searchTerm) {
                    symbols = symbols.filter(symbol => symbol.toUpperCase().includes(searchTerm));
                }

                symbols.sort(); // 按字母順序排序
                
                // 檢查目前選中的值是否仍然在篩選後的列表中，或者是否為 "全部庫存"
                const isCurrentSelectionValid = symbols.includes(selectedValue) || selectedValue === '__ALL__';

                // --- 重建股票下拉選單 ---
                stockFilter.innerHTML = ''; // 清空舊選項
                // 添加 "全部庫存" 選項
                const allOption = document.createElement('option');
                allOption.value = '__ALL__';
                allOption.textContent = '全部庫存';
                stockFilter.appendChild(allOption);

                // 添加篩選後的股票代號選項
                if (symbols.length > 0) {
                    symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        // 顯示格式: 代號 (名稱)
                        option.textContent = `${symbol} (${stockNameMap[symbol] || '未知'})`;
                        stockFilter.appendChild(option);
                    });
                }
                // --- 恢復下拉選單的選中狀態 ---
                if (isCurrentSelectionValid) {
                     // 如果原選中值有效，則恢復選中
                     stockFilter.value = selectedValue;
                } else {
                     // 否則，預設選中 "全部庫存"
                     stockFilter.value = '__ALL__';
                }
            }
            
            /**
             * 顯示指定的 Modal 彈出視窗。
             * @param {HTMLElement} modalElement - 要顯示的 Modal 元素。
             * @param {string} [title] - (可選) Modal 的標題 (僅對 messageModal 有效)。
             * @param {string} [message] - (可選) Modal 的訊息內容 (僅對 messageModal 有效)。
             */
            function showModal(modalElement, title, message) {
                 // 如果是通用訊息 Modal，設定標題和內容
                 if (modalElement === messageModal) {
                     messageModalTitle.textContent = title;
                     messageModalMessage.textContent = message;
                 }
                 // 移除控制顯示/隱藏的 CSS class，觸發動畫
                 modalElement.classList.remove('opacity-0', 'pointer-events-none');
                 modalElement.querySelector('.modal-content').classList.remove('scale-95');
            }
            
            /**
             * 隱藏指定的 Modal 彈出視窗。
             * @param {HTMLElement} modalElement - 要隱藏的 Modal 元素。
             */
            function hideModal(modalElement) {
                // 添加控制顯示/隱藏的 CSS class，觸發動畫
                modalElement.classList.add('opacity-0', 'pointer-events-none');
                modalElement.querySelector('.modal-content').classList.add('scale-95');
            }
            
            // --- 為各 Modal 的關閉/取消按鈕綁定事件 ---
            messageModalClose.addEventListener('click', () => hideModal(messageModal));
            addAccountBtn.addEventListener('click', () => {
                 newAccountFeeDiscountInput.value = 0.28; // 打開新增帳戶 Modal 前重設折數為預設值
                 newAccountMarketTypeInput.value = 'TW'; // *** 新增 ***: 重設市場類型
                 showModal(addAccountModal);
            });
            addAccountCancelBtn.addEventListener('click', () => hideModal(addAccountModal));
            
            editAccountBtn.addEventListener('click', () => {
                // 打開編輯帳戶 Modal 前載入目前帳戶的名稱和折數
                editAccountNameInput.value = appData.currentAccount;
                editAccountFeeDiscountInput.value = appData.accounts[appData.currentAccount]?.feeDiscount || 0.28;
                editAccountMarketTypeInput.value = appData.accounts[appData.currentAccount]?.marketType || 'TW'; // *** 新增 ***: 載入市場類型
                showModal(editAccountModal);
            });
            editAccountCancelBtn.addEventListener('click', () => hideModal(editAccountModal));
            
            deleteAccountBtn.addEventListener('click', () => {
                // 打開刪除確認 Modal 前設定提示訊息
                const accountToDelete = appData.currentAccount;
                deleteAccountMessage.textContent = `您確定要刪除「${accountToDelete}」帳戶嗎？此帳戶內的所有交易紀錄將被永久移除，此操作無法復原。`;
                showModal(deleteAccountModal);
            });
            deleteAccountCancelBtn.addEventListener('click', () => hideModal(deleteAccountModal));
            
            /**
             * 根據先進先出 (FIFO) 原則計算指定股票的目前持股部位。
             * @param {string} symbol - 股票代號。
             * @param {Array} transactions - 包含該股票所有交易紀錄的陣列。
             * @returns {Array} - 計算後剩餘的持股部位 (只包含買入紀錄，股數和成本可能已被調整)。
             */
            function getCurrentHoldings(symbol, transactions) {
                if (!Array.isArray(transactions)) return []; // 防錯
                // 過濾掉標記為待刪除的交易
                const activeTransactions = transactions.filter(tx => !tx.deletionTimestamp);
                // 篩選出指定股票的交易紀錄
                const symbolTxs = activeTransactions.filter(tx => tx.symbol === symbol);
                // 篩選出買入交易，並按日期升序排列
                const buyTxs = symbolTxs.filter(tx => tx.type === 'BUY').sort((a, b) => new Date(a.date) - new Date(b.date));
                // 篩選出賣出交易
                const sellTxs = symbolTxs.filter(tx => tx.type === 'SELL');
                // 計算總賣出股數
                let sharesSold = sellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                
                const holdings = []; // 用於存放計算後的持股部位
                // 遍歷排序後的買入交易
                for (const buyTx of buyTxs) {
                    // 計算此筆買入的每股成本 (含手續費)
                    // (buyTx.totalTxCost !== undefined ? buyTx.totalTxCost : (buyTx.price * buyTx.shares)) 是為了相容舊資料
                    const costBasis = buyTx.totalTxCost !== undefined ? buyTx.totalTxCost : (buyTx.price * buyTx.shares);
                    // 避免除以零
                    const costPerShare = buyTx.shares !== 0 ? costBasis / buyTx.shares : 0; 

                    // 如果已沒有需要扣除的賣出股數
                    if (sharesSold <= 0) {
                        // 將此筆買入紀錄完整加入持股列表 (移除舊的 feeDiscount)
                        const { feeDiscount, ...restOfBuyTx } = buyTx; 
                        holdings.push(restOfBuyTx); 
                        continue; // 處理下一筆買入
                    }

                    // 如果此筆買入股數大於剩餘需扣除的賣出股數
                    if (buyTx.shares > sharesSold) {
                        // 計算剩餘股數
                        const remainingShares = buyTx.shares - sharesSold;
                        // 移除舊的 feeDiscount
                        const { feeDiscount, ...restOfBuyTx } = buyTx; 
                        // 將部分扣除後的買入紀錄加入持股列表
                        holdings.push({
                            ...restOfBuyTx, 
                            shares: remainingShares, 
                            // 按比例重新計算剩餘持股的總成本
                            totalTxCost: remainingShares * costPerShare 
                        });
                        sharesSold = 0; // 所有賣出股數已扣除完畢
                    } 
                    // 如果此筆買入股數小於等於剩餘需扣除的賣出股數
                    else {
                        // 此筆買入被完全賣出，從剩餘賣出股數中扣除
                        sharesSold -= buyTx.shares; 
                    }
                }
                return holdings; // 返回計算後的持股列表
            }

            /**
             * 核心渲染函式，根據目前選中的帳戶和股票篩選條件，更新畫面內容。
             */
            function render() {
                // 獲取目前帳戶的交易紀錄
                const currentAccountData = appData.accounts[appData.currentAccount];
                const currentTransactions = currentAccountData ? currentAccountData.transactions : []; 

                if (!Array.isArray(currentTransactions)) return; // 防錯
                
                const selectedValue = stockFilter.value; // 獲取股票下拉選單的值
                const tableHead = transactionList.parentElement.querySelector('thead'); // 表格頭部元素
                transactionList.innerHTML = ''; // 清空表格內容

                // --- 情況一：顯示「全部庫存」總覽 ---
                if (selectedValue === '__ALL__') {
                    paginationControls.classList.add('hidden'); // 隱藏分頁
                    viewTitle.textContent = '投資組合總覽'; // 設定主標題
                    historyTitle.textContent = '庫存明細'; // 設定表格區塊標題
                    avgCostBox.classList.remove('hidden'); // 顯示 "平均成本/總成本(不含費用)" 區塊
                    totalCostBox.classList.remove('hidden'); // 顯示 "總成本(含費用)" 區塊
                    calculatePortfolioSummary(currentTransactions); // 計算並顯示總覽數據
                    
                    // 設定表格標頭
                    // *** 修改 ***: 新增 "平均成本(不含費用)" 欄位
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">更新狀態</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股票代號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股票名稱</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">持有股數</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">均價</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">總成本</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">均價(含費用)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">總成本(含費用)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">更新日期</th>
                        </tr>
                    `;
                    
                    // 獲取所有不重複的股票代號
                    const symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                    // 計算每支股票的持股明細
                    let portfolioDetails = symbols.map(symbol => {
                        const holdings = getCurrentHoldings(symbol, currentTransactions); // 計算持股部位
                        const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); // 計算總股數
                        if (totalShares <= 0) return null; // 如果股數為 0，則不顯示

                        // 計算總成本 (含費用)
                        const totalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                        // 計算平均成本 (含費用)
                        const averageCost = totalShares > 0 ? totalCost / totalShares : 0;
                        // 計算總成本 (不含費用)
                        const baseTotalCost = holdings.reduce((sum, tx) => sum + (tx.shares * (tx.price || 0)), 0);
                        // *** 新增 ***: 計算平均成本 (不含費用)
                        const averageBaseCost = totalShares > 0 ? baseTotalCost / totalShares : 0;

                        // 找出該股票最後更新日期和名稱
                        const symbolTransactions = currentTransactions.filter(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        const lastUpdateDate = symbolTransactions.reduce((max, tx) => (tx.date > max ? tx.date : max), '0000-00-00');
                        const name = (symbolTransactions.find(tx => tx.name) || {}).name || '';
                        
                        // 檢查是否所有交易都已標記為 reviewed
                        const isFullyReviewed = symbolTransactions.length > 0 && symbolTransactions.every(tx => tx.reviewed === true);

                        // 返回包含所有計算結果的物件
                        return { symbol, name, totalShares, baseTotalCost, averageBaseCost, averageCost, totalCost, lastUpdateDate, isFullyReviewed };
                    }).filter(Boolean); // 過濾掉股數為 0 的結果

                    // 按最後更新日期降序排列
                    portfolioDetails.sort((a, b) => new Date(b.lastUpdateDate) - new Date(a.lastUpdateDate));

                    // --- 渲染表格內容 ---
                    if (portfolioDetails.length > 0) {
                        portfolioDetails.forEach(detail => {
                            const row = document.createElement('tr'); // 創建表格行
                            row.className = 'hover:bg-stone-700/50'; // 添加滑鼠懸停效果

                            // 根據 reviewed 狀態設定按鈕樣式
                            const statusText = detail.isFullyReviewed ? '是' : '否';
                            const statusColor = detail.isFullyReviewed ? 'bg-emerald-800 text-emerald-100 hover:bg-emerald-700' : 'bg-stone-600 text-stone-200 hover:bg-stone-500';
                            const statusButtonHTML = `
                                <button class="px-3 py-1 text-xs font-semibold rounded-full transition-colors duration-200 ${statusColor}" data-symbol="${detail.symbol}" data-action="toggle-status-all">
                                    ${statusText}
                                </button>
                            `;
                            // 填充表格單元格內容
                            // *** 修改 ***: 新增 "平均成本(不含費用)" 欄位
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${statusButtonHTML}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-100">${detail.symbol}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalShares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                                
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.averageBaseCost.toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.baseTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.averageCost.toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalCost.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.lastUpdateDate}</td>
                                
                            `;
                            transactionList.appendChild(row); // 將行添加到表格中
                        });
                    }
                    // --- 處理無資料情況 ---
                    noDataMsg.textContent = '尚無任何庫存';
                    // 如果沒有庫存明細，顯示提示訊息，否則隱藏
                    noDataMsg.classList.toggle('hidden', portfolioDetails.length > 0);
                
                // --- 情況二：顯示「個別股票」的交易歷史 ---
                } else {
                    // 獲取選中股票的名稱
                    const stockName = (currentTransactions.find(tx => tx.symbol === selectedValue) || {}).name || '';
                    viewTitle.textContent = `個別檢視: ${selectedValue}`; // 設定主標題
                    historyTitle.textContent = `交易歷史紀錄: ${selectedValue} ${stockName}`; // 設定表格區塊標題
                    avgCostBox.classList.remove('hidden'); // 顯示平均成本區塊
                    totalCostBox.classList.remove('hidden'); // 顯示總成本區塊
                    calculateSummary(selectedValue, currentTransactions); // 計算並顯示個股的成本數據
                    
                    // 設定表格標頭 (個股檢視)
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">類型</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股數</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">價格</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">費用</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">操作</span></th>
                        </tr>
                    `;
                    // 篩選出選中股票的交易紀錄
                    const displayTransactions = currentTransactions.filter(tx => tx.symbol === selectedValue);
                    // 按日期降序排列
                    const sortedTransactions = [...displayTransactions].sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
                    
                    // --- 分頁邏輯 ---
                    const itemsPerPage = 10; // 每頁顯示數量
                    const totalPages = Math.ceil(sortedTransactions.length / itemsPerPage) || 1; // 計算總頁數
                    if (currentPage > totalPages) currentPage = totalPages; // 防止頁碼超出範圍
                    // 獲取目前頁面應顯示的交易紀錄
                    const paginatedTransactions = sortedTransactions.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                    // 根據是否需要分頁來顯示/隱藏分頁控制項
                    paginationControls.classList.toggle('hidden', sortedTransactions.length <= itemsPerPage);
                    // 更新頁碼資訊
                    pageInfo.textContent = `第 ${currentPage} / ${totalPages} 頁`;
                    // 禁用上一頁/下一頁按鈕（如果在第一頁/最後一頁）
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages;
                    
                    // --- 渲染表格內容 ---
                    paginatedTransactions.forEach(tx => {
                        const row = document.createElement('tr'); // 創建表格行
                        row.className = 'hover:bg-stone-700/50 transition-colors duration-200'; // 添加樣式

                        // 根據交易類型顯示不同樣式的標籤
                        const typeCell = tx.type === 'BUY' 
                            ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-sky-900 text-sky-200">買入</span>`
                            : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-rose-900 text-rose-200">賣出</span>`;

                        // 填充表格單元格內容
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${typeCell}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.shares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${(tx.price || 0).toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${(tx.fee || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                <button class="text-stone-400 hover:text-stone-200" data-id="${tx.id}" data-action="edit">編輯</button>
                                <button class="text-rose-400 hover:text-rose-500" data-id="${tx.id}" data-action="delete">刪除</button>
                            </td>
                        `;
                        transactionList.appendChild(row); // 添加行到表格
                    });
                     // --- 處理無資料情況 ---
                    noDataMsg.textContent = '尚無交易紀錄';
                    // 如果沒有交易紀錄，顯示提示訊息，否則隱藏
                    noDataMsg.classList.toggle('hidden', displayTransactions.length > 0);
                }
            }

            /**
             * 計算單一股票的總持有股數、平均成本(含費用)、總成本(含費用)，並更新顯示。
             * @param {string} symbol - 股票代號。
             * @param {Array} transactions - 包含該股票交易紀錄的陣列。
             */
            function calculateSummary(symbol, transactions) {
                // 設定顯示區塊的標題
                sharesTitle.textContent = '持有股數';
                avgCostTitle.textContent = '平均成本(含費用)';
                totalCostTitle.textContent = '總成本(含費用)';

                if (!Array.isArray(transactions)) {
                    // 如果沒有交易紀錄，顯示 0
                    totalSharesEl.textContent = '0';
                    avgCostEl.textContent = '0';
                    totalCostEl.textContent = '0';
                    return;
                }
                // 計算目前持股
                const holdings = getCurrentHoldings(symbol, transactions);
                // 計算總股數
                const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                // 計算總成本 (含費用)
                const totalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                // 計算平均成本 (含費用)
                const averageCost = totalShares > 0 ? totalCost / totalShares : 0;
                
                // 更新顯示元素的內容 (格式化數字)
                totalSharesEl.textContent = totalShares.toLocaleString('en-US', {maximumFractionDigits: 8});
                avgCostEl.textContent = averageCost.toLocaleString('en-US', {maximumFractionDigits: 4});
                totalCostEl.textContent = totalCost.toLocaleString('en-US', {maximumFractionDigits: 2});
            }
            
            /**
             * 計算投資組合總覽數據：總庫存檔數、總成本(不含費用)、總成本(含費用)，並更新顯示。
             * @param {Array} transactions - 目前帳戶的所有交易紀錄。
             */
            function calculatePortfolioSummary(transactions) {
                 // 設定顯示區塊的標題
                sharesTitle.textContent = '全部檔數';
                avgCostTitle.textContent = '總成本(不含費用)'; // *** 修改 ***
                totalCostTitle.textContent = '總成本(含費用)';

                if (!Array.isArray(transactions)) {
                    // 如果沒有交易紀錄，顯示 0
                    totalSharesEl.textContent = '0';
                    avgCostEl.textContent = '0'; // *** 修改 ***
                    totalCostEl.textContent = '0';
                    return;
                }
                // 獲取所有不重複的股票代號
                const symbols = [...new Set(transactions.map(tx => tx.symbol))];
                let portfolioStockCount = 0; // 庫存檔數計數器
                let portfolioTotalCost = 0; // 總成本(含費用)累加器
                let portfolioBaseTotalCost = 0; // *** 新增 ***: 總成本(不含費用)累加器
                
                // 遍歷每支股票
                symbols.forEach(symbol => {
                    const holdings = getCurrentHoldings(symbol, transactions); // 計算持股
                    const symbolTotalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); // 計算該股票總股數
                    // 如果持有股數大於 0
                    if (symbolTotalShares > 0) {
                        portfolioStockCount++; // 庫存檔數 +1
                        // 累加總成本 (含費用)
                        const symbolTotalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                        portfolioTotalCost += symbolTotalCost;
                        // *** 新增 ***: 累加總成本 (不含費用)
                        const symbolBaseTotalCost = holdings.reduce((sum, tx) => sum + (tx.shares * (tx.price || 0)), 0);
                        portfolioBaseTotalCost += symbolBaseTotalCost;
                    }
                });
                
                // 更新顯示元素的內容 (格式化數字)
                totalSharesEl.textContent = new Intl.NumberFormat().format(portfolioStockCount);
                avgCostEl.textContent = portfolioBaseTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2}); // *** 修改 ***
                totalCostEl.textContent = portfolioTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2});
            }

            // --- 事件處理函式 ---

            /**
             * 處理新增交易 (買入或賣出) 的邏輯。
             * @param {Event} e - 事件物件。
             * @param {string} transactionType - 'BUY' 或 'SELL'。
             */
            function handleAddTransaction(e, transactionType) {
                e.preventDefault(); // 防止表單預設提交行為
                // 從表單獲取輸入值
                const symbol = document.getElementById('tx-symbol').value.trim().toUpperCase();
                const name = stockNameMap[symbol] || ''; // 嘗試從 map 獲取名稱
                const date = document.getElementById('tx-date').value;
                const shares = parseFloat(document.getElementById('tx-shares').value);
                const price = parseFloat(document.getElementById('tx-price').value); 
                // *** 修改 ***: 從目前帳戶資料獲取手續費折數和市場類型
                const currentAccount = appData.accounts[appData.currentAccount];
                const feeDiscount = currentAccount?.feeDiscount || 0.28; 
                const marketType = currentAccount?.marketType || 'TW';
                
                // --- 輸入驗證 ---
                if (!symbol) { showModal(messageModal, '輸入錯誤', '請輸入股票代號。'); return; }
                if (isNaN(shares) || shares <= 0) { showModal(messageModal, '輸入錯誤', '請檢查股數是否為有效的正數。'); return; }
                if (isNaN(price) || price < 0) { showModal(messageModal, '輸入錯誤', '請檢查價格(均價)是否為有效的數字。'); return; }

                // 獲取目前帳戶的交易紀錄陣列
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 
                
                // --- 賣出前檢查庫存是否足夠 ---
                if (transactionType === 'SELL') {
                    const holdings = getCurrentHoldings(symbol, currentTransactions); // 計算目前持股
                    const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); // 計算總股數
                    if (shares > currentShares) {
                        // 如果要賣出的股數大於持有股數，顯示錯誤訊息並返回
                        showModal(messageModal, '賣出失敗', `您只有 ${currentShares.toLocaleString('en-US', {maximumFractionDigits: 8})} 股，無法賣出 ${shares} 股。`);
                        return;
                    }
                }

                // --- 計算費用 ---
                const amount = price * shares; // 交易金額
                let fee = 0; // 初始化費用
                let totalTxCost = 0; // 初始化買入總成本

                // *** 修改 ***: 根據市場類型計算費用
                if (marketType === 'TW') {
                    fee = amount * FEE_RATE * feeDiscount; // 台股手續費
                    if (transactionType === 'BUY') {
                        totalTxCost = amount + fee; // 買入總成本 = 金額 + 手續費
                    } else { // 'SELL'
                        fee += (amount * TAX_RATE); // 賣出總費用 = 手續費 + 證交稅
                    }
                } else { // 'US'
                    fee = amount * feeDiscount; // 美股手續費 (假設 feeDiscount 為費率)
                    if (transactionType === 'BUY') {
                        totalTxCost = amount + fee;
                    } else { // 'SELL'
                        // 美股賣出無交易稅 (根據使用者要求)
                    }
                }
                
                // --- 建立新的交易紀錄物件 ---
                const newTransaction = { 
                    id: Date.now(), // 使用時間戳作為唯一 ID
                    type: transactionType, 
                    symbol, 
                    name, 
                    date, 
                    shares, 
                    price, 
                    fee: Math.round(fee * 100) / 100, // 費用四捨五入到小數點第二位
                    reviewed: false // 新交易預設為未檢視
                };

                // 如果是買入交易，添加 totalTxCost 屬性
                if (transactionType === 'BUY') {
                    newTransaction.totalTxCost = totalTxCost; 
                }

                // --- 更新資料並儲存 ---
                currentTransactions.push(newTransaction); // 將新交易添加到陣列
                saveDataToLocalStorage(); // 保存到 localStorage
                
                // --- 重設表單並更新介面 ---
                addTransactionForm.reset(); // 清空表單
                setDateToToday(); // 將日期設回今天
                
                // --- 賣出後檢查是否需要提示清除歷史紀錄 ---
                if (transactionType === 'SELL') {
                    const updatedHoldings = getCurrentHoldings(symbol, currentTransactions); // 重新計算持股
                    const remainingShares = updatedHoldings.reduce((sum, tx) => sum + tx.shares, 0); // 計算剩餘股數
                    if (remainingShares === 0) {
                        // 如果歸零，彈出確認清除歷史紀錄的 Modal
                        symbolToClear = symbol;
                        clearHistoryMessage.textContent = `股票 ${symbol} 的庫存已為零，是否要清除其所有相關交易歷史紀錄？`;
                        showModal(clearHistoryModal);
                    } else {
                        // 如果未歸零，更新下拉選單並重新渲染
                        updateStockFilterOptions();
                        stockFilter.value = symbol; // 自動選中剛交易的股票
                        currentPage = 1; // 跳回第一頁
                        render();
                    }
                } 
                // --- 買入後更新介面 ---
                else {
                    updateStockFilterOptions();
                    stockFilter.value = symbol; // 自動選中剛交易的股票
                    currentPage = 1; // 跳回第一頁
                    render();
                }
            }

            // --- 綁定事件監聽器 ---

            // 綁定買入和賣出按鈕的點擊事件
            addBuyBtn.addEventListener('click', (e) => handleAddTransaction(e, 'BUY'));
            addSellBtn.addEventListener('click', (e) => handleAddTransaction(e, 'SELL'));

            // 使用事件代理處理交易列表中的按鈕點擊 (編輯、刪除、切換狀態)
            transactionList.addEventListener('click', (e) => {
                const target = e.target.closest('button'); // 確保點擊按鈕內部也能觸發
                // 如果點擊的不是按鈕或按鈕沒有 data-action 屬性，則忽略
                if (!target || !target.dataset.action) return;

                const action = target.dataset.action; // 獲取按鈕的動作類型
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 

                // --- 處理編輯和刪除 ---
                if (action === 'delete' || action === 'edit') {
                    const id = parseInt(target.dataset.id, 10); // 獲取交易 ID
                    // --- 刪除 ---
                    if (action === 'delete') {
                        // 過濾掉要刪除的交易紀錄，更新陣列
                        currentAccountData.transactions = currentTransactions.filter(tx => tx.id !== id); 
                        saveDataToLocalStorage(); // 保存變更
                        updateStockFilterOptions(); // 更新股票下拉選單 (可能某支股票沒紀錄了)
                        render(); // 重新渲染畫面
                    } 
                    // --- 編輯 ---
                    else if (action === 'edit') {
                        // 找到要編輯的交易紀錄
                        const tx = currentTransactions.find(t => t.id === id);
                        if (tx) {
                            // 將交易資料填入編輯 Modal 的表單中
                            document.getElementById('edit-transaction-id').value = tx.id;
                            document.getElementById('edit-symbol').value = tx.symbol;
                            document.getElementById('edit-date').value = tx.date;
                            document.getElementById('edit-shares').value = tx.shares;
                            document.getElementById('edit-price').value = tx.price || 0; 
                            editModalTitle.textContent = `編輯 ${tx.symbol} (${tx.type === 'BUY' ? '買入' : '賣出'})`; // 設定 Modal 標題
                            // 手動觸發 input 事件，以顯示股票名稱 (如果有的話)
                            document.getElementById('edit-symbol').dispatchEvent(new Event('input')); 
                            showModal(editTransactionModal); // 顯示編輯 Modal
                        }
                    }
                } 
                // --- 處理切換全部 reviewed 狀態 (總覽畫面) ---
                else if (action === 'toggle-status-all') {
                    const symbol = target.dataset.symbol; // 獲取股票代號
                    // 篩選出該股票的所有交易紀錄
                    const transactionsForSymbol = currentTransactions.filter(tx => tx.symbol === symbol); 
                    if (transactionsForSymbol.length > 0) {
                        // 判斷目前是否全部已檢視
                        const isCurrentlyFullyReviewed = transactionsForSymbol.every(tx => tx.reviewed === true);
                        // 設定新的狀態 (反轉目前狀態)
                        const newStatus = !isCurrentlyFullyReviewed; 
                        
                        // 更新該股票所有交易紀錄的 reviewed 狀態
                        transactionsForSymbol.forEach(tx => {
                            // 需要在原始陣列中找到並修改
                             const originalTx = currentTransactions.find(t => t.id === tx.id);
                             if (originalTx) {
                                 originalTx.reviewed = newStatus;
                             }
                        });
                        
                        saveDataToLocalStorage(); // 保存變更
                        render(); // 重新渲染畫面 (更新按鈕狀態)
                    }
                }
            });

            // 監聽帳戶下拉選單的變更事件
            accountFilter.addEventListener('change', (e) => {
                appData.currentAccount = e.target.value; // 更新目前選中的帳戶
                saveDataToLocalStorage(); // 保存 (主要為了記住選擇)
                stockSearch.value = ''; // 清空股票搜尋框
                updateAccountFeeDiscountDisplay(); // 更新手續費折數顯示
                updateAccountMarketTypeDisplay(); // *** 新增 ***: 更新市場類型顯示
                updateStockFilterOptions(); // 更新股票下拉選單
                currentPage = 1; // 重設頁碼
                render(); // 重新渲染
            });

            // 監聽主畫面帳戶手續費折數輸入框的變更事件
            accountFeeDiscountInput.addEventListener('change', (e) => {
                 const newDiscount = parseFloat(e.target.value); // 獲取新值
                 // 驗證輸入是否有效
                 if (!isNaN(newDiscount) && newDiscount >= 0 && appData.accounts[appData.currentAccount]) {
                     // 更新 appData 中的值
                     appData.accounts[appData.currentAccount].feeDiscount = newDiscount;
                     saveDataToLocalStorage(); // 保存變更
                     // 重新計算並渲染，在變更折數後立即看到成本變化
                     render(); 
                 } else {
                      // 如果輸入無效，顯示錯誤訊息並恢復原值
                      showModal(messageModal, '錯誤', '請輸入有效的手續費折數/費率。');
                      updateAccountFeeDiscountDisplay(); // 恢復輸入框顯示的值
                 }
            });

            // *** 新增 ***: 監聽主畫面市場類型下拉選單的變更事件
            accountMarketTypeInput.addEventListener('change', (e) => {
                 const newMarketType = e.target.value;
                 if (appData.accounts[appData.currentAccount]) {
                     appData.accounts[appData.currentAccount].marketType = newMarketType;
                     saveDataToLocalStorage();
                     // 重新計算並渲染，在變更市場後立即看到成本變化
                     render(); 
                 }
            });
            
            // 監聽股票下拉選單的變G更事件
            stockFilter.addEventListener('change', () => {
                currentPage = 1; // 重設頁碼
                render(); // 重新渲染
            });
            
            // 監聽股票搜尋框的輸入事件
            stockSearch.addEventListener('input', () => {
                updateStockFilterOptions(); // 即時更新股票下拉選單
                render(); // 重新渲染 (如果需要根據搜尋結果更新列表)
            });

            // 監聽分頁按鈕的點擊事件
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--; // 頁碼減 1
                    render(); // 重新渲染
                }
            });
            nextPageBtn.addEventListener('click', () => {
                 const currentAccountData = appData.accounts[appData.currentAccount];
                 const currentTransactions = currentAccountData ? currentAccountData.transactions : [];
                 const selectedStock = stockFilter.value;
                 const itemsPerPage = 10;
                 let totalItems = 0;
                 if (selectedStock === '__ALL__') {
                    // Note: 分頁目前僅在個股模式下啟用
                 } else {
                     totalItems = currentTransactions.filter(tx => tx.symbol === selectedStock).length;
                 }
                 const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;

                if (currentPage < totalPages) { // 檢查是否已達最後一頁
                     currentPage++; // 頁碼加 1
                     render(); // 重新渲染
                 }
            });
            
            // 監聽新增帳戶表單的提交事件
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault(); // 阻止表單提交
                const newAccountNameInput = document.getElementById('new-account-name');
                const newAccountName = newAccountNameInput.value.trim(); // 獲取帳戶名稱
                const newFeeDiscount = parseFloat(newAccountFeeDiscountInput.value); // 獲取手續費折數
                const newMarketType = newAccountMarketTypeInput.value; // *** 新增 ***: 獲取市場類型

                // --- 驗證 ---
                if (!newAccountName) {
                    showModal(messageModal, '錯誤', '帳戶名稱不能為空。');
                    return;
                }
                // 檢查帳戶名稱是否已存在
                if (appData.accounts[newAccountName]) {
                    showModal(messageModal, '錯誤', '該帳戶名稱已存在。');
                    return;
                }
                 // 驗證手續費折數
                 if (isNaN(newFeeDiscount) || newFeeDiscount < 0) { 
                    showModal(messageModal, '錯誤', '請輸入有效的手續費折數/費率。');
                    return;
                }

                // --- 新增帳戶 ---
                // *** 修改 ***: 在 appData.accounts 中創建新帳戶條目 (包含折數和市場類型)
                appData.accounts[newAccountName] = { transactions: [], feeDiscount: newFeeDiscount, marketType: newMarketType }; 
                appData.currentAccount = newAccountName; // 將新帳戶設為目前帳戶
                saveDataToLocalStorage(); // 保存變更

                // --- 清理並關閉 Modal ---
                newAccountNameInput.value = ''; // 清空名稱輸入框
                newAccountFeeDiscountInput.value = 0.28; // 恢復折數預設值
                newAccountMarketTypeInput.value = 'TW'; // *** 新增 ***: 恢復市場類型預設值
                hideModal(addAccountModal); // 關閉 Modal
                // --- 更新介面 ---
                updateAccountFilterOptions(); // 更新帳戶下拉選單 (會觸發 updateAccountFeeDiscountDisplay)
                updateStockFilterOptions(); // 更新股票下拉選單
                currentPage = 1; // 重設頁碼
                render(); // 重新渲染
            });
            
            // 監聽編輯帳戶表單的提交事件
            editAccountForm.addEventListener('submit', (e) => {
                e.preventDefault(); // 阻止表單提交
                const oldAccountName = appData.currentAccount; // 獲取舊帳戶名稱
                const newAccountName = editAccountNameInput.value.trim(); // 獲取新帳戶名稱
                const newFeeDiscount = parseFloat(editAccountFeeDiscountInput.value); // 獲取新手續費折數
                const newMarketType = editAccountMarketTypeInput.value; // *** 新增 ***: 獲取新市場類型

                // --- 驗證 ---
                if (!newAccountName) {
                    showModal(messageModal, '錯誤', '帳戶名稱不能為空。');
                    return;
                }
                 // 驗證手續費折數
                 if (isNaN(newFeeDiscount) || newFeeDiscount < 0) { 
                    showModal(messageModal, '錯誤', '請輸入有效的手續費折數/費率。');
                    return;
                }
                // 檢查新名稱是否與其他現有帳戶重複
                if (newAccountName !== oldAccountName && appData.accounts[newAccountName]) {
                     showModal(messageModal, '錯誤', '該帳戶名稱已存在。');
                    return;
                }

                // --- 更新帳戶資料 ---
                const accountDataToModify = appData.accounts[oldAccountName]; // 獲取要修改的帳戶資料
                // 更新手續費折數
                accountDataToModify.feeDiscount = newFeeDiscount;
                // *** 新增 ***: 更新市場類型
                accountDataToModify.marketType = newMarketType;

                // 如果帳戶名稱被修改
                if (newAccountName !== oldAccountName) {
                    // 將舊帳戶的資料賦值給新名稱
                    appData.accounts[newAccountName] = accountDataToModify;
                    // 刪除舊名稱的帳戶條目
                    delete appData.accounts[oldAccountName];
                    // 更新目前選中的帳戶為新名稱
                    appData.currentAccount = newAccountName; 
                }
                // 如果名稱沒變，只需儲存更新後的折數 (已在上面完成)
                
                saveDataToLocalStorage(); // 保存變更
                updateAccountFilterOptions(); // 更新帳戶下拉選單 (會觸發 updateAccountFeeDiscountDisplay)
                render(); // 重新渲染 (如果名稱改變，列表需要更新)
                hideModal(editAccountModal); // 關閉 Modal
            });

            // 監聽刪除帳戶確認按鈕的點擊事件
            deleteAccountConfirmBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount; // 獲取要刪除的帳戶名稱
                // 檢查是否為最後一個帳戶
                if (Object.keys(appData.accounts).length <= 1) {
                    showModal(messageModal, '錯誤', '無法刪除最後一個帳戶。');
                    hideModal(deleteAccountModal);
                    return;
                }
                // 從 appData 中刪除該帳戶
                delete appData.accounts[accountToDelete];
                // 將目前選中的帳戶設為剩餘帳戶中的第一個
                appData.currentAccount = Object.keys(appData.accounts)[0];
                saveDataToLocalStorage(); // 保存變更
                hideModal(deleteAccountModal); // 關閉 Modal
                // 更新介面
                updateAccountFilterOptions(); // 更新帳戶下拉選單 (會觸發 updateAccountFeeDiscountDisplay)
                updateStockFilterOptions(); // 更新股票下拉選單
                render(); // 重新渲染
                showModal(messageModal, '成功', `帳戶「${accountToDelete}」已成功刪除。`); // 顯示成功訊息
            });
            
            // 監聽 "立即清除" 歷史紀錄按鈕的點擊事件
            clearHistoryNowBtn.addEventListener('click', () => {
                // 確保 symbolToClear 有值且帳戶存在
                if (symbolToClear && appData.accounts[appData.currentAccount]) { 
                    const account = appData.accounts[appData.currentAccount]; 
                    // 過濾掉該股票的所有交易紀錄
                    account.transactions = account.transactions.filter(tx => tx.symbol !== symbolToClear); 
                    saveDataToLocalStorage(); // 保存變更
                    hideModal(clearHistoryModal); // 關閉 Modal
                    updateStockFilterOptions(); // 更新股票下拉選單
                    render(); // 重新渲染
                    showModal(messageModal, '紀錄已清除', `股票 ${symbolToClear} 的所有交易紀錄已被移除。`); // 顯示成功訊息
                    symbolToClear = null; // 清除暫存的股票代號
                }
            });

            // 監聽 "10天後清除" 歷史紀錄按鈕的點擊事件
            clearHistoryLaterBtn.addEventListener('click', () => {
                 // 確保 symbolToClear 有值且帳戶存在
                if (symbolToClear && appData.accounts[appData.currentAccount]) { 
                    const account = appData.accounts[appData.currentAccount]; 
                    const tenDaysInMillis = 10 * 24 * 60 * 60 * 1000; // 10 天的毫秒數
                    const deletionTimestamp = Date.now() + tenDaysInMillis; // 計算刪除時間戳
                    // 篩選出該股票目前未標記刪除的交易紀錄
                    const activeTransactionsForSymbol = account.transactions 
                        .filter(tx => tx.symbol === symbolToClear && !tx.deletionTimestamp);

                    // 為這些交易紀錄添加 deletionTimestamp 標記
                    activeTransactionsForSymbol.forEach(tx => {
                       // 直接在原始陣列中找到並修改
                       const originalTx = account.transactions.find(t => t.id === tx.id); 
                       if(originalTx) {
                           originalTx.deletionTimestamp = deletionTimestamp;
                       }
                    });
                    saveDataToLocalStorage(); // 保存變更
                    hideModal(clearHistoryModal); // 關閉 Modal
                    updateStockFilterOptions(); // 更新股票下拉選單
                    stockFilter.value = symbolToClear; // 保持選中該股票
                    render(); // 重新渲染 (視覺上這些交易還在)
                    showModal(messageModal, '已排程清除', `股票 ${symbolToClear} 的紀錄將在10天後自動清除。`); // 顯示提示訊息
                    symbolToClear = null; // 清除暫存的股票代號
                }
            });

            // 監聽匯出按鈕的點擊事件
            exportBtn.addEventListener('click', () => {
                // 檢查是否有帳戶資料可供匯出
                if (!appData.accounts || Object.keys(appData.accounts).length === 0) { 
                    showModal(messageModal, '提示', '沒有可匯出的資料。'); 
                    return; 
                }
                // 將 appData 轉換為格式化的 JSON 字串
                const dataStr = JSON.stringify(appData, null, 2);
                // 創建 Blob 物件
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                // 創建下載連結
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                // 設定下載檔名 (包含日期)
                a.download = `stock_shares_tracker_data_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); // 添加到頁面
                a.click(); // 模擬點擊觸發下載
                document.body.removeChild(a); // 從頁面移除
                URL.revokeObjectURL(url); // 釋放 URL 物件
                showModal(messageModal, '匯出成功', '您的所有帳戶紀錄已成功匯出為 JSON 檔案。'); // 顯示成功訊息
            });

            // 監聽匯入按鈕的點擊事件 (觸發隱藏的 file input)
            importBtn.addEventListener('click', () => importFile.click());
            // 監聽檔案選擇輸入框的變更事件
            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0]; // 獲取選擇的檔案
                if (!file) return; // 如果沒有選擇檔案，則返回
                const reader = new FileReader(); // 創建 FileReader 讀取檔案內容
                // 設定讀取完成後的回調函式
                reader.onload = (event) => {
                    try {
                        // 解析讀取到的 JSON 字串
                        const importedData = JSON.parse(event.target.result);
                        // 檢查匯入的資料是否包含必要的結構
                        if (importedData.accounts && importedData.currentAccount) {
                            appData = importedData; // 覆蓋目前的 appData
                            currentPage = 1; // 重設頁碼
                            
                            // 重新初始化應用程式，這會處理資料遷移和渲染
                            initializeApp_Local(); 
                            showModal(messageModal, '匯入成功', '所有帳戶紀錄已成功匯入。'); // 顯示成功訊息
                        } else {
                            // 如果格式不符，拋出錯誤
                            throw new Error('檔案格式不符');
                        }
                    } catch (error) {
                         // 如果解析失敗或格式不符，顯示錯誤訊息
                         showModal(messageModal, '匯入失敗', `檔案格式不正確或已損毀。(${error.message})`);
                    }
                };
                // 設定讀取錯誤的回調函式
                reader.onerror = () => {
                    showModal(messageModal, '匯入失敗', '讀取檔案時發生錯誤。');
                };
                reader.readAsText(file); // 以文字形式讀取檔案內容
                importFile.value = ''; // 清空 file input，以便下次可以選擇同一個檔案
            });
            
            // 監聽編輯交易 Modal 的取消按鈕
            editTransactionCancelBtn.addEventListener('click', () => hideModal(editTransactionModal));
            // 監聽編輯交易表單的提交事件
            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault(); // 阻止表單提交
                // 從表單獲取修改後的值
                const id = parseInt(document.getElementById('edit-transaction-id').value, 10);
                const newSymbol = document.getElementById('edit-symbol').value.trim().toUpperCase();
                const newDate = document.getElementById('edit-date').value;
                const newShares = parseFloat(document.getElementById('edit-shares').value);
                const newPrice = parseFloat(document.getElementById('edit-price').value); 
                
                // *** 修改 ***: 獲取目前帳戶資料、折數和市場類型
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 
                const feeDiscount = currentAccountData.feeDiscount; 
                const marketType = currentAccountData.marketType || 'TW';

                // 找到要編輯的交易紀錄索引
                const txIndex = currentTransactions.findIndex(t => t.id === id);
                if (txIndex === -1) return; // 如果沒找到，返回
                
                const originalSymbol = currentTransactions[txIndex].symbol; // 記錄原始股票代號
                const transactionType = currentTransactions[txIndex].type; // 獲取交易類型 (買/賣)

                // --- 驗證輸入 ---
                if (!newSymbol) { showModal(messageModal, '輸入錯誤', '股票代號不能為空。'); return; }
                if (isNaN(newShares) || newShares <= 0) { showModal(messageModal, '輸入錯誤', '請檢查股數是否為有效的正數。'); return; }
                if (isNaN(newPrice) || newPrice < 0) { showModal(messageModal, '輸入錯誤', '請檢查價格是否為有效的數字。'); return; }

                // --- 模擬修改並重新計算費用 ---
                // 創建一個臨時副本進行計算和驗證，避免直接修改原始資料
                const tempTransactions = JSON.parse(JSON.stringify(currentTransactions));
                const tempTxToUpdate = tempTransactions.find(t => t.id === id);
                
                // 更新臨時副本中的交易資料
                tempTxToUpdate.symbol = newSymbol;
                tempTxToUpdate.date = newDate;
                tempTxToUpdate.shares = newShares;
                tempTxToUpdate.price = newPrice; 

                // *** 修改 ***: 根據市場類型重新計算費用和總成本
                const newAmount = newPrice * newShares;
                let newFee = 0;
                
                if (marketType === 'TW') {
                    newFee = newAmount * FEE_RATE * feeDiscount;
                    if (transactionType === 'SELL') {
                        newFee += (newAmount * TAX_RATE);
                        tempTxToUpdate.fee = newFee;
                        delete tempTxToUpdate.totalTxCost; // 賣單沒有總成本
                    } else { // 'BUY'
                        tempTxToUpdate.fee = newFee;
                        tempTxToUpdate.totalTxCost = newAmount + newFee; // 計算買入總成本
                    }
                } else { // 'US'
                    newFee = newAmount * feeDiscount;
                    tempTxToUpdate.fee = newFee;
                    if (transactionType === 'SELL') {
                        delete tempTxToUpdate.totalTxCost; // 賣單沒有總成本
                    } else { // 'BUY'
                        tempTxToUpdate.totalTxCost = newAmount + newFee; // 計算買入總成本
                    }
                }
                
                // --- 驗證修改後的庫存是否會變負數 ---
                // 獲取受影響的股票代號 (原始代號和新代號)
                const affectedSymbols = new Set([originalSymbol, newSymbol]);
                for (const symbol of affectedSymbols) {
                    // 使用包含模擬修改的交易列表來計算持股
                    const tempHoldings = getCurrentHoldings(symbol, tempTransactions); 
                    // 計算模擬持股總數 (這裡其實不需要，下面直接比較買賣總數更準確)
                    // const tempTotalShares = tempHoldings.reduce((sum, tx) => sum + tx.shares, 0);

                     // 直接比較模擬修改後的買入總數和賣出總數
                     const symbolSellTxs = tempTransactions.filter(tx => tx.symbol === symbol && tx.type === 'SELL');
                     const totalSold = symbolSellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                     const symbolBuyTxs = tempTransactions.filter(tx => tx.symbol === symbol && tx.type === 'BUY');
                     const totalBought = symbolBuyTxs.reduce((sum, tx) => sum + tx.shares, 0);

                    // 如果賣出總數大於買入總數，表示庫存會變負數
                    if (totalSold > totalBought) {
                        showModal(messageModal, '編輯失敗', `此修改會導致股票 ${symbol} 的庫存變為負數，請重新檢查。`);
                        return; // 阻止修改
                    }
                }

                // --- 驗證通過，正式更新原始資料 ---
                const transactionToUpdate = currentTransactions[txIndex];
                transactionToUpdate.symbol = newSymbol;
                transactionToUpdate.name = stockNameMap[newSymbol] || ''; // 更新名稱
                transactionToUpdate.date = newDate;
                transactionToUpdate.shares = newShares;
                transactionToUpdate.price = newPrice; 
                transactionToUpdate.fee = tempTxToUpdate.fee; // 更新計算後的費用
                // 更新買入總成本 (如果是買單) 或移除 (如果是賣單)
                if (transactionType === 'BUY') {
                    transactionToUpdate.totalTxCost = tempTxToUpdate.totalTxCost; 
                } else {
                    delete transactionToUpdate.totalTxCost; 
                }
                
                saveDataToLocalStorage(); // 保存變更
                hideModal(editTransactionModal); // 關閉 Modal
                
                // --- 檢查修改後是否有股票歸零 ---
                let zeroedOutSymbol = null;
                for (const symbol of affectedSymbols) {
                    // 使用更新後的真實資料計算持股
                    const holdings = getCurrentHoldings(symbol, currentTransactions);
                    const remainingShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    // 如果剩餘股數為 0 且該股票仍有未標記刪除的交易紀錄
                    if (remainingShares === 0) {
                        const hasActiveTxs = currentTransactions.some(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        if (hasActiveTxs) {
                           zeroedOutSymbol = symbol; // 記錄歸零的股票代號
                           break; // 找到一個就夠了
                        }
                    }
                }

                // 如果有股票歸零，彈出清除歷史紀錄的確認 Modal
                if (zeroedOutSymbol) {
                    symbolToClear = zeroedOutSymbol;
                    clearHistoryMessage.textContent = `編輯後，股票 ${zeroedOutSymbol} 的庫存已為零，是否要清除其所有相關交易歷史紀錄？`;
                    showModal(clearHistoryModal);
                } 
                // 否則，直接更新介面
                else {
                    updateStockFilterOptions();
                    render(); 
                }
            });

            /**
             * 處理股票代號輸入框的輸入事件，延遲顯示對應的股票名稱。
             * @param {Event} e - Input 事件物件。
             */
            function handleSymbolInput(e) {
                clearTimeout(debounceTimer); // 清除之前的計時器 (防抖)
                const symbol = e.target.value.trim().toUpperCase(); // 獲取輸入值並轉大寫
                // 根據觸發事件的輸入框 ID 決定要更新哪個名稱顯示元素
                const nameDisplayId = `tx-symbol-name`; 
                const nameDisplayEl = document.getElementById(nameDisplayId);
                
                const editNameDisplayEl = document.getElementById('edit-symbol-name');
                const targetEl = e.target.id === 'edit-symbol' ? editNameDisplayEl : nameDisplayEl;

                if (!targetEl) return; // 如果找不到對應的名稱顯示元素，則返回

                // 設定一個延遲執行的計時器 (300 毫秒)
                debounceTimer = setTimeout(() => {
                    // 在計時器觸發時，根據 stockNameMap 查找並顯示股票名稱
                    if (stockNameMap[symbol]) {
                        targetEl.textContent = stockNameMap[symbol];
                    } else {
                        targetEl.textContent = ''; // 找不到則清空
                    }
                }, 300);
            }

            // --- 程式進入點 ---
            initializeApp_Local(); // 初始化應用程式 (載入資料、遷移、渲染)
            setDateToToday(); // 設定日期預設值
            
            // --- 其他事件監聽綁定 ---
            // 綁定可摺疊區塊的點擊事件
            collapsibleHeader.addEventListener('click', () => {
                // 檢查目前是否展開 (根據 maxHeight 是否有值)
                if (collapsibleContent.style.maxHeight) {
                    // 如果已展開，則摺疊
                    collapsibleContent.style.maxHeight = null; // 移除 maxHeight 以觸發收縮動畫
                    collapseIcon.style.transform = 'rotate(-90deg)'; // 旋轉圖標
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'true'); // 記錄摺疊狀態
                } else {
                    // 如果已摺疊，則展開
                    // 設定 maxHeight 為內容的實際滾動高度以觸發展開動畫
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px"; 
                    collapseIcon.style.transform = 'rotate(0deg)'; // 恢復圖標角度
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'false'); // 記錄展開狀態
                }
            });

            // 綁定股票代號輸入框的輸入事件 (新增交易和編輯交易)
            document.getElementById('tx-symbol').addEventListener('input', handleSymbolInput);
            document.getElementById('edit-symbol').addEventListener('input', handleSymbolInput);
        });
    </script>
</body>
</html>
