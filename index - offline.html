<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ˆæˆæœ¬ç´€éŒ„å„€è¡¨æ¿ ğŸ“Š (é›¢ç·šç‰ˆ)</title>
    
    <!-- 
        æ³¨æ„ï¼š 'ElienOnly.ico' æ˜¯ä¸€å€‹æœ¬åœ°æ–‡ä»¶ã€‚
        å¦‚æœé€™å€‹ .ico æª”æ¡ˆæ²’æœ‰å’Œ .html æª”æ¡ˆæ”¾åœ¨åŒä¸€å€‹è³‡æ–™å¤¾ä¸­ï¼Œåœ–ç¤ºå°‡æœƒéºå¤±ã€‚
        ç‚ºäº†å®Œå…¨é›¢ç·šï¼Œæ‚¨å¿…é ˆç¢ºä¿ 'ElienOnly.ico' æª”æ¡ˆå­˜åœ¨æ–¼æœ¬åœ°ã€‚
    -->
    <link rel="icon" href="ElienOnly.ico" type="image/ico">

    <!-- 
        å·²ç§»é™¤ï¼š <script src="https://cdn.tailwindcss.com"></script> (Tailwind CSS è…³æœ¬)
        
        å·²ç§»é™¤ï¼š <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> (Google Fonts)
    -->
    
    <!-- 
        é‡è¦æç¤ºï¼š
        ç”±æ–¼ Tailwind CSS (cdn.tailwindcss.com) è…³æœ¬å·²è¢«ç§»é™¤ï¼Œ
        æ‰€æœ‰ Tailwind class (ä¾‹å¦‚ bg-stone-800, p-4, grid ç­‰) å°‡æœƒå¤±æ•ˆã€‚
        æ‚¨å¿…é ˆæ‰‹å‹•å°‡ Tailwind ç”¢ç”Ÿçš„ CSS è²¼åˆ°é€™è£¡æ‰èƒ½æ­£å¸¸é¡¯ç¤ºã€‚
        (è«‹åƒè€ƒæˆ‘å¾ŒçºŒçš„èªªæ˜)
    -->
    <style>
        /* --- è«è˜­è¿ªæ·±è‰²ç³»é…è‰² --- */
        body {
            /* å·²ä¿®æ”¹ï¼šå­—é«”è®Šæ›´ç‚ºé›¢ç·šå®‰å…¨çš„ç³»çµ±å­—é«” 
                (åŸç‚º 'Inter', 'Noto Sans TC', sans-serif)
            */
            font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            background-color: #1c1917; /* çŸ³å¢¨æ£• */
            color: #f5f5f4; /* æš–çŸ³ç° */
        }
        /* --- ç¾åŒ–æ»¾å‹•æ¢ --- */
        .table-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #292524; /* æ·±çŸ³ç° */
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #57534e; /* ä¸­çŸ³ç° */
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #78716c; /* æ·ºçŸ³ç° */
        }
        /* --- Modal å‹•ç•« --- */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
             transition: transform 0.3s ease;
        }
        /* --- æ—¥æœŸé¸æ“‡å™¨åœ–æ¨™é¡è‰² --- */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8); /* åè½‰é¡è‰²ä½¿åœ–æ¨™åœ¨æ·±è‰²èƒŒæ™¯ä¸‹å¯è¦‹ */
            cursor: pointer; 
        }
        /* --- å¯æ‘ºç–Šå…§å®¹å‹•ç•« --- */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        /* --- æ—¥æœŸè¼¸å…¥æ¡†æ–‡å­—å¤§å° --- */
        input[type="date"]::-webkit-datetime-edit {
            font-size: 0.85rem; /* ç­‰åŒæ–¼ Tailwind çš„ text-xs */
        }
        /* --- éš±è—æ•¸å­—è¼¸å…¥æ¡†çš„ä¸Šä¸‹ç®­é ­ --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        
    </style>
    <style>
        /* ************************************************
           *** æ‚¨å¿…é ˆå°‡ Tailwind CSS å…§å®¹è¤‡è£½ä¸¦è²¼åˆ°é€™è£¡ ***
           *** (è«‹åƒè€ƒæª”æ¡ˆå¤–çš„èªªæ˜)                     ***
           ************************************************
        */
        *, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.container{width:100%}@media (min-width: 640px){.container{max-width:640px}}@media (min-width: 768px){.container{max-width:768px}}@media (min-width: 1024px){.container{max-width:1024px}}@media (min-width: 1280px){.container{max-width:1280px}}@media (min-width: 1536px){.container{max-width:1536px}}.pointer-events-none{pointer-events:none}.fixed{position:fixed}.inset-0{inset:0px}.z-50{z-index:50}.col-span-2{grid-column:span 2 / span 2}.mx-auto{margin-left:auto;margin-right:auto}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-3{margin-top:0.75rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.block{display:block}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-4{height:1rem}.w-full{width:100%}.min-w-full{min-width:100%}.max-w-5xl{max-width:64rem}.max-w-md{max-width:28rem}.max-w-sm{max-width:24rem}.flex-shrink-0{flex-shrink:0}.scale-95{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.cursor-pointer{cursor:pointer}.select-none{-webkit-user-select:none;user-select:none}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}.flex-col{flex-direction:column}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-end{justify-content:flex-end}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-4{gap:1rem}.space-x-2 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.5rem * var(--tw-space-x-reverse));margin-left:calc(0.5rem * calc(1 - var(--tw-space-x-reverse)))}.space-x-3 > :not([hidden]) ~ :not([hidden]){--tw-space-x-reverse:0;margin-right:calc(0.75rem * var(--tw-space-x-reverse));margin-left:calc(0.75rem * calc(1 - var(--tw-space-x-reverse)))}.space-y-3 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.75rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.75rem * var(--tw-space-y-reverse))}.space-y-4 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1rem * var(--tw-space-y-reverse))}.space-y-8 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(2rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(2rem * var(--tw-space-y-reverse))}.divide-y > :not([hidden]) ~ :not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px * var(--tw-divide-y-reverse))}.divide-stone-700 > :not([hidden]) ~ :not([hidden]){--tw-divide-opacity:1;border-color:rgb(68 64 60 / var(--tw-divide-opacity, 1))}.self-end{align-self:flex-end}.overflow-x-auto{overflow-x:auto}.rounded-2xl{border-radius:1rem}.rounded-lg{border-radius:0.5rem}.border{border-width:1px}.border-stone-700{--tw-border-opacity:1;border-color:rgb(68 64 60 / var(--tw-border-opacity, 1))}.bg-black{--tw-bg-opacity:1;background-color:rgb(0 0 0 / var(--tw-bg-opacity, 1))}.bg-rose-500{--tw-bg-opacity:1;background-color:rgb(244 63 94 / var(--tw-bg-opacity, 1))}.bg-sky-500{--tw-bg-opacity:1;background-color:rgb(14 165 233 / var(--tw-bg-opacity, 1))}.bg-stone-500{--tw-bg-opacity:1;background-color:rgb(120 113 108 / var(--tw-bg-opacity, 1))}.bg-stone-600{--tw-bg-opacity:1;background-color:rgb(87 83 78 / var(--tw-bg-opacity, 1))}.bg-stone-800{--tw-bg-opacity:1;background-color:rgb(41 37 36 / var(--tw-bg-opacity, 1))}.bg-stone-900{--tw-bg-opacity:1;background-color:rgb(28 25 23 / var(--tw-bg-opacity, 1))}.bg-opacity-70{--tw-bg-opacity:0.7}.p-2\.5{padding:0.625rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-4{padding-left:1rem;padding-right:1rem}.px-8{padding-left:2rem;padding-right:2rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-2\.5{padding-top:0.625rem;padding-bottom:0.625rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.py-8{padding-top:2rem;padding-bottom:2rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.pt-0{padding-top:0px}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.tracking-tight{letter-spacing:-0.025em}.tracking-wider{letter-spacing:0.05em}.text-amber-400{--tw-text-opacity:1;color:rgb(251 191 36 / var(--tw-text-opacity, 1))}.text-rose-400{--tw-text-opacity:1;color:rgb(251 113 133 / var(--tw-text-opacity, 1))}.text-sky-400{--tw-text-opacity:1;color:rgb(56 189 248 / var(--tw-text-opacity, 1))}.text-stone-100{--tw-text-opacity:1;color:rgb(245 245 244 / var(--tw-text-opacity, 1))}.text-stone-300{--tw-text-opacity:1;color:rgb(214 211 209 / var(--tw-text-opacity, 1))}.text-stone-400{--tw-text-opacity:1;color:rgb(168 162 158 / var(--tw-text-opacity, 1))}.text-stone-500{--tw-text-opacity:1;color:rgb(120 113 108 / var(--tw-text-opacity, 1))}.text-transparent{color:transparent}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.antialiased{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.opacity-0{opacity:0}.shadow-2xl{--tw-shadow:0 25px 50px -12px rgb(0 0 0 / 0.25);--tw-shadow-colored:0 25px 50px -12px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-inner{--tw-shadow:inset 0 2px 4px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:inset 0 2px 4px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-md{--tw-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 4px 6px -1px var(--tw-shadow-color), 0 2px 4px -2px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.transition{transition-property:color, background-color, border-color, fill, stroke, opacity, box-shadow, transform, filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter, -webkit-text-decoration-color, -webkit-backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.transition-transform{transition-property:transform;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.duration-300{transition-duration:300ms}.hover\:bg-rose-600:hover{--tw-bg-opacity:1;background-color:rgb(225 29 72 / var(--tw-bg-opacity, 1))}.hover\:bg-sky-600:hover{--tw-bg-opacity:1;background-color:rgb(2 132 199 / var(--tw-bg-opacity, 1))}.hover\:bg-stone-600:hover{--tw-bg-opacity:1;background-color:rgb(87 83 78 / var(--tw-bg-opacity, 1))}.hover\:bg-stone-700:hover{--tw-bg-opacity:1;background-color:rgb(68 64 60 / var(--tw-bg-opacity, 1))}.focus\:border-sky-400:focus{--tw-border-opacity:1;border-color:rgb(56 189 248 / var(--tw-border-opacity, 1))}.focus\:border-stone-500:focus{--tw-border-opacity:1;border-color:rgb(120 113 108 / var(--tw-border-opacity, 1))}.focus\:ring-sky-400:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(56 189 248 / var(--tw-ring-opacity, 1))}.focus\:ring-stone-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(120 113 108 / var(--tw-ring-opacity, 1))}.disabled\:cursor-not-allowed:disabled{cursor:not-allowed}.disabled\:opacity-50:disabled{opacity:0.5}@media (min-width: 640px){.sm\:mt-0{margin-top:0px}.sm\:flex-row{flex-direction:row}.sm\:p-6{padding:1.5rem}.sm\:text-4xl{font-size:2.25rem;line-height:2.5rem}}@media (min-width: 768px){.md\:col-span-1{grid-column:span 1 / span 1}.md\:col-span-2{grid-column:span 2 / span 2}.md\:col-span-3{grid-column:span 3 / span 3}.md\:col-span-5{grid-column:span 5 / span 5}.md\:grid-cols-12{grid-template-columns:repeat(12, minmax(0, 1fr))}.md\:grid-cols-6{grid-template-columns:repeat(6, minmax(0, 1fr))}}@media (min-width: 1024px){.lg\:p-8{padding:2rem}}
        
    </style>
</head>
<body class="antialiased">

    <!-- ç™»å…¥/é©—è­‰å€å¡Š (éš±è—) -->
    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl text-center hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">ğŸ“ˆé›²ç«¯å„€è¡¨æ¿ğŸ“Š</h1>
        <p class="mt-4 text-stone-400">ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥ä»¥è·¨è£ç½®åŒæ­¥æŒè‚¡è³‡æ–™</p>
        <button id="login-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">ä½¿ç”¨ Google ç™»å…¥</button>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ (é¡¯ç¤º) -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl"> 
        <!-- ç™»å‡ºæŒ‰éˆ• (éš±è—) -->
        <div class="flex justify-between items-center mb-6 hidden">
             <p id="user-display" class="text-sm text-stone-400"></p>
             <button id="logout-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">ç™»å‡º</button>
        </div>
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">ğŸ“ˆæˆæœ¬ç´€éŒ„å„€è¡¨æ¿ğŸ“Š</h1>
            <p class="mt-2 text-lg text-stone-400">ğŸ‡¹ğŸ‡¼  ğŸ‡ºğŸ‡¸ â¡ï¸ ğŸ¥¦ ğŸ”¥ (é›¢ç·šå–®æ©Ÿç‰ˆ)</p>
        </header>

        <main class="space-y-8">
            <!-- å¸³æˆ¶é¸æ“‡å€å¡Š -->
            <div class="bg-stone-800 p-4 rounded-2xl shadow-lg border border-stone-700 space-y-3">
                <!-- *** ä¿®æ”¹ ***: èª¿æ•´ Grid ç³»çµ±ç‚º 12 æ¬„ï¼Œä»¥ä¾¿å®¹ç´æ–°æ¬„ä½ -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <!-- Column 1: Account Select -->
                    <div class="md:col-span-5">
                        <label for="account-filter" class="block text-sm font-medium text-stone-300 mb-1">ç›®å‰å¸³æˆ¶</label>
                        <select id="account-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <!-- *** æ–°å¢ ***: å¸‚å ´é¡å‹ -->
                    <div class="md:col-span-2">
                        <label for="account-market-type" class="block text-sm font-medium text-stone-300 mb-1">å¸‚å ´</label>
                        <select id="account-market-type" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                            <option value="TW">å°è‚¡ ğŸ‡¹ğŸ‡¼</option>
                            <option value="US">ç¾è‚¡ ğŸ‡ºğŸ‡¸</option>
                        </select>
                    </div>
                    <!-- Column 2: Fee Discount -->
                     <div class="md:col-span-2"> <!-- *** ä¿®æ”¹ ***: èª¿æ•´ col-span -->
                        <label for="account-fee-discount" class="block text-sm font-medium text-stone-300 mb-1">æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡</label>
                         <input type="number" id="account-fee-discount" min="0" step="any" required value="0.28" class="block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <!-- Column 3: Buttons -->
                    <div class="flex items-center space-x-2 self-end md:col-span-3"> <!-- *** ä¿®æ”¹ ***: èª¿æ•´ col-span -->
                            <button id="add-account-btn" title="æ–°å¢å¸³æˆ¶" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">ï¼‹</button>
                            <button id="edit-account-btn" title="ç·¨è¼¯å¸³æˆ¶" class="flex-shrink-0 bg-stone-500 hover:bg-stone-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">âœï¸</button>
                            <button id="delete-account-btn" title="åˆªé™¤å¸³æˆ¶" class="flex-shrink-0 bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md hidden">ï¼</button>
                    </div>
                </div>
            </div>

            <!-- ç¸½è¦½èˆ‡ç¯©é¸å€å¡Š -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700 space-y-4">
                <h2 id="view-title" class="text-2xl font-bold text-stone-100 tracking-tight">ç¸½è¦½</h2>
                <!-- *** ä¿®æ”¹ ***: èª¿æ•´ Grid ç³»çµ±ç‚º 12 æ¬„ -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <!-- *** ä¿®æ”¹ ***: ç¸®çŸ­æœå°‹æ¡† -->
                    <div class="md:col-span-2">
                        <label for="stock-search" class="block text-sm font-medium text-stone-300 mb-2">æœå°‹æˆ–é¸æ“‡æª¢è¦–é …ç›®</label>
                        <input type="text" id="stock-search" placeholder="è¼¸å…¥ä»£è™Ÿç¯©é¸..." class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                    </div>
                    <!-- *** ä¿®æ”¹ ***: åŠ å¯¬ä¸‹æ‹‰é¸å–® -->
                    <div class="md:col-span-5">
                        <label for="stock-filter" class="block text-sm font-medium text-transparent mb-2 select-none">.</label>
                        <select id="stock-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <!-- *** ä¿®æ”¹ ***: col-span-1 (ç›¸å°è®Šçª„) -->
                    <div class="md:col-span-1">
                        <label id="shares-title" class="block text-sm font-medium text-stone-300 mb-2">å…¨éƒ¨æª”æ•¸</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalShares" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="avg-cost-box" class="md:col-span-2">
                        <label id="avg-cost-title" class="block text-sm font-medium text-stone-300 mb-2">å¹³å‡æˆæœ¬</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="avgCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="total-cost-box" class="md:col-span-2">
                        <label id="total-cost-title" class="block text-sm font-medium text-stone-300 mb-2">ç¸½æˆæœ¬</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆä½µæ–°å¢äº¤æ˜“ç´€éŒ„ -->
            <div class="bg-stone-800 rounded-2xl shadow-lg border border-stone-700">
                <div id="collapsible-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-stone-100">æ–°å¢äº¤æ˜“ç´€éŒ„</h2>
                    <span id="collapse-icon" class="text-stone-400 transform transition-transform duration-300">â–¼</span>
                </div>
                <div id="collapsible-content" class="collapsible-content">
                    <div class="p-4 pt-0">
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-stone-700">
                            <form id="add-transaction-form" class="space-y-4">
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label for="tx-symbol" class="block text-sm font-medium text-stone-300">è‚¡ç¥¨ä»£è™Ÿ</label>
                                        <input type="text" id="tx-symbol" required placeholder="ä¾‹å¦‚: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="tx-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="tx-date" class="block text-sm font-medium text-stone-300">æ—¥æœŸ</label>
                                        <input type="date" id="tx-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-shares" class="block text-sm font-medium text-stone-300">è‚¡æ•¸</label>
                                        <input type="number" id="tx-shares" min="0" step="any" required placeholder="1000" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-price" class="block text-sm font-medium text-stone-300">åƒ¹æ ¼(å‡åƒ¹)</label>
                                        <input type="number" id="tx-price" min="0" step="any" required placeholder="600.5" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                            </form>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <button type="button" id="add-buy-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">è²·å…¥</button>
                                <button type="button" id="add-sell-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">è³£å‡º</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- äº¤æ˜“æ­·å²/åº«å­˜æ˜ç´°å€å¡Š -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="history-title" class="text-xl font-semibold text-stone-100">äº¤æ˜“æ­·å²ç´€éŒ„</h2>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <button id="import-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">åŒ¯å…¥è³‡æ–™</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="export-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">åŒ¯å‡ºè³‡æ–™</button>
                    </div>
                </div>
                <div class="overflow-x-auto table-scrollbar">
                    <table class="min-w-full divide-y divide-stone-700">
                        <thead class="bg-stone-900">
                            </thead>
                        <tbody id="transaction-list" class="divide-y divide-stone-700">
                            </tbody>
                    </table>
                    <p id="no-data-msg" class="text-center py-8 text-stone-500">å°šç„¡äº¤æ˜“ç´€éŒ„</p>
                </div>
                 <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-stone-400 hidden">
                    <button id="prev-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">&lt; ä¸Šä¸€é </button>
                    <span id="page-info">ç¬¬ 1 / 1 é </span>
                    <button id="next-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é  &gt;</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- ä»¥ä¸‹æ˜¯å„ç¨®å½ˆå‡ºå¼è¦–çª— (Modal) -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="message-modal-title" class="text-lg font-semibold text-stone-100">æç¤º</h3>
            <p id="message-modal-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="add-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">æ–°å¢å¸³æˆ¶</h3>
            <form id="add-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="new-account-name" class="block text-sm font-medium text-stone-300">å¸³æˆ¶åç¨±</label>
                    <input type="text" id="new-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <!-- *** æ–°å¢ ***: å¸‚å ´é¡å‹ -->
                <div>
                    <label for="new-account-market-type" class="block text-sm font-medium text-stone-300">å¸‚å ´é¡å‹</label>
                    <select id="new-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                        <option value="TW">å°è‚¡ (TW)</option>
                        <option value="US">ç¾è‚¡ (US)</option>
                    </select>
                </div>
                <div>
                    <label for="new-account-fee-discount" class="block text-sm font-medium text-stone-300">æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡</label>
                    <input type="number" id="new-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">å»ºç«‹</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">ä¿®æ”¹å¸³æˆ¶</h3>
            <form id="edit-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="edit-account-name" class="block text-sm font-medium text-stone-300">æ–°å¸³æˆ¶åç¨±</label>
                    <input type="text" id="edit-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <!-- *** æ–°å¢ ***: å¸‚å ´é¡å‹ -->
                 <div>
                    <label for="edit-account-market-type" class="block text-sm font-medium text-stone-300">å¸‚å ´é¡å‹</label>
                    <select id="edit-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                        <option value="TW">å°è‚¡ (TW)</option>
                        <option value="US">ç¾è‚¡ (US)</option>
                    </select>
                </div>
                 <div>
                    <label for="edit-account-fee-discount" class="block text-sm font-medium text-stone-300">æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡</label>
                    <input type="number" id="edit-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-md w-full shadow-2xl transform scale-95">
            <h3 id="edit-modal-title" class="text-lg font-semibold text-stone-100">ç·¨è¼¯äº¤æ˜“ç´€éŒ„</h3>
            <form id="edit-transaction-form" class="mt-4 space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label for="edit-symbol" class="block text-sm font-medium text-stone-300">è‚¡ç¥¨ä»£è™Ÿ</label>
                        <input type="text" id="edit-symbol" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                        <small id="edit-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                    </div>
                    <div class="col-span-2">
                         <label for="edit-date" class="block text-sm font-medium text-stone-300">æ—¥æœŸ</label>
                         <input type="date" id="edit-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="col-span-2">
                         <label for="edit-shares" class="block text-sm font-medium text-stone-300">è‚¡æ•¸</label>
                         <input type="number" id="edit-shares" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="col-span-2">
                         <label for="edit-price" class="block text-sm font-medium text-stone-300">åƒ¹æ ¼</label>
                         <input type="number" id="edit-price" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-transaction-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-rose-400">ç¢ºèªåˆªé™¤å¸³æˆ¶</h3>
            <p id="delete-account-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="delete-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                <button type="button" id="delete-account-confirm" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <div id="clear-history-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-amber-400">ç¢ºèªæ¸…é™¤ç´€éŒ„</h3>
            <p id="clear-history-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="clear-history-later-btn" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å¦ (10å¤©å¾Œæ¸…é™¤)</button>
                <button type="button" id="clear-history-now-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">æ˜¯ (ç«‹å³æ¸…é™¤)</button>
            </div>
        </div>
    </div>

    <!-- 
        ä»¥ä¸‹æ˜¯æ‡‰ç”¨ç¨‹å¼çš„ä¸»è¦ JavaScript é‚è¼¯ã€‚
        é€™éƒ¨åˆ†å®Œå…¨æ²’æœ‰è®Šæ›´ï¼Œä»¥ç¢ºä¿æ‰€æœ‰åŠŸèƒ½ã€è¨»è§£å’Œé‚è¼¯éƒ½å’Œæ‚¨åŸå§‹æª”æ¡ˆä¸€è‡´ã€‚
    -->
    <script>
        // DOMContentLoaded äº‹ä»¶ç¢ºä¿åœ¨åŸ·è¡Œè…³æœ¬å‰ï¼ŒHTML å·²å®Œå…¨è¼‰å…¥å’Œè§£æ
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- å¸¸æ•¸å®šç¾© ---
            const FEE_RATE = 0.001425; // è­‰äº¤ç¨…æ‰‹çºŒè²»ç‡ (åˆ¸å•†æ”¶å–, åƒ…å°è‚¡)
            const TAX_RATE = 0.003;    // è­‰åˆ¸äº¤æ˜“ç¨…ç‡ (è³£å‡ºæ™‚æ”¿åºœæ”¶å–, åƒ…å°è‚¡)

            // --- DOM å…ƒç´ å®£å‘Š ---
            // å°‡ HTML é é¢ä¸Šçš„å…ƒç´ èˆ‡ JavaScript è®Šæ•¸é€£çµï¼Œæ–¹ä¾¿æ“ä½œ
            const addTransactionForm = document.getElementById('add-transaction-form'); // æ–°å¢äº¤æ˜“çš„è¡¨å–®
            const addBuyBtn = document.getElementById('add-buy-btn'); // "è²·å…¥" æŒ‰éˆ•
            const addSellBtn = document.getElementById('add-sell-btn'); // "è³£å‡º" æŒ‰éˆ•
            const addAccountForm = document.getElementById('add-account-form'); // æ–°å¢å¸³æˆ¶çš„è¡¨å–® (Modal å…§)
            const editAccountForm = document.getElementById('edit-account-form'); // ç·¨è¼¯å¸³æˆ¶çš„è¡¨å–® (Modal å…§)
            const transactionList = document.getElementById('transaction-list'); // äº¤æ˜“åˆ—è¡¨çš„ tbody
            const totalSharesEl = document.getElementById('totalShares'); // é¡¯ç¤ºç¸½è‚¡æ•¸/æª”æ•¸çš„å…ƒç´ 
            const avgCostEl = document.getElementById('avgCost'); // é¡¯ç¤ºå¹³å‡æˆæœ¬/ç¸½æˆæœ¬(ä¸å«è²»ç”¨)çš„å…ƒç´ 
            const totalCostEl = document.getElementById('totalCost'); // é¡¯ç¤ºç¸½æˆæœ¬(å«è²»ç”¨)çš„å…ƒç´ 
            const avgCostTitle = document.getElementById('avg-cost-title'); // å¹³å‡æˆæœ¬æ¨™é¡Œå…ƒç´ 
            const totalCostTitle = document.getElementById('total-cost-title'); // ç¸½æˆæœ¬æ¨™é¡Œå…ƒç´ 
            const avgCostBox = document.getElementById('avg-cost-box'); // å¹³å‡æˆæœ¬é¡¯ç¤ºå€å¡Š
            const totalCostBox = document.getElementById('total-cost-box'); // ç¸½æˆæœ¬é¡¯ç¤ºå€å¡Š
            const exportBtn = document.getElementById('export-btn'); // åŒ¯å‡ºæŒ‰éˆ•
            const importBtn = document.getElementById('import-btn'); // åŒ¯å…¥æŒ‰éˆ•
            const importFile = document.getElementById('import-file'); // æª”æ¡ˆé¸æ“‡è¼¸å…¥æ¡† (éš±è—)
            const noDataMsg = document.getElementById('no-data-msg'); // "å°šç„¡äº¤æ˜“ç´€éŒ„" çš„æç¤ºè¨Šæ¯
            const accountFilter = document.getElementById('account-filter'); // å¸³æˆ¶é¸æ“‡ä¸‹æ‹‰é¸å–®
            const accountFeeDiscountInput = document.getElementById('account-fee-discount'); // ä¸»ç•«é¢é¡¯ç¤º/ä¿®æ”¹å¸³æˆ¶æ‰‹çºŒè²»æŠ˜æ•¸çš„è¼¸å…¥æ¡†
            const accountMarketTypeInput = document.getElementById('account-market-type'); // *** æ–°å¢ ***: ä¸»ç•«é¢å¸‚å ´é¡å‹
            const stockFilter = document.getElementById('stock-filter'); // è‚¡ç¥¨é¸æ“‡ä¸‹æ‹‰é¸å–®
            const stockSearch = document.getElementById('stock-search'); // è‚¡ç¥¨æœå°‹è¼¸å…¥æ¡†
            const viewTitle = document.getElementById('view-title'); // ä¸»æ¨™é¡Œ (ç¸½è¦½/å€‹åˆ¥æª¢è¦–)
            const sharesTitle = document.getElementById('shares-title'); // ç¸½è‚¡æ•¸/æª”æ•¸å€å¡Šçš„æ¨™é¡Œ
            const historyTitle = document.getElementById('history-title'); // äº¤æ˜“æ­·å²/åº«å­˜æ˜ç´°å€å¡Šçš„æ¨™é¡Œ
            // Modal ç›¸é—œå…ƒç´ 
            const messageModal = document.getElementById('message-modal'); // é€šç”¨è¨Šæ¯ Modal
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalMessage = document.getElementById('message-modal-message');
            const messageModalClose = document.getElementById('message-modal-close');
            const addAccountModal = document.getElementById('add-account-modal'); // æ–°å¢å¸³æˆ¶ Modal
            const addAccountBtn = document.getElementById('add-account-btn');
            const addAccountCancelBtn = document.getElementById('add-account-cancel');
            const newAccountFeeDiscountInput = document.getElementById('new-account-fee-discount'); // æ–°å¢å¸³æˆ¶ Modal å…§çš„æŠ˜æ•¸è¼¸å…¥
            const newAccountMarketTypeInput = document.getElementById('new-account-market-type'); // *** æ–°å¢ ***: æ–°å¢å¸³æˆ¶ Modal å¸‚å ´é¡å‹
            const editAccountModal = document.getElementById('edit-account-modal'); // ç·¨è¼¯å¸³æˆ¶ Modal
            const editAccountBtn = document.getElementById('edit-account-btn');
            const editAccountCancelBtn = document.getElementById('edit-account-cancel');
            const editAccountNameInput = document.getElementById('edit-account-name'); // ç·¨è¼¯å¸³æˆ¶ Modal å…§çš„åç¨±è¼¸å…¥
            const editAccountFeeDiscountInput = document.getElementById('edit-account-fee-discount'); // ç·¨è¼¯å¸³æˆ¶ Modal å…§çš„æŠ˜æ•¸è¼¸å…¥
            const editAccountMarketTypeInput = document.getElementById('edit-account-market-type'); // *** æ–°å¢ ***: ç·¨è¼¯å¸³æˆ¶ Modal å¸‚å ´é¡å‹
            const deleteAccountBtn = document.getElementById('delete-account-btn'); // åˆªé™¤å¸³æˆ¶æŒ‰éˆ•
            const deleteAccountModal = document.getElementById('delete-account-modal'); // åˆªé™¤å¸³æˆ¶ç¢ºèª Modal
            const deleteAccountMessage = document.getElementById('delete-account-message');
            const deleteAccountCancelBtn = document.getElementById('delete-account-cancel');
            const deleteAccountConfirmBtn = document.getElementById('delete-account-confirm');
            const clearHistoryModal = document.getElementById('clear-history-modal'); // æ¸…é™¤æ­·å²ç´€éŒ„ç¢ºèª Modal
            const clearHistoryMessage = document.getElementById('clear-history-message');
            const clearHistoryLaterBtn = document.getElementById('clear-history-later-btn'); // 10å¤©å¾Œæ¸…é™¤æŒ‰éˆ•
            const clearHistoryNowBtn = document.getElementById('clear-history-now-btn'); // ç«‹å³æ¸…é™¤æŒ‰éˆ•
            // åˆ†é ç›¸é—œå…ƒç´ 
            const paginationControls = document.getElementById('pagination-controls'); // åˆ†é æ§åˆ¶å€å¡Š
            const prevPageBtn = document.getElementById('prev-page-btn'); // ä¸Šä¸€é æŒ‰éˆ•
            const nextPageBtn = document.getElementById('next-page-btn'); // ä¸‹ä¸€é æŒ‰éˆ•
            const pageInfo = document.getElementById('page-info'); // é ç¢¼è³‡è¨Š
            // å¯æ‘ºç–Šå€å¡Šç›¸é—œå…ƒç´ 
            const collapsibleHeader = document.getElementById('collapsible-header'); // æ–°å¢äº¤æ˜“å€å¡Šçš„æ¨™é ­
            const collapsibleContent = document.getElementById('collapsible-content'); // æ–°å¢äº¤æ˜“å€å¡Šçš„å…§å®¹
            const collapseIcon = document.getElementById('collapse-icon'); // æ‘ºç–Šåœ–æ¨™
            // ç·¨è¼¯äº¤æ˜“ Modal ç›¸é—œå…ƒç´ 
            const editTransactionModal = document.getElementById('edit-transaction-modal'); // ç·¨è¼¯äº¤æ˜“ Modal
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const editModalTitle = document.getElementById('edit-modal-title');
            const editTransactionCancelBtn = document.getElementById('edit-transaction-cancel');
            // ç™»å…¥/ä¸»æ‡‰ç”¨å®¹å™¨ (ä¿ç•™å®£å‘Šï¼Œå³ä½¿åœ¨æœ¬æ©Ÿç‰ˆéš±è—)
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            // --- æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹è®Šæ•¸ ---
            let appData = {}; // å­˜æ”¾æ‰€æœ‰æ‡‰ç”¨ç¨‹å¼è³‡æ–™ (å¸³æˆ¶ã€äº¤æ˜“ç´€éŒ„ç­‰)
            let currentPage = 1; // ç›®å‰é¡¯ç¤ºçš„äº¤æ˜“æ­·å²é ç¢¼
            let symbolToClear = null; // æš«å­˜ç­‰å¾…ç¢ºèªæ˜¯å¦æ¸…é™¤æ­·å²ç´€éŒ„çš„è‚¡ç¥¨ä»£è™Ÿ
            let debounceTimer; // ç”¨æ–¼è¼¸å…¥å»¶é²è™•ç†çš„è¨ˆæ™‚å™¨

            // --- è‚¡ç¥¨ä»£è™Ÿèˆ‡åç¨±å°æ‡‰è¡¨ ---
            // *** ä¿®æ”¹ ***: æ ¼å¼èª¿æ•´ç‚ºæ¯è¡Œä¸€å€‹é …ç›®
            const stockNameMap = {
				"0050": "å…ƒå¤§å°ç£50",
                "0051": "å…ƒå¤§ä¸­å‹100",
                "0052": "å¯Œé‚¦ç§‘æŠ€",
                "0053": "å…ƒå¤§é›»å­",
                "0055": "å…ƒå¤§MSCIé‡‘è",
                "0056": "å…ƒå¤§é«˜è‚¡æ¯",
                "0057": "å¯Œé‚¦æ‘©å°",
                "0061": "å…ƒå¤§å¯¶æ»¬æ·±",
                "006201": "å…ƒå¤§å¯¶æ«ƒ50",
                "006203": "å…ƒå¤§MSCIå°ç£",
                "006204": "æ°¸è±è‡ºç£åŠ æ¬Š",
                "006205": "å¯Œé‚¦ä¸Šè¨¼",
                "006206": "å…ƒå¤§ä¸Šè­‰50",
                "006207": "å¾©è¯æ»¬æ·±",
                "006208": "å¯Œé‚¦å°50",
                "00631L": "å…ƒå¤§å°ç£50æ­£2",
                "00632R": "å…ƒå¤§å°ç£50å1",
                "00633L": "å¯Œé‚¦ä¸Šè¨¼æ­£2",
                "00634R": "å¯Œé‚¦ä¸Šè¨¼å1",
                "00635U": "æœŸå…ƒå¤§S&Pé»ƒé‡‘",
                "00636": "åœ‹æ³°ä¸­åœ‹A50",
                "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2",
                "00638R": "å…ƒå¤§æ»¬æ·±300å1",
                "00639": "å¯Œé‚¦æ·±100",
                "00640L": "å¯Œé‚¦æ—¥æœ¬æ­£2",
                "00641R": "å¯Œé‚¦æ—¥æœ¬å1",
                "00642U": "æœŸå…ƒå¤§S&PçŸ³æ²¹",
                "00643": "ç¾¤ç›Šæ·±è¨¼ä¸­å°",
                "00645": "å¯Œé‚¦æ—¥æœ¬",
                "00646": "å…ƒå¤§S&P500",
                "00647L": "å…ƒå¤§S&P500æ­£2",
                "00648R": "å…ƒå¤§S&P500å1",
                "00650L": "å¾©è¯é¦™æ¸¯æ­£2",
                "00651R": "å¾©è¯é¦™æ¸¯å1",
                "00652": "å¯Œé‚¦å°åº¦",
                "00653L": "å¯Œé‚¦å°åº¦æ­£2",
                "00654R": "å¯Œé‚¦å°åº¦å1",
                "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2",
                "00656R": "åœ‹æ³°ä¸­åœ‹A50å1",
                "00657": "åœ‹æ³°æ—¥ç¶“225",
                "00660": "å…ƒå¤§æ­æ´²50",
                "00661": "å…ƒå¤§æ—¥ç¶“225",
                "00662": "å¯Œé‚¦NASDAQ",
                "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2",
                "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1",
                "00665L": "å¯Œé‚¦æ’ç”Ÿåœ‹ä¼æ­£2",
                "00666R": "å¯Œé‚¦æ’ç”Ÿåœ‹ä¼å1",
                "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š",
                "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1",
                "00670L": "å¯Œé‚¦NASDAQæ­£2",
                "00671R": "å¯Œé‚¦NASDAQå1",
                "00673R": "æœŸå…ƒå¤§S&PåŸæ²¹å1",
                "00674R": "æœŸå…ƒå¤§S&Pé»ƒé‡‘å1",
                "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2",
                "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1",
                "00678": "ç¾¤ç›Šé‚£æ–¯é”à°•à±ç”ŸæŠ€",
                "00679B": "å…ƒå¤§ç¾å‚µ20å¹´",
                "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2",
                "00681R": "å…ƒå¤§ç¾å‚µ20å1",
                "00682U": "æœŸå…ƒå¤§ç¾å…ƒæŒ‡æ•¸",
                "00683L": "æœŸå…ƒå¤§ç¾å…ƒæŒ‡æ­£2",
                "00684R": "æœŸå…ƒå¤§ç¾å…ƒæŒ‡å1",
                "00685L": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šæ­£2",
                "00686R": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šå1",
                "00687B": "åœ‹æ³°20å¹´ç¾å‚µ",
                "00688L": "åœ‹æ³°20å¹´ç¾å‚µæ­£2",
                "00689R": "åœ‹æ³°20å¹´ç¾å‚µå1",
                "00690": "å…†è±å°ç£è—ç±Œ30",
                "00692": "å¯Œé‚¦å…¬å¸æ²»ç†",
                "00693U": "æœŸè¡—å£S&Pé»ƒè±†",
                "00695B": "å¯Œé‚¦ç¾å‚µ7-10å¹´",
                "00696B": "å¯Œé‚¦ç¾å‚µ20å¹´",
                "00697B": "å…ƒå¤§ç¾å‚µ7-10",
                "00700": "å¯Œé‚¦æ†ç”Ÿåœ‹ä¼",
                "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30",
                "00702": "åœ‹æ³°æ¨™æ™®ä½æ³¢é«˜æ¯",
                "00703": "å°æ–°MSCIä¸­åœ‹",
                "00706L": "æœŸå…ƒå¤§S&Pæ—¥åœ“æ­£2",
                "00707R": "æœŸå…ƒå¤§S&Pæ—¥åœ“å1",
                "00708L": "æœŸå…ƒå¤§S&Pé»ƒé‡‘æ­£2",
                "00709": "å¯Œé‚¦æ­æ´²",
                "00710B": "å¾©è¯å½­åšéæŠ•ç­‰å‚µ",
                "00711B": "å¾©è¯å½­åšæ–°èˆˆå‚µ",
                "00712": "å¾©è¯å¯Œæ™‚ä¸å‹•ç”¢",
                "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢",
                "00714": "ç¾¤ç›Šé“ç“Šç¾åœ‹åœ°ç”¢",
                "00715L": "æœŸè¡—å£å¸ƒè˜­ç‰¹æ­£2",
                "00717": "å¯Œé‚¦ç¾åœ‹ç‰¹åˆ¥è‚¡",
                "00719B": "å…ƒå¤§ç¾å‚µ1-3",
                "00720B": "å…ƒå¤§æŠ•è³‡ç´šå…¬å¸å‚µ",
                "00722B": "ç¾¤ç›ŠæŠ•è³‡ç´šé›»ä¿¡å‚µ",
                "00723B": "ç¾¤ç›ŠæŠ•è³‡ç´šç§‘æŠ€å‚µ",
                "00724B": "ç¾¤ç›ŠæŠ•è³‡ç´šé‡‘èå‚µ",
                "00725B": "åœ‹æ³°æŠ•è³‡ç´šå…¬å¸å‚µ",
                "00726B": "åœ‹æ³°æ–°èˆˆæŠ•ç­‰å‚µ",
                "00727B": "åœ‹æ³°å„ªé¸æŠ•é ­ç­‰å‚µ",
                "00728": "ç¬¬ä¸€é‡‘å·¥æ¥­30",
                "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯",
                "00731": "å¾©è¯å¯Œæ™‚é«˜æ¯ä½æ³¢",
                "00733": "å¯Œé‚¦è‡ºç£ä¸­å°",
                "00734B": "å°æ–°JPMæ–°èˆˆå‚µ",
                "00735": "åœ‹æ³°è‡ºéŸ“ç§‘æŠ€",
                "00736": "åœ‹æ³°æ–°èˆˆå¸‚å ´",
                "00737": "åœ‹æ³°AIæ©Ÿå™¨äºº",
                "00738U": "æœŸå…ƒå¤§é“ç“Šç™½éŠ€",
                "00739": "å…ƒå¤§MSCI Aè‚¡",
                "00740B": "å¯Œé‚¦å…¨çƒæŠ•ç­‰å‚µ",
                "00741B": "å¯Œé‚¦å…¨çƒéæŠ•ç­‰å‚µ",
                "00746B": "å¯Œé‚¦Aç´šå…¬å¸å‚µ",
                "00749B": "å‡±åŸºæ–°èˆˆå‚µ10+",
                "00750B": "å‡±åŸºç§‘æŠ€å‚µ10+",
                "00751B": "å…ƒå¤§AAAè‡³Aå…¬å¸å‚µ",
                "00752": "ä¸­ä¿¡ä¸­åœ‹5G",
                "00753L": "ä¸­ä¿¡ä¸­åœ‹5Gæ­£2",
                "00757": "çµ±ä¸€FANG+",
                "00758B": "å¾©è¯èƒ½æºå‚µ",
                "00759B": "å¾©è¯è£½è—¥å‚µ",
                "00760B": "å¾©è¯æ–°èˆˆä¼æ¥­å‚µ",
                "00761B": "åœ‹æ³°Aç´šå…¬å¸å‚µ",
                "00762": "å…ƒå¤§å…¨çƒAI",
                "00764B": "å¾©è¯20å¹´ç¾å‚µ",
                "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€",
                "00771": "å…ƒå¤§USé«˜æ¯ç‰¹åˆ¥è‚¡",
                "00772B": "ä¸­ä¿¡é«˜è©•ç´šå…¬å¸å‚µ",
                "00773B": "ä¸­ä¿¡å„ªå…ˆé‡‘èå‚µ",
                "00775B": "æ–°å…‰æŠ•ç­‰å‚µ15+",
                "00777B": "å‡±åŸºAAAè‡³Aå…¬å¸å‚µ",
                "00778B": "å‡±åŸºé‡‘èå‚µ20+",
                "00779B": "å‡±åŸºç¾å‚µ25+",
                "00780B": "åœ‹æ³°Aç´šé‡‘èå‚µ",
                "00781B": "åœ‹æ³°Aç´šç§‘æŠ€å‚µ",
                "00782B": "åœ‹æ³°Aç´šå…¬ç”¨å‚µ",
                "00783": "å¯Œé‚¦ä¸­è¨¼500",
                "00785B": "å¯Œé‚¦é‡‘èæŠ•ç­‰å‚µ",
                "00786B": "å…ƒå¤§10å¹´IGéŠ€è¡Œå‚µ",
                "00787B": "å…ƒå¤§10å¹´IGé†«ç™‚å‚µ",
                "00788B": "å…ƒå¤§10å¹´IGé›»èƒ½å‚µ",
                "00789B": "å¾©è¯å…¬å¸å‚µA3",
                "00791B": "å¾©è¯ä¿¡ç”¨å‚µ1-5",
                "00792B": "ç¾¤ç›ŠAç´šå…¬å¸å‚µ",
                "00793B": "ç¾¤ç›ŠAAA-Aé†«ç™‚å‚µ",
                "00795B": "ä¸­ä¿¡ç¾åœ‹å…¬å‚µ20å¹´",
                "00799B": "åœ‹æ³°Aç´šé†«ç™‚å‚µ",
                "00830": "åœ‹æ³°è²»åŸåŠå°é«”",
                "00834B": "ç¬¬ä¸€é‡‘èå‚µ10+",
                "00836B": "æ°¸è±10å¹´Aå…¬å¸å‚µ",
                "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ",
                "00851": "å°æ–°å…¨çƒAI",
                "00858": "æ°¸è±ç¾åœ‹500å¤§",
                "00861": "å…ƒå¤§å…¨çƒæœªä¾†é€šè¨Š",
                "00870B": "å…ƒå¤§15å¹´EMä¸»æ¬Šå‚µ",
                "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰",
                "00876": "å…ƒå¤§å…¨çƒ5G",
                "00877": "å¾©è¯ä¸­åœ‹5G",
                "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯",
                "00881": "åœ‹æ³°å°ç£ç§‘æŠ€é¾é ­",
                "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯",
                "00885": "å¯Œé‚¦è¶Šå—",
                "00886": "æ°¸è±ç¾åœ‹ç§‘æŠ€",
                "00888": "æ°¸è±å°ç£ESG",
                "00891": "ä¸­ä¿¡é—œéµåŠå°é«”",
                "00892": "å¯Œé‚¦å°ç£åŠå°é«”",
                "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š",
                "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30",
                "00895": "å¯Œé‚¦æœªä¾†è»Š",
                "00896": "ä¸­ä¿¡ç¶ èƒ½åŠé›»å‹•è»Š",
                "00897": "å¯Œé‚¦åŸºå› å…ç–«ç”ŸæŠ€",
                "00898": "åœ‹æ³°åŸºå› å…ç–«é©å‘½",
                "00899": "FTæ½”æ·¨èƒ½æº",
                "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30",
                "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ",
                "00902": "ä¸­ä¿¡é›»æ± åŠå„²èƒ½",
                "00903": "å¯Œé‚¦å…ƒå®‡å®™",
                "00904": "æ–°å…‰è‡ºç£åŠå°é«”30",
                "00905": "FTè‡ºç£Smart",
                "00907": "æ°¸è±å„ªæ¯å­˜è‚¡",
                "00908": "å¯Œé‚¦å…¥æ¯REITs+",
                "00909": "åœ‹æ³°æ•¸ä½æ”¯ä»˜æœå‹™",
                "00910": "ç¬¬ä¸€é‡‘å¤ªç©ºè¡›æ˜Ÿ",
                "00911": "å…†è±æ´²éš›åŠå°é«”",
                "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50",
                "00913": "å…†è±å°ç£æ™¶åœ“è£½é€ ",
                "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30",
                "00917": "ä¸­ä¿¡ç‰¹é¸é‡‘è",
                "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30",
                "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯",
                "00920": "å¯Œé‚¦ESGç¶ è‰²é›»åŠ›",
                "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡",
                "00922": "åœ‹æ³°å°ç£é ˜è¢–50",
                "00923": "ç¾¤ç›Šå°ç£ESGä½ç¢³",
                "00924": "å¾©è¯S&P500æˆé•·",
                "00926": "å‡±åŸºå…¨çƒèè‹±55",
                "00927": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š",
                "00928": "ä¸­ä¿¡ä¸Šæ«ƒESG 30",
                "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯",
                "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯",
                "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š",
                "00933B": "åœ‹æ³°10Y+é‡‘èå‚µ",
                "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯",
                "00935": "é‡æ‘è‡ºç£æ–°ç§‘æŠ€50",
                "00936": "å°æ–°æ°¸çºŒé«˜æ¯ä¸­å°",
                "00937B": "ç¾¤ç›ŠESGæŠ•ç­‰å‚µ20+",
                "00938": "å‡±åŸºå„ªé¸30",
                "00939": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½",
                "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯",
                "00941": "ä¸­ä¿¡ä¸Šæ¸¸åŠå°é«”",
                "00943": "å…†è±é›»å­é«˜æ¯ç­‰æ¬Š",
                "00944": "é‡æ‘è¶¨å‹¢å‹•èƒ½é«˜æ¯",
                "00946": "ç¾¤ç›Šç§‘æŠ€é«˜æ¯æˆé•·",
                "00947": "å°æ–°å°ç£ICè¨­è¨ˆ",
                "00949": "å¾©è¯æ—¥æœ¬é¾é ­",
                "00951": "å°æ–°æ—¥æœ¬åŠå°é«”",
                "00952": "å‡±åŸºå°ç£AI50",
                "00954": "ä¸­ä¿¡æ—¥æœ¬åŠå°é«”",
                "00955": "ä¸­ä¿¡æ—¥æœ¬å•†ç¤¾",
                "00956": "ä¸­ä¿¡æ—¥ç¶“é«˜è‚¡æ¯",
                "00960": "é‡æ‘å…¨çƒèˆªé‹é¾é ­",
                "00961": "FTå°ç£æ°¸çºŒé«˜æ¯",
                "00962": "å°æ–°AIå„ªæ¯å‹•èƒ½",
                "00963": "ä¸­ä¿¡å…¨çƒé«˜è‚¡æ¯",
                "00964": "ä¸­ä¿¡äºå¤ªé«˜è‚¡æ¯",
                "00965": "å…ƒå¤§èˆªå¤ªé˜²è¡›ç§‘æŠ€",
                "00971": "é‡æ‘ç¾åœ‹ç ”ç™¼é¾é ­",
                "00972": "é‡æ‘æ—¥æœ¬å‹•nengé«˜æ¯",
                "009800": "ä¸­ä¿¡NASDAQ",
                "009801": "ä¸­ä¿¡ç¾åœ‹å‰µæ–°ç§‘æŠ€",
                "009802": "å¯Œé‚¦æ——è‰¦50",
                "009803": "ä¿å¾·ä¿¡å¸‚å€¼å‹•èƒ½50",
                "009804": "è¯é‚¦å°ç²¾å½©50",
                "009805": "æ–°å…‰ç¾åœ‹é›»åŠ›åŸºç¤",
                "009806": "å°æ–°æ¨™æ™®500",
                "009807": "å°æ–°æ¨™æ™®ç§‘æŠ€ç²¾é¸",
                "009808": "è¯å—æ°¸æ˜Œå„ªé¸50",
                "00980A": "ä¸»å‹•é‡æ‘è‡ºç£å„ªé¸",
                "009810": "ä¿å¾·ä¿¡å…¨çƒè—ç±Œ",
                "0D9811": "çµ±ä¸€ç¾åœ‹50",
                "009812": "é‡æ‘æ—¥æœ¬æ±è¨¼",
                "00981A": "ä¸»å‹•çµ±ä¸€å°è‚¡å¢é•·",
                "00982A": "ä¸»å‹•ç¾¤ç›Šè‡ºç£å¼·æ£’",
                "00983A": "ä¸»å‹•ä¸­ä¿¡ARKå‰µæ–°",
                "00984A": "ä¸»å‹•å®‰è¯è‡ºç£é«˜æ¯",
                "00985A": "ä¸»å‹•é‡æ‘è‡ºç£50",
                "00986A": "ä¸»å‹•å°æ–°é¾é ­æˆé•·",
                
			};
            
            /**
             * å¾ localStorage è¼‰å…¥è³‡æ–™ä¸¦åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ã€‚
             * åŒ…å«è³‡æ–™çµæ§‹é·ç§»é‚è¼¯ï¼Œä»¥è™•ç†èˆŠæ ¼å¼è³‡æ–™ã€‚
             */
            function initializeApp_Local() {
                // å¾ localStorage è®€å–åç‚º 'stockTrackerData_LocalTest' çš„è³‡æ–™
                const storedDataJSON = localStorage.getItem('stockTrackerData_LocalTest');
                let storedData = null; // æš«å­˜è§£æå¾Œçš„è³‡æ–™
                if (storedDataJSON) {
                    try {
                        // å˜—è©¦å°‡ JSON å­—ä¸²è§£æç‚º JavaScript ç‰©ä»¶
                        storedData = JSON.parse(storedDataJSON);
                    } catch (e) {
                        // å¦‚æœè§£æå¤±æ•—ï¼Œè¼¸å‡ºéŒ¯èª¤è¨Šæ¯
                        console.error("ç„¡æ³•è§£æ localStorage è³‡æ–™:", e);
                        storedData = null;
                    }
                }
                
                // --- åˆå§‹åŒ–æˆ–è¼‰å…¥æ‡‰ç”¨ç¨‹å¼è³‡æ–™ (appData) ---
                if (storedData && storedData.accounts) {
                    // å¦‚æœ localStorage æœ‰è³‡æ–™ä¸”åŒ…å« accounts å±¬æ€§ï¼Œå‰‡ä½¿ç”¨å®ƒ
                    appData = storedData;
                } else {
                    // å¦å‰‡ï¼Œåˆå§‹åŒ–ä¸€å€‹åŒ…å«é è¨­å¸³æˆ¶çš„æ–°è³‡æ–™çµæ§‹
                    appData = { 
                        accounts: { 
                            // *** ä¿®æ”¹ ***: åŠ å…¥ marketType
                            'é è¨­å¸³æˆ¶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } 
                        }, 
                        currentAccount: 'é è¨­å¸³æˆ¶' // ç›®å‰é¸ä¸­çš„å¸³æˆ¶åç¨±
                    };
                }
                
                // --- ç¢ºä¿ç›®å‰é¸ä¸­çš„å¸³æˆ¶ (currentAccount) æ˜¯æœ‰æ•ˆçš„ ---
                if (!appData.accounts[appData.currentAccount]) {
                    // å¦‚æœç›®å‰å¸³æˆ¶ç„¡æ•ˆ (å¯èƒ½å·²è¢«åˆªé™¤)ï¼Œå‰‡é¸å–ç¬¬ä¸€å€‹å¸³æˆ¶æˆ–å‰µå»ºé è¨­å¸³æˆ¶
                    appData.currentAccount = Object.keys(appData.accounts)[0] || 'é è¨­å¸³æˆ¶';
                    if (!appData.accounts[appData.currentAccount]) {
                            // å¦‚æœé€£ç¬¬ä¸€å€‹å¸³æˆ¶éƒ½æ²’æœ‰ï¼Œç¢ºä¿é è¨­å¸³æˆ¶å­˜åœ¨
                            // *** ä¿®æ”¹ ***: åŠ å…¥ marketType
                            appData.accounts['é è¨­å¸³æˆ¶'] = { transactions: [], feeDiscount: 0.28, marketType: 'TW' }; 
                    }
                }
                
                // --- è³‡æ–™é·ç§»èˆ‡æ¸…ç† ---
                // é€™å€‹è¿´åœˆéæ­·æ‰€æœ‰å¸³æˆ¶ï¼Œé€²è¡Œè³‡æ–™æ ¼å¼æª¢æŸ¥èˆ‡é·ç§»
                let needsSave = false; // æ¨™è¨˜æ˜¯å¦éœ€è¦å°‡é·ç§»å¾Œçš„è³‡æ–™å­˜å› localStorage
                for (const accountName in appData.accounts) {
                    const accountData = appData.accounts[accountName]; // å–å¾—å¸³æˆ¶è³‡æ–™

                    // --- é·ç§»èˆŠçš„å¸³æˆ¶çµæ§‹ (å¦‚æœå¸³æˆ¶è³‡æ–™ç›´æ¥æ˜¯é™£åˆ—) ---
                    if (Array.isArray(accountData)) {
                        console.log(`åµæ¸¬åˆ°å¸³æˆ¶ ${accountName} ç‚ºèˆŠæ ¼å¼ï¼Œé€²è¡Œé·ç§»...`);
                        let initialFeeDiscount = 0.28; // é è¨­æ‰‹çºŒè²»æŠ˜æ•¸
                        // å˜—è©¦å¾èˆŠè³‡æ–™çš„ç¬¬ä¸€ç­†äº¤æ˜“ä¸­è®€å–æ‰‹çºŒè²»æŠ˜æ•¸
                        if (accountData.length > 0 && accountData[0].feeDiscount !== undefined) {
                            initialFeeDiscount = accountData[0].feeDiscount;
                        }
                        // å°‡èˆŠçš„é™£åˆ—çµæ§‹è½‰æ›ç‚ºæ–°çš„ç‰©ä»¶çµæ§‹
                        // *** ä¿®æ”¹ ***: åŠ å…¥ marketType
                        appData.accounts[accountName] = { 
                            transactions: accountData, // ä¿ç•™åŸæœ‰çš„äº¤æ˜“ç´€éŒ„é™£åˆ—
                            feeDiscount: initialFeeDiscount, // æ·»åŠ æ‰‹çºŒè²»æŠ˜æ•¸å±¬æ€§
                            marketType: 'TW' // èˆŠè³‡æ–™é è¨­ç‚ºå°è‚¡
                        };
                        needsSave = true; // æ¨™è¨˜éœ€è¦å„²å­˜
                    } 
                    // --- è™•ç†ç„¡æ•ˆæˆ–éœ€è¦åˆå§‹åŒ–çš„å¸³æˆ¶çµæ§‹ ---
                    else if (typeof accountData !== 'object' || accountData === null) {
                        // å¦‚æœå¸³æˆ¶è³‡æ–™ä¸æ˜¯ç‰©ä»¶æˆ–ç‚º nullï¼Œå‰‡é‡è¨­ç‚ºæ¨™æº–çµæ§‹
                         // *** ä¿®æ”¹ ***: åŠ å…¥ marketType
                         appData.accounts[accountName] = { transactions: [], feeDiscount: 0.28, marketType: 'TW' };
                         needsSave = true;
                    } 
                    // --- ç¢ºä¿æ–°çš„å¸³æˆ¶çµæ§‹å®Œæ•´ ---
                    else {
                         // å¦‚æœå¸³æˆ¶ç‰©ä»¶ç¼ºå°‘ transactions é™£åˆ—ï¼Œå‰‡è£œä¸Š
                         if (!Array.isArray(accountData.transactions)) {
                            accountData.transactions = [];
                            needsSave = true;
                         }
                         // å¦‚æœå¸³æˆ¶ç‰©ä»¶ç¼ºå°‘ feeDiscount å±¬æ€§ï¼Œå‰‡è£œä¸Šé è¨­å€¼
                         if (accountData.feeDiscount === undefined) {
                             accountData.feeDiscount = 0.28;
                             needsSave = true;
                         }
                         // *** æ–°å¢ ***: å¦‚æœå¸³æˆ¶ç‰©ä»¶ç¼ºå°‘ marketType å±¬æ€§ï¼Œå‰‡è£œä¸Šé è¨­å€¼ 'TW'
                         if (accountData.marketType === undefined) {
                             accountData.marketType = 'TW';
                             needsSave = true;
                         }
                    }

                    // --- è™•ç†å¸³æˆ¶å…§çš„äº¤æ˜“ç´€éŒ„ (è£œé½ŠèˆŠè³‡æ–™æ¬„ä½ã€é‡æ–°è¨ˆç®—è²»ç”¨) ---
                    const transactions = appData.accounts[accountName].transactions; // å–å¾—è©²å¸³æˆ¶çš„äº¤æ˜“ç´€éŒ„é™£åˆ—
                    // *** ä¿®æ”¹ ***: ç²å–å¸³æˆ¶çš„æ‰‹çºŒè²»æŠ˜æ•¸å’Œå¸‚å ´é¡å‹
                    const accountFeeDiscount = appData.accounts[accountName].feeDiscount; 
                    const accountMarketType = appData.accounts[accountName].marketType || 'TW';

                    transactions.forEach(tx => {
                        // è£œé½Šè‚¡ç¥¨åç¨± (å¦‚æœä¸å­˜åœ¨)
                        if (!tx.name) tx.name = stockNameMap[tx.symbol] || '';
                        // è£œé½Š reviewed ç‹€æ…‹ (å¦‚æœä¸å­˜åœ¨)
                        if (tx.reviewed === undefined) tx.reviewed = false; 
                        
                        // è£œé½Š price (å¦‚æœä¸å­˜åœ¨)
                        if (tx.price === undefined) { tx.price = 0; needsSave = true; }

                        // è¨ˆç®—äº¤æ˜“é‡‘é¡ (è‚¡æ•¸ * åƒ¹æ ¼)
                        const amount = tx.price * tx.shares;

                        // å¦‚æœè²»ç”¨ (fee) ä¸å­˜åœ¨ï¼Œæˆ–è€…äº¤æ˜“ç´€éŒ„ä¸­æœ‰èˆŠçš„ feeDiscount æ¬„ä½ (ä»£è¡¨æ˜¯èˆŠè³‡æ–™éœ€è¦é‡æ–°è¨ˆç®—)
                        if (tx.fee === undefined || tx.feeDiscount !== undefined) {
                            
                            // *** ä¿®æ”¹ ***: æ ¹æ“šå¸‚å ´é¡å‹é‡æ–°è¨ˆç®—è²»ç”¨
                            let fee = 0;
                            if (accountMarketType === 'TW') {
                                // èˆŠè³‡æ–™é·ç§»æ™‚ï¼Œä½¿ç”¨å¸³æˆ¶ç•¶å‰çš„æŠ˜æ•¸é‡æ–°è¨ˆç®—
                                fee = amount * FEE_RATE * accountFeeDiscount; 
                                // å¦‚æœæ˜¯è³£å‡ºäº¤æ˜“ï¼ŒåŠ ä¸Šè­‰äº¤ç¨…
                                if (tx.type === 'SELL') {
                                    fee += (amount * TAX_RATE);
                                }
                            } else { // 'US'
                                // å‡è¨­èˆŠè³‡æ–™å¦‚æœæ˜¯ç¾è‚¡(é›–ç„¶ä¸å¤ªå¯èƒ½ï¼Œä½†ç‚ºæ±‚é‚è¼¯å®Œæ•´)ï¼Œè²»ç”¨ = é‡‘é¡ * è²»ç‡
                                fee = amount * accountFeeDiscount;
                                // ç¾è‚¡è³£å‡ºä¸åŠ ç¨… (æ ¹æ“šä½¿ç”¨è€…è¦æ±‚)
                            }
                            tx.fee = fee;
                            
                            // å¦‚æœæ˜¯è²·å…¥äº¤æ˜“ï¼Œä¸”ç¸½äº¤æ˜“æˆæœ¬ (totalTxCost) ä¸å­˜åœ¨ï¼Œæˆ–è€…æœ‰èˆŠçš„ feeDiscount æ¬„ä½
                            if (tx.type === 'BUY') {
                                // é‡æ–°è¨ˆç®—è²·å…¥ç¸½æˆæœ¬ (äº¤æ˜“é‡‘é¡ + æ‰‹çºŒè²»)
                                tx.totalTxCost = amount + tx.fee; 
                            }
                            needsSave = true; // æ¨™è¨˜éœ€è¦å„²å­˜
                        }
                        
                        // *** é·ç§»å®Œæˆå¾Œç§»é™¤äº¤æ˜“ç´€éŒ„ä¸­çš„èˆŠ feeDiscount æ¬„ä½ ***
                        if (tx.feeDiscount !== undefined) {
                            delete tx.feeDiscount;
                            needsSave = true; // æ¨™è¨˜éœ€è¦å„²å­˜
                        }
                    });
                }
                
                // --- å¦‚æœåœ¨é·ç§»éç¨‹ä¸­è³‡æ–™æœ‰è®Šå‹•ï¼Œå‰‡å­˜å› localStorage ---
                if (needsSave) {
                    saveDataToLocalStorage();
                    console.log("è³‡æ–™çµæ§‹å·²æ›´æ–°æˆ–é·ç§»å®Œæˆã€‚");
                }
                
                // --- æ¸…ç†éæœŸçš„å¾…åˆªé™¤äº¤æ˜“ ---
                cleanupExpiredTransactions(); 
                
                // --- æ¢å¾©æ‘ºç–Šç‹€æ…‹ ---
                const isCollapsed = localStorage.getItem('isFormCollapsed_SharesOnly') === 'true';
                if (isCollapsed) {
                    // å¦‚æœä¹‹å‰æ˜¯æ‘ºç–Šçš„ï¼Œä¿æŒæ‘ºç–Š
                    collapsibleContent.style.maxHeight = null;
                    collapseIcon.style.transform = 'rotate(-90deg)';
                } else {
                    // å¦å‰‡ï¼Œå±•é–‹ä¸¦è¨­å®šæ­£ç¢ºçš„é«˜åº¦
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                    collapseIcon.style.transform = 'rotate(0deg)';
                }
                
                // --- æ›´æ–°ä»‹é¢å…ƒä»¶ ---
                updateAccountFilterOptions(); // æ›´æ–°å¸³æˆ¶ä¸‹æ‹‰é¸å–®
                updateAccountFeeDiscountDisplay(); // æ›´æ–°å¸³æˆ¶æ‰‹çºŒè²»æŠ˜æ•¸é¡¯ç¤º
                updateAccountMarketTypeDisplay(); // *** æ–°å¢ ***: æ›´æ–°å¸‚å ´é¡å‹é¡¯ç¤º
                updateStockFilterOptions(); // æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–®
                render(); // é‡æ–°æ¸²æŸ“ä¸»è¦å…§å®¹å€åŸŸ
            }

            /**
             * å°‡ appData ç‰©ä»¶è½‰æ›ç‚º JSON å­—ä¸²ä¸¦å„²å­˜åˆ° localStorageã€‚
             */
            function saveDataToLocalStorage() {
                try {
                    // ä½¿ç”¨ 'stockTrackerData_LocalTest' ä½œç‚º key å„²å­˜è³‡æ–™
                    localStorage.setItem('stockTrackerData_LocalTest', JSON.stringify(appData));
                } catch (error) {
                    // å¦‚æœå„²å­˜å¤±æ•— (ä¾‹å¦‚ localStorage ç©ºé–“å·²æ»¿)ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    console.error("è³‡æ–™å„²å­˜è‡³ localStorage å¤±æ•—:", error);
                    showModal(messageModal, 'å„²å­˜å¤±æ•—', 'ç„¡æ³•å°‡è³‡æ–™å„²å­˜è‡³ç€è¦½å™¨ï¼Œç©ºé–“å¯èƒ½å·²æ»¿ã€‚');
                }
            }
            
            /**
             * å°‡æ–°å¢äº¤æ˜“è¡¨å–®ä¸­çš„æ—¥æœŸæ¬„ä½é è¨­ç‚ºä»Šå¤©ã€‚
             */
            function setDateToToday() {
                // ç²å–ä»Šå¤©çš„æ—¥æœŸä¸¦æ ¼å¼åŒ–ç‚º YYYY-MM-DD
                const today = new Date().toISOString().slice(0, 10);
                // è¨­å®šæ—¥æœŸè¼¸å…¥æ¡†çš„å€¼
                document.getElementById('tx-date').value = today;
            }

            /**
             * æ¸…ç†æ¨™è¨˜ç‚º "10å¤©å¾Œåˆªé™¤" ä¸”å·²éæœŸçš„äº¤æ˜“ç´€éŒ„ã€‚
             */
            function cleanupExpiredTransactions() {
                let changed = false; // æ¨™è¨˜æ˜¯å¦æœ‰è³‡æ–™è®Šå‹•
                const now = Date.now(); // ç²å–ç•¶å‰æ™‚é–“æˆ³
                // éæ­·æ‰€æœ‰å¸³æˆ¶
                for (const accountName in appData.accounts) {
                    const account = appData.accounts[accountName]; 
                    const transactions = account.transactions; 
                    if (!Array.isArray(transactions)) continue; // å¦‚æœæ²’æœ‰äº¤æ˜“ç´€éŒ„ï¼Œè·³é

                    // æ‰¾å‡ºæ‰€æœ‰ deletionTimestamp å·²éæœŸçš„äº¤æ˜“ç´€éŒ„æ‰€å±¬çš„è‚¡ç¥¨ä»£è™Ÿ (å»é‡)
                    const symbolsWithExpiredTimestamp = [...new Set(
                        transactions
                            .filter(tx => tx.deletionTimestamp && tx.deletionTimestamp <= now)
                            .map(tx => tx.symbol)
                    )];

                    // éæ­·é€™äº›éœ€è¦æ¸…ç†çš„è‚¡ç¥¨ä»£è™Ÿ
                    symbolsWithExpiredTimestamp.forEach(symbol => {
                        // é‡æ–°è¨ˆç®—è©²è‚¡ç¥¨ç›®å‰çš„æŒè‚¡ (æ’é™¤å·²æ¨™è¨˜åˆªé™¤çš„)
                        const holdings = getCurrentHoldings(symbol, transactions); 
                        const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);

                        // å¦‚æœæ¸…ç†å¾ŒæŒè‚¡ç‚º 0ï¼Œå‰‡ç›´æ¥åˆªé™¤è©²è‚¡ç¥¨çš„æ‰€æœ‰ç›¸é—œäº¤æ˜“ç´€éŒ„
                        if (currentShares === 0) {
                            account.transactions = transactions.filter(tx => tx.symbol !== symbol); 
                        } 
                        // å¦‚æœæ¸…ç†å¾Œä»æœ‰æŒè‚¡ï¼Œåƒ…ç§»é™¤äº¤æ˜“ç´€éŒ„ä¸­çš„ deletionTimestamp æ¨™è¨˜
                        else {
                            account.transactions.forEach(tx => { 
                                if (tx.symbol === symbol) {
                                    delete tx.deletionTimestamp;
                                }
                            });
                        }
                        changed = true; // æ¨™è¨˜è³‡æ–™å·²è®Šå‹•
                    });
                }
                // å¦‚æœè³‡æ–™æœ‰è®Šå‹•ï¼Œå‰‡å­˜å› localStorage
                if (changed) saveDataToLocalStorage(); 
            }
            
            /**
             * æ›´æ–°å¸³æˆ¶é¸æ“‡ä¸‹æ‹‰é¸å–®çš„é¸é …ï¼Œä¸¦æ ¹æ“šå¸³æˆ¶æ•¸é‡é¡¯ç¤º/éš±è—åˆªé™¤æŒ‰éˆ•ã€‚
             */
            function updateAccountFilterOptions() {
                // ç¢ºä¿ appData.accounts å­˜åœ¨
                if (!appData.accounts) {
                    // *** ä¿®æ”¹ ***: åŠ å…¥ marketType
                    appData.accounts = { 'é è¨­å¸³æˆ¶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } }; 
                    appData.currentAccount = 'é è¨­å¸³æˆ¶';
                }
                const accountNames = Object.keys(appData.accounts); // ç²å–æ‰€æœ‰å¸³æˆ¶åç¨±
                accountFilter.innerHTML = ''; // æ¸…ç©ºä¸‹æ‹‰é¸å–®
                // ç‚ºæ¯å€‹å¸³æˆ¶åç¨±å‰µå»ºä¸€å€‹ <option> å…ƒç´ ä¸¦æ·»åŠ åˆ°ä¸‹æ‹‰é¸å–®ä¸­
                accountNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    accountFilter.appendChild(option);
                });
                // è¨­å®šä¸‹æ‹‰é¸å–®çš„é¸ä¸­å€¼ç‚ºç›®å‰å¸³æˆ¶
                accountFilter.value = appData.currentAccount;
                // å¦‚æœå¸³æˆ¶æ•¸é‡å°‘æ–¼ç­‰æ–¼ 1ï¼Œéš±è—åˆªé™¤æŒ‰éˆ•
                deleteAccountBtn.classList.toggle('hidden', accountNames.length <= 1);
                // æ›´æ–°ä¸»ç•«é¢ä¸Šé¡¯ç¤ºçš„æ‰‹çºŒè²»æŠ˜æ•¸
                updateAccountFeeDiscountDisplay(); 
                // *** æ–°å¢ ***: æ›´æ–°å¸‚å ´é¡å‹é¡¯ç¤º
                updateAccountMarketTypeDisplay();
            }

             /**
             * æ›´æ–°ä¸»ç•«é¢å¸³æˆ¶å€å¡Šçš„æ‰‹çºŒè²»æŠ˜æ•¸è¼¸å…¥æ¡†çš„å€¼ï¼Œä½¿å…¶èˆ‡ç›®å‰é¸ä¸­å¸³æˆ¶çš„è¨­å®šåŒæ­¥ã€‚
             */
            function updateAccountFeeDiscountDisplay() {
                 // ç¢ºä¿ç›®å‰å¸³æˆ¶å­˜åœ¨æ–¼ appData ä¸­
                 if (appData.accounts && appData.accounts[appData.currentAccount]) {
                     // æ›´æ–°è¼¸å…¥æ¡†çš„å€¼
                     accountFeeDiscountInput.value = appData.accounts[appData.currentAccount].feeDiscount;
                 } else {
                      // å¦‚æœå¸³æˆ¶ä¸å­˜åœ¨ (ç•°å¸¸æƒ…æ³)ï¼Œä½¿ç”¨é è¨­å€¼
                      accountFeeDiscountInput.value = 0.28; 
                 }
            }
            
            /**
             * *** æ–°å¢ ***: æ›´æ–°ä¸»ç•«é¢å¸³æˆ¶å€å¡Šçš„å¸‚å ´é¡å‹ä¸‹æ‹‰é¸å–®çš„å€¼ã€‚
             */
            function updateAccountMarketTypeDisplay() {
                 if (appData.accounts && appData.accounts[appData.currentAccount]) {
                     accountMarketTypeInput.value = appData.accounts[appData.currentAccount].marketType || 'TW';
                 } else {
                      accountMarketTypeInput.value = 'TW';
                 }
            }

            /**
             * æ›´æ–°è‚¡ç¥¨é¸æ“‡ä¸‹æ‹‰é¸å–®çš„é¸é …ï¼Œæ ¹æ“šæœå°‹æ¡†å…§å®¹é€²è¡Œç¯©é¸ã€‚
             */
            function updateStockFilterOptions() {
                // ç²å–ç›®å‰å¸³æˆ¶çš„äº¤æ˜“ç´€éŒ„
                const currentAccountData = appData.accounts[appData.currentAccount];
                const currentTransactions = currentAccountData ? currentAccountData.transactions : []; 
                
                const selectedValue = stockFilter.value; // ç›®å‰ä¸‹æ‹‰é¸å–®é¸ä¸­çš„å€¼
                const searchTerm = stockSearch.value.trim().toUpperCase(); // æœå°‹æ¡†çš„å€¼ (è½‰å¤§å¯«)
                
                if (!Array.isArray(currentTransactions)) return; // é˜²éŒ¯

                // ç²å–ç›®å‰å¸³æˆ¶äº¤æ˜“ç´€éŒ„ä¸­æ‰€æœ‰ä¸é‡è¤‡çš„è‚¡ç¥¨ä»£è™Ÿ
                let symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                
                // å¦‚æœæœå°‹æ¡†æœ‰å…§å®¹ï¼Œå‰‡ç¯©é¸è‚¡ç¥¨ä»£è™Ÿ
                if (searchTerm) {
                    symbols = symbols.filter(symbol => symbol.toUpperCase().includes(searchTerm));
                }

                symbols.sort(); // æŒ‰å­—æ¯é †åºæ’åº
                
                // æª¢æŸ¥ç›®å‰é¸ä¸­çš„å€¼æ˜¯å¦ä»ç„¶åœ¨ç¯©é¸å¾Œçš„åˆ—è¡¨ä¸­ï¼Œæˆ–è€…æ˜¯å¦ç‚º "å…¨éƒ¨åº«å­˜"
                const isCurrentSelectionValid = symbols.includes(selectedValue) || selectedValue === '__ALL__';

                // --- é‡å»ºè‚¡ç¥¨ä¸‹æ‹‰é¸å–® ---
                stockFilter.innerHTML = ''; // æ¸…ç©ºèˆŠé¸é …
                // æ·»åŠ  "å…¨éƒ¨åº«å­˜" é¸é …
                const allOption = document.createElement('option');
                allOption.value = '__ALL__';
                allOption.textContent = 'å…¨éƒ¨åº«å­˜';
                stockFilter.appendChild(allOption);

                // æ·»åŠ ç¯©é¸å¾Œçš„è‚¡ç¥¨ä»£è™Ÿé¸é …
                if (symbols.length > 0) {
                    symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        // é¡¯ç¤ºæ ¼å¼: ä»£è™Ÿ (åç¨±)
                        option.textContent = `${symbol} (${stockNameMap[symbol] || 'æœªçŸ¥'})`;
                        stockFilter.appendChild(option);
                    });
                }
                // --- æ¢å¾©ä¸‹æ‹‰é¸å–®çš„é¸ä¸­ç‹€æ…‹ ---
                if (isCurrentSelectionValid) {
                     // å¦‚æœåŸé¸ä¸­å€¼æœ‰æ•ˆï¼Œå‰‡æ¢å¾©é¸ä¸­
                     stockFilter.value = selectedValue;
                } else {
                     // å¦å‰‡ï¼Œé è¨­é¸ä¸­ "å…¨éƒ¨åº«å­˜"
                     stockFilter.value = '__ALL__';
                }
            }
            
            /**
             * é¡¯ç¤ºæŒ‡å®šçš„ Modal å½ˆå‡ºè¦–çª—ã€‚
             * @param {HTMLElement} modalElement - è¦é¡¯ç¤ºçš„ Modal å…ƒç´ ã€‚
             * @param {string} [title] - (å¯é¸) Modal çš„æ¨™é¡Œ (åƒ…å° messageModal æœ‰æ•ˆ)ã€‚
             * @param {string} [message] - (å¯é¸) Modal çš„è¨Šæ¯å…§å®¹ (åƒ…å° messageModal æœ‰æ•ˆ)ã€‚
             */
            function showModal(modalElement, title, message) {
                 // å¦‚æœæ˜¯é€šç”¨è¨Šæ¯ Modalï¼Œè¨­å®šæ¨™é¡Œå’Œå…§å®¹
                 if (modalElement === messageModal) {
                     messageModalTitle.textContent = title;
                     messageModalMessage.textContent = message;
                 }
                 // ç§»é™¤æ§åˆ¶é¡¯ç¤º/éš±è—çš„ CSS classï¼Œè§¸ç™¼å‹•ç•«
                 modalElement.classList.remove('opacity-0', 'pointer-events-none');
                 modalElement.querySelector('.modal-content').classList.remove('scale-95');
            }
            
            /**
             * éš±è—æŒ‡å®šçš„ Modal å½ˆå‡ºè¦–çª—ã€‚
             * @param {HTMLElement} modalElement - è¦éš±è—çš„ Modal å…ƒç´ ã€‚
             */
            function hideModal(modalElement) {
                // æ·»åŠ æ§åˆ¶é¡¯ç¤º/éš±è—çš„ CSS classï¼Œè§¸ç™¼å‹•ç•«
                modalElement.classList.add('opacity-0', 'pointer-events-none');
                modalElement.querySelector('.modal-content').classList.add('scale-95');
            }
            
            // --- ç‚ºå„ Modal çš„é—œé–‰/å–æ¶ˆæŒ‰éˆ•ç¶å®šäº‹ä»¶ ---
            messageModalClose.addEventListener('click', () => hideModal(messageModal));
            addAccountBtn.addEventListener('click', () => {
                 newAccountFeeDiscountInput.value = 0.28; // æ‰“é–‹æ–°å¢å¸³æˆ¶ Modal å‰é‡è¨­æŠ˜æ•¸ç‚ºé è¨­å€¼
                 newAccountMarketTypeInput.value = 'TW'; // *** æ–°å¢ ***: é‡è¨­å¸‚å ´é¡å‹
                 showModal(addAccountModal);
            });
            addAccountCancelBtn.addEventListener('click', () => hideModal(addAccountModal));
            
            editAccountBtn.addEventListener('click', () => {
                // æ‰“é–‹ç·¨è¼¯å¸³æˆ¶ Modal å‰è¼‰å…¥ç›®å‰å¸³æˆ¶çš„åç¨±å’ŒæŠ˜æ•¸
                editAccountNameInput.value = appData.currentAccount;
                editAccountFeeDiscountInput.value = appData.accounts[appData.currentAccount]?.feeDiscount || 0.28;
                editAccountMarketTypeInput.value = appData.accounts[appData.currentAccount]?.marketType || 'TW'; // *** æ–°å¢ ***: è¼‰å…¥å¸‚å ´é¡å‹
                showModal(editAccountModal);
            });
            editAccountCancelBtn.addEventListener('click', () => hideModal(editAccountModal));
            
            deleteAccountBtn.addEventListener('click', () => {
                // æ‰“é–‹åˆªé™¤ç¢ºèª Modal å‰è¨­å®šæç¤ºè¨Šæ¯
                const accountToDelete = appData.currentAccount;
                deleteAccountMessage.textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${accountToDelete}ã€å¸³æˆ¶å—ï¼Ÿæ­¤å¸³æˆ¶å…§çš„æ‰€æœ‰äº¤æ˜“ç´€éŒ„å°‡è¢«æ°¸ä¹…ç§»é™¤ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
                showModal(deleteAccountModal);
            });
            deleteAccountCancelBtn.addEventListener('click', () => hideModal(deleteAccountModal));
            
            /**
             * æ ¹æ“šå…ˆé€²å…ˆå‡º (FIFO) åŸå‰‡è¨ˆç®—æŒ‡å®šè‚¡ç¥¨çš„ç›®å‰æŒè‚¡éƒ¨ä½ã€‚
             * @param {string} symbol - è‚¡ç¥¨ä»£è™Ÿã€‚
             * @param {Array} transactions - åŒ…å«è©²è‚¡ç¥¨æ‰€æœ‰äº¤æ˜“ç´€éŒ„çš„é™£åˆ—ã€‚
             * @returns {Array} - è¨ˆç®—å¾Œå‰©é¤˜çš„æŒè‚¡éƒ¨ä½ (åªåŒ…å«è²·å…¥ç´€éŒ„ï¼Œè‚¡æ•¸å’Œæˆæœ¬å¯èƒ½å·²è¢«èª¿æ•´)ã€‚
             */
            function getCurrentHoldings(symbol, transactions) {
                if (!Array.isArray(transactions)) return []; // é˜²éŒ¯
                // éæ¿¾æ‰æ¨™è¨˜ç‚ºå¾…åˆªé™¤çš„äº¤æ˜“
                const activeTransactions = transactions.filter(tx => !tx.deletionTimestamp);
                // ç¯©é¸å‡ºæŒ‡å®šè‚¡ç¥¨çš„äº¤æ˜“ç´€éŒ„
                const symbolTxs = activeTransactions.filter(tx => tx.symbol === symbol);
                // ç¯©é¸å‡ºè²·å…¥äº¤æ˜“ï¼Œä¸¦æŒ‰æ—¥æœŸå‡åºæ’åˆ—
                const buyTxs = symbolTxs.filter(tx => tx.type === 'BUY').sort((a, b) => new Date(a.date) - new Date(b.date));
                // ç¯©é¸å‡ºè³£å‡ºäº¤æ˜“
                const sellTxs = symbolTxs.filter(tx => tx.type === 'SELL');
                // è¨ˆç®—ç¸½è³£å‡ºè‚¡æ•¸
                let sharesSold = sellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                
                const holdings = []; // ç”¨æ–¼å­˜æ”¾è¨ˆç®—å¾Œçš„æŒè‚¡éƒ¨ä½
                // éæ­·æ’åºå¾Œçš„è²·å…¥äº¤æ˜“
                for (const buyTx of buyTxs) {
                    // è¨ˆç®—æ­¤ç­†è²·å…¥çš„æ¯è‚¡æˆæœ¬ (å«æ‰‹çºŒè²»)
                    // (buyTx.totalTxCost !== undefined ? buyTx.totalTxCost : (buyTx.price * buyTx.shares)) æ˜¯ç‚ºäº†ç›¸å®¹èˆŠè³‡æ–™
                    const costBasis = buyTx.totalTxCost !== undefined ? buyTx.totalTxCost : (buyTx.price * buyTx.shares);
                    // é¿å…é™¤ä»¥é›¶
                    const costPerShare = buyTx.shares !== 0 ? costBasis / buyTx.shares : 0; 

                    // å¦‚æœå·²æ²’æœ‰éœ€è¦æ‰£é™¤çš„è³£å‡ºè‚¡æ•¸
                    if (sharesSold <= 0) {
                        // å°‡æ­¤ç­†è²·å…¥ç´€éŒ„å®Œæ•´åŠ å…¥æŒè‚¡åˆ—è¡¨ (ç§»é™¤èˆŠçš„ feeDiscount)
                        const { feeDiscount, ...restOfBuyTx } = buyTx; 
                        holdings.push(restOfBuyTx); 
                        continue; // è™•ç†ä¸‹ä¸€ç­†è²·å…¥
                    }

                    // å¦‚æœæ­¤ç­†è²·å…¥è‚¡æ•¸å¤§æ–¼å‰©é¤˜éœ€æ‰£é™¤çš„è³£å‡ºè‚¡æ•¸
                    if (buyTx.shares > sharesSold) {
                        // è¨ˆç®—å‰©é¤˜è‚¡æ•¸
                        const remainingShares = buyTx.shares - sharesSold;
                        // ç§»é™¤èˆŠçš„ feeDiscount
                        const { feeDiscount, ...restOfBuyTx } = buyTx; 
                        // å°‡éƒ¨åˆ†æ‰£é™¤å¾Œçš„è²·å…¥ç´€éŒ„åŠ å…¥æŒè‚¡åˆ—è¡¨
                        holdings.push({
                            ...restOfBuyTx, 
                            shares: remainingShares, 
                            // æŒ‰æ¯”ä¾‹é‡æ–°è¨ˆç®—å‰©é¤˜æŒè‚¡çš„ç¸½æˆæœ¬
                            totalTxCost: remainingShares * costPerShare 
                        });
                        sharesSold = 0; // æ‰€æœ‰è³£å‡ºè‚¡æ•¸å·²æ‰£é™¤å®Œç•¢
                    } 
                    // å¦‚æœæ­¤ç­†è²·å…¥è‚¡æ•¸å°æ–¼ç­‰æ–¼å‰©é¤˜éœ€æ‰£é™¤çš„è³£å‡ºè‚¡æ•¸
                    else {
                        // æ­¤ç­†è²·å…¥è¢«å®Œå…¨è³£å‡ºï¼Œå¾å‰©é¤˜è³£å‡ºè‚¡æ•¸ä¸­æ‰£é™¤
                        sharesSold -= buyTx.shares; 
                    }
                }
                return holdings; // è¿”å›è¨ˆç®—å¾Œçš„æŒè‚¡åˆ—è¡¨
            }

            /**
             * æ ¸å¿ƒæ¸²æŸ“å‡½å¼ï¼Œæ ¹æ“šç›®å‰é¸ä¸­çš„å¸³æˆ¶å’Œè‚¡ç¥¨ç¯©é¸æ¢ä»¶ï¼Œæ›´æ–°ç•«é¢å…§å®¹ã€‚
             */
            function render() {
                // ç²å–ç›®å‰å¸³æˆ¶çš„äº¤æ˜“ç´€éŒ„
                const currentAccountData = appData.accounts[appData.currentAccount];
                const currentTransactions = currentAccountData ? currentAccountData.transactions : []; 

                if (!Array.isArray(currentTransactions)) return; // é˜²éŒ¯
                
                const selectedValue = stockFilter.value; // ç²å–è‚¡ç¥¨ä¸‹æ‹‰é¸å–®çš„å€¼
                const tableHead = transactionList.parentElement.querySelector('thead'); // è¡¨æ ¼é ­éƒ¨å…ƒç´ 
                transactionList.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å…§å®¹

                // --- æƒ…æ³ä¸€ï¼šé¡¯ç¤ºã€Œå…¨éƒ¨åº«å­˜ã€ç¸½è¦½ ---
                if (selectedValue === '__ALL__') {
                    paginationControls.classList.add('hidden'); // éš±è—åˆ†é 
                    viewTitle.textContent = 'æŠ•è³‡çµ„åˆç¸½è¦½'; // è¨­å®šä¸»æ¨™é¡Œ
                    historyTitle.textContent = 'åº«å­˜æ˜ç´°'; // è¨­å®šè¡¨æ ¼å€å¡Šæ¨™é¡Œ
                    avgCostBox.classList.remove('hidden'); // é¡¯ç¤º "å¹³å‡æˆæœ¬/ç¸½æˆæœ¬(ä¸å«è²»ç”¨)" å€å¡Š
                    totalCostBox.classList.remove('hidden'); // é¡¯ç¤º "ç¸½æˆæœ¬(å«è²»ç”¨)" å€å¡Š
                    calculatePortfolioSummary(currentTransactions); // è¨ˆç®—ä¸¦é¡¯ç¤ºç¸½è¦½æ•¸æ“š
                    
                    // è¨­å®šè¡¨æ ¼æ¨™é ­
                    // *** ä¿®æ”¹ ***: æ–°å¢ "å¹³å‡æˆæœ¬(ä¸å«è²»ç”¨)" æ¬„ä½
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æ›´æ–°ç‹€æ…‹</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">è‚¡ç¥¨ä»£è™Ÿ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">è‚¡ç¥¨åç¨±</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æŒæœ‰è‚¡æ•¸</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">å‡åƒ¹</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">ç¸½æˆæœ¬</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">å‡åƒ¹(å«è²»ç”¨)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">ç¸½æˆæœ¬(å«è²»ç”¨)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æ›´æ–°æ—¥æœŸ</th>
                        </tr>
                    `;
                    
                    // ç²å–æ‰€æœ‰ä¸é‡è¤‡çš„è‚¡ç¥¨ä»£è™Ÿ
                    const symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                    // è¨ˆç®—æ¯æ”¯è‚¡ç¥¨çš„æŒè‚¡æ˜ç´°
                    let portfolioDetails = symbols.map(symbol => {
                        const holdings = getCurrentHoldings(symbol, currentTransactions); // è¨ˆç®—æŒè‚¡éƒ¨ä½
                        const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); // è¨ˆç®—ç¸½è‚¡æ•¸
                        if (totalShares <= 0) return null; // å¦‚æœè‚¡æ•¸ç‚º 0ï¼Œå‰‡ä¸é¡¯ç¤º

                        // è¨ˆç®—ç¸½æˆæœ¬ (å«è²»ç”¨)
                        const totalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                        // è¨ˆç®—å¹³å‡æˆæœ¬ (å«è²»ç”¨)
                        const averageCost = totalShares > 0 ? totalCost / totalShares : 0;
                        // è¨ˆç®—ç¸½æˆæœ¬ (ä¸å«è²»ç”¨)
                        const baseTotalCost = holdings.reduce((sum, tx) => sum + (tx.shares * (tx.price || 0)), 0);
                        // *** æ–°å¢ ***: è¨ˆç®—å¹³å‡æˆæœ¬ (ä¸å«è²»ç”¨)
                        const averageBaseCost = totalShares > 0 ? baseTotalCost / totalShares : 0;

                        // æ‰¾å‡ºè©²è‚¡ç¥¨æœ€å¾Œæ›´æ–°æ—¥æœŸå’Œåç¨±
                        const symbolTransactions = currentTransactions.filter(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        const lastUpdateDate = symbolTransactions.reduce((max, tx) => (tx.date > max ? tx.date : max), '0000-00-00');
                        const name = (symbolTransactions.find(tx => tx.name) || {}).name || '';
                        
                        // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰äº¤æ˜“éƒ½å·²æ¨™è¨˜ç‚º reviewed
                        const isFullyReviewed = symbolTransactions.length > 0 && symbolTransactions.every(tx => tx.reviewed === true);

                        // è¿”å›åŒ…å«æ‰€æœ‰è¨ˆç®—çµæœçš„ç‰©ä»¶
                        return { symbol, name, totalShares, baseTotalCost, averageBaseCost, averageCost, totalCost, lastUpdateDate, isFullyReviewed };
                    }).filter(Boolean); // éæ¿¾æ‰è‚¡æ•¸ç‚º 0 çš„çµæœ

                    // æŒ‰æœ€å¾Œæ›´æ–°æ—¥æœŸé™åºæ’åˆ—
                    portfolioDetails.sort((a, b) => new Date(b.lastUpdateDate) - new Date(a.lastUpdateDate));

                    // --- æ¸²æŸ“è¡¨æ ¼å…§å®¹ ---
                    if (portfolioDetails.length > 0) {
                        portfolioDetails.forEach(detail => {
                            const row = document.createElement('tr'); // å‰µå»ºè¡¨æ ¼è¡Œ
                            row.className = 'hover:bg-stone-700/50'; // æ·»åŠ æ»‘é¼ æ‡¸åœæ•ˆæœ

                            // æ ¹æ“š reviewed ç‹€æ…‹è¨­å®šæŒ‰éˆ•æ¨£å¼
                            const statusText = detail.isFullyReviewed ? 'æ˜¯' : 'å¦';
                            const statusColor = detail.isFullyReviewed ? 'bg-emerald-800 text-emerald-100 hover:bg-emerald-700' : 'bg-stone-600 text-stone-200 hover:bg-stone-500';
                            const statusButtonHTML = `
                                <button class="px-3 py-1 text-xs font-semibold rounded-full transition-colors duration-200 ${statusColor}" data-symbol="${detail.symbol}" data-action="toggle-status-all">
                                    ${statusText}
                                </button>
                            `;
                            // å¡«å……è¡¨æ ¼å–®å…ƒæ ¼å…§å®¹
                            // *** ä¿®æ”¹ ***: æ–°å¢ "å¹³å‡æˆæœ¬(ä¸å«è²»ç”¨)" æ¬„ä½
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${statusButtonHTML}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-100">${detail.symbol}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalShares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                                
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.averageBaseCost.toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.baseTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.averageCost.toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalCost.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.lastUpdateDate}</td>
                                
                            `;
                            transactionList.appendChild(row); // å°‡è¡Œæ·»åŠ åˆ°è¡¨æ ¼ä¸­
                        });
                    }
                    // --- è™•ç†ç„¡è³‡æ–™æƒ…æ³ ---
                    noDataMsg.textContent = 'å°šç„¡ä»»ä½•åº«å­˜';
                    // å¦‚æœæ²’æœ‰åº«å­˜æ˜ç´°ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯ï¼Œå¦å‰‡éš±è—
                    noDataMsg.classList.toggle('hidden', portfolioDetails.length > 0);
                
                // --- æƒ…æ³äºŒï¼šé¡¯ç¤ºã€Œå€‹åˆ¥è‚¡ç¥¨ã€çš„äº¤æ˜“æ­·å² ---
                } else {
                    // ç²å–é¸ä¸­è‚¡ç¥¨çš„åç¨±
                    const stockName = (currentTransactions.find(tx => tx.symbol === selectedValue) || {}).name || '';
                    viewTitle.textContent = `å€‹åˆ¥æª¢è¦–: ${selectedValue}`; // è¨­å®šä¸»æ¨™é¡Œ
                    historyTitle.textContent = `äº¤æ˜“æ­·å²ç´€éŒ„: ${selectedValue} ${stockName}`; // è¨­å®šè¡¨æ ¼å€å¡Šæ¨™é¡Œ
                    avgCostBox.classList.remove('hidden'); // é¡¯ç¤ºå¹³å‡æˆæœ¬å€å¡Š
                    totalCostBox.classList.remove('hidden'); // é¡¯ç¤ºç¸½æˆæœ¬å€å¡Š
                    calculateSummary(selectedValue, currentTransactions); // è¨ˆç®—ä¸¦é¡¯ç¤ºå€‹è‚¡çš„æˆæœ¬æ•¸æ“š
                    
                    // è¨­å®šè¡¨æ ¼æ¨™é ­ (å€‹è‚¡æª¢è¦–)
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æ—¥æœŸ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">é¡å‹</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">è‚¡æ•¸</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">åƒ¹æ ¼</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">è²»ç”¨</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">æ“ä½œ</span></th>
                        </tr>
                    `;
                    // ç¯©é¸å‡ºé¸ä¸­è‚¡ç¥¨çš„äº¤æ˜“ç´€éŒ„
                    const displayTransactions = currentTransactions.filter(tx => tx.symbol === selectedValue);
                    // æŒ‰æ—¥æœŸé™åºæ’åˆ—
                    const sortedTransactions = [...displayTransactions].sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
                    
                    // --- åˆ†é é‚è¼¯ ---
                    const itemsPerPage = 10; // æ¯é é¡¯ç¤ºæ•¸é‡
                    const totalPages = Math.ceil(sortedTransactions.length / itemsPerPage) || 1; // è¨ˆç®—ç¸½é æ•¸
                    if (currentPage > totalPages) currentPage = totalPages; // é˜²æ­¢é ç¢¼è¶…å‡ºç¯„åœ
                    // ç²å–ç›®å‰é é¢æ‡‰é¡¯ç¤ºçš„äº¤æ˜“ç´€éŒ„
                    const paginatedTransactions = sortedTransactions.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                    // æ ¹æ“šæ˜¯å¦éœ€è¦åˆ†é ä¾†é¡¯ç¤º/éš±è—åˆ†é æ§åˆ¶é …
                    paginationControls.classList.toggle('hidden', sortedTransactions.length <= itemsPerPage);
                    // æ›´æ–°é ç¢¼è³‡è¨Š
                    pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
                    // ç¦ç”¨ä¸Šä¸€é /ä¸‹ä¸€é æŒ‰éˆ•ï¼ˆå¦‚æœåœ¨ç¬¬ä¸€é /æœ€å¾Œä¸€é ï¼‰
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages;
                    
                    // --- æ¸²æŸ“è¡¨æ ¼å…§å®¹ ---
                    paginatedTransactions.forEach(tx => {
                        const row = document.createElement('tr'); // å‰µå»ºè¡¨æ ¼è¡Œ
                        row.className = 'hover:bg-stone-700/50 transition-colors duration-200'; // æ·»åŠ æ¨£å¼

                        // æ ¹æ“šäº¤æ˜“é¡å‹é¡¯ç¤ºä¸åŒæ¨£å¼çš„æ¨™ç±¤
                        const typeCell = tx.type === 'BUY' 
                            ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-sky-900 text-sky-200">è²·å…¥</span>`
                            : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-rose-900 text-rose-200">è³£å‡º</span>`;

                        // å¡«å……è¡¨æ ¼å–®å…ƒæ ¼å…§å®¹
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${typeCell}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.shares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${(tx.price || 0).toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${(tx.fee || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                <button class="text-stone-400 hover:text-stone-200" data-id="${tx.id}" data-action="edit">ç·¨è¼¯</button>
                                <button class="text-rose-400 hover:text-rose-500" data-id="${tx.id}" data-action="delete">åˆªé™¤</button>
                            </td>
                        `;
                        transactionList.appendChild(row); // æ·»åŠ è¡Œåˆ°è¡¨æ ¼
                    });
                     // --- è™•ç†ç„¡è³‡æ–™æƒ…æ³ ---
                    noDataMsg.textContent = 'å°šç„¡äº¤æ˜“ç´€éŒ„';
                    // å¦‚æœæ²’æœ‰äº¤æ˜“ç´€éŒ„ï¼Œé¡¯ç¤ºæç¤ºè¨Šæ¯ï¼Œå¦å‰‡éš±è—
                    noDataMsg.classList.toggle('hidden', displayTransactions.length > 0);
                }
            }

            /**
             * è¨ˆç®—å–®ä¸€è‚¡ç¥¨çš„ç¸½æŒæœ‰è‚¡æ•¸ã€å¹³å‡æˆæœ¬(å«è²»ç”¨)ã€ç¸½æˆæœ¬(å«è²»ç”¨)ï¼Œä¸¦æ›´æ–°é¡¯ç¤ºã€‚
             * @param {string} symbol - è‚¡ç¥¨ä»£è™Ÿã€‚
             * @param {Array} transactions - åŒ…å«è©²è‚¡ç¥¨äº¤æ˜“ç´€éŒ„çš„é™£åˆ—ã€‚
             */
            function calculateSummary(symbol, transactions) {
                // è¨­å®šé¡¯ç¤ºå€å¡Šçš„æ¨™é¡Œ
                sharesTitle.textContent = 'æŒæœ‰è‚¡æ•¸';
                avgCostTitle.textContent = 'å¹³å‡æˆæœ¬(å«è²»ç”¨)';
                totalCostTitle.textContent = 'ç¸½æˆæœ¬(å«è²»ç”¨)';

                if (!Array.isArray(transactions)) {
                    // å¦‚æœæ²’æœ‰äº¤æ˜“ç´€éŒ„ï¼Œé¡¯ç¤º 0
                    totalSharesEl.textContent = '0';
                    avgCostEl.textContent = '0';
                    totalCostEl.textContent = '0';
                    return;
                }
                // è¨ˆç®—ç›®å‰æŒè‚¡
                const holdings = getCurrentHoldings(symbol, transactions);
                // è¨ˆç®—ç¸½è‚¡æ•¸
                const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                // è¨ˆç®—ç¸½æˆæœ¬ (å«è²»ç”¨)
                const totalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                // è¨ˆç®—å¹³å‡æˆæœ¬ (å«è²»ç”¨)
                const averageCost = totalShares > 0 ? totalCost / totalShares : 0;
                
                // æ›´æ–°é¡¯ç¤ºå…ƒç´ çš„å…§å®¹ (æ ¼å¼åŒ–æ•¸å­—)
                totalSharesEl.textContent = totalShares.toLocaleString('en-US', {maximumFractionDigits: 8});
                avgCostEl.textContent = averageCost.toLocaleString('en-US', {maximumFractionDigits: 4});
                totalCostEl.textContent = totalCost.toLocaleString('en-US', {maximumFractionDigits: 2});
            }
            
            /**
             * è¨ˆç®—æŠ•è³‡çµ„åˆç¸½è¦½æ•¸æ“šï¼šç¸½åº«å­˜æª”æ•¸ã€ç¸½æˆæœ¬(ä¸å«è²»ç”¨)ã€ç¸½æˆæœ¬(å«è²»ç”¨)ï¼Œä¸¦æ›´æ–°é¡¯ç¤ºã€‚
             * @param {Array} transactions - ç›®å‰å¸³æˆ¶çš„æ‰€æœ‰äº¤æ˜“ç´€éŒ„ã€‚
             */
            function calculatePortfolioSummary(transactions) {
                 // è¨­å®šé¡¯ç¤ºå€å¡Šçš„æ¨™é¡Œ
                sharesTitle.textContent = 'å…¨éƒ¨æª”æ•¸';
                avgCostTitle.textContent = 'ç¸½æˆæœ¬(ä¸å«è²»ç”¨)'; // *** ä¿®æ”¹ ***
                totalCostTitle.textContent = 'ç¸½æˆæœ¬(å«è²»ç”¨)';

                if (!Array.isArray(transactions)) {
                    // å¦‚æœæ²’æœ‰äº¤æ˜“ç´€éŒ„ï¼Œé¡¯ç¤º 0
                    totalSharesEl.textContent = '0';
                    avgCostEl.textContent = '0'; // *** ä¿®æ”¹ ***
                    totalCostEl.textContent = '0';
                    return;
                }
                // ç²å–æ‰€æœ‰ä¸é‡è¤‡çš„è‚¡ç¥¨ä»£è™Ÿ
                const symbols = [...new Set(transactions.map(tx => tx.symbol))];
                let portfolioStockCount = 0; // åº«å­˜æª”æ•¸è¨ˆæ•¸å™¨
                let portfolioTotalCost = 0; // ç¸½æˆæœ¬(å«è²»ç”¨)ç´¯åŠ å™¨
                let portfolioBaseTotalCost = 0; // *** æ–°å¢ ***: ç¸½æˆæœ¬(ä¸å«è²»ç”¨)ç´¯åŠ å™¨
                
                // éæ­·æ¯æ”¯è‚¡ç¥¨
                symbols.forEach(symbol => {
                    const holdings = getCurrentHoldings(symbol, transactions); // è¨ˆç®—æŒè‚¡
                    const symbolTotalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); // è¨ˆç®—è©²è‚¡ç¥¨ç¸½è‚¡æ•¸
                    // å¦‚æœæŒæœ‰è‚¡æ•¸å¤§æ–¼ 0
                    if (symbolTotalShares > 0) {
                        portfolioStockCount++; // åº«å­˜æª”æ•¸ +1
                        // ç´¯åŠ ç¸½æˆæœ¬ (å«è²»ç”¨)
                        const symbolTotalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                        portfolioTotalCost += symbolTotalCost;
                        // *** æ–°å¢ ***: ç´¯åŠ ç¸½æˆæœ¬ (ä¸å«è²»ç”¨)
                        const symbolBaseTotalCost = holdings.reduce((sum, tx) => sum + (tx.shares * (tx.price || 0)), 0);
                        portfolioBaseTotalCost += symbolBaseTotalCost;
                    }
                });
                
                // æ›´æ–°é¡¯ç¤ºå…ƒç´ çš„å…§å®¹ (æ ¼å¼åŒ–æ•¸å­—)
                totalSharesEl.textContent = new Intl.NumberFormat().format(portfolioStockCount);
                avgCostEl.textContent = portfolioBaseTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2}); // *** ä¿®æ”¹ ***
                totalCostEl.textContent = portfolioTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2});
            }

            // --- äº‹ä»¶è™•ç†å‡½å¼ ---

            /**
             * è™•ç†æ–°å¢äº¤æ˜“ (è²·å…¥æˆ–è³£å‡º) çš„é‚è¼¯ã€‚
             * @param {Event} e - äº‹ä»¶ç‰©ä»¶ã€‚
             * @param {string} transactionType - 'BUY' æˆ– 'SELL'ã€‚
             */
            function handleAddTransaction(e, transactionType) {
                e.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­æäº¤è¡Œç‚º
                // å¾è¡¨å–®ç²å–è¼¸å…¥å€¼
                const symbol = document.getElementById('tx-symbol').value.trim().toUpperCase();
                const name = stockNameMap[symbol] || ''; // å˜—è©¦å¾ map ç²å–åç¨±
                const date = document.getElementById('tx-date').value;
                const shares = parseFloat(document.getElementById('tx-shares').value);
                const price = parseFloat(document.getElementById('tx-price').value); 
                // *** ä¿®æ”¹ ***: å¾ç›®å‰å¸³æˆ¶è³‡æ–™ç²å–æ‰‹çºŒè²»æŠ˜æ•¸å’Œå¸‚å ´é¡å‹
                const currentAccount = appData.accounts[appData.currentAccount];
                const feeDiscount = currentAccount?.feeDiscount || 0.28; 
                const marketType = currentAccount?.marketType || 'TW';
                
                // --- è¼¸å…¥é©—è­‰ ---
                if (!symbol) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚'); return; }
                if (isNaN(shares) || shares <= 0) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹æª¢æŸ¥è‚¡æ•¸æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ­£æ•¸ã€‚'); return; }
                if (isNaN(price) || price < 0) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹æª¢æŸ¥åƒ¹æ ¼(å‡åƒ¹)æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ•¸å­—ã€‚'); return; }

                // ç²å–ç›®å‰å¸³æˆ¶çš„äº¤æ˜“ç´€éŒ„é™£åˆ—
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 
                
                // --- è³£å‡ºå‰æª¢æŸ¥åº«å­˜æ˜¯å¦è¶³å¤  ---
                if (transactionType === 'SELL') {
                    const holdings = getCurrentHoldings(symbol, currentTransactions); // è¨ˆç®—ç›®å‰æŒè‚¡
                    const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); // è¨ˆç®—ç¸½è‚¡æ•¸
                    if (shares > currentShares) {
                        // å¦‚æœè¦è³£å‡ºçš„è‚¡æ•¸å¤§æ–¼æŒæœ‰è‚¡æ•¸ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦è¿”å›
                        showModal(messageModal, 'è³£å‡ºå¤±æ•—', `æ‚¨åªæœ‰ ${currentShares.toLocaleString('en-US', {maximumFractionDigits: 8})} è‚¡ï¼Œç„¡æ³•è³£å‡º ${shares} è‚¡ã€‚`);
                        return;
                    }
                }

                // --- è¨ˆç®—è²»ç”¨ ---
                const amount = price * shares; // äº¤æ˜“é‡‘é¡
                let fee = 0; // åˆå§‹åŒ–è²»ç”¨
                let totalTxCost = 0; // åˆå§‹åŒ–è²·å…¥ç¸½æˆæœ¬

                // *** ä¿®æ”¹ ***: æ ¹æ“šå¸‚å ´é¡å‹è¨ˆç®—è²»ç”¨
                if (marketType === 'TW') {
                    fee = amount * FEE_RATE * feeDiscount; // å°è‚¡æ‰‹çºŒè²»
                    if (transactionType === 'BUY') {
                        totalTxCost = amount + fee; // è²·å…¥ç¸½æˆæœ¬ = é‡‘é¡ + æ‰‹çºŒè²»
                    } else { // 'SELL'
                        fee += (amount * TAX_RATE); // è³£å‡ºç¸½è²»ç”¨ = æ‰‹çºŒè²» + è­‰äº¤ç¨…
                    }
                } else { // 'US'
                    fee = amount * feeDiscount; // ç¾è‚¡æ‰‹çºŒè²» (å‡è¨­ feeDiscount ç‚ºè²»ç‡)
                    if (transactionType === 'BUY') {
                        totalTxCost = amount + fee;
                    } else { // 'SELL'
                        // ç¾è‚¡è³£å‡ºç„¡äº¤æ˜“ç¨… (æ ¹æ“šä½¿ç”¨è€…è¦æ±‚)
                    }
                }
                
                // --- å»ºç«‹æ–°çš„äº¤æ˜“ç´€éŒ„ç‰©ä»¶ ---
                const newTransaction = { 
                    id: Date.now(), // ä½¿ç”¨æ™‚é–“æˆ³ä½œç‚ºå”¯ä¸€ ID
                    type: transactionType, 
                    symbol, 
                    name, 
                    date, 
                    shares, 
                    price, 
                    fee: Math.round(fee * 100) / 100, // è²»ç”¨å››æ¨äº”å…¥åˆ°å°æ•¸é»ç¬¬äºŒä½
                    reviewed: false // æ–°äº¤æ˜“é è¨­ç‚ºæœªæª¢è¦–
                };

                // å¦‚æœæ˜¯è²·å…¥äº¤æ˜“ï¼Œæ·»åŠ  totalTxCost å±¬æ€§
                if (transactionType === 'BUY') {
                    newTransaction.totalTxCost = totalTxCost; 
                }

                // --- æ›´æ–°è³‡æ–™ä¸¦å„²å­˜ ---
                currentTransactions.push(newTransaction); // å°‡æ–°äº¤æ˜“æ·»åŠ åˆ°é™£åˆ—
                saveDataToLocalStorage(); // ä¿å­˜åˆ° localStorage
                
                // --- é‡è¨­è¡¨å–®ä¸¦æ›´æ–°ä»‹é¢ ---
                addTransactionForm.reset(); // æ¸…ç©ºè¡¨å–®
                setDateToToday(); // å°‡æ—¥æœŸè¨­å›ä»Šå¤©
                
                // --- è³£å‡ºå¾Œæª¢æŸ¥æ˜¯å¦éœ€è¦æç¤ºæ¸…é™¤æ­·å²ç´€éŒ„ ---
                if (transactionType === 'SELL') {
                    const updatedHoldings = getCurrentHoldings(symbol, currentTransactions); // é‡æ–°è¨ˆç®—æŒè‚¡
                    const remainingShares = updatedHoldings.reduce((sum, tx) => sum + tx.shares, 0); // è¨ˆç®—å‰©é¤˜è‚¡æ•¸
                    if (remainingShares === 0) {
                        // å¦‚æœæ­¸é›¶ï¼Œå½ˆå‡ºç¢ºèªæ¸…é™¤æ­·å²ç´€éŒ„çš„ Modal
                        symbolToClear = symbol;
                        clearHistoryMessage.textContent = `è‚¡ç¥¨ ${symbol} çš„åº«å­˜å·²ç‚ºé›¶ï¼Œæ˜¯å¦è¦æ¸…é™¤å…¶æ‰€æœ‰ç›¸é—œäº¤æ˜“æ­·å²ç´€éŒ„ï¼Ÿ`;
                        showModal(clearHistoryModal);
                    } else {
                        // å¦‚æœæœªæ­¸é›¶ï¼Œæ›´æ–°ä¸‹æ‹‰é¸å–®ä¸¦é‡æ–°æ¸²æŸ“
                        updateStockFilterOptions();
                        stockFilter.value = symbol; // è‡ªå‹•é¸ä¸­å‰›äº¤æ˜“çš„è‚¡ç¥¨
                        currentPage = 1; // è·³å›ç¬¬ä¸€é 
                        render();
                    }
                } 
                // --- è²·å…¥å¾Œæ›´æ–°ä»‹é¢ ---
                else {
                    updateStockFilterOptions();
                    stockFilter.value = symbol; // è‡ªå‹•é¸ä¸­å‰›äº¤æ˜“çš„è‚¡ç¥¨
                    currentPage = 1; // è·³å›ç¬¬ä¸€é 
                    render();
                }
            }

            // --- ç¶å®šäº‹ä»¶ç›£è½å™¨ ---

            // ç¶å®šè²·å…¥å’Œè³£å‡ºæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            addBuyBtn.addEventListener('click', (e) => handleAddTransaction(e, 'BUY'));
            addSellBtn.addEventListener('click', (e) => handleAddTransaction(e, 'SELL'));

            // ä½¿ç”¨äº‹ä»¶ä»£ç†è™•ç†äº¤æ˜“åˆ—è¡¨ä¸­çš„æŒ‰éˆ•é»æ“Š (ç·¨è¼¯ã€åˆªé™¤ã€åˆ‡æ›ç‹€æ…‹)
            transactionList.addEventListener('click', (e) => {
                const target = e.target.closest('button'); // ç¢ºä¿é»æ“ŠæŒ‰éˆ•å…§éƒ¨ä¹Ÿèƒ½è§¸ç™¼
                // å¦‚æœé»æ“Šçš„ä¸æ˜¯æŒ‰éˆ•æˆ–æŒ‰éˆ•æ²’æœ‰ data-action å±¬æ€§ï¼Œå‰‡å¿½ç•¥
                if (!target || !target.dataset.action) return;

                const action = target.dataset.action; // ç²å–æŒ‰éˆ•çš„å‹•ä½œé¡å‹
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 

                // --- è™•ç†ç·¨è¼¯å’Œåˆªé™¤ ---
                if (action === 'delete' || action === 'edit') {
                    const id = parseInt(target.dataset.id, 10); // ç²å–äº¤æ˜“ ID
                    // --- åˆªé™¤ ---
                    if (action === 'delete') {
                        // éæ¿¾æ‰è¦åˆªé™¤çš„äº¤æ˜“ç´€éŒ„ï¼Œæ›´æ–°é™£åˆ—
                        currentAccountData.transactions = currentTransactions.filter(tx => tx.id !== id); 
                        saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                        updateStockFilterOptions(); // æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–® (å¯èƒ½æŸæ”¯è‚¡ç¥¨æ²’ç´€éŒ„äº†)
                        render(); // é‡æ–°æ¸²æŸ“ç•«é¢
                    } 
                    // --- ç·¨è¼¯ ---
                    else if (action === 'edit') {
                        // æ‰¾åˆ°è¦ç·¨è¼¯çš„äº¤æ˜“ç´€éŒ„
                        const tx = currentTransactions.find(t => t.id === id);
                        if (tx) {
                            // å°‡äº¤æ˜“è³‡æ–™å¡«å…¥ç·¨è¼¯ Modal çš„è¡¨å–®ä¸­
                            document.getElementById('edit-transaction-id').value = tx.id;
                            document.getElementById('edit-symbol').value = tx.symbol;
                            document.getElementById('edit-date').value = tx.date;
                            document.getElementById('edit-shares').value = tx.shares;
                            document.getElementById('edit-price').value = tx.price || 0; 
                            editModalTitle.textContent = `ç·¨è¼¯ ${tx.symbol} (${tx.type === 'BUY' ? 'è²·å…¥' : 'è³£å‡º'})`; // è¨­å®š Modal æ¨™é¡Œ
                            // æ‰‹å‹•è§¸ç™¼ input äº‹ä»¶ï¼Œä»¥é¡¯ç¤ºè‚¡ç¥¨åç¨± (å¦‚æœæœ‰çš„è©±)
                            document.getElementById('edit-symbol').dispatchEvent(new Event('input')); 
                            showModal(editTransactionModal); // é¡¯ç¤ºç·¨è¼¯ Modal
                        }
                    }
                } 
                // --- è™•ç†åˆ‡æ›å…¨éƒ¨ reviewed ç‹€æ…‹ (ç¸½è¦½ç•«é¢) ---
                else if (action === 'toggle-status-all') {
                    const symbol = target.dataset.symbol; // ç²å–è‚¡ç¥¨ä»£è™Ÿ
                    // ç¯©é¸å‡ºè©²è‚¡ç¥¨çš„æ‰€æœ‰äº¤æ˜“ç´€éŒ„
                    const transactionsForSymbol = currentTransactions.filter(tx => tx.symbol === symbol); 
                    if (transactionsForSymbol.length > 0) {
                        // åˆ¤æ–·ç›®å‰æ˜¯å¦å…¨éƒ¨å·²æª¢è¦–
                        const isCurrentlyFullyReviewed = transactionsForSymbol.every(tx => tx.reviewed === true);
                        // è¨­å®šæ–°çš„ç‹€æ…‹ (åè½‰ç›®å‰ç‹€æ…‹)
                        const newStatus = !isCurrentlyFullyReviewed; 
                        
                        // æ›´æ–°è©²è‚¡ç¥¨æ‰€æœ‰äº¤æ˜“ç´€éŒ„çš„ reviewed ç‹€æ…‹
                        transactionsForSymbol.forEach(tx => {
                            // éœ€è¦åœ¨åŸå§‹é™£åˆ—ä¸­æ‰¾åˆ°ä¸¦ä¿®æ”¹
                             const originalTx = currentTransactions.find(t => t.id === tx.id);
                             if (originalTx) {
                                 originalTx.reviewed = newStatus;
                             }
                        });
                        
                        saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                        render(); // é‡æ–°æ¸²æŸ“ç•«é¢ (æ›´æ–°æŒ‰éˆ•ç‹€æ…‹)
                    }
                }
            });

            // ç›£è½å¸³æˆ¶ä¸‹æ‹‰é¸å–®çš„è®Šæ›´äº‹ä»¶
            accountFilter.addEventListener('change', (e) => {
                appData.currentAccount = e.target.value; // æ›´æ–°ç›®å‰é¸ä¸­çš„å¸³æˆ¶
                saveDataToLocalStorage(); // ä¿å­˜ (ä¸»è¦ç‚ºäº†è¨˜ä½é¸æ“‡)
                stockSearch.value = ''; // æ¸…ç©ºè‚¡ç¥¨æœå°‹æ¡†
                updateAccountFeeDiscountDisplay(); // æ›´æ–°æ‰‹çºŒè²»æŠ˜æ•¸é¡¯ç¤º
                updateAccountMarketTypeDisplay(); // *** æ–°å¢ ***: æ›´æ–°å¸‚å ´é¡å‹é¡¯ç¤º
                updateStockFilterOptions(); // æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–®
                currentPage = 1; // é‡è¨­é ç¢¼
                render(); // é‡æ–°æ¸²æŸ“
            });

            // ç›£è½ä¸»ç•«é¢å¸³æˆ¶æ‰‹çºŒè²»æŠ˜æ•¸è¼¸å…¥æ¡†çš„è®Šæ›´äº‹ä»¶
            accountFeeDiscountInput.addEventListener('change', (e) => {
                 const newDiscount = parseFloat(e.target.value); // ç²å–æ–°å€¼
                 // é©—è­‰è¼¸å…¥æ˜¯å¦æœ‰æ•ˆ
                 if (!isNaN(newDiscount) && newDiscount >= 0 && appData.accounts[appData.currentAccount]) {
                     // æ›´æ–° appData ä¸­çš„å€¼
                     appData.accounts[appData.currentAccount].feeDiscount = newDiscount;
                     saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                     // é‡æ–°è¨ˆç®—ä¸¦æ¸²æŸ“ï¼Œåœ¨è®Šæ›´æŠ˜æ•¸å¾Œç«‹å³çœ‹åˆ°æˆæœ¬è®ŠåŒ–
                     render(); 
                 } else {
                      // å¦‚æœè¼¸å…¥ç„¡æ•ˆï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦æ¢å¾©åŸå€¼
                      showModal(messageModal, 'éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡ã€‚');
                      updateAccountFeeDiscountDisplay(); // æ¢å¾©è¼¸å…¥æ¡†é¡¯ç¤ºçš„å€¼
                 }
            });

            // *** æ–°å¢ ***: ç›£è½ä¸»ç•«é¢å¸‚å ´é¡å‹ä¸‹æ‹‰é¸å–®çš„è®Šæ›´äº‹ä»¶
            accountMarketTypeInput.addEventListener('change', (e) => {
                 const newMarketType = e.target.value;
                 if (appData.accounts[appData.currentAccount]) {
                     appData.accounts[appData.currentAccount].marketType = newMarketType;
                     saveDataToLocalStorage();
                     // é‡æ–°è¨ˆç®—ä¸¦æ¸²æŸ“ï¼Œåœ¨è®Šæ›´å¸‚å ´å¾Œç«‹å³çœ‹åˆ°æˆæœ¬è®ŠåŒ–
                     render(); 
                 }
            });
            
            // ç›£è½è‚¡ç¥¨ä¸‹æ‹‰é¸å–®çš„è®ŠGæ›´äº‹ä»¶
            stockFilter.addEventListener('change', () => {
                currentPage = 1; // é‡è¨­é ç¢¼
                render(); // é‡æ–°æ¸²æŸ“
            });
            
            // ç›£è½è‚¡ç¥¨æœå°‹æ¡†çš„è¼¸å…¥äº‹ä»¶
            stockSearch.addEventListener('input', () => {
                updateStockFilterOptions(); // å³æ™‚æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–®
                render(); // é‡æ–°æ¸²æŸ“ (å¦‚æœéœ€è¦æ ¹æ“šæœå°‹çµæœæ›´æ–°åˆ—è¡¨)
            });

            // ç›£è½åˆ†é æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--; // é ç¢¼æ¸› 1
                    render(); // é‡æ–°æ¸²æŸ“
                }
            });
            nextPageBtn.addEventListener('click', () => {
                 const currentAccountData = appData.accounts[appData.currentAccount];
                 const currentTransactions = currentAccountData ? currentAccountData.transactions : [];
                 const selectedStock = stockFilter.value;
                 const itemsPerPage = 10;
                 let totalItems = 0;
                 if (selectedStock === '__ALL__') {
                    // Note: åˆ†é ç›®å‰åƒ…åœ¨å€‹è‚¡æ¨¡å¼ä¸‹å•Ÿç”¨
                 } else {
                     totalItems = currentTransactions.filter(tx => tx.symbol === selectedStock).length;
                 }
                 const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;

                if (currentPage < totalPages) { // æª¢æŸ¥æ˜¯å¦å·²é”æœ€å¾Œä¸€é 
                     currentPage++; // é ç¢¼åŠ  1
                     render(); // é‡æ–°æ¸²æŸ“
                 }
            });
            
            // ç›£è½æ–°å¢å¸³æˆ¶è¡¨å–®çš„æäº¤äº‹ä»¶
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault(); // é˜»æ­¢è¡¨å–®æäº¤
                const newAccountNameInput = document.getElementById('new-account-name');
                const newAccountName = newAccountNameInput.value.trim(); // ç²å–å¸³æˆ¶åç¨±
                const newFeeDiscount = parseFloat(newAccountFeeDiscountInput.value); // ç²å–æ‰‹çºŒè²»æŠ˜æ•¸
                const newMarketType = newAccountMarketTypeInput.value; // *** æ–°å¢ ***: ç²å–å¸‚å ´é¡å‹

                // --- é©—è­‰ ---
                if (!newAccountName) {
                    showModal(messageModal, 'éŒ¯èª¤', 'å¸³æˆ¶åç¨±ä¸èƒ½ç‚ºç©ºã€‚');
                    return;
                }
                // æª¢æŸ¥å¸³æˆ¶åç¨±æ˜¯å¦å·²å­˜åœ¨
                if (appData.accounts[newAccountName]) {
                    showModal(messageModal, 'éŒ¯èª¤', 'è©²å¸³æˆ¶åç¨±å·²å­˜åœ¨ã€‚');
                    return;
                }
                 // é©—è­‰æ‰‹çºŒè²»æŠ˜æ•¸
                 if (isNaN(newFeeDiscount) || newFeeDiscount < 0) { 
                    showModal(messageModal, 'éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡ã€‚');
                    return;
                }

                // --- æ–°å¢å¸³æˆ¶ ---
                // *** ä¿®æ”¹ ***: åœ¨ appData.accounts ä¸­å‰µå»ºæ–°å¸³æˆ¶æ¢ç›® (åŒ…å«æŠ˜æ•¸å’Œå¸‚å ´é¡å‹)
                appData.accounts[newAccountName] = { transactions: [], feeDiscount: newFeeDiscount, marketType: newMarketType }; 
                appData.currentAccount = newAccountName; // å°‡æ–°å¸³æˆ¶è¨­ç‚ºç›®å‰å¸³æˆ¶
                saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´

                // --- æ¸…ç†ä¸¦é—œé–‰ Modal ---
                newAccountNameInput.value = ''; // æ¸…ç©ºåç¨±è¼¸å…¥æ¡†
                newAccountFeeDiscountInput.value = 0.28; // æ¢å¾©æŠ˜æ•¸é è¨­å€¼
                newAccountMarketTypeInput.value = 'TW'; // *** æ–°å¢ ***: æ¢å¾©å¸‚å ´é¡å‹é è¨­å€¼
                hideModal(addAccountModal); // é—œé–‰ Modal
                // --- æ›´æ–°ä»‹é¢ ---
                updateAccountFilterOptions(); // æ›´æ–°å¸³æˆ¶ä¸‹æ‹‰é¸å–® (æœƒè§¸ç™¼ updateAccountFeeDiscountDisplay)
                updateStockFilterOptions(); // æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–®
                currentPage = 1; // é‡è¨­é ç¢¼
                render(); // é‡æ–°æ¸²æŸ“
            });
            
            // ç›£è½ç·¨è¼¯å¸³æˆ¶è¡¨å–®çš„æäº¤äº‹ä»¶
            editAccountForm.addEventListener('submit', (e) => {
                e.preventDefault(); // é˜»æ­¢è¡¨å–®æäº¤
                const oldAccountName = appData.currentAccount; // ç²å–èˆŠå¸³æˆ¶åç¨±
                const newAccountName = editAccountNameInput.value.trim(); // ç²å–æ–°å¸³æˆ¶åç¨±
                const newFeeDiscount = parseFloat(editAccountFeeDiscountInput.value); // ç²å–æ–°æ‰‹çºŒè²»æŠ˜æ•¸
                const newMarketType = editAccountMarketTypeInput.value; // *** æ–°å¢ ***: ç²å–æ–°å¸‚å ´é¡å‹

                // --- é©—è­‰ ---
                if (!newAccountName) {
                    showModal(messageModal, 'éŒ¯èª¤', 'å¸³æˆ¶åç¨±ä¸èƒ½ç‚ºç©ºã€‚');
                    return;
                }
                 // é©—è­‰æ‰‹çºŒè²»æŠ˜æ•¸
                 if (isNaN(newFeeDiscount) || newFeeDiscount < 0) { 
                    showModal(messageModal, 'éŒ¯èª¤', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡ã€‚');
                    return;
                }
                // æª¢æŸ¥æ–°åç¨±æ˜¯å¦èˆ‡å…¶ä»–ç¾æœ‰å¸³æˆ¶é‡è¤‡
                if (newAccountName !== oldAccountName && appData.accounts[newAccountName]) {
                     showModal(messageModal, 'éŒ¯èª¤', 'è©²å¸³æˆ¶åç¨±å·²å­˜åœ¨ã€‚');
                    return;
                }

                // --- æ›´æ–°å¸³æˆ¶è³‡æ–™ ---
                const accountDataToModify = appData.accounts[oldAccountName]; // ç²å–è¦ä¿®æ”¹çš„å¸³æˆ¶è³‡æ–™
                // æ›´æ–°æ‰‹çºŒè²»æŠ˜æ•¸
                accountDataToModify.feeDiscount = newFeeDiscount;
                // *** æ–°å¢ ***: æ›´æ–°å¸‚å ´é¡å‹
                accountDataToModify.marketType = newMarketType;

                // å¦‚æœå¸³æˆ¶åç¨±è¢«ä¿®æ”¹
                if (newAccountName !== oldAccountName) {
                    // å°‡èˆŠå¸³æˆ¶çš„è³‡æ–™è³¦å€¼çµ¦æ–°åç¨±
                    appData.accounts[newAccountName] = accountDataToModify;
                    // åˆªé™¤èˆŠåç¨±çš„å¸³æˆ¶æ¢ç›®
                    delete appData.accounts[oldAccountName];
                    // æ›´æ–°ç›®å‰é¸ä¸­çš„å¸³æˆ¶ç‚ºæ–°åç¨±
                    appData.currentAccount = newAccountName; 
                }
                // å¦‚æœåç¨±æ²’è®Šï¼Œåªéœ€å„²å­˜æ›´æ–°å¾Œçš„æŠ˜æ•¸ (å·²åœ¨ä¸Šé¢å®Œæˆ)
                
                saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                updateAccountFilterOptions(); // æ›´æ–°å¸³æˆ¶ä¸‹æ‹‰é¸å–® (æœƒè§¸ç™¼ updateAccountFeeDiscountDisplay)
                render(); // é‡æ–°æ¸²æŸ“ (å¦‚æœåç¨±æ”¹è®Šï¼Œåˆ—è¡¨éœ€è¦æ›´æ–°)
                hideModal(editAccountModal); // é—œé–‰ Modal
            });

            // ç›£è½åˆªé™¤å¸³æˆ¶ç¢ºèªæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            deleteAccountConfirmBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount; // ç²å–è¦åˆªé™¤çš„å¸³æˆ¶åç¨±
                // æª¢æŸ¥æ˜¯å¦ç‚ºæœ€å¾Œä¸€å€‹å¸³æˆ¶
                if (Object.keys(appData.accounts).length <= 1) {
                    showModal(messageModal, 'éŒ¯èª¤', 'ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€å€‹å¸³æˆ¶ã€‚');
                    hideModal(deleteAccountModal);
                    return;
                }
                // å¾ appData ä¸­åˆªé™¤è©²å¸³æˆ¶
                delete appData.accounts[accountToDelete];
                // å°‡ç›®å‰é¸ä¸­çš„å¸³æˆ¶è¨­ç‚ºå‰©é¤˜å¸³æˆ¶ä¸­çš„ç¬¬ä¸€å€‹
                appData.currentAccount = Object.keys(appData.accounts)[0];
                saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                hideModal(deleteAccountModal); // é—œé–‰ Modal
                // æ›´æ–°ä»‹é¢
                updateAccountFilterOptions(); // æ›´æ–°å¸³æˆ¶ä¸‹æ‹‰é¸å–® (æœƒè§¸ç™¼ updateAccountFeeDiscountDisplay)
                updateStockFilterOptions(); // æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–®
                render(); // é‡æ–°æ¸²æŸ“
                showModal(messageModal, 'æˆåŠŸ', `å¸³æˆ¶ã€Œ${accountToDelete}ã€å·²æˆåŠŸåˆªé™¤ã€‚`); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            });
            
            // ç›£è½ "ç«‹å³æ¸…é™¤" æ­·å²ç´€éŒ„æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            clearHistoryNowBtn.addEventListener('click', () => {
                // ç¢ºä¿ symbolToClear æœ‰å€¼ä¸”å¸³æˆ¶å­˜åœ¨
                if (symbolToClear && appData.accounts[appData.currentAccount]) { 
                    const account = appData.accounts[appData.currentAccount]; 
                    // éæ¿¾æ‰è©²è‚¡ç¥¨çš„æ‰€æœ‰äº¤æ˜“ç´€éŒ„
                    account.transactions = account.transactions.filter(tx => tx.symbol !== symbolToClear); 
                    saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                    hideModal(clearHistoryModal); // é—œé–‰ Modal
                    updateStockFilterOptions(); // æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–®
                    render(); // é‡æ–°æ¸²æŸ“
                    showModal(messageModal, 'ç´€éŒ„å·²æ¸…é™¤', `è‚¡ç¥¨ ${symbolToClear} çš„æ‰€æœ‰äº¤æ˜“ç´€éŒ„å·²è¢«ç§»é™¤ã€‚`); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    symbolToClear = null; // æ¸…é™¤æš«å­˜çš„è‚¡ç¥¨ä»£è™Ÿ
                }
            });

            // ç›£è½ "10å¤©å¾Œæ¸…é™¤" æ­·å²ç´€éŒ„æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            clearHistoryLaterBtn.addEventListener('click', () => {
                 // ç¢ºä¿ symbolToClear æœ‰å€¼ä¸”å¸³æˆ¶å­˜åœ¨
                if (symbolToClear && appData.accounts[appData.currentAccount]) { 
                    const account = appData.accounts[appData.currentAccount]; 
                    const tenDaysInMillis = 10 * 24 * 60 * 60 * 1000; // 10 å¤©çš„æ¯«ç§’æ•¸
                    const deletionTimestamp = Date.now() + tenDaysInMillis; // è¨ˆç®—åˆªé™¤æ™‚é–“æˆ³
                    // ç¯©é¸å‡ºè©²è‚¡ç¥¨ç›®å‰æœªæ¨™è¨˜åˆªé™¤çš„äº¤æ˜“ç´€éŒ„
                    const activeTransactionsForSymbol = account.transactions 
                        .filter(tx => tx.symbol === symbolToClear && !tx.deletionTimestamp);

                    // ç‚ºé€™äº›äº¤æ˜“ç´€éŒ„æ·»åŠ  deletionTimestamp æ¨™è¨˜
                    activeTransactionsForSymbol.forEach(tx => {
                       // ç›´æ¥åœ¨åŸå§‹é™£åˆ—ä¸­æ‰¾åˆ°ä¸¦ä¿®æ”¹
                       const originalTx = account.transactions.find(t => t.id === tx.id); 
                       if(originalTx) {
                           originalTx.deletionTimestamp = deletionTimestamp;
                       }
                    });
                    saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                    hideModal(clearHistoryModal); // é—œé–‰ Modal
                    updateStockFilterOptions(); // æ›´æ–°è‚¡ç¥¨ä¸‹æ‹‰é¸å–®
                    stockFilter.value = symbolToClear; // ä¿æŒé¸ä¸­è©²è‚¡ç¥¨
                    render(); // é‡æ–°æ¸²æŸ“ (è¦–è¦ºä¸Šé€™äº›äº¤æ˜“é‚„åœ¨)
                    showModal(messageModal, 'å·²æ’ç¨‹æ¸…é™¤', `è‚¡ç¥¨ ${symbolToClear} çš„ç´€éŒ„å°‡åœ¨10å¤©å¾Œè‡ªå‹•æ¸…é™¤ã€‚`); // é¡¯ç¤ºæç¤ºè¨Šæ¯
                    symbolToClear = null; // æ¸…é™¤æš«å­˜çš„è‚¡ç¥¨ä»£è™Ÿ
                }
            });

            // ç›£è½åŒ¯å‡ºæŒ‰éˆ•çš„é»æ“Šäº‹ä»¶
            exportBtn.addEventListener('click', () => {
                // æª¢æŸ¥æ˜¯å¦æœ‰å¸³æˆ¶è³‡æ–™å¯ä¾›åŒ¯å‡º
                if (!appData.accounts || Object.keys(appData.accounts).length === 0) { 
                    showModal(messageModal, 'æç¤º', 'æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ã€‚'); 
                    return; 
                }
                // å°‡ appData è½‰æ›ç‚ºæ ¼å¼åŒ–çš„ JSON å­—ä¸²
                const dataStr = JSON.stringify(appData, null, 2);
                // å‰µå»º Blob ç‰©ä»¶
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                // å‰µå»ºä¸‹è¼‰é€£çµ
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                // è¨­å®šä¸‹è¼‰æª”å (åŒ…å«æ—¥æœŸ)
                a.download = `stock_shares_tracker_data_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); // æ·»åŠ åˆ°é é¢
                a.click(); // æ¨¡æ“¬é»æ“Šè§¸ç™¼ä¸‹è¼‰
                document.body.removeChild(a); // å¾é é¢ç§»é™¤
                URL.revokeObjectURL(url); // é‡‹æ”¾ URL ç‰©ä»¶
                showModal(messageModal, 'åŒ¯å‡ºæˆåŠŸ', 'æ‚¨çš„æ‰€æœ‰å¸³æˆ¶ç´€éŒ„å·²æˆåŠŸåŒ¯å‡ºç‚º JSON æª”æ¡ˆã€‚'); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            });

            // ç›£è½åŒ¯å…¥æŒ‰éˆ•çš„é»æ“Šäº‹ä»¶ (è§¸ç™¼éš±è—çš„ file input)
            importBtn.addEventListener('click', () => importFile.click());
            // ç›£è½æª”æ¡ˆé¸æ“‡è¼¸å…¥æ¡†çš„è®Šæ›´äº‹ä»¶
            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0]; // ç²å–é¸æ“‡çš„æª”æ¡ˆ
                if (!file) return; // å¦‚æœæ²’æœ‰é¸æ“‡æª”æ¡ˆï¼Œå‰‡è¿”å›
                const reader = new FileReader(); // å‰µå»º FileReader è®€å–æª”æ¡ˆå…§å®¹
                // è¨­å®šè®€å–å®Œæˆå¾Œçš„å›èª¿å‡½å¼
                reader.onload = (event) => {
                    try {
                        // è§£æè®€å–åˆ°çš„ JSON å­—ä¸²
                        const importedData = JSON.parse(event.target.result);
                        // æª¢æŸ¥åŒ¯å…¥çš„è³‡æ–™æ˜¯å¦åŒ…å«å¿…è¦çš„çµæ§‹
                        if (importedData.accounts && importedData.currentAccount) {
                            appData = importedData; // è¦†è“‹ç›®å‰çš„ appData
                            currentPage = 1; // é‡è¨­é ç¢¼
                            
                            // é‡æ–°åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ï¼Œé€™æœƒè™•ç†è³‡æ–™é·ç§»å’Œæ¸²æŸ“
                            initializeApp_Local(); 
                            showModal(messageModal, 'åŒ¯å…¥æˆåŠŸ', 'æ‰€æœ‰å¸³æˆ¶ç´€éŒ„å·²æˆåŠŸåŒ¯å…¥ã€‚'); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                        } else {
                            // å¦‚æœæ ¼å¼ä¸ç¬¦ï¼Œæ‹‹å‡ºéŒ¯èª¤
                            throw new Error('æª”æ¡ˆæ ¼å¼ä¸ç¬¦');
                        }
                    } catch (error) {
                         // å¦‚æœè§£æå¤±æ•—æˆ–æ ¼å¼ä¸ç¬¦ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                         showModal(messageModal, 'åŒ¯å…¥å¤±æ•—', `æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºæˆ–å·²ææ¯€ã€‚(${error.message})`);
                    }
                };
                // è¨­å®šè®€å–éŒ¯èª¤çš„å›èª¿å‡½å¼
                reader.onerror = () => {
                    showModal(messageModal, 'åŒ¯å…¥å¤±æ•—', 'è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
                };
                reader.readAsText(file); // ä»¥æ–‡å­—å½¢å¼è®€å–æª”æ¡ˆå…§å®¹
                importFile.value = ''; // æ¸…ç©º file inputï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥é¸æ“‡åŒä¸€å€‹æª”æ¡ˆ
            });
            
            // ç›£è½ç·¨è¼¯äº¤æ˜“ Modal çš„å–æ¶ˆæŒ‰éˆ•
            editTransactionCancelBtn.addEventListener('click', () => hideModal(editTransactionModal));
            // ç›£è½ç·¨è¼¯äº¤æ˜“è¡¨å–®çš„æäº¤äº‹ä»¶
            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault(); // é˜»æ­¢è¡¨å–®æäº¤
                // å¾è¡¨å–®ç²å–ä¿®æ”¹å¾Œçš„å€¼
                const id = parseInt(document.getElementById('edit-transaction-id').value, 10);
                const newSymbol = document.getElementById('edit-symbol').value.trim().toUpperCase();
                const newDate = document.getElementById('edit-date').value;
                const newShares = parseFloat(document.getElementById('edit-shares').value);
                const newPrice = parseFloat(document.getElementById('edit-price').value); 
                
                // *** ä¿®æ”¹ ***: ç²å–ç›®å‰å¸³æˆ¶è³‡æ–™ã€æŠ˜æ•¸å’Œå¸‚å ´é¡å‹
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 
                const feeDiscount = currentAccountData.feeDiscount; 
                const marketType = currentAccountData.marketType || 'TW';

                // æ‰¾åˆ°è¦ç·¨è¼¯çš„äº¤æ˜“ç´€éŒ„ç´¢å¼•
                const txIndex = currentTransactions.findIndex(t => t.id === id);
                if (txIndex === -1) return; // å¦‚æœæ²’æ‰¾åˆ°ï¼Œè¿”å›
                
                const originalSymbol = currentTransactions[txIndex].symbol; // è¨˜éŒ„åŸå§‹è‚¡ç¥¨ä»£è™Ÿ
                const transactionType = currentTransactions[txIndex].type; // ç²å–äº¤æ˜“é¡å‹ (è²·/è³£)

                // --- é©—è­‰è¼¸å…¥ ---
                if (!newSymbol) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è‚¡ç¥¨ä»£è™Ÿä¸èƒ½ç‚ºç©ºã€‚'); return; }
                if (isNaN(newShares) || newShares <= 0) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹æª¢æŸ¥è‚¡æ•¸æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ­£æ•¸ã€‚'); return; }
                if (isNaN(newPrice) || newPrice < 0) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹æª¢æŸ¥åƒ¹æ ¼æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ•¸å­—ã€‚'); return; }

                // --- æ¨¡æ“¬ä¿®æ”¹ä¸¦é‡æ–°è¨ˆç®—è²»ç”¨ ---
                // å‰µå»ºä¸€å€‹è‡¨æ™‚å‰¯æœ¬é€²è¡Œè¨ˆç®—å’Œé©—è­‰ï¼Œé¿å…ç›´æ¥ä¿®æ”¹åŸå§‹è³‡æ–™
                const tempTransactions = JSON.parse(JSON.stringify(currentTransactions));
                const tempTxToUpdate = tempTransactions.find(t => t.id === id);
                
                // æ›´æ–°è‡¨æ™‚å‰¯æœ¬ä¸­çš„äº¤æ˜“è³‡æ–™
                tempTxToUpdate.symbol = newSymbol;
                tempTxToUpdate.date = newDate;
                tempTxToUpdate.shares = newShares;
                tempTxToUpdate.price = newPrice; 

                // *** ä¿®æ”¹ ***: æ ¹æ“šå¸‚å ´é¡å‹é‡æ–°è¨ˆç®—è²»ç”¨å’Œç¸½æˆæœ¬
                const newAmount = newPrice * newShares;
                let newFee = 0;
                
                if (marketType === 'TW') {
                    newFee = newAmount * FEE_RATE * feeDiscount;
                    if (transactionType === 'SELL') {
                        newFee += (newAmount * TAX_RATE);
                        tempTxToUpdate.fee = newFee;
                        delete tempTxToUpdate.totalTxCost; // è³£å–®æ²’æœ‰ç¸½æˆæœ¬
                    } else { // 'BUY'
                        tempTxToUpdate.fee = newFee;
                        tempTxToUpdate.totalTxCost = newAmount + newFee; // è¨ˆç®—è²·å…¥ç¸½æˆæœ¬
                    }
                } else { // 'US'
                    newFee = newAmount * feeDiscount;
                    tempTxToUpdate.fee = newFee;
                    if (transactionType === 'SELL') {
                        delete tempTxToUpdate.totalTxCost; // è³£å–®æ²’æœ‰ç¸½æˆæœ¬
                    } else { // 'BUY'
                        tempTxToUpdate.totalTxCost = newAmount + newFee; // è¨ˆç®—è²·å…¥ç¸½æˆæœ¬
                    }
                }
                
                // --- é©—è­‰ä¿®æ”¹å¾Œçš„åº«å­˜æ˜¯å¦æœƒè®Šè² æ•¸ ---
                // ç²å–å—å½±éŸ¿çš„è‚¡ç¥¨ä»£è™Ÿ (åŸå§‹ä»£è™Ÿå’Œæ–°ä»£è™Ÿ)
                const affectedSymbols = new Set([originalSymbol, newSymbol]);
                for (const symbol of affectedSymbols) {
                    // ä½¿ç”¨åŒ…å«æ¨¡æ“¬ä¿®æ”¹çš„äº¤æ˜“åˆ—è¡¨ä¾†è¨ˆç®—æŒè‚¡
                    const tempHoldings = getCurrentHoldings(symbol, tempTransactions); 
                    // è¨ˆç®—æ¨¡æ“¬æŒè‚¡ç¸½æ•¸ (é€™è£¡å…¶å¯¦ä¸éœ€è¦ï¼Œä¸‹é¢ç›´æ¥æ¯”è¼ƒè²·è³£ç¸½æ•¸æ›´æº–ç¢º)
                    // const tempTotalShares = tempHoldings.reduce((sum, tx) => sum + tx.shares, 0);

                     // ç›´æ¥æ¯”è¼ƒæ¨¡æ“¬ä¿®æ”¹å¾Œçš„è²·å…¥ç¸½æ•¸å’Œè³£å‡ºç¸½æ•¸
                     const symbolSellTxs = tempTransactions.filter(tx => tx.symbol === symbol && tx.type === 'SELL');
                     const totalSold = symbolSellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                     const symbolBuyTxs = tempTransactions.filter(tx => tx.symbol === symbol && tx.type === 'BUY');
                     const totalBought = symbolBuyTxs.reduce((sum, tx) => sum + tx.shares, 0);

                    // å¦‚æœè³£å‡ºç¸½æ•¸å¤§æ–¼è²·å…¥ç¸½æ•¸ï¼Œè¡¨ç¤ºåº«å­˜æœƒè®Šè² æ•¸
                    if (totalSold > totalBought) {
                        showModal(messageModal, 'ç·¨è¼¯å¤±æ•—', `æ­¤ä¿®æ”¹æœƒå°è‡´è‚¡ç¥¨ ${symbol} çš„åº«å­˜è®Šç‚ºè² æ•¸ï¼Œè«‹é‡æ–°æª¢æŸ¥ã€‚`);
                        return; // é˜»æ­¢ä¿®æ”¹
                    }
                }

                // --- é©—è­‰é€šéï¼Œæ­£å¼æ›´æ–°åŸå§‹è³‡æ–™ ---
                const transactionToUpdate = currentTransactions[txIndex];
                transactionToUpdate.symbol = newSymbol;
                transactionToUpdate.name = stockNameMap[newSymbol] || ''; // æ›´æ–°åç¨±
                transactionToUpdate.date = newDate;
                transactionToUpdate.shares = newShares;
                transactionToUpdate.price = newPrice; 
                transactionToUpdate.fee = tempTxToUpdate.fee; // æ›´æ–°è¨ˆç®—å¾Œçš„è²»ç”¨
                // æ›´æ–°è²·å…¥ç¸½æˆæœ¬ (å¦‚æœæ˜¯è²·å–®) æˆ–ç§»é™¤ (å¦‚æœæ˜¯è³£å–®)
                if (transactionType === 'BUY') {
                    transactionToUpdate.totalTxCost = tempTxToUpdate.totalTxCost; 
                } else {
                    delete transactionToUpdate.totalTxCost; 
                }
                
                saveDataToLocalStorage(); // ä¿å­˜è®Šæ›´
                hideModal(editTransactionModal); // é—œé–‰ Modal
                
                // --- æª¢æŸ¥ä¿®æ”¹å¾Œæ˜¯å¦æœ‰è‚¡ç¥¨æ­¸é›¶ ---
                let zeroedOutSymbol = null;
                for (const symbol of affectedSymbols) {
                    // ä½¿ç”¨æ›´æ–°å¾Œçš„çœŸå¯¦è³‡æ–™è¨ˆç®—æŒè‚¡
                    const holdings = getCurrentHoldings(symbol, currentTransactions);
                    const remainingShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    // å¦‚æœå‰©é¤˜è‚¡æ•¸ç‚º 0 ä¸”è©²è‚¡ç¥¨ä»æœ‰æœªæ¨™è¨˜åˆªé™¤çš„äº¤æ˜“ç´€éŒ„
                    if (remainingShares === 0) {
                        const hasActiveTxs = currentTransactions.some(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        if (hasActiveTxs) {
                           zeroedOutSymbol = symbol; // è¨˜éŒ„æ­¸é›¶çš„è‚¡ç¥¨ä»£è™Ÿ
                           break; // æ‰¾åˆ°ä¸€å€‹å°±å¤ äº†
                        }
                    }
                }

                // å¦‚æœæœ‰è‚¡ç¥¨æ­¸é›¶ï¼Œå½ˆå‡ºæ¸…é™¤æ­·å²ç´€éŒ„çš„ç¢ºèª Modal
                if (zeroedOutSymbol) {
                    symbolToClear = zeroedOutSymbol;
                    clearHistoryMessage.textContent = `ç·¨è¼¯å¾Œï¼Œè‚¡ç¥¨ ${zeroedOutSymbol} çš„åº«å­˜å·²ç‚ºé›¶ï¼Œæ˜¯å¦è¦æ¸…é™¤å…¶æ‰€æœ‰ç›¸é—œäº¤æ˜“æ­·å²ç´€éŒ„ï¼Ÿ`;
                    showModal(clearHistoryModal);
                } 
                // å¦å‰‡ï¼Œç›´æ¥æ›´æ–°ä»‹é¢
                else {
                    updateStockFilterOptions();
                    render(); 
                }
            });

            /**
             * è™•ç†è‚¡ç¥¨ä»£è™Ÿè¼¸å…¥æ¡†çš„è¼¸å…¥äº‹ä»¶ï¼Œå»¶é²é¡¯ç¤ºå°æ‡‰çš„è‚¡ç¥¨åç¨±ã€‚
             * @param {Event} e - Input äº‹ä»¶ç‰©ä»¶ã€‚
             */
            function handleSymbolInput(e) {
                clearTimeout(debounceTimer); // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨ (é˜²æŠ–)
                const symbol = e.target.value.trim().toUpperCase(); // ç²å–è¼¸å…¥å€¼ä¸¦è½‰å¤§å¯«
                // æ ¹æ“šè§¸ç™¼äº‹ä»¶çš„è¼¸å…¥æ¡† ID æ±ºå®šè¦æ›´æ–°å“ªå€‹åç¨±é¡¯ç¤ºå…ƒç´ 
                const nameDisplayId = `tx-symbol-name`; 
                const nameDisplayEl = document.getElementById(nameDisplayId);
                
                const editNameDisplayEl = document.getElementById('edit-symbol-name');
                const targetEl = e.target.id === 'edit-symbol' ? editNameDisplayEl : nameDisplayEl;

                if (!targetEl) return; // å¦‚æœæ‰¾ä¸åˆ°å°æ‡‰çš„åç¨±é¡¯ç¤ºå…ƒç´ ï¼Œå‰‡è¿”å›

                // è¨­å®šä¸€å€‹å»¶é²åŸ·è¡Œçš„è¨ˆæ™‚å™¨ (300 æ¯«ç§’)
                debounceTimer = setTimeout(() => {
                    // åœ¨è¨ˆæ™‚å™¨è§¸ç™¼æ™‚ï¼Œæ ¹æ“š stockNameMap æŸ¥æ‰¾ä¸¦é¡¯ç¤ºè‚¡ç¥¨åç¨±
                    if (stockNameMap[symbol]) {
                        targetEl.textContent = stockNameMap[symbol];
                    } else {
                        targetEl.textContent = ''; // æ‰¾ä¸åˆ°å‰‡æ¸…ç©º
                    }
                }, 300);
            }

            // --- ç¨‹å¼é€²å…¥é» ---
            initializeApp_Local(); // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ (è¼‰å…¥è³‡æ–™ã€é·ç§»ã€æ¸²æŸ“)
            setDateToToday(); // è¨­å®šæ—¥æœŸé è¨­å€¼
            
            // --- å…¶ä»–äº‹ä»¶ç›£è½ç¶å®š ---
            // ç¶å®šå¯æ‘ºç–Šå€å¡Šçš„é»æ“Šäº‹ä»¶
            collapsibleHeader.addEventListener('click', () => {
                // æª¢æŸ¥ç›®å‰æ˜¯å¦å±•é–‹ (æ ¹æ“š maxHeight æ˜¯å¦æœ‰å€¼)
                if (collapsibleContent.style.maxHeight) {
                    // å¦‚æœå·²å±•é–‹ï¼Œå‰‡æ‘ºç–Š
                    collapsibleContent.style.maxHeight = null; // ç§»é™¤ maxHeight ä»¥è§¸ç™¼æ”¶ç¸®å‹•ç•«
                    collapseIcon.style.transform = 'rotate(-90deg)'; // æ—‹è½‰åœ–æ¨™
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'true'); // è¨˜éŒ„æ‘ºç–Šç‹€æ…‹
                } else {
                    // å¦‚æœå·²æ‘ºç–Šï¼Œå‰‡å±•é–‹
                    // è¨­å®š maxHeight ç‚ºå…§å®¹çš„å¯¦éš›æ»¾å‹•é«˜åº¦ä»¥è§¸ç™¼å±•é–‹å‹•ç•«
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px"; 
                    collapseIcon.style.transform = 'rotate(0deg)'; // æ¢å¾©åœ–æ¨™è§’åº¦
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'false'); // è¨˜éŒ„å±•é–‹ç‹€æ…‹
                }
            });

            // ç¶å®šè‚¡ç¥¨ä»£è™Ÿè¼¸å…¥æ¡†çš„è¼¸å…¥äº‹ä»¶ (æ–°å¢äº¤æ˜“å’Œç·¨è¼¯äº¤æ˜“)
            document.getElementById('tx-symbol').addEventListener('input', handleSymbolInput);
            document.getElementById('edit-symbol').addEventListener('input', handleSymbolInput);
        });
    </script>
</body>
</html>
