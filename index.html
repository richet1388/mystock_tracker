<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ğŸ“ˆé›²ç«¯å„€è¡¨æ¿ ğŸ“Š</title>
    <link rel="icon" href="ElienOnly.ico" type="image/ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- è«è˜­è¿ªæ·±è‰²ç³»é…è‰² --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1c1917; /* çŸ³å¢¨æ£• */
            color: #f5f5f4; /* æš–çŸ³ç° */
        }
        .table-scrollbar::-webkit-scrollbar { width:6px; height:6px; }
        .table-scrollbar::-webkit-scrollbar-track { background:#292524; border-radius:10px; }
        .table-scrollbar::-webkit-scrollbar-thumb { background:#57534e; border-radius:10px; }
        .table-scrollbar::-webkit-scrollbar-thumb:hover { background:#78716c; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor:pointer; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        input[type="date"]::-webkit-datetime-edit { font-size: 0.85rem; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin:0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="antialiased">

    <!-- ç™»å…¥/é©—è­‰å€å¡Š (éš±è—) -->
    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl text-center hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">ğŸ“ˆé›²ç«¯å„€è¡¨æ¿ğŸ“Š</h1>
        <p class="mt-4 text-stone-400">ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥ä»¥è·¨è£ç½®åŒæ­¥æŒè‚¡è³‡æ–™</p>
        <button id="login-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">ä½¿ç”¨ Google ç™»å…¥</button>
    </div>

    <!-- ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ (é¡¯ç¤º) -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl" style="display:none;">
        <div class="flex justify-between items-center mb-6 hidden">
             <p id="user-display" class="text-sm text-stone-400"></p>
             <button id="logout-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">ç™»å‡º</button>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">ğŸ“ˆæˆæœ¬ç´€éŒ„å„€è¡¨æ¿ğŸ“Š</h1>
            <p class="mt-2 text-lg text-stone-400">ğŸ‡¹ğŸ‡¼  ğŸ‡ºğŸ‡¸ â¡ï¸ ğŸ¥¦ ğŸ”¥ (é›²ç«¯ç‰ˆ)</p>
        </header>

        <main class="space-y-8">
            <!-- å¸³æˆ¶é¸æ“‡å€å¡Š -->
            <div class="bg-stone-800 p-4 rounded-2xl shadow-lg border border-stone-700 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-5">
                        <label for="account-filter" class="block text-sm font-medium text-stone-300 mb-1">ç›®å‰å¸³æˆ¶</label>
                        <select id="account-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="account-market-type" class="block text-sm font-medium text-stone-300 mb-1">å¸‚å ´</label>
                        <select id="account-market-type" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                            <option value="TW">å°è‚¡ ğŸ‡¹ğŸ‡¼</option>
                            <option value="US">ç¾è‚¡ ğŸ‡ºğŸ‡¸</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="account-fee-discount" class="block text-sm font-medium text-stone-300 mb-1">æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡</label>
                        <input type="number" id="account-fee-discount" min="0" step="any" required value="0.28" class="block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="flex items-center space-x-2 self-end md:col-span-3">
                            <button id="add-account-btn" title="æ–°å¢å¸³æˆ¶" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">ï¼‹</button>
                            <button id="edit-account-btn" title="ç·¨è¼¯å¸³æˆ¶" class="flex-shrink-0 bg-stone-500 hover:bg-stone-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">âœï¸</button>
                            <button id="delete-account-btn" title="åˆªé™¤å¸³æˆ¶" class="flex-shrink-0 bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md hidden">ï¼</button>
                    </div>
                </div>
            </div>

            <!-- ç¸½è¦½èˆ‡ç¯©é¸å€å¡Š -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700 space-y-4">
                <h2 id="view-title" class="text-2xl font-bold text-stone-100 tracking-tight">ç¸½è¦½</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="stock-search" class="block text-sm font-medium text-stone-300 mb-2">æœå°‹æˆ–é¸æ“‡æª¢è¦–é …ç›®</label>
                        <input type="text" id="stock-search" placeholder="è¼¸å…¥ä»£è™Ÿç¯©é¸..." class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                    </div>
                    <div class="md:col-span-2">
                        <label for="stock-filter" class="block text-sm font-medium text-transparent mb-2 select-none">.</label>
                        <select id="stock-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div class="md:col-span-1">
                        <label id="shares-title" class="block text-sm font-medium text-stone-300 mb-2">å…¨éƒ¨åº«å­˜æª”æ•¸</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalShares" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="avg-cost-box" class="md:col-span-1">
                        <label id="avg-cost-title" class="block text-sm font-medium text-stone-300 mb-2">å¹³å‡æˆæœ¬</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="avgCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="total-cost-box" class="md:col-span-1">
                        <label id="total-cost-title" class="block text-sm font-medium text-stone-300 mb-2">ç¸½æˆæœ¬</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆä½µæ–°å¢äº¤æ˜“ç´€éŒ„ -->
            <div class="bg-stone-800 rounded-2xl shadow-lg border border-stone-700">
                <div id="collapsible-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-stone-100">æ–°å¢äº¤æ˜“ç´€éŒ„</h2>
                    <span id="collapse-icon" class="text-stone-400 transform transition-transform duration-300">â–¼</span>
                </div>
                <div id="collapsible-content" class="collapsible-content">
                    <div class="p-4 pt-0">
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-stone-700">
                            <form id="add-transaction-form" class="space-y-4">
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label for="tx-symbol" class="block text-sm font-medium text-stone-300">è‚¡ç¥¨ä»£è™Ÿ</label>
                                        <input type="text" id="tx-symbol" required placeholder="ä¾‹å¦‚: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="tx-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="tx-date" class="block text-sm font-medium text-stone-300">æ—¥æœŸ</label>
                                        <input type="date" id="tx-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-shares" class="block text-sm font-medium text-stone-300">è‚¡æ•¸</label>
                                        <input type="number" id="tx-shares" min="0" step="any" required placeholder="1000" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-price" class="block text-sm font-medium text-stone-300">åƒ¹æ ¼(å‡åƒ¹)</label>
                                        <input type="number" id="tx-price" min="0" step="any" required placeholder="600.5" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                            </form>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <button type="button" id="add-buy-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">è²·å…¥</button>
                                <button type="button" id="add-sell-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">è³£å‡º</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- äº¤æ˜“æ­·å²/åº«å­˜æ˜ç´°å€å¡Š -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="history-title" class="text-xl font-semibold text-stone-100">äº¤æ˜“æ­·å²ç´€éŒ„</h2>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <button id="import-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">åŒ¯å…¥è³‡æ–™</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="export-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">åŒ¯å‡ºè³‡æ–™</button>
                    </div>
                </div>
                <div class="overflow-x-auto table-scrollbar">
                    <table class="min-w-full divide-y divide-stone-700">
                        <thead class="bg-stone-900"></thead>
                        <tbody id="transaction-list" class="divide-y divide-stone-700"></tbody>
                    </table>
                    <p id="no-data-msg" class="text-center py-8 text-stone-500">å°šç„¡äº¤æ˜“ç´€éŒ„</p>
                </div>
                <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-stone-400 hidden">
                    <button id="prev-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">&lt; ä¸Šä¸€é </button>
                    <span id="page-info">ç¬¬ 1 / 1 é </span>
                    <button id="next-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é  &gt;</button>
                </div>
            </div>
        </main>
    </div>

    <!-- message modal (simple) -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="message-modal-title" class="text-lg font-semibold text-stone-100">æç¤º</h3>
            <p id="message-modal-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- account modals (simple) -->
    <div id="add-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">æ–°å¢å¸³æˆ¶</h3>
            <form id="add-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="new-account-name" class="block text-sm font-medium text-stone-300">å¸³æˆ¶åç¨±</label>
                    <input type="text" id="new-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div>
                    <label for="new-account-market-type" class="block text-sm font-medium text-stone-300">å¸‚å ´é¡å‹</label>
                    <select id="new-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                        <option value="TW">å°è‚¡ (TW)</option>
                        <option value="US">ç¾è‚¡ (US)</option>
                    </select>
                </div>
                <div>
                    <label for="new-account-fee-discount" class="block text-sm font-medium text-stone-300">æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡</label>
                    <input type="number" id="new-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">å»ºç«‹</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">ä¿®æ”¹å¸³æˆ¶</h3>
            <form id="edit-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="edit-account-name" class="block text-sm font-medium text-stone-300">æ–°å¸³æˆ¶åç¨±</label>
                    <input type="text" id="edit-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div>
                    <label for="edit-account-market-type" class="block text-sm font-medium text-stone-300">å¸‚å ´é¡å‹</label>
                    <select id="edit-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                        <option value="TW">å°è‚¡ (TW)</option>
                        <option value="US">ç¾è‚¡ (US)</option>
                    </select>
                </div>
                <div>
                    <label for="edit-account-fee-discount" class="block text-sm font-medium text-stone-300">æ‰‹çºŒè²»æŠ˜æ•¸/è²»ç‡</label>
                    <input type="number" id="edit-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase åˆå§‹åŒ–æ¨¡çµ„ï¼ˆæ¨¡çµ„åŒ–å¼•å…¥ï¼Œä¸¦æŠŠå¿…è¦ API æš´éœ²åœ¨ window.firebaseApiï¼‰ -->
    <script type="module">
        // é€™æ®µæœƒä½¿ç”¨ Firebase modular SDKã€‚è«‹æŠŠä¸‹æ–¹ firebaseConfig å¡«ä¸Šä½ çš„å°ˆæ¡ˆè¨­å®šã€‚
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.11.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.11.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, onValue, update } from "https://www.gstatic.com/firebasejs/11.11.0/firebase-database.js";

        // --------- TODO: åœ¨æ­¤å¡«å…¥ä½ çš„ Firebase è¨­å®š ----------
        const firebaseConfig = {
            apiKey: "AIzaSyBNA20afPELKWGlKHkQfdNhk5Z1wjlTYfs",
            authDomain: "stock-tracker-940de.firebaseapp.com",
            databaseURL: "https://stock-tracker-940de-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "stock-tracker-940de",
            storageBucket: "stock-tracker-940de.firebasestorage.app",
            messagingSenderId: "546233071753",
            appId: "1:546233071753:web:c95d9bece5dd10aa83ae58"
        };
        // ---------------------------------------------------

        // åˆå§‹åŒ– Firebaseï¼ˆè‹¥æ²’å¡« configï¼ŒinitializeApp æœƒå¤±æ•— -> æœƒè§¸ç™¼ catchï¼‰
        let firebaseApp = null;
        let auth = null;
        let db = null;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getDatabase(firebaseApp);
        } catch (e) {
            console.warn("Firebase åˆå§‹åŒ–å¤±æ•—ï¼ˆå¯èƒ½æœªå¡« config æˆ–ç¶²è·¯å•é¡Œï¼‰:", e);
            // ä¸ä¸­æ–·ï¼šæ¥ä¸‹ä¾†ä¸»ç¨‹å¼æœƒå›é€€åˆ° localStorage
        }

        // æš´éœ²ç°¡æ˜“ä»‹é¢åˆ° windowï¼Œä¸»ç¨‹å¼å¯ä»¥ç”¨å®ƒèˆ‡ Firebase äº’å‹•
        window.firebaseApi = {
            available: !!(auth && db),
            auth,
            db,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            dbMethods: {
                getUserData: async (uid) => {
                    if (!db) throw new Error("Realtime Database æœªåˆå§‹åŒ–");
                    const userRef = ref(db, `users/${uid}`);
                    const snap = await get(userRef);
                    return snap.exists() ? snap.val() : null;
                },
                saveUserData: async (uid, data) => {
                    if (!db) throw new Error("Realtime Database æœªåˆå§‹åŒ–");
                    const userRef = ref(db, `users/${uid}`);
                    // é€™è£¡æ¡ç”¨ setï¼ˆæ›¿æ›ï¼‰ï¼Œå¦‚æœä½ æƒ³è¦ merge å¯æ”¹ç”¨ update
                    await set(userRef, data);
                },
                attachListener: (uid, onChange) => {
                    if (!db) throw new Error("Realtime Database æœªåˆå§‹åŒ–");
                    const userRef = ref(db, `users/${uid}`);
                    return onValue(userRef, (snapshot) => {
                        onChange(snapshot.val());
                    }, (err) => {
                        console.error("Realtime DB listener error:", err);
                    });
                },
                detachListener: (listener) => {
                    // onValue å‚³å›ä¸€å€‹å–æ¶ˆå‡½å¼ï¼ˆåœ¨ modular ç‰ˆæœ¬ä¸­ä¸ç”¨ detachï¼‰ï¼Œ
                    // ä½¿ç”¨è€…å‘¼å«è¿”å›çš„ unsubscribe() å³å¯åœæ­¢ç›£è½ã€‚
                }
            }
        };
    </script>

    <!-- ä¸»ç¨‹å¼ï¼šä¿ç•™åŸ UI ID èˆ‡å¤§éƒ¨åˆ†é‚è¼¯ï¼Œä½†å„²å­˜/è¼‰å…¥æ”¹ç‚ºä½¿ç”¨ firebaseApi å„ªå…ˆï¼Œå¦å‰‡ localStorage -->
    <script>
        // IMPORTANT: æˆ‘å€‘å‡è¨­ firebaseApi å¯èƒ½åœ¨ä¸Šé¢æ¨¡çµ„å·²ç¶“åˆå§‹åŒ–ã€‚
        // è‹¥ firebaseApi.available === true -> ä½¿ç”¨ Realtime DBï¼ŒåŒæ™‚æ›ç›£è½ã€‚
        // è‹¥ä¸å¯ç”¨ -> ä½¿ç”¨ localStorageã€‚

        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM å…ƒç´  ---
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            const accountFilter = document.getElementById('account-filter');
            const accountFeeDiscountInput = document.getElementById('account-fee-discount');
            const accountMarketTypeInput = document.getElementById('account-market-type');
            const addAccountBtn = document.getElementById('add-account-btn');
            const editAccountBtn = document.getElementById('edit-account-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const addAccountModal = document.getElementById('add-account-modal');
            const addAccountCancelBtn = document.getElementById('add-account-cancel');
            const newAccountFeeDiscountInput = document.getElementById('new-account-fee-discount');
            const newAccountMarketTypeInput = document.getElementById('new-account-market-type');
            const addAccountForm = document.getElementById('add-account-form');
            const editAccountModal = document.getElementById('edit-account-modal');
            const editAccountCancelBtn = document.getElementById('edit-account-cancel');
            const editAccountNameInput = document.getElementById('edit-account-name');
            const editAccountFeeDiscountInput = document.getElementById('edit-account-fee-discount');
            const editAccountMarketTypeInput = document.getElementById('edit-account-market-type');

            const stockFilter = document.getElementById('stock-filter');
            const stockSearch = document.getElementById('stock-search');
            const transactionList = document.getElementById('transaction-list');
            const totalSharesEl = document.getElementById('totalShares');
            const avgCostEl = document.getElementById('avgCost');
            const totalCostEl = document.getElementById('totalCost');
            const noDataMsg = document.getElementById('no-data-msg');
            const importBtn = document.getElementById('import-btn');
            const exportBtn = document.getElementById('export-btn');
            const importFile = document.getElementById('import-file');

            const addBuyBtn = document.getElementById('add-buy-btn');
            const addSellBtn = document.getElementById('add-sell-btn');
            const addTransactionForm = document.getElementById('add-transaction-form');
            const txSymbolInput = document.getElementById('tx-symbol');
            const txDateInput = document.getElementById('tx-date');
            const txSharesInput = document.getElementById('tx-shares');
            const txPriceInput = document.getElementById('tx-price');

            const messageModal = document.getElementById('message-modal');
            const messageModalClose = document.getElementById('message-modal-close');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalMessage = document.getElementById('message-modal-message');

            // collapsible
            const collapsibleHeader = document.getElementById('collapsible-header');
            const collapsibleContent = document.getElementById('collapsible-content');
            const collapseIcon = document.getElementById('collapse-icon');

            // --- å…§éƒ¨ç‹€æ…‹ ---
            let appData = {}; // { accounts: { name: { transactions: [], feeDiscount, marketType } }, currentAccount: '...' }
            let currentUser = null; // firebase user object when logged in
            let firebaseListenerUnsubscribe = null; // è‹¥æœ‰é›²ç«¯ç›£è½å‰‡å­˜æ”¾å‡½å¼
            const LOCAL_KEY = 'stockTrackerData_LocalTest';

            // ä¸€äº›å¸¸æ•¸
            const FEE_RATE = 0.001425;
            const TAX_RATE = 0.003;

            /** ---------- helper: show / hide modal ---------- */
            function showModal(modalEl, title, message) {
                if (modalEl === messageModal) {
                    if (title) messageModalTitle.textContent = title;
                    if (message) messageModalMessage.textContent = message;
                }
                modalEl.classList.remove('opacity-0', 'pointer-events-none');
                modalEl.querySelector('.modal-content')?.classList.remove('scale-95');
            }
            function hideModal(modalEl) {
                modalEl.classList.add('opacity-0', 'pointer-events-none');
                modalEl.querySelector('.modal-content')?.classList.add('scale-95');
            }
            messageModalClose.addEventListener('click', () => hideModal(messageModal));

            /** ---------- localStorage helpers ---------- */
            function loadFromLocalStorage() {
                try {
                    const raw = localStorage.getItem(LOCAL_KEY);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (e) {
                    console.error("è®€å– localStorage å¤±æ•—ï¼š", e);
                    return null;
                }
            }
            function saveToLocalStorage() {
                try {
                    localStorage.setItem(LOCAL_KEY, JSON.stringify(appData));
                } catch (e) {
                    console.error("å¯«å…¥ localStorage å¤±æ•—ï¼š", e);
                    showModal(messageModal, 'å„²å­˜å¤±æ•—', 'ç€è¦½å™¨æœ¬æ©Ÿå„²å­˜å¤±æ•—ã€‚');
                }
            }

            /** ---------- firebase wrapper helpers ---------- */
            async function loadFromFirebase(uid) {
                if (!window.firebaseApi || !window.firebaseApi.available) throw new Error("firebase not available");
                try {
                    const data = await window.firebaseApi.dbMethods.getUserData(uid);
                    return data;
                } catch (e) {
                    console.error("å¾ Firebase è¼‰å…¥å¤±æ•—ï¼š", e);
                    throw e;
                }
            }
            async function saveToFirebase(uid) {
                if (!window.firebaseApi || !window.firebaseApi.available) throw new Error("firebase not available");
                try {
                    await window.firebaseApi.dbMethods.saveUserData(uid, appData);
                } catch (e) {
                    console.error("å„²å­˜è‡³ Firebase å¤±æ•—ï¼š", e);
                    throw e;
                }
            }
            function attachFirebaseListener(uid) {
                if (!window.firebaseApi || !window.firebaseApi.available) return null;
                // onValue returns an unsubscribe function in modular SDK -> simulate by returning the unsubscribe
                const unsubscribe = window.firebaseApi.dbMethods.attachListener(uid, (val) => {
                    if (!val) return;
                    // ç•¶é›²ç«¯è³‡æ–™è®Šæ›´æ™‚æ›´æ–°æœ¬åœ° appDataï¼ˆä¸¦é‡æ–° renderï¼‰
                    appData = val;
                    render();
                });
                // NOTE: modular onValue returns a function? In our helper we didn't return unsubscribe; but the modular onValue's return is the unsubscribe.
                // é‘’æ–¼æˆ‘å€‘çš„ window.firebaseApi.dbMethods.attachListener æ²’æœ‰å›å‚³ unsubscribeï¼Œç„¡æ³•ç›´æ¥å–æ¶ˆã€‚æœ¬ç¯„ä¾‹å‡è¨­ attachListener å›å‚³ unsubscribeï¼ˆè‹¥éœ€ï¼Œè«‹ä¿®æ”¹ä¸Šæ–¹ module ä»¥å›å‚³ onValue çš„ unsubscribeï¼‰ã€‚
                return unsubscribe;
            }

            /** ---------- save strategy wrapper ---------- */
            // å„²å­˜ï¼šè‹¥ç™»å…¥ä¸” firebase å¯ç”¨ -> å„ªå…ˆåŒæ­¥åˆ° firebaseï¼ˆä¸¦å­˜ local åšé›¢ç·šå‚™æ´ï¼‰ï¼›å¦å‰‡åªå­˜ local
            async function saveData() {
                // always update local copy
                saveToLocalStorage();
                if (currentUser && window.firebaseApi && window.firebaseApi.available) {
                    try {
                        await saveToFirebase(currentUser.uid);
                        // no visual prompt requested by user
                    } catch (e) {
                        console.warn("åŒæ­¥åˆ°é›²ç«¯å¤±æ•—ï¼Œè³‡æ–™å·²ä¿å­˜åœ¨ localStorageã€‚");
                    }
                }
            }

            /** ---------- initialize appData default & migration ---------- */
            function ensureAppDataStructure(d) {
                if (!d || typeof d !== 'object') {
                    return { accounts: { 'é è¨­å¸³æˆ¶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } }, currentAccount: 'é è¨­å¸³æˆ¶' };
                }
                if (!d.accounts || typeof d.accounts !== 'object') d.accounts = { 'é è¨­å¸³æˆ¶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } };
                if (!d.currentAccount || !d.accounts[d.currentAccount]) d.currentAccount = Object.keys(d.accounts)[0] || 'é è¨­å¸³æˆ¶';
                // migrate each account
                for (const name of Object.keys(d.accounts)) {
                    const acc = d.accounts[name];
                    if (Array.isArray(acc)) {
                        // old format => convert
                        d.accounts[name] = { transactions: acc, feeDiscount: 0.28, marketType: 'TW' };
                    } else {
                        if (!Array.isArray(acc.transactions)) acc.transactions = [];
                        if (acc.feeDiscount === undefined) acc.feeDiscount = 0.28;
                        if (!acc.marketType) acc.marketType = 'TW';
                    }
                }
                return d;
            }

            /** ---------- render UI ---------- */
            function updateAccountFilterOptions() {
                accountFilter.innerHTML = '';
                const names = Object.keys(appData.accounts || {});
                names.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = n; opt.textContent = n;
                    accountFilter.appendChild(opt);
                });
                accountFilter.value = appData.currentAccount || names[0];
                deleteAccountBtn.classList.toggle('hidden', names.length <= 1);
                updateAccountFeeDiscountDisplay();
                updateAccountMarketTypeDisplay();
            }
            function updateAccountFeeDiscountDisplay() {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    accountFeeDiscountInput.value = appData.accounts[appData.currentAccount].feeDiscount;
                } else accountFeeDiscountInput.value = 0.28;
            }
            function updateAccountMarketTypeDisplay() {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    accountMarketTypeInput.value = appData.accounts[appData.currentAccount].marketType || 'TW';
                } else accountMarketTypeInput.value = 'TW';
            }

            function updateStockFilterOptions() {
                const currentTransactions = (appData.accounts[appData.currentAccount] && appData.accounts[appData.currentAccount].transactions) || [];
                const selectedValue = stockFilter.value;
                const searchTerm = (stockSearch.value || '').trim().toUpperCase();
                let symbols = [...new Set(currentTransactions.map(tx => tx.symbol || ''))].filter(Boolean);
                if (searchTerm) symbols = symbols.filter(s => s.toUpperCase().includes(searchTerm));
                symbols.sort();
                stockFilter.innerHTML = '';
                const allOption = document.createElement('option'); allOption.value='__ALL__'; allOption.textContent='å…¨éƒ¨åº«å­˜';
                stockFilter.appendChild(allOption);
                symbols.forEach(sym => {
                    const opt = document.createElement('option'); opt.value = sym; opt.textContent = sym;
                    stockFilter.appendChild(opt);
                });
                if ([...stockFilter.options].some(o => o.value === selectedValue)) {
                    stockFilter.value = selectedValue;
                } else stockFilter.value = '__ALL__';
            }

            function renderTransactionsList() {
                transactionList.innerHTML = '';
                const txs = (appData.accounts[appData.currentAccount] && appData.accounts[appData.currentAccount].transactions) || [];
                if (!txs.length) {
                    noDataMsg.style.display = 'block';
                } else {
                    noDataMsg.style.display = 'none';
                }
                // simple listing: show date, symbol, shares, price, type, fee
                txs.slice().reverse().forEach((tx, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-stone-900';
                    const td = (html) => { const tdEl = document.createElement('td'); tdEl.className='px-4 py-3 text-sm text-stone-200'; tdEl.innerHTML = html; return tdEl; };
                    tr.appendChild(td(`<strong>${tx.symbol || ''}</strong><div class="text-xs text-stone-400">${tx.name||''}</div>`));
                    tr.appendChild(td(`${tx.type || ''}`));
                    tr.appendChild(td(`${tx.shares || 0}`));
                    tr.appendChild(td(`${tx.price || 0}`));
                    tr.appendChild(td(`${(tx.fee||0).toFixed ? (tx.fee||0).toFixed(2) : tx.fee}`));
                    transactionList.appendChild(tr);
                });
            }

            function recalcOverview() {
                const txs = (appData.accounts[appData.currentAccount] && appData.accounts[appData.currentAccount].transactions) || [];
                let totalCost = 0, totalShares = 0, weightedSum = 0;
                txs.forEach(tx => {
                    if (tx.type === 'BUY') {
                        const amount = (tx.price || 0) * (tx.shares || 0);
                        totalCost += amount + (tx.fee || 0);
                        totalShares += (tx.shares || 0);
                    } else if (tx.type === 'SELL') {
                        // è³£å‡ºä¸åˆ—å…¥æŒæœ‰æˆæœ¬è¨ˆç®—ï¼ˆæ­¤è™•ç¤ºç¯„æ€§ç°¡åŒ–ï¼‰
                        totalShares += (tx.shares || 0); // for counting records only
                    }
                });
                avgCostEl.textContent = totalShares ? (totalCost / totalShares).toFixed(2) : '0';
                totalCostEl.textContent = totalCost.toFixed(2);
                totalSharesEl.textContent = txs.length;
            }

            function render() {
                updateAccountFilterOptions();
                updateStockFilterOptions();
                renderTransactionsList();
                recalcOverview();
            }

            /** ---------- UI interactions (accounts) ---------- */
            addAccountBtn.addEventListener('click', () => {
                newAccountFeeDiscountInput.value = 0.28;
                newAccountMarketTypeInput.value = 'TW';
                showModal(addAccountModal);
            });
            addAccountCancelBtn.addEventListener('click', () => hideModal(addAccountModal));
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('new-account-name').value.trim() || `å¸³æˆ¶ ${Date.now()}`;
                const fee = parseFloat(newAccountFeeDiscountInput.value) || 0.28;
                const market = newAccountMarketTypeInput.value || 'TW';
                if (!appData.accounts) appData.accounts = {};
                appData.accounts[name] = { transactions: [], feeDiscount: fee, marketType: market };
                appData.currentAccount = name;
                hideModal(addAccountModal);
                saveData().then(render);
            });

            editAccountBtn.addEventListener('click', () => {
                editAccountNameInput.value = appData.currentAccount;
                editAccountFeeDiscountInput.value = appData.accounts[appData.currentAccount]?.feeDiscount || 0.28;
                editAccountMarketTypeInput.value = appData.accounts[appData.currentAccount]?.marketType || 'TW';
                showModal(editAccountModal);
            });
            editAccountCancelBtn.addEventListener('click', () => hideModal(editAccountModal));
            document.getElementById('edit-account-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = editAccountNameInput.value.trim();
                const fee = parseFloat(editAccountFeeDiscountInput.value) || 0.28;
                const market = editAccountMarketTypeInput.value || 'TW';
                const oldName = appData.currentAccount;
                if (newName !== oldName) {
                    appData.accounts[newName] = appData.accounts[oldName];
                    delete appData.accounts[oldName];
                    appData.currentAccount = newName;
                }
                appData.accounts[appData.currentAccount].feeDiscount = fee;
                appData.accounts[appData.currentAccount].marketType = market;
                hideModal(editAccountModal);
                saveData().then(render);
            });

            deleteAccountBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount;
                if (confirm(`ç¢ºå®šè¦åˆªé™¤å¸³æˆ¶ ${accountToDelete} ?`)) {
                    delete appData.accounts[accountToDelete];
                    const remaining = Object.keys(appData.accounts || {});
                    appData.currentAccount = remaining[0] || 'é è¨­å¸³æˆ¶';
                    saveData().then(render);
                }
            });

            accountFilter.addEventListener('change', (e) => {
                appData.currentAccount = accountFilter.value;
                render();
            });
            accountFeeDiscountInput.addEventListener('change', (e) => {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    appData.accounts[appData.currentAccount].feeDiscount = parseFloat(e.target.value) || 0.28;
                    saveData();
                }
            });
            accountMarketTypeInput.addEventListener('change', (e) => {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    appData.accounts[appData.currentAccount].marketType = e.target.value || 'TW';
                    saveData();
                }
            });

            /** ---------- transactions add (buy/sell) ---------- */
            function buildTransactionObject(type) {
                return {
                    id: 'tx_' + Date.now(),
                    symbol: (txSymbolInput.value || '').toUpperCase(),
                    name: '',
                    date: txDateInput.value || new Date().toISOString().slice(0,10),
                    shares: parseFloat(txSharesInput.value) || 0,
                    price: parseFloat(txPriceInput.value) || 0,
                    type: type,
                    fee: 0,
                    totalTxCost: 0
                };
            }
            addBuyBtn.addEventListener('click', async () => {
                const tx = buildTransactionObject('BUY');
                // compute fee based on account settings
                const acc = appData.accounts[appData.currentAccount];
                const amount = tx.price * tx.shares;
                if (acc && acc.marketType === 'TW') {
                    tx.fee = amount * FEE_RATE * (acc.feeDiscount || 0.28);
                } else {
                    tx.fee = amount * (acc?.feeDiscount || 0.0);
                }
                tx.totalTxCost = amount + tx.fee;
                tx.name = ''; // could map from stockNameMap if available
                acc.transactions.push(tx);
                await saveData();
                render();
                addTransactionForm.reset();
            });
            addSellBtn.addEventListener('click', async () => {
                const tx = buildTransactionObject('SELL');
                const acc = appData.accounts[appData.currentAccount];
                const amount = tx.price * tx.shares;
                if (acc && acc.marketType === 'TW') {
                    tx.fee = amount * FEE_RATE * (acc.feeDiscount || 0.28) + amount * TAX_RATE; // include tax for sell
                } else {
                    tx.fee = amount * (acc?.feeDiscount || 0.0);
                }
                tx.totalTxCost = amount - tx.fee;
                acc.transactions.push(tx);
                await saveData();
                render();
                addTransactionForm.reset();
            });

            /** ---------- import / export ---------- */
            exportBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(appData, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'stocktracker_export.json'; a.click();
                URL.revokeObjectURL(url);
            });
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const parsed = JSON.parse(ev.target.result);
                        appData = ensureAppDataStructure(parsed);
                        saveData().then(render);
                    } catch (err) {
                        showModal(messageModal, 'åŒ¯å…¥å¤±æ•—', 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    }
                };
                reader.readAsText(file);
            });

            /** ---------- collapsible ---------- */
            collapsibleHeader.addEventListener('click', () => {
                if (collapsibleContent.style.maxHeight) {
                    collapsibleContent.style.maxHeight = null;
                    collapseIcon.style.transform = 'rotate(-90deg)';
                } else {
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                    collapseIcon.style.transform = 'rotate(0deg)';
                }
            });

            /** ---------- Auth flow ---------- */
            function showAppForLoggedIn(user) {
                currentUser = user;
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                if (userDisplay) userDisplay.textContent = `å·²ç™»å…¥ï¼š${user.displayName || user.email}`;
            }
            function showAuthPrompt() {
                currentUser = null;
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                if (userDisplay) userDisplay.textContent = '';
            }

            async function initializeApp() {
                // 1) å˜—è©¦å¾ firebaseApi å–å¾—ä½¿ç”¨è€…ç‹€æ…‹ï¼ˆå¦‚æœ firebase å¯ç”¨ï¼‰
                const fb = window.firebaseApi;
                if (fb && fb.available && fb.auth) {
                    // ç¶å®š onAuthStateChangedï¼ˆè‹¥ firebase æœªé…ç½®æˆ–å¤±æ•—ï¼Œæ­¤æ®µæœƒè·³åˆ° elseï¼‰
                    fb.onAuthStateChanged(fb.auth, async (user) => {
                        if (user) {
                            // å·²ç™»å…¥
                            showAppForLoggedIn(user);
                            // load user data from realtime db
                            try {
                                const remote = await loadFromFirebase(user.uid);
                                if (remote) {
                                    appData = ensureAppDataStructure(remote);
                                } else {
                                    // if remote empty but local exists, push local -> remote
                                    const local = loadFromLocalStorage();
                                    if (local) {
                                        appData = ensureAppDataStructure(local);
                                        await saveToFirebase(user.uid);
                                    } else {
                                        appData = ensureAppDataStructure(appData);
                                        await saveToFirebase(user.uid);
                                    }
                                }
                                // attach realtime listener to keep in sync
                                try {
                                    if (firebaseListenerUnsubscribe && typeof firebaseListenerUnsubscribe === 'function') {
                                        firebaseListenerUnsubscribe();
                                        firebaseListenerUnsubscribe = null;
                                    }
                                    // Our attachFirebaseListener might not return unsubscribe depending on implementation,
                                    // so we attempt to call dbMethods.attachListener which in our module calls onValue.
                                    if (fb.dbMethods && typeof fb.dbMethods.attachListener === 'function') {
                                        // attachListener returns nothing in the provided module, but onValue returns an unsubscribe normally.
                                        // To be safe, we don't rely on unsub. (If you want to be able to unsubscribe, modify the module script to return the unsubscribe.)
                                        fb.dbMethods.attachListener(user.uid, (val) => {
                                            if (!val) return;
                                            appData = ensureAppDataStructure(val);
                                            render();
                                        });
                                    }
                                } catch (err) { console.warn("ç„¡æ³•é™„åŠ é›²ç«¯ç›£è½ï¼š", err); }
                                saveToLocalStorage(); // keep local backup
                                render();
                            } catch (err) {
                                console.warn("å¾é›²ç«¯è¼‰å…¥å¤±æ•—ï¼Œæ”¹ç”¨ localStorageï¼š", err);
                                const local = loadFromLocalStorage();
                                appData = ensureAppDataStructure(local);
                                render();
                            }
                        } else {
                            // æœªç™»å…¥ -> é¡¯ç¤ºç™»å…¥ç•«é¢ï¼Œä¸¦ä½¿ç”¨ local data
                            showAuthPrompt();
                            const local = loadFromLocalStorage();
                            appData = ensureAppDataStructure(local);
                            render();
                        }
                    });
                    // login/logout handlers
                    loginBtn.addEventListener('click', async () => {
                        const provider = new fb.GoogleAuthProvider();
                        try {
                            await fb.signInWithPopup(fb.auth, provider);
                        } catch (err) {
                            console.error("ç™»å…¥å¤±æ•—ï¼š", err);
                            showModal(messageModal, 'ç™»å…¥å¤±æ•—', 'ç„¡æ³•ä½¿ç”¨ Google ç™»å…¥');
                        }
                    });
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await fb.signOut(fb.auth);
                            // æ¸…æ‰æœ¬åœ°ä½¿ç”¨è€…è³‡è¨Šï¼ˆUI already handled by auth listenerï¼‰
                        } catch (err) {
                            console.error("ç™»å‡ºå¤±æ•—ï¼š", err);
                        }
                    });
                } else {
                    // firebase not available -> fallback to local-only mode
                    console.warn("Firebase not available, fallback to localStorage only.");
                    showAuthPrompt();
                    const local = loadFromLocalStorage();
                    appData = ensureAppDataStructure(local);
                    render();
                    // disable login button (no firebase)
                    loginBtn.addEventListener('click', () => {
                        showModal(messageModal, 'Firebase æœªè¨­å®š', 'è«‹å…ˆåœ¨ç¨‹å¼ä¸­å¡«å…¥ Firebase è¨­å®šå¾Œå•Ÿç”¨é›²ç«¯åŠŸèƒ½ã€‚');
                    });
                }
            }

            // åˆå§‹åŒ– tx date ç‚ºä»Šå¤©
            function setDateToToday() { txDateInput.value = new Date().toISOString().slice(0,10); }
            setDateToToday();

            // æœ€å¾Œå‘¼å«åˆå§‹åŒ–
            initializeApp();

        }); // DOMContentLoaded end
    </script>
</body>
</html>
