<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📈雲端儀表板 📊</title>
    <link rel="icon" href="ElienOnly.ico" type="image/ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        // TODO: 在此貼上您的 Firebase 專案設定物件
        // 1. 前往 Firebase 控制台 (https://console.firebase.google.com/)
        // 2. 建立新專案 (或使用現有專案)
        // 3. 進入專案，點選「專案設定」(Project Settings)
        // 4. 在「您的應用程式」(Your apps) 中，註冊一個新的「網頁應用程式」(Web app)
        // 5. 複製提供的 firebaseConfig 物件並貼到下方
        const firebaseConfig = {
            apiKey: "AIzaSyBNA20afPELKWGlKHkQfdNhk5Z1wjlTYfs",
            authDomain: "stock-tracker-940de.firebaseapp.com",
            databaseURL: "https://stock-tracker-940de-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "stock-tracker-940de",
            storageBucket: "stock-tracker-940de.firebasestorage.app",
            messagingSenderId: "546233071753",
            appId: "1:546233071753:web:c95d9bece5dd10aa83ae58"
                    };

        // 初始化 Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    
    <style>
        /* --- 莫蘭迪深色系配色 --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1c1917; /* 石墨棕 */
            color: #f5f5f4; /* 暖石灰 */
        }
        /* [ ... 其他 style 內容 ... ] */
        /* --- 隱藏數字輸入框的上下箭頭 --- */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
    </style>
</head>
<body class="antialiased">

    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈雲端儀表板📊</h1>
        <p class="mt-4 text-stone-400">使用 Google 帳戶登入以跨裝置同步持股資料</p>
        <button id="login-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">使用 Google 登入</button>
    </div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl hidden"> 
        
        <div class="flex justify-between items-center mb-6">
             <p id="user-display" class="text-sm text-stone-400"></p>
             <button id="logout-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">登出</button>
        </div>
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈成本紀錄儀表板📊</h1>
            <p class="mt-2 text-lg text-stone-400">🇹🇼  🇺🇸 ➡️ 🥦 🔥 (雲端同步版)</p>
        </header>

        <main class="space-y-8">
            <div class="bg-stone-800 p-4 rounded-2xl shadow-lg border border-stone-700 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-5">
                        <label for="account-filter" class="block text-sm font-medium text-stone-300 mb-1">目前帳戶</label>
                        <select id="account-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="account-market-type" class="block text-sm font-medium text-stone-300 mb-1">市場</label>
                        <select id="account-market-type" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                            <option value="TW">台股 🇹🇼</option>
                            <option value="US">美股 🇺🇸</option>
                        </select>
                    </div>
                    <div class="md:col-span-2"> <label for="account-fee-discount" class="block text-sm font-medium text-stone-300 mb-1">手續費折數/費率</label>
                         <input type="number" id="account-fee-discount" min="0" step="any" required value="0.28" class="block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="flex items-center space-x-2 self-end md:col-span-3"> <button id="add-account-btn" title="新增帳戶" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">＋</button>
                            <button id="edit-account-btn" title="編輯帳戶" class="flex-shrink-0 bg-stone-500 hover:bg-stone-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">✏️</button>
                            <button id="delete-account-btn" title="刪除帳戶" class="flex-shrink-0 bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md hidden">－</button>
                    </div>
                </div>
            </div>

            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700 space-y-4">
                <h2 id="view-title" class="text-2xl font-bold text-stone-100 tracking-tight">總覽</h2>
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="stock-search" class="block text-sm font-medium text-stone-300 mb-2">搜尋或選擇檢視項目</label>
                        <input type="text" id="stock-search" placeholder="輸入代號篩選..." class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                    </div>
                    <div class="md:col-span-5">
                        <label for="stock-filter" class="block text-sm font-medium text-transparent mb-2 select-none">.</label>
                        <select id="stock-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div class="md:col-span-1">
                        <label id="shares-title" class="block text-sm font-medium text-stone-300 mb-2">全部檔數</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalShares" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="avg-cost-box" class="md:col-span-2">
                        <label id="avg-cost-title" class="block text-sm font-medium text-stone-300 mb-2">平均成本</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="avgCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="total-cost-box" class="md:col-span-2">
                        <label id="total-cost-title" class="block text-sm font-medium text-stone-300 mb-2">總成本</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-stone-800 rounded-2xl shadow-lg border border-stone-700">
                <div id="collapsible-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-stone-100">新增交易紀錄</h2>
                    <span id="collapse-icon" class="text-stone-400 transform transition-transform duration-300">▼</span>
                </div>
                <div id="collapsible-content" class="collapsible-content">
                    <div class="p-4 pt-0">
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-stone-700">
                            <form id="add-transaction-form" class="space-y-4">
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label for="tx-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                                        <input type="text" id="tx-symbol" required placeholder="例如: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="tx-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="tx-date" class="block text-sm font-medium text-stone-300">日期</label>
                                        <input type="date" id="tx-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-shares" class="block text-sm font-medium text-stone-300">股數</label>
                                        <input type="number" id="tx-shares" min="0" step="any" required placeholder="1000" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-price" class="block text-sm font-medium text-stone-300">價格(均價)</label>
                                        <input type="number" id="tx-price" min="0" step="any" required placeholder="600.5" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                            </form>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <button type="button" id="add-buy-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">買入</button>
                                <button type="button" id="add-sell-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">賣出</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="history-title" class="text-xl font-semibold text-stone-100">交易歷史紀錄</h2>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <button id="import-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯入資料</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="export-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯出資料</button>
                    </div>
                </div>
                <div class="overflow-x-auto table-scrollbar">
                    <table class="min-w-full divide-y divide-stone-700">
                        <thead class="bg-stone-900">
                            </thead>
                        <tbody id="transaction-list" class="divide-y divide-stone-700">
                            </tbody>
                    </table>
                    <p id="no-data-msg" class="text-center py-8 text-stone-500">尚無交易紀錄</p>
                </div>
                 <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-stone-400 hidden">
                    <button id="prev-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">&lt; 上一頁</button>
                    <span id="page-info">第 1 / 1 頁</span>
                    <button id="next-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">下一頁 &gt;</button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="message-modal-title" class="text-lg font-semibold text-stone-100">提示</h3>
            <p id="message-modal-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">確認</button>
            </div>
        </div>
    </div>

    <div id="add-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">新增帳戶</h3>
            <form id="add-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="new-account-name" class="block text-sm font-medium text-stone-300">帳戶名稱</label>
                    <input type="text" id="new-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div>
                    <label for="new-account-market-type" class="block text-sm font-medium text-stone-300">市場類型</label>
                    <select id="new-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                        <option value="TW">台股 (TW)</option>
                        <option value="US">美股 (US)</option>
                    </select>
                </div>
                <div>
                    <label for="new-account-fee-discount" class="block text-sm font-medium text-stone-300">手續費折數/費率</label>
                    <input type="number" id="new-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">建立</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">修改帳戶</h3>
            <form id="edit-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="edit-account-name" class="block text-sm font-medium text-stone-300">新帳戶名稱</label>
                    <input type="text" id="edit-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div>
                    <label for="edit-account-market-type" class="block text-sm font-medium text-stone-300">市場類型</label>
                    <select id="edit-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                        <option value="TW">台股 (TW)</option>
                        <option value="US">美股 (US)</option>
                    </select>
                </div>
                 <div>
                    <label for="edit-account-fee-discount" class="block text-sm font-medium text-stone-300">手續費折數/費率</label>
                    <input type="number" id="edit-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-4 rounded-lg transition">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-md w-full shadow-2xl transform scale-95">
            <h3 id="edit-modal-title" class="text-lg font-semibold text-stone-100">編輯交易紀錄</h3>
            <form id="edit-transaction-form" class="mt-4 space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <div class="grid grid-cols-4 gap-4">
                    <div class="col-span-2">
                        <label for="edit-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                        <input type="text" id="edit-symbol" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                        <small id="edit-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                    </div>
                    <div class="col-span-2">
                         <label for="edit-date" class="block text-sm font-medium text-stone-300">日期</label>
                         <input type="date" id="edit-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="col-span-2">
                         <label for="edit-shares" class="block text-sm font-medium text-stone-300">股數</label>
                         <input type="number" id="edit-shares" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="col-span-2">
                         <label for="edit-price" class="block text-sm font-medium text-stone-300">價格</label>
                         <input type="number" id="edit-price" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-transaction-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-rose-400">確認刪除帳戶</h3>
            <p id="delete-account-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="delete-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                <button type="button" id="delete-account-confirm" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">確認刪除</button>
            </div>
        </div>
    </div>
    
    <div id="clear-history-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-amber-400">確認清除紀錄</h3>
            <p id="clear-history-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="clear-history-later-btn" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">否 (10天後清除)</button>
                <button type="button" id="clear-history-now-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">是 (立即清除)</button>
            </div>
        </div>
    </div>

    <script>
        // DOMContentLoaded 事件確保在執行腳本前，HTML 已完全載入和解析
        document.addEventListener('DOMContentLoaded', () => {

            // *** Firebase 修改 ***: 獲取 Firebase 服務實例
            const auth = firebase.auth();
            const db = firebase.database();
            const provider = new firebase.auth.GoogleAuthProvider();

            // --- 常數定義 ---
            const FEE_RATE = 0.001425; // 證交稅手續費率 (券商收取, 僅台股)
            const TAX_RATE = 0.003;    // 證券交易稅率 (賣出時政府收取, 僅台股)

            // --- DOM 元素宣告 ---
            // [ ... 所有的 DOM 元素宣告保持不變 ... ]
            const addTransactionForm = document.getElementById('add-transaction-form'); // 新增交易的表單
            const addBuyBtn = document.getElementById('add-buy-btn'); // "買入" 按鈕
            const addSellBtn = document.getElementById('add-sell-btn'); // "賣出" 按鈕
            const addAccountForm = document.getElementById('add-account-form'); // 新增帳戶的表單 (Modal 內)
            const editAccountForm = document.getElementById('edit-account-form'); // 編輯帳戶的表單 (Modal 內)
            const transactionList = document.getElementById('transaction-list'); // 交易列表的 tbody
            const totalSharesEl = document.getElementById('totalShares'); // 顯示總股數/檔數的元素
            const avgCostEl = document.getElementById('avgCost'); // 顯示平均成本/總成本(不含費用)的元素
            const totalCostEl = document.getElementById('totalCost'); // 顯示總成本(含費用)的元素
            const avgCostTitle = document.getElementById('avg-cost-title'); // 平均成本標題元素
            const totalCostTitle = document.getElementById('total-cost-title'); // 總成本標題元素
            const avgCostBox = document.getElementById('avg-cost-box'); // 平均成本顯示區塊
            const totalCostBox = document.getElementById('total-cost-box'); // 總成本顯示區塊
            const exportBtn = document.getElementById('export-btn'); // 匯出按鈕
            const importBtn = document.getElementById('import-btn'); // 匯入按鈕
            const importFile = document.getElementById('import-file'); // 檔案選擇輸入框 (隱藏)
            const noDataMsg = document.getElementById('no-data-msg'); // "尚無交易紀錄" 的提示訊息
            const accountFilter = document.getElementById('account-filter'); // 帳戶選擇下拉選單
            const accountFeeDiscountInput = document.getElementById('account-fee-discount'); // 主畫面顯示/修改帳戶手續費折數的輸入框
            const accountMarketTypeInput = document.getElementById('account-market-type'); // *** 新增 ***: 主畫面市場類型
            const stockFilter = document.getElementById('stock-filter'); // 股票選擇下拉選單
            const stockSearch = document.getElementById('stock-search'); // 股票搜尋輸入框
            const viewTitle = document.getElementById('view-title'); // 主標題 (總覽/個別檢視)
            const sharesTitle = document.getElementById('shares-title'); // 總股數/檔數區塊的標題
            const historyTitle = document.getElementById('history-title'); // 交易歷史/庫存明細區塊的標題
            // Modal 相關元素
            const messageModal = document.getElementById('message-modal'); // 通用訊息 Modal
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalMessage = document.getElementById('message-modal-message');
            const messageModalClose = document.getElementById('message-modal-close');
            const addAccountModal = document.getElementById('add-account-modal'); // 新增帳戶 Modal
            const addAccountBtn = document.getElementById('add-account-btn');
            const addAccountCancelBtn = document.getElementById('add-account-cancel');
            const newAccountFeeDiscountInput = document.getElementById('new-account-fee-discount'); // 新增帳戶 Modal 內的折數輸入
            const newAccountMarketTypeInput = document.getElementById('new-account-market-type'); // *** 新增 ***: 新增帳戶 Modal 市場類型
            const editAccountModal = document.getElementById('edit-account-modal'); // 編輯帳戶 Modal
            const editAccountBtn = document.getElementById('edit-account-btn');
            const editAccountCancelBtn = document.getElementById('edit-account-cancel');
            const editAccountNameInput = document.getElementById('edit-account-name'); // 編輯帳戶 Modal 內的名稱輸入
            const editAccountFeeDiscountInput = document.getElementById('edit-account-fee-discount'); // 編輯帳戶 Modal 內的折數輸入
            const editAccountMarketTypeInput = document.getElementById('edit-account-market-type'); // *** 新增 ***: 編輯帳戶 Modal 市場類型
            const deleteAccountBtn = document.getElementById('delete-account-btn'); // 刪除帳戶按鈕
            const deleteAccountModal = document.getElementById('delete-account-modal'); // 刪除帳戶確認 Modal
            const deleteAccountMessage = document.getElementById('delete-account-message');
            const deleteAccountCancelBtn = document.getElementById('delete-account-cancel');
            const deleteAccountConfirmBtn = document.getElementById('delete-account-confirm');
            const clearHistoryModal = document.getElementById('clear-history-modal'); // 清除歷史紀錄確認 Modal
            const clearHistoryMessage = document.getElementById('clear-history-message');
            const clearHistoryLaterBtn = document.getElementById('clear-history-later-btn'); // 10天後清除按鈕
            const clearHistoryNowBtn = document.getElementById('clear-history-now-btn'); // 立即清除按鈕
            // 分頁相關元素
            const paginationControls = document.getElementById('pagination-controls'); // 分頁控制區塊
            const prevPageBtn = document.getElementById('prev-page-btn'); // 上一頁按鈕
            const nextPageBtn = document.getElementById('next-page-btn'); // 下一頁按鈕
            const pageInfo = document.getElementById('page-info'); // 頁碼資訊
            // 可摺疊區塊相關元素
            const collapsibleHeader = document.getElementById('collapsible-header'); // 新增交易區塊的標頭
            const collapsibleContent = document.getElementById('collapsible-content'); // 新增交易區塊的內容
            const collapseIcon = document.getElementById('collapse-icon'); // 摺疊圖標
            // 編輯交易 Modal 相關元素
            const editTransactionModal = document.getElementById('edit-transaction-modal'); // 編輯交易 Modal
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const editModalTitle = document.getElementById('edit-modal-title');
            const editTransactionCancelBtn = document.getElementById('edit-transaction-cancel');
            // 登入/主應用容器
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            // --- 應用程式狀態變數 ---
            let appData = {}; // 存放所有應用程式資料 (帳戶、交易紀錄等)
            let currentPage = 1; // 目前顯示的交易歷史頁碼
            let symbolToClear = null; // 暫存等待確認是否清除歷史紀錄的股票代號
            let debounceTimer; // 用於輸入延遲處理的計時器
            let currentUid = null; // *** Firebase 修改 ***: 儲存目前登入使用者的 UID
            let dataListener = null; // *** Firebase 修改 ***: 儲存 Firebase 監聽器

            // --- 股票代號與名稱對應表 ---
            // [ ... stockNameMap 內容保持不變 ... ]
            const stockNameMap = {
				"0050": "元大台灣50",
                "0051": "元大中型100",
                "0052": "富邦科技",
                "0053": "元大電子",
                "0055": "元大MSCI金融",
                "0056": "元大高股息",
                "0057": "富邦摩台",
                "0061": "元大寶滬深",
                "006201": "元大寶櫃50",
                "006203": "元大MSCI台灣",
                "006204": "永豐臺灣加權",
                "006205": "富邦上証",
                "006206": "元大上證50",
                "006207": "復華滬深",
                "006208": "富邦台50",
                "00631L": "元大台灣50正2",
                "00632R": "元大台灣50反1",
                "00633L": "富邦上証正2",
                "00634R": "富邦上証反1",
                "00635U": "期元大S&P黃金",
                "00636": "國泰中國A50",
                "00637L": "元大滬深300正2",
                "00638R": "元大滬深300反1",
                "00639": "富邦深100",
                "00640L": "富邦日本正2",
                "00641R": "富邦日本反1",
                "00642U": "期元大S&P石油",
                "00643": "群益深証中小",
                "00645": "富邦日本",
                "00646": "元大S&P500",
                "00647L": "元大S&P500正2",
                "00648R": "元大S&P500反1",
                "00650L": "復華香港正2",
                "00651R": "復華香港反1",
                "00652": "富邦印度",
                "00653L": "富邦印度正2",
                "00654R": "富邦印度反1",
                "00655L": "國泰中國A50正2",
                "00656R": "國泰中國A50反1",
                "00657": "國泰日經225",
                "00660": "元大歐洲50",
                "00661": "元大日經225",
                "00662": "富邦NASDAQ",
                "00663L": "國泰臺灣加權正2",
                "00664R": "國泰臺灣加權反1",
                "00665L": "富邦恒生國企正2",
                "00666R": "富邦恒生國企反1",
                "00668": "國泰美國道瓊",
                "00669R": "國泰美國道瓊反1",
                "00670L": "富邦NASDAQ正2",
                "00671R": "富邦NASDAQ反1",
                "00673R": "期元大S&P原油反1",
                "00674R": "期元大S&P黃金反1",
                "00675L": "富邦臺灣加權正2",
                "00676R": "富邦臺灣加權反1",
                "00678": "群益那斯達క్生技",
                "00679B": "元大美債20年",
                "00680L": "元大美債20正2",
                "00681R": "元大美債20反1",
                "00682U": "期元大美元指數",
                "00683L": "期元大美元指正2",
                "00684R": "期元大美元指反1",
                "00685L": "群益臺灣加權正2",
                "00686R": "群益臺灣加權反1",
                "00687B": "國泰20年美債",
                "00688L": "國泰20年美債正2",
                "00689R": "國泰20年美債反1",
                "00690": "兆豐台灣藍籌30",
                "00692": "富邦公司治理",
                "00693U": "期街口S&P黃豆",
                "00695B": "富邦美債7-10年",
                "00696B": "富邦美債20年",
                "00697B": "元大美債7-10",
                "00700": "富邦恆生國企",
                "00701": "國泰股利精選30",
                "00702": "國泰標普低波高息",
                "00703": "台新MSCI中國",
                "00706L": "期元大S&P日圓正2",
                "00707R": "期元大S&P日圓反1",
                "00708L": "期元大S&P黃金正2",
                "00709": "富邦歐洲",
                "00710B": "復華彭博非投等債",
                "00711B": "復華彭博新興債",
                "00712": "復華富時不動產",
                "00713": "元大台灣高息低波",
                "00714": "群益道瓊美國地產",
                "00715L": "期街口布蘭特正2",
                "00717": "富邦美國特別股",
                "00719B": "元大美債1-3",
                "00720B": "元大投資級公司債",
                "00722B": "群益投資級電信債",
                "00723B": "群益投資級科技債",
                "00724B": "群益投資級金融債",
                "00725B": "國泰投資級公司債",
                "00726B": "國泰新興投等債",
                "00727B": "國泰優選投頭等債",
                "00728": "第一金工業30",
                "00730": "富邦臺灣優質高息",
                "00731": "復華富時高息低波",
                "00733": "富邦臺灣中小",
                "00734B": "台新JPM新興債",
                "00735": "國泰臺韓科技",
                "00736": "國泰新興市場",
                "00737": "國泰AI機器人",
                "00738U": "期元大道瓊白銀",
                "00739": "元大MSCI A股",
                "00740B": "富邦全球投等債",
                "00741B": "富邦全球非投等債",
                "00746B": "富邦A級公司債",
                "00749B": "凱基新興債10+",
                "00750B": "凱基科技債10+",
                "00751B": "元大AAA至A公司債",
                "00752": "中信中國5G",
                "00753L": "中信中國5G正2",
                "00757": "統一FANG+",
                "00758B": "復華能源債",
                "00759B": "復華製藥債",
                "00760B": "復華新興企業債",
                "00761B": "國泰A級公司債",
                "00762": "元大全球AI",
                "00764B": "復華20年美債",
                "00770": "國泰北美科技",
                "00771": "元大US高息特別股",
                "00772B": "中信高評級公司債",
                "00773B": "中信優先金融債",
                "00775B": "新光投等債15+",
                "00777B": "凱基AAA至A公司債",
                "00778B": "凱基金融債20+",
                "00779B": "凱基美債25+",
                "00780B": "國泰A級金融債",
                "00781B": "國泰A級科技債",
                "00782B": "國泰A級公用債",
                "00783": "富邦中証500",
                "00785B": "富邦金融投等債",
                "00786B": "元大10年IG銀行債",
                "00787B": "元大10年IG醫療債",
                "00788B": "元大10年IG電能債",
                "00789B": "復華公司債A3",
                "00791B": "復華信用債1-5",
                "00792B": "群益A級公司債",
                "00793B": "群益AAA-A醫療債",
                "00795B": "中信美國公債20年",
                "00799B": "國泰A級醫療債",
                "00830": "國泰費城半導體",
                "00834B": "第一金融債10+",
                "00836B": "永豐10年A公司債",
                "00850": "元大臺灣ESG永續",
                "00851": "台新全球AI",
                "00858": "永豐美國500大",
                "00861": "元大全球未來通訊",
                "00870B": "元大15年EM主權債",
                "00875": "國泰網路資安",
                "00876": "元大全球5G",
                "00877": "復華中國5G",
                "00878": "國泰永續高股息",
                "00881": "國泰台灣科技龍頭",
                "00882": "中信中國高股息",
                "00885": "富邦越南",
                "00886": "永豐美國科技",
                "00888": "永豐台灣ESG",
                "00891": "中信關鍵半導體",
                "00892": "富邦台灣半導體",
                "00893": "國泰智能電動車",
                "00894": "中信小資高價30",
                "00895": "富邦未來車",
                "00896": "中信綠能及電動車",
                "00897": "富邦基因免疫生技",
                "00898": "國泰基因免疫革命",
                "00899": "FT潔淨能源",
                "00900": "富邦特選高股息30",
                "00901": "永豐智能車供應鏈",
                "00902": "中信電池及儲能",
                "00903": "富邦元宇宙",
                "00904": "新光臺灣半導體30",
                "00905": "FT臺灣Smart",
                "00907": "永豐優息存股",
                "00908": "富邦入息REITs+",
                "00909": "國泰數位支付服務",
                "00910": "第一金太空衛星",
                "00911": "兆豐洲際半導體",
                "00912": "中信臺灣智慧50",
                "00913": "兆豐台灣晶圓製造",
                "00915": "凱基優選高股息30",
                "00917": "中信特選金融",
                "00918": "大華優利高填息30",
                "00919": "群益台灣精選高息",
                "00920": "富邦ESG綠色電力",
                "00921": "兆豐龍頭等權重",
                "00922": "國泰台灣領袖50",
                "00923": "群益台灣ESG低碳",
                "00924": "復華S&P500成長",
                "00926": "凱基全球菁英55",
                "00927": "群益半導體收益",
                "00928": "中信上櫃ESG 30",
                "00929": "復華台灣科技優息",
                "00930": "永豐ESG低碳高息",
                "00932": "兆豐永續高息等權",
                "00933B": "國泰10Y+金融債",
                "00934": "中信成長高股息",
                "00935": "野村臺灣新科技50",
                "00936": "台新永續高息中小",
                "00937B": "群益ESG投等債20+",
                "00938": "凱基優選30",
                "00939": "統一台灣高息動能",
                "00940": "元大台灣價值高息",
                "00941": "中信上游半導體",
                "00943": "兆豐電子高息等權",
                "00944": "野村趨勢動能高息",
                "00946": "群益科技高息成長",
                "00947": "台新台灣IC設計",
                "00949": "復華日本龍頭",
                "00951": "台新日本半導體",
                "00952": "凱基台灣AI50",
                "00954": "中信日本半導體",
                "00955": "中信日本商社",
                "00956": "中信日經高股息",
                "00960": "野村全球航運龍頭",
                "00961": "FT台灣永續高息",
                "00962": "台新AI優息動能",
                "00963": "中信全球高股息",
                "00964": "中信亞太高股息",
                "00965": "元大航太防衛科技",
                "00971": "野村美國研發龍頭",
                "00972": "野村日本動neng高息",
                "009800": "中信NASDAQ",
                "009801": "中信美國創新科技",
                "009802": "富邦旗艦50",
                "009803": "保德信市值動能50",
                "009804": "聯邦台精彩50",
                "009805": "新光美國電力基礎",
                "009806": "台新標普500",
                "009807": "台新標普科技精選",
                "009808": "華南永昌優選50",
                "00980A": "主動野村臺灣優選",
                "009810": "保德信全球藍籌",
                "0D9811": "統一美國50",
                "009812": "野村日本東証",
                "00981A": "主動統一台股增長",
                "00982A": "主動群益臺灣強棒",
                "00983A": "主動中信ARK創新",
                "00984A": "主動安聯臺灣高息",
                "00985A": "主動野村臺灣50",
                "00986A": "主動台新龍頭成長",
			};
            
            /**
             * *** Firebase 修改 ***:
             * 設定 Firebase Realtime Database 的資料監聽器。
             * 當使用者登入時，此函式會被觸發，用來獲取雲端資料或初始化新使用者的資料。
             * @param {string} uid - 使用者的唯一 ID。
             */
            function setupDataListener(uid) {
                // 如果已有監聽器，先移除舊的，避免重複監聽
                if (dataListener) {
                    dataListener.off();
                }
                
                // 設定目前使用者的 UID
                currentUid = uid;
                // 建立指向該使用者資料庫路徑的引用
                const dbRef = db.ref('users/' + uid + '/appData');
                
                // *** Firebase 修改 ***: 使用 onValue 監聽資料變化 (取代 localStorage.getItem)
                // onValue 會在初次載入和資料變更時觸發
                dataListener = dbRef.on('value', (snapshot) => {
                    let storedData = null;
                    if (snapshot.exists()) {
                        // 如果雲端有資料，則使用它
                        storedData = snapshot.val();
                    }
                    
                    // --- 初始化或載入應用程式資料 (appData) ---
                    if (storedData && storedData.accounts) {
                        appData = storedData;
                    } else {
                        // 否則，初始化一個包含預設帳戶的新資料結構
                        appData = { 
                            accounts: { 
                                '預設帳戶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } 
                            }, 
                            currentAccount: '預設帳戶'
                        };
                        // *** Firebase 修改 ***: 將新使用者的預設資料存回 Firebase
                        saveDataToFirebase();
                    }
                    
                    // --- 確保目前選中的帳戶 (currentAccount) 是有效的 ---
                    if (!appData.accounts[appData.currentAccount]) {
                        appData.currentAccount = Object.keys(appData.accounts)[0] || '預設帳戶';
                        if (!appData.accounts[appData.currentAccount]) {
                                appData.accounts['預設帳戶'] = { transactions: [], feeDiscount: 0.28, marketType: 'TW' }; 
                        }
                    }
                    
                    // --- 資料遷移與清理 ---
                    // (這段邏輯保持不變，它能確保從舊版本匯入或殘留的資料結構保持最新)
                    let needsSave = false; 
                    for (const accountName in appData.accounts) {
                        const accountData = appData.accounts[accountName]; 

                        if (Array.isArray(accountData)) {
                            console.log(`偵測到帳戶 ${accountName} 為舊格式，進行遷移...`);
                            let initialFeeDiscount = 0.28; 
                            if (accountData.length > 0 && accountData[0].feeDiscount !== undefined) {
                                initialFeeDiscount = accountData[0].feeDiscount;
                            }
                            appData.accounts[accountName] = { 
                                transactions: accountData, 
                                feeDiscount: initialFeeDiscount, 
                                marketType: 'TW' 
                            };
                            needsSave = true; 
                        } 
                        else if (typeof accountData !== 'object' || accountData === null) {
                             appData.accounts[accountName] = { transactions: [], feeDiscount: 0.28, marketType: 'TW' };
                             needsSave = true;
                        } 
                        else {
                             if (!Array.isArray(accountData.transactions)) {
                                accountData.transactions = [];
                                needsSave = true;
                             }
                             if (accountData.feeDiscount === undefined) {
                                 accountData.feeDiscount = 0.28;
                                 needsSave = true;
                             }
                             if (accountData.marketType === undefined) {
                                 accountData.marketType = 'TW';
                                 needsSave = true;
                             }
                        }

                        const transactions = appData.accounts[accountName].transactions; 
                        const accountFeeDiscount = appData.accounts[accountName].feeDiscount; 
                        const accountMarketType = appData.accounts[accountName].marketType || 'TW';

                        transactions.forEach(tx => {
                            if (!tx.name) tx.name = stockNameMap[tx.symbol] || '';
                            if (tx.reviewed === undefined) tx.reviewed = false; 
                            if (tx.price === undefined) { tx.price = 0; needsSave = true; }
                            
                            const amount = tx.price * tx.shares;

                            if (tx.fee === undefined || tx.feeDiscount !== undefined) {
                                let fee = 0;
                                if (accountMarketType === 'TW') {
                                    fee = amount * FEE_RATE * accountFeeDiscount; 
                                    if (tx.type === 'SELL') {
                                        fee += (amount * TAX_RATE);
                                    }
                                } else { // 'US'
                                    fee = amount * accountFeeDiscount;
                                }
                                tx.fee = fee;
                                
                                if (tx.type === 'BUY') {
                                    tx.totalTxCost = amount + tx.fee; 
                                }
                                needsSave = true;
                            }
                            
                            if (tx.feeDiscount !== undefined) {
                                delete tx.feeDiscount;
                                needsSave = true;
                            }
                        });
                    }
                    
                    // *** Firebase 修改 ***: 如果資料遷移有變動，存回 Firebase
                    if (needsSave) {
                        saveDataToFirebase();
                        console.log("資料結構已更新或遷移完成。");
                    }
                    
                    // --- 清理過期的待刪除交易 ---
                    cleanupExpiredTransactions(); // (此函式內部會呼叫 saveDataToFirebase)
                    
                    // --- 恢復摺疊狀態 (這部分仍使用 localStorage，因為它純粹是 UI 偏好，不需要跨裝置同步) ---
                    const isCollapsed = localStorage.getItem('isFormCollapsed_SharesOnly') === 'true';
                    if (isCollapsed) {
                        collapsibleContent.style.maxHeight = null;
                        collapseIcon.style.transform = 'rotate(-90deg)';
                    } else {
                        collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                        collapseIcon.style.transform = 'rotate(0deg)';
                    }
                    
                    // --- 更新介面元件 ---
                    updateAccountFilterOptions(); 
                    updateAccountFeeDiscountDisplay(); 
                    updateAccountMarketTypeDisplay(); 
                    updateStockFilterOptions(); 
                    render(); // 重新渲染主要內容區域
                    
                }, (error) => {
                    console.error("Firebase 資料讀取失敗:", error);
                    showModal(messageModal, '連線錯誤', '無法從 Firebase 讀取資料。');
                });
            }

            /**
             * *** Firebase 修改 ***:
             * 將 appData 物件轉換為 JSON 字串並儲存到 Firebase Realtime Database。
             * 取代 saveDataToLocalStorage()
             */
            function saveDataToFirebase() {
                // 必須要有使用者 UID 和資料庫實例才能儲存
                if (!currentUid || !db) {
                    console.warn("尚未登入或 Firebase 未初始化，無法儲存資料。");
                    return;
                }
                
                try {
                    // 使用 'set' 將整個 appData 物件寫入使用者的路徑
                    db.ref('users/' + currentUid + '/appData').set(appData)
                        .catch((error) => {
                            // 處理可能的寫入錯誤
                            console.error("資料儲存至 Firebase 失敗:", error);
                            showModal(messageModal, '儲存失敗', '無法將資料同步至雲端。');
                        });
                } catch (error) {
                    console.error("資料儲存至 Firebase 失敗:", error);
                    showModal(messageModal, '儲存失敗', '無法將資料同步至雲端。');
                }
            }
            
            /**
             * 將新增交易表單中的日期欄位預設為今天。
             */
            function setDateToToday() {
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('tx-date').value = today;
            }

            /**
             * 清理標記為 "10天後刪除" 且已過期的交易紀錄。
             */
            function cleanupExpiredTransactions() {
                let changed = false; 
                const now = Date.now(); 
                for (const accountName in appData.accounts) {
                    const account = appData.accounts[accountName]; 
                    const transactions = account.transactions; 
                    if (!Array.isArray(transactions)) continue; 

                    const symbolsWithExpiredTimestamp = [...new Set(
                        transactions
                            .filter(tx => tx.deletionTimestamp && tx.deletionTimestamp <= now)
                            .map(tx => tx.symbol)
                    )];

                    symbolsWithExpiredTimestamp.forEach(symbol => {
                        const holdings = getCurrentHoldings(symbol, transactions); 
                        const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);

                        if (currentShares === 0) {
                            account.transactions = transactions.filter(tx => tx.symbol !== symbol); 
                        } 
                        else {
                            account.transactions.forEach(tx => { 
                                if (tx.symbol === symbol) {
                                    delete tx.deletionTimestamp;
                                }
                            });
                        }
                        changed = true; 
                    });
                }
                // *** Firebase 修改 ***: 如果資料有變動，則存回 Firebase
                if (changed) saveDataToFirebase(); 
            }
            
            // --- 後續所有函式 (updateAccountFilterOptions, render, calculateSummary, handleAddTransaction 等) 保持不變 ---
            // --- 唯一的修改是：在這些函式中，所有對 saveDataToLocalStorage() 的呼叫，都已替換為 saveDataToFirebase() ---
            
            function updateAccountFilterOptions() {
                if (!appData.accounts) {
                    appData.accounts = { '預設帳戶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } }; 
                    appData.currentAccount = '預設帳戶';
                }
                const accountNames = Object.keys(appData.accounts); 
                accountFilter.innerHTML = ''; 
                accountNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    accountFilter.appendChild(option);
                });
                accountFilter.value = appData.currentAccount;
                deleteAccountBtn.classList.toggle('hidden', accountNames.length <= 1);
                updateAccountFeeDiscountDisplay(); 
                updateAccountMarketTypeDisplay();
            }

             function updateAccountFeeDiscountDisplay() {
                 if (appData.accounts && appData.accounts[appData.currentAccount]) {
                     accountFeeDiscountInput.value = appData.accounts[appData.currentAccount].feeDiscount;
                 } else {
                      accountFeeDiscountInput.value = 0.28; 
                 }
            }
            
            function updateAccountMarketTypeDisplay() {
                 if (appData.accounts && appData.accounts[appData.currentAccount]) {
                     accountMarketTypeInput.value = appData.accounts[appData.currentAccount].marketType || 'TW';
                 } else {
                      accountMarketTypeInput.value = 'TW';
                 }
            }

            function updateStockFilterOptions() {
                const currentAccountData = appData.accounts[appData.currentAccount];
                const currentTransactions = currentAccountData ? currentAccountData.transactions : []; 
                
                const selectedValue = stockFilter.value; 
                const searchTerm = stockSearch.value.trim().toUpperCase(); 
                
                if (!Array.isArray(currentTransactions)) return; 

                let symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                
                if (searchTerm) {
                    symbols = symbols.filter(symbol => symbol.toUpperCase().includes(searchTerm));
                }

                symbols.sort(); 
                
                const isCurrentSelectionValid = symbols.includes(selectedValue) || selectedValue === '__ALL__';

                stockFilter.innerHTML = ''; 
                const allOption = document.createElement('option');
                allOption.value = '__ALL__';
                allOption.textContent = '全部庫存';
                stockFilter.appendChild(allOption);

                if (symbols.length > 0) {
                    symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = `${symbol} (${stockNameMap[symbol] || '未知'})`;
                        stockFilter.appendChild(option);
                    });
                }
                if (isCurrentSelectionValid) {
                     stockFilter.value = selectedValue;
                } else {
                     stockFilter.value = '__ALL__';
                }
            }
            
            function showModal(modalElement, title, message) {
                 if (modalElement === messageModal) {
                     messageModalTitle.textContent = title;
                     messageModalMessage.textContent = message;
                 }
                 modalElement.classList.remove('opacity-0', 'pointer-events-none');
                 modalElement.querySelector('.modal-content').classList.remove('scale-95');
            }
            
            function hideModal(modalElement) {
                modalElement.classList.add('opacity-0', 'pointer-events-none');
                modalElement.querySelector('.modal-content').classList.add('scale-95');
            }
            
            messageModalClose.addEventListener('click', () => hideModal(messageModal));
            addAccountBtn.addEventListener('click', () => {
                 newAccountFeeDiscountInput.value = 0.28; 
                 newAccountMarketTypeInput.value = 'TW'; 
                 showModal(addAccountModal);
            });
            addAccountCancelBtn.addEventListener('click', () => hideModal(addAccountModal));
            
            editAccountBtn.addEventListener('click', () => {
                editAccountNameInput.value = appData.currentAccount;
                editAccountFeeDiscountInput.value = appData.accounts[appData.currentAccount]?.feeDiscount || 0.28;
                editAccountMarketTypeInput.value = appData.accounts[appData.currentAccount]?.marketType || 'TW'; 
                showModal(editAccountModal);
            });
            editAccountCancelBtn.addEventListener('click', () => hideModal(editAccountModal));
            
            deleteAccountBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount;
                deleteAccountMessage.textContent = `您確定要刪除「${accountToDelete}」帳戶嗎？此帳戶內的所有交易紀錄將被永久移除，此操作無法復原。`;
                showModal(deleteAccountModal);
            });
            deleteAccountCancelBtn.addEventListener('click', () => hideModal(deleteAccountModal));
            
            function getCurrentHoldings(symbol, transactions) {
                if (!Array.isArray(transactions)) return []; 
                const activeTransactions = transactions.filter(tx => !tx.deletionTimestamp);
                const symbolTxs = activeTransactions.filter(tx => tx.symbol === symbol);
                const buyTxs = symbolTxs.filter(tx => tx.type === 'BUY').sort((a, b) => new Date(a.date) - new Date(b.date));
                const sellTxs = symbolTxs.filter(tx => tx.type === 'SELL');
                let sharesSold = sellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                
                const holdings = []; 
                for (const buyTx of buyTxs) {
                    const costBasis = buyTx.totalTxCost !== undefined ? buyTx.totalTxCost : (buyTx.price * buyTx.shares);
                    const costPerShare = buyTx.shares !== 0 ? costBasis / buyTx.shares : 0; 

                    if (sharesSold <= 0) {
                        const { feeDiscount, ...restOfBuyTx } = buyTx; 
                        holdings.push(restOfBuyTx); 
                        continue; 
                    }

                    if (buyTx.shares > sharesSold) {
                        const remainingShares = buyTx.shares - sharesSold;
                        const { feeDiscount, ...restOfBuyTx } = buyTx; 
                        holdings.push({
                            ...restOfBuyTx, 
                            shares: remainingShares, 
                            totalTxCost: remainingShares * costPerShare 
                        });
                        sharesSold = 0; 
                    } 
                    else {
                        sharesSold -= buyTx.shares; 
                    }
                }
                return holdings; 
            }

            function render() {
                const currentAccountData = appData.accounts[appData.currentAccount];
                const currentTransactions = currentAccountData ? currentAccountData.transactions : []; 

                if (!Array.isArray(currentTransactions)) return; 
                
                const selectedValue = stockFilter.value; 
                const tableHead = transactionList.parentElement.querySelector('thead'); 
                transactionList.innerHTML = ''; 

                if (selectedValue === '__ALL__') {
                    paginationControls.classList.add('hidden'); 
                    viewTitle.textContent = '投資組合總覽'; 
                    historyTitle.textContent = '庫存明細'; 
                    avgCostBox.classList.remove('hidden'); 
                    totalCostBox.classList.remove('hidden'); 
                    calculatePortfolioSummary(currentTransactions); 
                    
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">更新狀態</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股票代號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股票名稱</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">持有股數</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">均價</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">總成本</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">均價(含費用)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">總成本(含費用)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">更新日期</th>
                        </tr>
                    `;
                    
                    const symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                    let portfolioDetails = symbols.map(symbol => {
                        const holdings = getCurrentHoldings(symbol, currentTransactions); 
                        const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); 
                        if (totalShares <= 0) return null; 

                        const totalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                        const averageCost = totalShares > 0 ? totalCost / totalShares : 0;
                        const baseTotalCost = holdings.reduce((sum, tx) => sum + (tx.shares * (tx.price || 0)), 0);
                        const averageBaseCost = totalShares > 0 ? baseTotalCost / totalShares : 0;

                        const symbolTransactions = currentTransactions.filter(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        const lastUpdateDate = symbolTransactions.reduce((max, tx) => (tx.date > max ? tx.date : max), '0000-00-00');
                        const name = (symbolTransactions.find(tx => tx.name) || {}).name || '';
                        
                        const isFullyReviewed = symbolTransactions.length > 0 && symbolTransactions.every(tx => tx.reviewed === true);

                        return { symbol, name, totalShares, baseTotalCost, averageBaseCost, averageCost, totalCost, lastUpdateDate, isFullyReviewed };
                    }).filter(Boolean); 

                    portfolioDetails.sort((a, b) => new Date(b.lastUpdateDate) - new Date(a.lastUpdateDate));

                    if (portfolioDetails.length > 0) {
                        portfolioDetails.forEach(detail => {
                            const row = document.createElement('tr'); 
                            row.className = 'hover:bg-stone-700/50'; 

                            const statusText = detail.isFullyReviewed ? '是' : '否';
                            const statusColor = detail.isFullyReviewed ? 'bg-emerald-800 text-emerald-100 hover:bg-emerald-700' : 'bg-stone-600 text-stone-200 hover:bg-stone-500';
                            const statusButtonHTML = `
                                <button class="px-3 py-1 text-xs font-semibold rounded-full transition-colors duration-200 ${statusColor}" data-symbol="${detail.symbol}" data-action="toggle-status-all">
                                    ${statusText}
                                </button>
                            `;
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${statusButtonHTML}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-100">${detail.symbol}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalShares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                                
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.averageBaseCost.toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.baseTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.averageCost.toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalCost.toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.lastUpdateDate}</td>
                                
                            `;
                            transactionList.appendChild(row); 
                        });
                    }
                    noDataMsg.textContent = '尚無任何庫存';
                    noDataMsg.classList.toggle('hidden', portfolioDetails.length > 0);
                
                } else {
                    const stockName = (currentTransactions.find(tx => tx.symbol === selectedValue) || {}).name || '';
                    viewTitle.textContent = `個別檢視: ${selectedValue}`; 
                    historyTitle.textContent = `交易歷史紀錄: ${selectedValue} ${stockName}`; 
                    avgCostBox.classList.remove('hidden'); 
                    totalCostBox.classList.remove('hidden'); 
                    calculateSummary(selectedValue, currentTransactions); 
                    
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">類型</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股數</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">價格</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">費用</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">操作</span></th>
                        </tr>
                    `;
                    const displayTransactions = currentTransactions.filter(tx => tx.symbol === selectedValue);
                    const sortedTransactions = [...displayTransactions].sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
                    
                    const itemsPerPage = 10; 
                    const totalPages = Math.ceil(sortedTransactions.length / itemsPerPage) || 1; 
                    if (currentPage > totalPages) currentPage = totalPages; 
                    const paginatedTransactions = sortedTransactions.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                    paginationControls.classList.toggle('hidden', sortedTransactions.length <= itemsPerPage);
                    pageInfo.textContent = `第 ${currentPage} / ${totalPages} 頁`;
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages;
                    
                    paginatedTransactions.forEach(tx => {
                        const row = document.createElement('tr'); 
                        row.className = 'hover:bg-stone-700/50 transition-colors duration-200'; 

                        const typeCell = tx.type === 'BUY' 
                            ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-sky-900 text-sky-200">買入</span>`
                            : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-rose-900 text-rose-200">賣出</span>`;

                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${typeCell}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.shares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${(tx.price || 0).toLocaleString('en-US', {maximumFractionDigits: 4})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${(tx.fee || 0).toLocaleString('en-US', {maximumFractionDigits: 2})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                <button class="text-stone-400 hover:text-stone-200" data-id="${tx.id}" data-action="edit">編輯</button>
                                <button class="text-rose-400 hover:text-rose-500" data-id="${tx.id}" data-action="delete">刪除</button>
                            </td>
                        `;
                        transactionList.appendChild(row); 
                    });
                    noDataMsg.textContent = '尚無交易紀錄';
                    noDataMsg.classList.toggle('hidden', displayTransactions.length > 0);
                }
            }

            function calculateSummary(symbol, transactions) {
                sharesTitle.textContent = '持有股數';
                avgCostTitle.textContent = '平均成本(含費用)';
                totalCostTitle.textContent = '總成本(含費用)';

                if (!Array.isArray(transactions)) {
                    totalSharesEl.textContent = '0';
                    avgCostEl.textContent = '0';
                    totalCostEl.textContent = '0';
                    return;
                }
                const holdings = getCurrentHoldings(symbol, transactions);
                const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                const totalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                const averageCost = totalShares > 0 ? totalCost / totalShares : 0;
                
                totalSharesEl.textContent = totalShares.toLocaleString('en-US', {maximumFractionDigits: 8});
                avgCostEl.textContent = averageCost.toLocaleString('en-US', {maximumFractionDigits: 4});
                totalCostEl.textContent = totalCost.toLocaleString('en-US', {maximumFractionDigits: 2});
            }
            
            function calculatePortfolioSummary(transactions) {
                sharesTitle.textContent = '全部檔數';
                avgCostTitle.textContent = '總成本(不含費用)'; 
                totalCostTitle.textContent = '總成本(含費用)';

                if (!Array.isArray(transactions)) {
                    totalSharesEl.textContent = '0';
                    avgCostEl.textContent = '0'; 
                    totalCostEl.textContent = '0';
                    return;
                }
                const symbols = [...new Set(transactions.map(tx => tx.symbol))];
                let portfolioStockCount = 0; 
                let portfolioTotalCost = 0; 
                let portfolioBaseTotalCost = 0; 
                
                symbols.forEach(symbol => {
                    const holdings = getCurrentHoldings(symbol, transactions); 
                    const symbolTotalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); 
                    if (symbolTotalShares > 0) {
                        portfolioStockCount++; 
                        const symbolTotalCost = holdings.reduce((sum, tx) => sum + (tx.totalTxCost || 0), 0);
                        portfolioTotalCost += symbolTotalCost;
                        const symbolBaseTotalCost = holdings.reduce((sum, tx) => sum + (tx.shares * (tx.price || 0)), 0);
                        portfolioBaseTotalCost += symbolBaseTotalCost;
                    }
                });
                
                totalSharesEl.textContent = new Intl.NumberFormat().format(portfolioStockCount);
                avgCostEl.textContent = portfolioBaseTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2}); 
                totalCostEl.textContent = portfolioTotalCost.toLocaleString('en-US', {maximumFractionDigits: 2});
            }

            function handleAddTransaction(e, transactionType) {
                e.preventDefault(); 
                const symbol = document.getElementById('tx-symbol').value.trim().toUpperCase();
                const name = stockNameMap[symbol] || ''; 
                const date = document.getElementById('tx-date').value;
                const shares = parseFloat(document.getElementById('tx-shares').value);
                const price = parseFloat(document.getElementById('tx-price').value); 
                const currentAccount = appData.accounts[appData.currentAccount];
                const feeDiscount = currentAccount?.feeDiscount || 0.28; 
                const marketType = currentAccount?.marketType || 'TW';
                
                if (!symbol) { showModal(messageModal, '輸入錯誤', '請輸入股票代號。'); return; }
                if (isNaN(shares) || shares <= 0) { showModal(messageModal, '輸入錯誤', '請檢查股數是否為有效的正數。'); return; }
                if (isNaN(price) || price < 0) { showModal(messageModal, '輸入錯誤', '請檢查價格(均價)是否為有效的數字。'); return; }

                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 
                
                if (transactionType === 'SELL') {
                    const holdings = getCurrentHoldings(symbol, currentTransactions); 
                    const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0); 
                    if (shares > currentShares) {
                        showModal(messageModal, '賣出失敗', `您只有 ${currentShares.toLocaleString('en-US', {maximumFractionDigits: 8})} 股，無法賣出 ${shares} 股。`);
                        return;
                    }
                }

                const amount = price * shares; 
                let fee = 0; 
                let totalTxCost = 0; 

                if (marketType === 'TW') {
                    fee = amount * FEE_RATE * feeDiscount; 
                    if (transactionType === 'BUY') {
                        totalTxCost = amount + fee; 
                    } else { // 'SELL'
                        fee += (amount * TAX_RATE); 
                    }
                } else { // 'US'
                    fee = amount * feeDiscount; 
                    if (transactionType === 'BUY') {
                        totalTxCost = amount + fee;
                    } else { // 'SELL'
                    }
                }
                
                const newTransaction = { 
                    id: Date.now(), 
                    type: transactionType, 
                    symbol, 
                    name, 
                    date, 
                    shares, 
                    price, 
                    fee: Math.round(fee * 100) / 100, 
                    reviewed: false 
                };

                if (transactionType === 'BUY') {
                    newTransaction.totalTxCost = totalTxCost; 
                }

                currentTransactions.push(newTransaction); 
                saveDataToFirebase(); // *** Firebase 修改 ***
                
                addTransactionForm.reset(); 
                setDateToToday(); 
                
                if (transactionType === 'SELL') {
                    const updatedHoldings = getCurrentHoldings(symbol, currentTransactions); 
                    const remainingShares = updatedHoldings.reduce((sum, tx) => sum + tx.shares, 0); 
                    if (remainingShares === 0) {
                        symbolToClear = symbol;
                        clearHistoryMessage.textContent = `股票 ${symbol} 的庫存已為零，是否要清除其所有相關交易歷史紀錄？`;
                        showModal(clearHistoryModal);
                    } else {
                        updateStockFilterOptions();
                        stockFilter.value = symbol; 
                        currentPage = 1; 
                        render();
                    }
                } 
                else {
                    updateStockFilterOptions();
                    stockFilter.value = symbol; 
                    currentPage = 1; 
                    render();
                }
            }


            addBuyBtn.addEventListener('click', (e) => handleAddTransaction(e, 'BUY'));
            addSellBtn.addEventListener('click', (e) => handleAddTransaction(e, 'SELL'));

            transactionList.addEventListener('click', (e) => {
                const target = e.target.closest('button'); 
                if (!target || !target.dataset.action) return;

                const action = target.dataset.action; 
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 

                if (action === 'delete' || action === 'edit') {
                    const id = parseInt(target.dataset.id, 10); 
                    if (action === 'delete') {
                        currentAccountData.transactions = currentTransactions.filter(tx => tx.id !== id); 
                        saveDataToFirebase(); // *** Firebase 修改 ***
                        updateStockFilterOptions(); 
                        render(); 
                    } 
                    else if (action === 'edit') {
                        const tx = currentTransactions.find(t => t.id === id);
                        if (tx) {
                            document.getElementById('edit-transaction-id').value = tx.id;
                            document.getElementById('edit-symbol').value = tx.symbol;
                            document.getElementById('edit-date').value = tx.date;
                            document.getElementById('edit-shares').value = tx.shares;
                            document.getElementById('edit-price').value = tx.price || 0; 
                            editModalTitle.textContent = `編輯 ${tx.symbol} (${tx.type === 'BUY' ? '買入' : '賣出'})`; 
                            document.getElementById('edit-symbol').dispatchEvent(new Event('input')); 
                            showModal(editTransactionModal); 
                        }
                    }
                } 
                else if (action === 'toggle-status-all') {
                    const symbol = target.dataset.symbol; 
                    const transactionsForSymbol = currentTransactions.filter(tx => tx.symbol === symbol); 
                    if (transactionsForSymbol.length > 0) {
                        const isCurrentlyFullyReviewed = transactionsForSymbol.every(tx => tx.reviewed === true);
                        const newStatus = !isCurrentlyFullyReviewed; 
                        
                        transactionsForSymbol.forEach(tx => {
                             const originalTx = currentTransactions.find(t => t.id === tx.id);
                             if (originalTx) {
                                 originalTx.reviewed = newStatus;
                             }
                        });
                        
                        saveDataToFirebase(); // *** Firebase 修改 ***
                        render(); 
                    }
                }
            });

            accountFilter.addEventListener('change', (e) => {
                appData.currentAccount = e.target.value; 
                saveDataToFirebase(); // *** Firebase 修改 *** (儲存目前選擇)
                stockSearch.value = ''; 
                updateAccountFeeDiscountDisplay(); 
                updateAccountMarketTypeDisplay(); 
                updateStockFilterOptions(); 
                currentPage = 1; 
                render(); 
            });

            accountFeeDiscountInput.addEventListener('change', (e) => {
                 const newDiscount = parseFloat(e.target.value); 
                 if (!isNaN(newDiscount) && newDiscount >= 0 && appData.accounts[appData.currentAccount]) {
                     appData.accounts[appData.currentAccount].feeDiscount = newDiscount;
                     saveDataToFirebase(); // *** Firebase 修改 ***
                     render(); 
                 } else {
                      showModal(messageModal, '錯誤', '請輸入有效的手續費折數/費率。');
                      updateAccountFeeDiscountDisplay(); 
                 }
            });

            accountMarketTypeInput.addEventListener('change', (e) => {
                 const newMarketType = e.target.value;
                 if (appData.accounts[appData.currentAccount]) {
                     appData.accounts[appData.currentAccount].marketType = newMarketType;
                     saveDataToFirebase(); // *** Firebase 修改 ***
                     render(); 
                 }
            });
            
            stockFilter.addEventListener('change', () => {
                currentPage = 1; 
                render(); 
            });
            
            stockSearch.addEventListener('input', () => {
                updateStockFilterOptions(); 
                render(); 
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--; 
                    render(); 
                }
            });
            nextPageBtn.addEventListener('click', () => {
                 const currentAccountData = appData.accounts[appData.currentAccount];
                 const currentTransactions = currentAccountData ? currentAccountData.transactions : [];
                 const selectedStock = stockFilter.value;
                 const itemsPerPage = 10;
                 let totalItems = 0;
                 if (selectedStock === '__ALL__') {
                 } else {
                     totalItems = currentTransactions.filter(tx => tx.symbol === selectedStock).length;
                 }
                 const totalPages = Math.ceil(totalItems / itemsPerPage) || 1;

                if (currentPage < totalPages) { 
                     currentPage++; 
                     render(); 
                 }
            });
            
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                const newAccountNameInput = document.getElementById('new-account-name');
                const newAccountName = newAccountNameInput.value.trim(); 
                const newFeeDiscount = parseFloat(newAccountFeeDiscountInput.value); 
                const newMarketType = newAccountMarketTypeInput.value; 

                if (!newAccountName) {
                    showModal(messageModal, '錯誤', '帳戶名稱不能為空。');
                    return;
                }
                if (appData.accounts[newAccountName]) {
                    showModal(messageModal, '錯誤', '該帳戶名稱已存在。');
                    return;
                }
                 if (isNaN(newFeeDiscount) || newFeeDiscount < 0) { 
                    showModal(messageModal, '錯誤', '請輸入有效的手續費折數/費率。');
                    return;
                }

                appData.accounts[newAccountName] = { transactions: [], feeDiscount: newFeeDiscount, marketType: newMarketType }; 
                appData.currentAccount = newAccountName; 
                saveDataToFirebase(); // *** Firebase 修改 ***

                newAccountNameInput.value = ''; 
                newAccountFeeDiscountInput.value = 0.28; 
                newAccountMarketTypeInput.value = 'TW'; 
                hideModal(addAccountModal); 
                updateAccountFilterOptions(); 
                updateStockFilterOptions(); 
                currentPage = 1; 
                render(); 
            });
            
            editAccountForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                const oldAccountName = appData.currentAccount; 
                const newAccountName = editAccountNameInput.value.trim(); 
                const newFeeDiscount = parseFloat(editAccountFeeDiscountInput.value); 
                const newMarketType = editAccountMarketTypeInput.value; 

                if (!newAccountName) {
                    showModal(messageModal, '錯誤', '帳戶名稱不能為空。');
                    return;
                }
                 if (isNaN(newFeeDiscount) || newFeeDiscount < 0) { 
                    showModal(messageModal, '錯誤', '請輸入有效的手續費折數/費率。');
                    return;
                }
                if (newAccountName !== oldAccountName && appData.accounts[newAccountName]) {
                     showModal(messageModal, '錯誤', '該帳戶名稱已存在。');
                    return;
                }

                const accountDataToModify = appData.accounts[oldAccountName]; 
                accountDataToModify.feeDiscount = newFeeDiscount;
                accountDataToModify.marketType = newMarketType;

                if (newAccountName !== oldAccountName) {
                    appData.accounts[newAccountName] = accountDataToModify;
                    delete appData.accounts[oldAccountName];
                    appData.currentAccount = newAccountName; 
                }
                
                saveDataToFirebase(); // *** Firebase 修改 ***
                updateAccountFilterOptions(); 
                render(); 
                hideModal(editAccountModal); 
            });

            deleteAccountConfirmBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount; 
                if (Object.keys(appData.accounts).length <= 1) {
                    showModal(messageModal, '錯誤', '無法刪除最後一個帳戶。');
                    hideModal(deleteAccountModal);
                    return;
                }
                delete appData.accounts[accountToDelete];
                appData.currentAccount = Object.keys(appData.accounts)[0];
                saveDataToFirebase(); // *** Firebase 修改 ***
                hideModal(deleteAccountModal); 
                updateAccountFilterOptions(); 
                updateStockFilterOptions(); 
                render(); 
                showModal(messageModal, '成功', `帳戶「${accountToDelete}」已成功刪除。`); 
            });
            
            clearHistoryNowBtn.addEventListener('click', () => {
                if (symbolToClear && appData.accounts[appData.currentAccount]) { 
                    const account = appData.accounts[appData.currentAccount]; 
                    account.transactions = account.transactions.filter(tx => tx.symbol !== symbolToClear); 
                    saveDataToFirebase(); // *** Firebase 修改 ***
                    hideModal(clearHistoryModal); 
                    updateStockFilterOptions(); 
                    render(); 
                    showModal(messageModal, '紀錄已清除', `股票 ${symbolToClear} 的所有交易紀錄已被移除。`); 
                    symbolToClear = null; 
                }
            });

            clearHistoryLaterBtn.addEventListener('click', () => {
                if (symbolToClear && appData.accounts[appData.currentAccount]) { 
                    const account = appData.accounts[appData.currentAccount]; 
                    const tenDaysInMillis = 10 * 24 * 60 * 60 * 1000; 
                    const deletionTimestamp = Date.now() + tenDaysInMillis; 
                    const activeTransactionsForSymbol = account.transactions 
                        .filter(tx => tx.symbol === symbolToClear && !tx.deletionTimestamp);

                    activeTransactionsForSymbol.forEach(tx => {
                       const originalTx = account.transactions.find(t => t.id === tx.id); 
                       if(originalTx) {
                           originalTx.deletionTimestamp = deletionTimestamp;
                       }
                    });
                    saveDataToFirebase(); // *** Firebase 修改 ***
                    hideModal(clearHistoryModal); 
                    updateStockFilterOptions(); 
                    stockFilter.value = symbolToClear; 
                    render(); 
                    showModal(messageModal, '已排程清除', `股票 ${symbolToClear} 的紀錄將在10天後自動清除。`); 
                    symbolToClear = null; 
                }
            });

            exportBtn.addEventListener('click', () => {
                // 匯出功能不變，匯出的是目前載入到瀏覽器中的 appData
                if (!appData.accounts || Object.keys(appData.accounts).length === 0) { 
                    showModal(messageModal, '提示', '沒有可匯出的資料。'); 
                    return; 
                }
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_shares_tracker_data_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                URL.revokeObjectURL(url); 
                showModal(messageModal, '匯出成功', '您的所有帳戶紀錄已成功匯出為 JSON 檔案。'); 
            });

            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0]; 
                if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.accounts && importedData.currentAccount) {
                            appData = importedData; // 覆蓋目前的 appData
                            currentPage = 1; 
                            
                            // *** Firebase 修改 ***: 
                            // 將匯入的資料存到 Firebase
                            // onValue 監聽器會自動偵測到這個變更，並觸發 initializeApp/render
                            saveDataToFirebase(); 
                            
                            showModal(messageModal, '匯入成功', '所有帳戶紀錄已成功匯入並同步至雲端。'); 
                        } else {
                            throw new Error('檔案格式不符');
                        }
                    } catch (error) {
                         showModal(messageModal, '匯入失敗', `檔案格式不正確或已損毀。(${error.message})`);
                    }
                };
                reader.onerror = () => {
                    showModal(messageModal, '匯入失敗', '讀取檔案時發生錯誤。');
                };
                reader.readAsText(file); 
                importFile.value = ''; 
            });
            
            editTransactionCancelBtn.addEventListener('click', () => hideModal(editTransactionModal));
            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault(); 
                const id = parseInt(document.getElementById('edit-transaction-id').value, 10);
                const newSymbol = document.getElementById('edit-symbol').value.trim().toUpperCase();
                const newDate = document.getElementById('edit-date').value;
                const newShares = parseFloat(document.getElementById('edit-shares').value);
                const newPrice = parseFloat(document.getElementById('edit-price').value); 
                
                const currentAccountData = appData.accounts[appData.currentAccount]; 
                const currentTransactions = currentAccountData.transactions; 
                const feeDiscount = currentAccountData.feeDiscount; 
                const marketType = currentAccountData.marketType || 'TW';

                const txIndex = currentTransactions.findIndex(t => t.id === id);
                if (txIndex === -1) return; 
                
                const originalSymbol = currentTransactions[txIndex].symbol; 
                const transactionType = currentTransactions[txIndex].type; 

                if (!newSymbol) { showModal(messageModal, '輸入錯誤', '股票代號不能為空。'); return; }
                if (isNaN(newShares) || newShares <= 0) { showModal(messageModal, '輸入錯誤', '請檢查股數是否為有效的正數。'); return; }
                if (isNaN(newPrice) || newPrice < 0) { showModal(messageModal, '輸入錯誤', '請檢查價格是否為有效的數字。'); return; }

                const tempTransactions = JSON.parse(JSON.stringify(currentTransactions));
                const tempTxToUpdate = tempTransactions.find(t => t.id === id);
                
                tempTxToUpdate.symbol = newSymbol;
                tempTxToUpdate.date = newDate;
                tempTxToUpdate.shares = newShares;
                tempTxToUpdate.price = newPrice; 

                const newAmount = newPrice * newShares;
                let newFee = 0;
                
                if (marketType === 'TW') {
                    newFee = newAmount * FEE_RATE * feeDiscount;
                    if (transactionType === 'SELL') {
                        newFee += (newAmount * TAX_RATE);
                        tempTxToUpdate.fee = newFee;
                        delete tempTxToUpdate.totalTxCost; 
                    } else { // 'BUY'
                        tempTxToUpdate.fee = newFee;
                        tempTxToUpdate.totalTxCost = newAmount + newFee; 
                    }
                } else { // 'US'
                    newFee = newAmount * feeDiscount;
                    tempTxToUpdate.fee = newFee;
                    if (transactionType === 'SELL') {
                        delete tempTxToUpdate.totalTxCost; 
                    } else { // 'BUY'
                        tempTxToUpdate.totalTxCost = newAmount + newFee; 
                    }
                }
                
                const affectedSymbols = new Set([originalSymbol, newSymbol]);
                for (const symbol of affectedSymbols) {
                     const symbolSellTxs = tempTransactions.filter(tx => tx.symbol === symbol && tx.type === 'SELL');
                     const totalSold = symbolSellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                     const symbolBuyTxs = tempTransactions.filter(tx => tx.symbol === symbol && tx.type === 'BUY');
                     const totalBought = symbolBuyTxs.reduce((sum, tx) => sum + tx.shares, 0);

                    if (totalSold > totalBought) {
                        showModal(messageModal, '編輯失敗', `此修改會導致股票 ${symbol} 的庫存變為負數，請重新檢查。`);
                        return; 
                    }
                }

                const transactionToUpdate = currentTransactions[txIndex];
                transactionToUpdate.symbol = newSymbol;
                transactionToUpdate.name = stockNameMap[newSymbol] || ''; 
                transactionToUpdate.date = newDate;
                transactionToUpdate.shares = newShares;
                transactionToUpdate.price = newPrice; 
                transactionToUpdate.fee = tempTxToUpdate.fee; 
                if (transactionType === 'BUY') {
                    transactionToUpdate.totalTxCost = tempTxToUpdate.totalTxCost; 
                } else {
                    delete transactionToUpdate.totalTxCost; 
                }
                
                saveDataToFirebase(); // *** Firebase 修改 ***
                hideModal(editTransactionModal); 
                
                let zeroedOutSymbol = null;
                for (const symbol of affectedSymbols) {
                    const holdings = getCurrentHoldings(symbol, currentTransactions);
                    const remainingShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    if (remainingShares === 0) {
                        const hasActiveTxs = currentTransactions.some(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        if (hasActiveTxs) {
                           zeroedOutSymbol = symbol; 
                           break; 
                        }
                    }
                }

                if (zeroedOutSymbol) {
                    symbolToClear = zeroedOutSymbol;
                    clearHistoryMessage.textContent = `編輯後，股票 ${zeroedOutSymbol} 的庫存已為零，是否要清除其所有相關交易歷史紀錄？`;
                    showModal(clearHistoryModal);
                } 
                else {
                    updateStockFilterOptions();
                    render(); 
                }
            });

            function handleSymbolInput(e) {
                clearTimeout(debounceTimer); 
                const symbol = e.target.value.trim().toUpperCase(); 
                const nameDisplayId = `tx-symbol-name`; 
                const nameDisplayEl = document.getElementById(nameDisplayId);
                
                const editNameDisplayEl = document.getElementById('edit-symbol-name');
                const targetEl = e.target.id === 'edit-symbol' ? editNameDisplayEl : nameDisplayEl;

                if (!targetEl) return; 

                debounceTimer = setTimeout(() => {
                    if (stockNameMap[symbol]) {
                        targetEl.textContent = stockNameMap[symbol];
                    } else {
                        targetEl.textContent = ''; 
                    }
                }, 300);
            }

            // --- 程式進入點 (修改) ---
            // 移除 initializeApp_Local();
            
            setDateToToday(); // 設定日期預設值 (保留)
            
            // 綁定可摺疊區塊的點擊事件 (保留)
            collapsibleHeader.addEventListener('click', () => {
                if (collapsibleContent.style.maxHeight) {
                    collapsibleContent.style.maxHeight = null; 
                    collapseIcon.style.transform = 'rotate(-90deg)'; 
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'true'); 
                } else {
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px"; 
                    collapseIcon.style.transform = 'rotate(0deg)'; 
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'false'); 
                }
            });

            // 綁定股票代號輸入框的輸入事件 (保留)
            document.getElementById('tx-symbol').addEventListener('input', handleSymbolInput);
            document.getElementById('edit-symbol').addEventListener('input', handleSymbolInput);


            // *** Firebase 修改 ***: 加入認證與登入/登出邏輯
            
            // 監聽登入按鈕
            loginBtn.addEventListener('click', () => {
                auth.signInWithPopup(provider)
                    .catch((error) => {
                        console.error("Google 登入失敗:", error);
                        showModal(messageModal, '登入失敗', error.message);
                    });
            });

            // 監聽登出按鈕
            logoutBtn.addEventListener('click', () => {
                auth.signOut();
            });

            // 監聽認證狀態變化 (程式的主要進入點)
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // --- 使用者已登入 ---
                    console.log("使用者已登入:", user.uid);
                    // 顯示主應用程式
                    appContainer.classList.remove('hidden');
                    // 隱藏登入區塊
                    authContainer.classList.add('hidden');
                    // 顯示使用者資訊和登出按鈕
                    userDisplay.textContent = `登入為: ${user.displayName || user.email}`;
                    logoutBtn.parentElement.classList.remove('hidden');

                    // *** 觸發資料監聽器 ***
                    // 這將會從 Firebase 載入該使用者的資料並啟動應用程式
                    setupDataListener(user.uid);

                } else {
                    // --- 使用者已登出 ---
                    console.log("使用者已登出");
                    // 隱藏主應用程式
                    appContainer.classList.add('hidden');
                    // 顯示登入區塊
                    authContainer.classList.remove('hidden');
                    // 隱藏使用者資訊和登出按鈕
                    logoutBtn.parentElement.classList.add('hidden');
                    userDisplay.textContent = '';
                    
                    // 清理狀態
                    appData = {};
                    currentUid = null;
                    if (dataListener) {
                        dataListener.off(); // 停止監聽舊使用者的資料
                        dataListener = null;
                    }
                    render(); // 清空畫面
                }
            });

        });
    </script>
</body>
</html>