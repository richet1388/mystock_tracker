<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ˆé›²ç«¯å„€è¡¨æ¿ğŸ“Š</title>
    <link rel="icon" href="ElienOnly.ico" type="image/ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- è«è˜­è¿ªæ·±è‰²ç³»é…è‰² --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1c1917; 
            color: #f5f5f4; 
        }
        .table-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #292524;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #57534e;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #78716c;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
             transition: transform 0.3s ease;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8); 
            cursor: pointer; 
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        input[type="date"]::-webkit-datetime-edit {
            font-size: 0.85rem; /* ç­‰åŒæ–¼ Tailwind çš„ text-xs */
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body class="antialiased">

    <!-- Login/Auth Section -->
    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">ğŸ“ˆé›²ç«¯å„€è¡¨æ¿ğŸ“Š</h1>
        <p class="mt-4 text-stone-400">ä½¿ç”¨ Google å¸³æˆ¶ç™»å…¥ä»¥è·¨è£ç½®åŒæ­¥è³‡æ–™</p>
        <button id="login-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">ä½¿ç”¨ Google ç™»å…¥</button>
    </div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl hidden"> 
        <div class="flex justify-between items-center mb-6">
             <p id="user-display" class="text-sm text-stone-400"></p>
             <button id="logout-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">ç™»å‡º</button>
        </div>
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">ğŸ“ˆé›²ç«¯å„€è¡¨æ¿ğŸ“Š</h1>
            <p class="mt-2 text-lg text-stone-400">å°ˆæ³¨æ–¼è¿½è¹¤æŒè‚¡ç¸½æ•¸</p>
        </header>

        <main class="space-y-8">
            <div class="bg-stone-800 p-4 rounded-2xl shadow-lg border border-stone-700">
                <label for="account-filter" class="block text-sm font-medium text-stone-300 mb-2">ç›®å‰å¸³æˆ¶</label>
                <div class="flex items-center space-x-2">
                    <select id="account-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    <button id="add-account-btn" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">ï¼‹ æ–°å¢</button>
                    <button id="edit-account-btn" class="flex-shrink-0 bg-stone-500 hover:bg-stone-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">âœï¸ ä¿®æ”¹åç¨±</button>
                    <button id="delete-account-btn" class="flex-shrink-0 bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md hidden">ï¼ åˆªé™¤</button>
                </div>
            </div>

            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700 space-y-4">
                <h2 id="view-title" class="text-2xl font-bold text-stone-100 tracking-tight">æŠ•è³‡çµ„åˆç¸½è¦½</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="stock-search" class="block text-sm font-medium text-stone-300 mb-2">æœå°‹æˆ–é¸æ“‡æª¢è¦–é …ç›®</label>
                        <input type="text" id="stock-search" placeholder="è¼¸å…¥ä»£è™Ÿç¯©é¸..." class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                    </div>
                    <div>
                        <label for="stock-filter" class="block text-sm font-medium text-transparent mb-2 select-none">.</label>
                        <select id="stock-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div>
                        <label id="shares-title" class="block text-sm font-medium text-stone-300 mb-2">å…¨éƒ¨åº«å­˜æª”æ•¸</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalShares" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-stone-800 rounded-2xl shadow-lg border border-stone-700">
                <div id="collapsible-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-stone-100">æ–°å¢äº¤æ˜“ç´€éŒ„</h2>
                    <span id="collapse-icon" class="text-stone-400 transform transition-transform duration-300">â–¼</span>
                </div>
                <div id="collapsible-content" class="collapsible-content">
                    <div class="p-4 pt-0 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-sky-800">
                            <h3 class="text-lg font-semibold mb-4 text-sky-300">è²·å…¥</h3>
                            <form id="add-buy-form" class="space-y-4">
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label for="buy-symbol" class="block text-sm font-medium text-stone-300">è‚¡ç¥¨ä»£è™Ÿ</label>
                                        <input type="text" id="buy-symbol" required placeholder="ä¾‹å¦‚: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="buy-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="buy-date" class="block text-sm font-medium text-stone-300">æ—¥æœŸ</label>
                                        <input type="date" id="buy-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="buy-shares" class="block text-sm font-medium text-stone-300">è‚¡æ•¸</label>
                                        <input type="number" id="buy-shares" min="0" step="any" required placeholder="1000" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">æ–°å¢è²·å…¥</button>
                            </form>
                        </div>

                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-rose-800">
                            <h3 class="text-lg font-semibold mb-4 text-rose-300">è³£å‡º</h3>
                            <form id="add-sell-form" class="space-y-4">
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label for="sell-symbol" class="block text-sm font-medium text-stone-300">è‚¡ç¥¨ä»£è™Ÿ</label>
                                        <input type="text" id="sell-symbol" required placeholder="ä¾‹å¦‚: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-rose-400 focus:border-rose-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="sell-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="sell-date" class="block text-sm font-medium text-stone-300">æ—¥æœŸ</label>
                                        <input type="date" id="sell-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-rose-400 focus:border-rose-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="sell-shares" class="block text-sm font-medium text-stone-300">è‚¡æ•¸</label>
                                        <input type="number" id="sell-shares" min="0" step="any" required placeholder="500" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-rose-400 focus:border-rose-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">æ–°å¢è³£å‡º</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <h2 class="text-xl font-semibold text-stone-100 mb-4">æŒè‚¡ä½”æ¯”åˆ†æ</h2>
                <div class="relative h-64 md:h-80">
                     <canvas id="portfolio-chart"></canvas>
                </div>
                <p id="no-chart-data-msg" class="text-center py-8 text-stone-500 hidden">æŒæœ‰å–®ä¸€è‚¡ç¥¨æˆ–ç„¡åº«å­˜ï¼Œç„¡æ³•ç”Ÿæˆåœ–è¡¨</p>
            </div>


            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="history-title" class="text-xl font-semibold text-stone-100">äº¤æ˜“æ­·å²ç´€éŒ„</h2>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <button id="import-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">åŒ¯å…¥è³‡æ–™</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="export-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">åŒ¯å‡ºè³‡æ–™</button>
                    </div>
                </div>
                <div class="overflow-x-auto table-scrollbar">
                    <table class="min-w-full divide-y divide-stone-700">
                        <thead class="bg-stone-900">
                            </thead>
                        <tbody id="transaction-list" class="divide-y divide-stone-700">
                            </tbody>
                    </table>
                    <p id="no-data-msg" class="text-center py-8 text-stone-500">å°šç„¡äº¤æ˜“ç´€éŒ„</p>
                </div>
                 <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-stone-400 hidden">
                    <button id="prev-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">&lt; ä¸Šä¸€é </button>
                    <span id="page-info">ç¬¬ 1 / 1 é </span>
                    <button id="next-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">ä¸‹ä¸€é  &gt;</button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="message-modal-title" class="text-lg font-semibold text-stone-100">æç¤º</h3>
            <p id="message-modal-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="add-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">æ–°å¢å¸³æˆ¶</h3>
            <form id="add-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="new-account-name" class="block text-sm font-medium text-stone-300">å¸³æˆ¶åç¨±</label>
                    <input type="text" id="new-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">å»ºç«‹</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">ä¿®æ”¹å¸³æˆ¶åç¨±</h3>
            <form id="edit-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="edit-account-name" class="block text-sm font-medium text-stone-300">æ–°å¸³æˆ¶åç¨±</label>
                    <input type="text" id="edit-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="edit-modal-title" class="text-lg font-semibold text-stone-100">ç·¨è¼¯äº¤æ˜“ç´€éŒ„</h3>
            <form id="edit-transaction-form" class="mt-4 space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="edit-symbol" class="block text-sm font-medium text-stone-300">è‚¡ç¥¨ä»£è™Ÿ</label>
                        <input type="text" id="edit-symbol" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                        <small id="edit-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                    </div>
                    <div>
                         <label for="edit-date" class="block text-sm font-medium text-stone-300">æ—¥æœŸ</label>
                         <input type="date" id="edit-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div>
                         <label for="edit-shares" class="block text-sm font-medium text-stone-300">è‚¡æ•¸</label>
                         <input type="number" id="edit-shares" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-transaction-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">å„²å­˜è®Šæ›´</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-rose-400">ç¢ºèªåˆªé™¤å¸³æˆ¶</h3>
            <p id="delete-account-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="delete-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å–æ¶ˆ</button>
                <button type="button" id="delete-account-confirm" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">ç¢ºèªåˆªé™¤</button>
            </div>
        </div>
    </div>
    
    <div id="clear-history-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-amber-400">ç¢ºèªæ¸…é™¤ç´€éŒ„</h3>
            <p id="clear-history-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="clear-history-later-btn" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">å¦ (3å¤©å¾Œæ¸…é™¤)</button>
                <button type="button" id="clear-history-now-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">æ˜¯ (ç«‹å³æ¸…é™¤)</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase è¨­å®š (è«‹è²¼ä¸Šæ‚¨è‡ªå·±çš„è¨­å®š) ---
            const firebaseConfig = {
                apiKey: "AIzaSyBNA20afPELKWGlKHkQfdNhk5Z1wjlTYfs",
                authDomain: "stock-tracker-940de.firebaseapp.com",
                databaseURL: "https://stock-tracker-940de-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "stock-tracker-940de",
                storageBucket: "stock-tracker-940de.firebasestorage.app",
                messagingSenderId: "546233071753",
                appId: "1:546233071753:web:c95d9bece5dd10aa83ae58"
                };

            // --- Firebase åˆå§‹åŒ– ---
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.database();
            let user = null; 
            let dbRef = null;

            // --- DOM å…ƒç´ å®£å‘Š ---
            const addBuyForm = document.getElementById('add-buy-form');
            const addSellForm = document.getElementById('add-sell-form');
            const addAccountForm = document.getElementById('add-account-form');
            const editAccountForm = document.getElementById('edit-account-form');
            const transactionList = document.getElementById('transaction-list');
            const totalSharesEl = document.getElementById('totalShares');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const noDataMsg = document.getElementById('no-data-msg');
            const accountFilter = document.getElementById('account-filter');
            const stockFilter = document.getElementById('stock-filter');
            const stockSearch = document.getElementById('stock-search');
            const viewTitle = document.getElementById('view-title');
            const sharesTitle = document.getElementById('shares-title');
            const historyTitle = document.getElementById('history-title');
            const messageModal = document.getElementById('message-modal');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalMessage = document.getElementById('message-modal-message');
            const messageModalClose = document.getElementById('message-modal-close');
            const addAccountModal = document.getElementById('add-account-modal');
            const addAccountBtn = document.getElementById('add-account-btn');
            const addAccountCancelBtn = document.getElementById('add-account-cancel');
            const editAccountModal = document.getElementById('edit-account-modal');
            const editAccountBtn = document.getElementById('edit-account-btn');
            const editAccountCancelBtn = document.getElementById('edit-account-cancel');
            const editAccountNameInput = document.getElementById('edit-account-name');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const deleteAccountModal = document.getElementById('delete-account-modal');
            const deleteAccountMessage = document.getElementById('delete-account-message');
            const deleteAccountCancelBtn = document.getElementById('delete-account-cancel');
            const deleteAccountConfirmBtn = document.getElementById('delete-account-confirm');
            const clearHistoryModal = document.getElementById('clear-history-modal');
            const clearHistoryMessage = document.getElementById('clear-history-message');
            const clearHistoryLaterBtn = document.getElementById('clear-history-later-btn');
            const clearHistoryNowBtn = document.getElementById('clear-history-now-btn');
            const paginationControls = document.getElementById('pagination-controls');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const pageInfo = document.getElementById('page-info');
            const collapsibleHeader = document.getElementById('collapsible-header');
            const collapsibleContent = document.getElementById('collapsible-content');
            const collapseIcon = document.getElementById('collapse-icon');
            const editTransactionModal = document.getElementById('edit-transaction-modal');
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const editModalTitle = document.getElementById('edit-modal-title');
            const editTransactionCancelBtn = document.getElementById('edit-transaction-cancel');
            const portfolioChartCanvas = document.getElementById('portfolio-chart');
            const noChartDataMsg = document.getElementById('no-chart-data-msg');
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            // --- æ‡‰ç”¨ç¨‹å¼è³‡æ–™çµæ§‹èˆ‡ç‹€æ…‹ ---
            let appData = {}; 
            let currentPage = 1; 
            let symbolToClear = null;
            let debounceTimer; 
            let portfolioChart; 

            const stockNameMap = {
				"0050": "å…ƒå¤§å°ç£50", "0051": "å…ƒå¤§ä¸­å‹100", "0052": "å¯Œé‚¦ç§‘æŠ€", "0053": "å…ƒå¤§é›»å­", "0055": "å…ƒå¤§MSCIé‡‘è", "0056": "å…ƒå¤§é«˜è‚¡æ¯", "0057": "å¯Œé‚¦æ‘©å°", "0061": "å…ƒå¤§å¯¶æ»¬æ·±", "006201": "å…ƒå¤§å¯¶æ«ƒ50", "006203": "å…ƒå¤§MSCIå°ç£", "006204": "æ°¸è±è‡ºç£åŠ æ¬Š", "006205": "å¯Œé‚¦ä¸Šè¨¼", "006206": "å…ƒå¤§ä¸Šè­‰50", "006207": "å¾©è¯æ»¬æ·±", "006208": "å¯Œé‚¦å°50", "00631L": "å…ƒå¤§å°ç£50æ­£2", "00632R": "å…ƒå¤§å°ç£50å1", "00633L": "å¯Œé‚¦ä¸Šè¨¼æ­£2", "00634R": "å¯Œé‚¦ä¸Šè¨¼å1", "00635U": "æœŸå…ƒå¤§S&Pé»ƒé‡‘", "00636": "åœ‹æ³°ä¸­åœ‹A50", "00637L": "å…ƒå¤§æ»¬æ·±300æ­£2", "00638R": "å…ƒå¤§æ»¬æ·±300å1", "00639": "å¯Œé‚¦æ·±100", "00640L": "å¯Œé‚¦æ—¥æœ¬æ­£2", "00641R": "å¯Œé‚¦æ—¥æœ¬å1", "00642U": "æœŸå…ƒå¤§S&PçŸ³æ²¹", "00643": "ç¾¤ç›Šæ·±è¨¼ä¸­å°", "00645": "å¯Œé‚¦æ—¥æœ¬", "00646": "å…ƒå¤§S&P500", "00647L": "å…ƒå¤§S&P500æ­£2", "00648R": "å…ƒå¤§S&P500å1", "00650L": "å¾©è¯é¦™æ¸¯æ­£2", "00651R": "å¾©è¯é¦™æ¸¯å1", "00652": "å¯Œé‚¦å°åº¦", "00653L": "å¯Œé‚¦å°åº¦æ­£2", "00654R": "å¯Œé‚¦å°åº¦å1", "00655L": "åœ‹æ³°ä¸­åœ‹A50æ­£2", "00656R": "åœ‹æ³°ä¸­åœ‹A50å1", "00657": "åœ‹æ³°æ—¥ç¶“225", "00660": "å…ƒå¤§æ­æ´²50", "00661": "å…ƒå¤§æ—¥ç¶“225", "00662": "å¯Œé‚¦NASDAQ", "00663L": "åœ‹æ³°è‡ºç£åŠ æ¬Šæ­£2", "00664R": "åœ‹æ³°è‡ºç£åŠ æ¬Šå1", "00665L": "å¯Œé‚¦æ’ç”Ÿåœ‹ä¼æ­£2", "00666R": "å¯Œé‚¦æ’ç”Ÿåœ‹ä¼å1", "00668": "åœ‹æ³°ç¾åœ‹é“ç“Š", "00669R": "åœ‹æ³°ç¾åœ‹é“ç“Šå1", "00670L": "å¯Œé‚¦NASDAQæ­£2", "00671R": "å¯Œé‚¦NASDAQå1", "00673R": "æœŸå…ƒå¤§S&PåŸæ²¹å1", "00674R": "æœŸå…ƒå¤§S&Pé»ƒé‡‘å1", "00675L": "å¯Œé‚¦è‡ºç£åŠ æ¬Šæ­£2", "00676R": "å¯Œé‚¦è‡ºç£åŠ æ¬Šå1", "00678": "ç¾¤ç›Šé‚£æ–¯é”å…‹ç”ŸæŠ€", "00679B": "å…ƒå¤§ç¾å‚µ20å¹´", "00680L": "å…ƒå¤§ç¾å‚µ20æ­£2", "00681R": "å…ƒå¤§ç¾å‚µ20å1", "00682U": "æœŸå…ƒå¤§ç¾å…ƒæŒ‡æ•¸", "00683L": "æœŸå…ƒå¤§ç¾å…ƒæŒ‡æ­£2", "00684R": "æœŸå…ƒå¤§ç¾å…ƒæŒ‡å1", "00685L": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šæ­£2", "00686R": "ç¾¤ç›Šè‡ºç£åŠ æ¬Šå1", "00687B": "åœ‹æ³°20å¹´ç¾å‚µ", "00688L": "åœ‹æ³°20å¹´ç¾å‚µæ­£2", "00689R": "åœ‹æ³°20å¹´ç¾å‚µå1", "00690": "å…†è±å°ç£è—ç±Œ30", "00692": "å¯Œé‚¦å…¬å¸æ²»ç†", "00693U": "æœŸè¡—å£S&Pé»ƒè±†", "00695B": "å¯Œé‚¦ç¾å‚µ7-10å¹´", "00696B": "å¯Œé‚¦ç¾å‚µ20å¹´", "00697B": "å…ƒå¤§ç¾å‚µ7-10", "00700": "å¯Œé‚¦æ†ç”Ÿåœ‹ä¼", "00701": "åœ‹æ³°è‚¡åˆ©ç²¾é¸30", "00702": "åœ‹æ³°æ¨™æ™®ä½æ³¢é«˜æ¯", "00703": "å°æ–°MSCIä¸­åœ‹", "00706L": "æœŸå…ƒå¤§S&Pæ—¥åœ“æ­£2", "00707R": "æœŸå…ƒå¤§S&Pæ—¥åœ“å1", "00708L": "æœŸå…ƒå¤§S&Pé»ƒé‡‘æ­£2", "00709": "å¯Œé‚¦æ­æ´²", "00710B": "å¾©è¯å½­åšéæŠ•ç­‰å‚µ", "00711B": "å¾©è¯å½­åšæ–°èˆˆå‚µ", "00712": "å¾©è¯å¯Œæ™‚ä¸å‹•ç”¢", "00713": "å…ƒå¤§å°ç£é«˜æ¯ä½æ³¢", "00714": "ç¾¤ç›Šé“ç“Šç¾åœ‹åœ°ç”¢", "00715L": "æœŸè¡—å£å¸ƒè˜­ç‰¹æ­£2", "00717": "å¯Œé‚¦ç¾åœ‹ç‰¹åˆ¥è‚¡", "00719B": "å…ƒå¤§ç¾å‚µ1-3", "00720B": "å…ƒå¤§æŠ•è³‡ç´šå…¬å¸å‚µ", "00722B": "ç¾¤ç›ŠæŠ•è³‡ç´šé›»ä¿¡å‚µ", "00723B": "ç¾¤ç›ŠæŠ•è³‡ç´šç§‘æŠ€å‚µ", "00724B": "ç¾¤ç›ŠæŠ•è³‡ç´šé‡‘èå‚µ", "00725B": "åœ‹æ³°æŠ•è³‡ç´šå…¬å¸å‚µ", "00726B": "åœ‹æ³°æ–°èˆˆæŠ•ç­‰å‚µ", "00727B": "åœ‹æ³°å„ªé¸æŠ•é ­ç­‰å‚µ", "00728": "ç¬¬ä¸€é‡‘å·¥æ¥­30", "00730": "å¯Œé‚¦è‡ºç£å„ªè³ªé«˜æ¯", "00731": "å¾©è¯å¯Œæ™‚é«˜æ¯ä½æ³¢", "00733": "å¯Œé‚¦è‡ºç£ä¸­å°", "00734B": "å°æ–°JPMæ–°èˆˆå‚µ", "00735": "åœ‹æ³°è‡ºéŸ“ç§‘æŠ€", "00736": "åœ‹æ³°æ–°èˆˆå¸‚å ´", "00737": "åœ‹æ³°AIæ©Ÿå™¨äºº", "00738U": "æœŸå…ƒå¤§é“ç“Šç™½éŠ€", "00739": "å…ƒå¤§MSCI Aè‚¡", "00740B": "å¯Œé‚¦å…¨çƒæŠ•ç­‰å‚µ", "00741B": "å¯Œé‚¦å…¨çƒéæŠ•ç­‰å‚µ", "00746B": "å¯Œé‚¦Aç´šå…¬å¸å‚µ", "00749B": "å‡±åŸºæ–°èˆˆå‚µ10+", "00750B": "å‡±åŸºç§‘æŠ€å‚µ10+", "00751B": "å…ƒå¤§AAAè‡³Aå…¬å¸å‚µ", "00752": "ä¸­ä¿¡ä¸­åœ‹5G", "00753L": "ä¸­ä¿¡ä¸­åœ‹5Gæ­£2", "00757": "çµ±ä¸€FANG+", "00758B": "å¾©è¯èƒ½æºå‚µ", "00759B": "å¾©è¯è£½è—¥å‚µ", "00760B": "å¾©è¯æ–°èˆˆä¼æ¥­å‚µ", "00761B": "åœ‹æ³°Aç´šå…¬å¸å‚µ", "00762": "å…ƒå¤§å…¨çƒAI", "00764B": "å¾©è¯20å¹´ç¾å‚µ", "00770": "åœ‹æ³°åŒ—ç¾ç§‘æŠ€", "00771": "å…ƒå¤§USé«˜æ¯ç‰¹åˆ¥è‚¡", "00772B": "ä¸­ä¿¡é«˜è©•ç´šå…¬å¸å‚µ", "00773B": "ä¸­ä¿¡å„ªå…ˆé‡‘èå‚µ", "00775B": "æ–°å…‰æŠ•ç­‰å‚µ15+", "00777B": "å‡±åŸºAAAè‡³Aå…¬å¸å‚µ", "00778B": "å‡±åŸºé‡‘èå‚µ20+", "00779B": "å‡±åŸºç¾å‚µ25+", "00780B": "åœ‹æ³°Aç´šé‡‘èå‚µ", "00781B": "åœ‹æ³°Aç´šç§‘æŠ€å‚µ", "00782B": "åœ‹æ³°Aç´šå…¬ç”¨å‚µ", "00783": "å¯Œé‚¦ä¸­è¨¼500", "00785B": "å¯Œé‚¦é‡‘èæŠ•ç­‰å‚µ", "00786B": "å…ƒå¤§10å¹´IGéŠ€è¡Œå‚µ", "00787B": "å…ƒå¤§10å¹´IGé†«ç™‚å‚µ", "00788B": "å…ƒå¤§10å¹´IGé›»èƒ½å‚µ", "00789B": "å¾©è¯å…¬å¸å‚µA3", "00791B": "å¾©è¯ä¿¡ç”¨å‚µ1-5", "00792B": "ç¾¤ç›ŠAç´šå…¬å¸å‚µ", "00793B": "ç¾¤ç›ŠAAA-Aé†«ç™‚å‚µ", "00795B": "ä¸­ä¿¡ç¾åœ‹å…¬å‚µ20å¹´", "00799B": "åœ‹æ³°Aç´šé†«ç™‚å‚µ", "00830": "åœ‹æ³°è²»åŸåŠå°é«”", "00834B": "ç¬¬ä¸€é‡‘èå‚µ10+", "00836B": "æ°¸è±10å¹´Aå…¬å¸å‚µ", "00850": "å…ƒå¤§è‡ºç£ESGæ°¸çºŒ", "00851": "å°æ–°å…¨çƒAI", "00858": "æ°¸è±ç¾åœ‹500å¤§", "00861": "å…ƒå¤§å…¨çƒæœªä¾†é€šè¨Š", "00870B": "å…ƒå¤§15å¹´EMä¸»æ¬Šå‚µ", "00875": "åœ‹æ³°ç¶²è·¯è³‡å®‰", "00876": "å…ƒå¤§å…¨çƒ5G", "00877": "å¾©è¯ä¸­åœ‹5G", "00878": "åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯", "00881": "åœ‹æ³°å°ç£ç§‘æŠ€é¾é ­", "00882": "ä¸­ä¿¡ä¸­åœ‹é«˜è‚¡æ¯", "00885": "å¯Œé‚¦è¶Šå—", "00886": "æ°¸è±ç¾åœ‹ç§‘æŠ€", "00888": "æ°¸è±å°ç£ESG", "00891": "ä¸­ä¿¡é—œéµåŠå°é«”", "00892": "å¯Œé‚¦å°ç£åŠå°é«”", "00893": "åœ‹æ³°æ™ºèƒ½é›»å‹•è»Š", "00894": "ä¸­ä¿¡å°è³‡é«˜åƒ¹30", "00895": "å¯Œé‚¦æœªä¾†è»Š", "00896": "ä¸­ä¿¡ç¶ èƒ½åŠé›»å‹•è»Š", "00897": "å¯Œé‚¦åŸºå› å…ç–«ç”ŸæŠ€", "00898": "åœ‹æ³°åŸºå› å…ç–«é©å‘½", "00899": "FTæ½”æ·¨èƒ½æº", "00900": "å¯Œé‚¦ç‰¹é¸é«˜è‚¡æ¯30", "00901": "æ°¸è±æ™ºèƒ½è»Šä¾›æ‡‰éˆ", "00902": "ä¸­ä¿¡é›»æ± åŠå„²èƒ½", "00903": "å¯Œé‚¦å…ƒå®‡å®™", "00904": "æ–°å…‰è‡ºç£åŠå°é«”30", "00905": "FTè‡ºç£Smart", "00907": "æ°¸è±å„ªæ¯å­˜è‚¡", "00908": "å¯Œé‚¦å…¥æ¯REITs+", "00909": "åœ‹æ³°æ•¸ä½æ”¯ä»˜æœå‹™", "00910": "ç¬¬ä¸€é‡‘å¤ªç©ºè¡›æ˜Ÿ", "00911": "å…†è±æ´²éš›åŠå°é«”", "00912": "ä¸­ä¿¡è‡ºç£æ™ºæ…§50", "00913": "å…†è±å°ç£æ™¶åœ“è£½é€ ", "00915": "å‡±åŸºå„ªé¸é«˜è‚¡æ¯30", "00917": "ä¸­ä¿¡ç‰¹é¸é‡‘è", "00918": "å¤§è¯å„ªåˆ©é«˜å¡«æ¯30", "00919": "ç¾¤ç›Šå°ç£ç²¾é¸é«˜æ¯", "00920": "å¯Œé‚¦ESGç¶ è‰²é›»åŠ›", "00921": "å…†è±é¾é ­ç­‰æ¬Šé‡", "00922": "åœ‹æ³°å°ç£é ˜è¢–50", "00923": "ç¾¤ç›Šå°ç£ESGä½ç¢³", "00924": "å¾©è¯S&P500æˆé•·", "00926": "å‡±åŸºå…¨çƒèè‹±55", "00927": "ç¾¤ç›ŠåŠå°é«”æ”¶ç›Š", "00928": "ä¸­ä¿¡ä¸Šæ«ƒESG 30", "00929": "å¾©è¯å°ç£ç§‘æŠ€å„ªæ¯", "00930": "æ°¸è±ESGä½ç¢³é«˜æ¯", "00932": "å…†è±æ°¸çºŒé«˜æ¯ç­‰æ¬Š", "00933B": "åœ‹æ³°10Y+é‡‘èå‚µ", "00934": "ä¸­ä¿¡æˆé•·é«˜è‚¡æ¯", "00935": "é‡æ‘è‡ºç£æ–°ç§‘æŠ€50", "00936": "å°æ–°æ°¸çºŒé«˜æ¯ä¸­å°", "00937B": "ç¾¤ç›ŠESGæŠ•ç­‰å‚µ20+", "00938": "å‡±åŸºå„ªé¸30", "00939": "çµ±ä¸€å°ç£é«˜æ¯å‹•èƒ½", "00940": "å…ƒå¤§å°ç£åƒ¹å€¼é«˜æ¯", "00941": "ä¸­ä¿¡ä¸Šæ¸¸åŠå°é«”", "00943": "å…†è±é›»å­é«˜æ¯ç­‰æ¬Š", "00944": "é‡æ‘è¶¨å‹¢å‹•èƒ½é«˜æ¯", "00946": "ç¾¤ç›Šç§‘æŠ€é«˜æ¯æˆé•·", "00947": "å°æ–°å°ç£ICè¨­è¨ˆ", "00949": "å¾©è¯æ—¥æœ¬é¾é ­", "00951": "å°æ–°æ—¥æœ¬åŠå°é«”", "00952": "å‡±åŸºå°ç£AI50", "00954": "ä¸­ä¿¡æ—¥æœ¬åŠå°é«”", "00955": "ä¸­ä¿¡æ—¥æœ¬å•†ç¤¾", "00956": "ä¸­ä¿¡æ—¥ç¶“é«˜è‚¡æ¯", "00960": "é‡æ‘å…¨çƒèˆªé‹é¾é ­", "00961": "FTå°ç£æ°¸çºŒé«˜æ¯", "00962": "å°æ–°AIå„ªæ¯å‹•èƒ½", "00963": "ä¸­ä¿¡å…¨çƒé«˜è‚¡æ¯", "00964": "ä¸­ä¿¡äºå¤ªé«˜è‚¡æ¯", "00965": "å…ƒå¤§èˆªå¤ªé˜²è¡›ç§‘æŠ€", "00971": "é‡æ‘ç¾åœ‹ç ”ç™¼é¾é ­", "00972": "é‡æ‘æ—¥æœ¬å‹•èƒ½é«˜æ¯", "009800": "ä¸­ä¿¡NASDAQ", "009801": "ä¸­ä¿¡ç¾åœ‹å‰µæ–°ç§‘æŠ€", "009802": "å¯Œé‚¦æ——è‰¦50", "009803": "ä¿å¾·ä¿¡å¸‚å€¼å‹•èƒ½50", "009804": "è¯é‚¦å°ç²¾å½©50", "009805": "æ–°å…‰ç¾åœ‹é›»åŠ›åŸºç¤", "009806": "å°æ–°æ¨™æ™®500", "009807": "å°æ–°æ¨™æ™®ç§‘æŠ€ç²¾é¸", "009808": "è¯å—æ°¸æ˜Œå„ªé¸50", "00980A": "ä¸»å‹•é‡æ‘è‡ºç£å„ªé¸", "009810": "ä¿å¾·ä¿¡å…¨çƒè—ç±Œ", "009811": "çµ±ä¸€ç¾åœ‹50", "009812": "é‡æ‘æ—¥æœ¬æ±è¨¼", "00981A": "ä¸»å‹•çµ±ä¸€å°è‚¡å¢é•·", "00982A": "ä¸»å‹•ç¾¤ç›Šè‡ºç£å¼·æ£’", "00983A": "ä¸»å‹•ä¸­ä¿¡ARKå‰µæ–°", "00984A": "ä¸»å‹•å®‰è¯è‡ºç£é«˜æ¯", "00985A": "ä¸»å‹•é‡æ‘è‡ºç£50", "00986A": "ä¸»å‹•å°æ–°é¾é ­æˆé•·",
			};
            
            // --- Firebase æ ¸å¿ƒåŠŸèƒ½ ---

            auth.onAuthStateChanged(currentUser => {
                if (currentUser) {
                    user = currentUser;
                    userDisplay.textContent = `æ­¡è¿, ${user.displayName || user.email}`;
                    dbRef = db.ref(`users/${user.uid}`);
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    listenForDataChanges();
                } else {
                    user = null;
                    dbRef = null;
                    appData = {}; 
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    if (portfolioChart) portfolioChart.destroy();
                }
            });
            
            function listenForDataChanges() {
                if (!dbRef) return;
                dbRef.on('value', (snapshot) => {
                    const storedData = snapshot.val();
                    if (storedData && storedData.accounts) {
                        appData = storedData;
                    } else {
                        appData = { accounts: { 'é è¨­å¸³æˆ¶': '' }, currentAccount: 'é è¨­å¸³æˆ¶' };
                    }
                     if (!appData.accounts[appData.currentAccount]) {
                        appData.currentAccount = Object.keys(appData.accounts)[0] || 'é è¨­å¸³æˆ¶';
                        if (!appData.accounts[appData.currentAccount]) {
                             appData.accounts['é è¨­å¸³æˆ¶'] = '';
                        }
                    }
                    
                    // è³‡æ–™é·ç§»å’Œæ¸…ç†
                    for (const accountName in appData.accounts) {
                        if(appData.accounts[accountName] && Array.isArray(appData.accounts[accountName])){
                            appData.accounts[accountName].forEach(tx => {
                                if (!tx.name) tx.name = stockNameMap[tx.symbol] || '';
                                // [æ–°å¢åŠŸèƒ½] ç‚ºèˆŠè³‡æ–™åŠ ä¸Š reviewed å±¬æ€§
                                if (tx.reviewed === undefined) {
                                    tx.reviewed = false;
                                }
                            });
                        } else {
                            // è™•ç†ä½”ä½ç¬¦æˆ–èˆŠè³‡æ–™æ ¼å¼å•é¡Œ
                             if (appData.accounts[accountName] === '') {
                                 appData.accounts[accountName] = []; // å°‡ä½”ä½ç¬¦è½‰æ›å›ç©ºé™£åˆ—
                             } else {
                                 appData.accounts[accountName] = [];
                             }
                        }
                    }
                    cleanupExpiredTransactions(); 
                    
                    const isCollapsed = localStorage.getItem('isFormCollapsed_SharesOnly') === 'true';
                    if (isCollapsed) {
                        collapsibleContent.style.maxHeight = null;
                        collapseIcon.style.transform = 'rotate(-90deg)';
                    } else {
                        collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                        collapseIcon.style.transform = 'rotate(0deg)';
                    }
                    
                    updateAccountFilterOptions();
                    updateStockFilterOptions();
                    render();
                });
            }

            function saveDataToFirebase() {
                if (!dbRef) return;
                const dataToSave = JSON.parse(JSON.stringify(appData));
                for (const accountName in dataToSave.accounts) {
                    const transactions = dataToSave.accounts[accountName];
                    if (Array.isArray(transactions) && transactions.length === 0) {
                        dataToSave.accounts[accountName] = ''; 
                    }
                }
                dbRef.set(dataToSave)
                    .catch(error => console.error("è³‡æ–™å„²å­˜å¤±æ•—:", error));
            }

            loginBtn.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider);
            });

            logoutBtn.addEventListener('click', () => {
                auth.signOut();
            });

            // --- å‡½å¼å®šç¾© ---

            function setDateToToday() {
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('buy-date').value = today;
                document.getElementById('sell-date').value = today;
            }

            function cleanupExpiredTransactions() {
                let changed = false;
                const now = Date.now();
                for (const accountName in appData.accounts) {
                    const transactions = appData.accounts[accountName];
                    if (!Array.isArray(transactions)) continue;

                    const symbolsWithExpiredTimestamp = [...new Set(
                        transactions
                            .filter(tx => tx.deletionTimestamp && tx.deletionTimestamp <= now)
                            .map(tx => tx.symbol)
                    )];

                    symbolsWithExpiredTimestamp.forEach(symbol => {
                        const holdings = getCurrentHoldings(symbol, transactions);
                        const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);

                        if (currentShares === 0) {
                            appData.accounts[accountName] = transactions.filter(tx => tx.symbol !== symbol);
                        } else {
                            appData.accounts[accountName].forEach(tx => {
                                if (tx.symbol === symbol) {
                                    delete tx.deletionTimestamp;
                                }
                            });
                        }
                        changed = true;
                    });
                }
                if (changed) saveDataToFirebase();
            }
            
            function updateAccountFilterOptions() {
                const accountNames = Object.keys(appData.accounts);
                accountFilter.innerHTML = '';
                accountNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    accountFilter.appendChild(option);
                });
                accountFilter.value = appData.currentAccount;
                deleteAccountBtn.classList.toggle('hidden', accountNames.length <= 1);
            }

            function updateStockFilterOptions() {
                const currentTransactions = appData.accounts[appData.currentAccount] || [];
                const selectedValue = stockFilter.value;
                const searchTerm = stockSearch.value.trim().toUpperCase();
                
                if (!Array.isArray(currentTransactions)) return;

                let symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                
                if (searchTerm) {
                    symbols = symbols.filter(symbol => symbol.toUpperCase().includes(searchTerm));
                }

                symbols.sort();
                
                const isCurrentSelectionValid = symbols.includes(selectedValue) || selectedValue === '__ALL__';

                stockFilter.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = '__ALL__';
                allOption.textContent = 'å…¨éƒ¨åº«å­˜';
                stockFilter.appendChild(allOption);

                if (symbols.length > 0) {
                    symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = `${symbol} (${stockNameMap[symbol] || 'æœªçŸ¥'})`;
                        stockFilter.appendChild(option);
                    });
                }
                if (isCurrentSelectionValid) {
                     stockFilter.value = selectedValue;
                } else {
                     stockFilter.value = '__ALL__';
                }
            }
            
            function showModal(modalElement, title, message) {
                 if (modalElement === messageModal) {
                     messageModalTitle.textContent = title;
                     messageModalMessage.textContent = message;
                 }
                 modalElement.classList.remove('opacity-0', 'pointer-events-none');
                 modalElement.querySelector('.modal-content').classList.remove('scale-95');
            }
            
            function hideModal(modalElement) {
                modalElement.classList.add('opacity-0', 'pointer-events-none');
                modalElement.querySelector('.modal-content').classList.add('scale-95');
            }
            
            messageModalClose.addEventListener('click', () => hideModal(messageModal));
            addAccountBtn.addEventListener('click', () => showModal(addAccountModal));
            addAccountCancelBtn.addEventListener('click', () => hideModal(addAccountModal));
            
            editAccountBtn.addEventListener('click', () => {
                editAccountNameInput.value = appData.currentAccount;
                showModal(editAccountModal);
            });
            editAccountCancelBtn.addEventListener('click', () => hideModal(editAccountModal));
            
            deleteAccountBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount;
                deleteAccountMessage.textContent = `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${accountToDelete}ã€å¸³æˆ¶å—ï¼Ÿæ­¤å¸³æˆ¶å…§çš„æ‰€æœ‰äº¤æ˜“ç´€éŒ„å°‡è¢«æ°¸ä¹…ç§»é™¤ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`;
                showModal(deleteAccountModal);
            });
            deleteAccountCancelBtn.addEventListener('click', () => hideModal(deleteAccountModal));
            
            function getCurrentHoldings(symbol, transactions) {
                if (!Array.isArray(transactions)) return [];
                const activeTransactions = transactions.filter(tx => !tx.deletionTimestamp);
                const symbolTxs = activeTransactions.filter(tx => tx.symbol === symbol);
                const buyTxs = symbolTxs.filter(tx => tx.type === 'BUY').sort((a, b) => new Date(a.date) - new Date(b.date));
                const sellTxs = symbolTxs.filter(tx => tx.type === 'SELL');
                let sharesSold = sellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                
                const holdings = [];
                for (const buyTx of buyTxs) {
                    if (sharesSold <= 0) {
                        holdings.push({...buyTx});
                        continue;
                    }
                    if (buyTx.shares > sharesSold) {
                        holdings.push({...buyTx, shares: buyTx.shares - sharesSold});
                        sharesSold = 0;
                    } else {
                        sharesSold -= buyTx.shares;
                    }
                }
                return holdings;
            }

            function renderPortfolioChart() {
                const currentTransactions = appData.accounts[appData.currentAccount] || [];
                if (!Array.isArray(currentTransactions)) return;

                const symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                
                const chartData = symbols.map(symbol => {
                    const holdings = getCurrentHoldings(symbol, currentTransactions);
                    const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    return {
                        symbol: `${symbol} (${stockNameMap[symbol] || 'æœªçŸ¥'})`,
                        shares: totalShares
                    };
                }).filter(d => d.shares > 0);

                noChartDataMsg.classList.toggle('hidden', chartData.length > 1);
                portfolioChartCanvas.classList.toggle('hidden', chartData.length <= 1);

                if (chartData.length <= 1) {
                    if (portfolioChart) {
                        portfolioChart.destroy();
                        portfolioChart = null;
                    }
                    return;
                }

                const labels = chartData.map(d => d.symbol);
                const data = chartData.map(d => d.shares);
                
                const backgroundColors = data.map(() => `hsla(${Math.random() * 360}, 70%, 60%, 0.8)`);
                const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));

                if (portfolioChart) {
                    portfolioChart.destroy();
                }

                portfolioChart = new Chart(portfolioChartCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'è‚¡æ•¸',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#d6d3d1',
                                    font: {
                                        family: "'Inter', 'Noto Sans TC', sans-serif"
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += context.parsed.toLocaleString('en-US', {maximumFractionDigits: 8}) + ' è‚¡';
                                        }
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const value = context.parsed;
                                        const percentage = ((value / total) * 100).toFixed(2);
                                        return `ä½”æ¯”: ${percentage}%`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function render() {
                const currentTransactions = appData.accounts[appData.currentAccount] || [];
                if (!Array.isArray(currentTransactions)) return;
                
                const selectedValue = stockFilter.value;
                const tableHead = transactionList.parentElement.querySelector('thead');
                transactionList.innerHTML = '';

                if (selectedValue === '__ALL__') {
                    paginationControls.classList.add('hidden');
                    viewTitle.textContent = 'æŠ•è³‡çµ„åˆç¸½è¦½';
                    sharesTitle.textContent = 'å…¨éƒ¨åº«å­˜æª”æ•¸';
                    historyTitle.textContent = 'åº«å­˜æ˜ç´°';
                    calculatePortfolioSummary(currentTransactions);
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">è‚¡ç¥¨ä»£è™Ÿ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">è‚¡ç¥¨åç¨±</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æŒæœ‰è‚¡æ•¸</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æ›´æ–°æ—¥æœŸ</th>
                        </tr>
                    `;
                    
                    const symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                    let portfolioDetails = symbols.map(symbol => {
                        const holdings = getCurrentHoldings(symbol, currentTransactions);
                        const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                        if (totalShares <= 0) return null;

                        const symbolTransactions = currentTransactions.filter(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        const lastUpdateDate = symbolTransactions.reduce((max, tx) => (tx.date > max ? tx.date : max), '0000-00-00');
                        const name = (symbolTransactions.find(tx => tx.name) || {}).name || '';
                        return { symbol, name, totalShares, lastUpdateDate };
                    }).filter(Boolean);

                    portfolioDetails.sort((a, b) => new Date(b.lastUpdateDate) - new Date(a.lastUpdateDate));

                    if (portfolioDetails.length > 0) {
                        portfolioDetails.forEach(detail => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-stone-700/50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-100">${detail.symbol}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalShares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.lastUpdateDate}</td>
                            `;
                            transactionList.appendChild(row);
                        });
                    }
                    noDataMsg.textContent = 'å°šç„¡ä»»ä½•åº«å­˜';
                    noDataMsg.classList.toggle('hidden', portfolioDetails.length > 0);
                } else {
                    const stockName = (currentTransactions.find(tx => tx.symbol === selectedValue) || {}).name || '';
                    viewTitle.textContent = `å€‹åˆ¥è‚¡ç¥¨æª¢è¦–: ${selectedValue} ${stockName}`;
                    sharesTitle.textContent = 'æŒæœ‰è‚¡æ•¸';
                    historyTitle.textContent = 'äº¤æ˜“æ­·å²ç´€éŒ„';
                    calculateSummary(selectedValue, currentTransactions);
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æ—¥æœŸ</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">é¡å‹</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">è‚¡æ•¸</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">æ›´æ–°ç‹€æ…‹</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">æ“ä½œ</span></th>
                        </tr>
                    `;
                    const displayTransactions = currentTransactions.filter(tx => tx.symbol === selectedValue);
                    const sortedTransactions = [...displayTransactions].sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
                    const itemsPerPage = 10;
                    const totalPages = Math.ceil(sortedTransactions.length / itemsPerPage) || 1;
                    if (currentPage > totalPages) currentPage = totalPages;
                    const paginatedTransactions = sortedTransactions.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                    paginationControls.classList.toggle('hidden', sortedTransactions.length <= itemsPerPage);
                    pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPages} é `;
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages;
                    paginatedTransactions.forEach(tx => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-stone-700/50 transition-colors duration-200';
                        
                        const typeCell = tx.type === 'BUY' 
                            ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-sky-900 text-sky-200">è²·å…¥</span>`
                            : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-rose-900 text-rose-200">è³£å‡º</span>`;

                        // [æ–°å¢åŠŸèƒ½] å»ºç«‹ç‹€æ…‹åˆ‡æ›æŒ‰éˆ•
                        const statusText = tx.reviewed ? 'æ˜¯' : 'å¦';
                        const statusColor = tx.reviewed ? 'bg-emerald-800 text-emerald-100 hover:bg-emerald-700' : 'bg-stone-600 text-stone-200 hover:bg-stone-500';
                        const statusButtonHTML = `
                            <button class="px-3 py-1 text-xs font-semibold rounded-full transition-colors duration-200 ${statusColor}" data-id="${tx.id}" data-action="toggle-status">
                                ${statusText}
                            </button>
                        `;

                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${typeCell}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.shares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${statusButtonHTML}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                <button class="text-stone-400 hover:text-stone-200" data-id="${tx.id}" data-action="edit">ç·¨è¼¯</button>
                                <button class="text-rose-400 hover:text-rose-500" data-id="${tx.id}" data-action="delete">åˆªé™¤</button>
                            </td>
                        `;
                        transactionList.appendChild(row);
                    });
                    noDataMsg.textContent = 'å°šç„¡äº¤æ˜“ç´€éŒ„';
                    noDataMsg.classList.toggle('hidden', displayTransactions.length > 0);
                }
                renderPortfolioChart();
            }

            function calculateSummary(symbol, transactions) {
                if (!Array.isArray(transactions)) {
                    totalSharesEl.textContent = '0';
                    return;
                }
                const holdings = getCurrentHoldings(symbol, transactions);
                const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                totalSharesEl.textContent = totalShares.toLocaleString('en-US', {maximumFractionDigits: 8});
            }
            
            function calculatePortfolioSummary(transactions) {
                if (!Array.isArray(transactions)) {
                    totalSharesEl.textContent = '0';
                    return;
                }
                const symbols = [...new Set(transactions.map(tx => tx.symbol))];
                let portfolioStockCount = 0;
                symbols.forEach(symbol => {
                    const holdings = getCurrentHoldings(symbol, transactions);
                    const symbolTotalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    if (symbolTotalShares > 0) {
                        portfolioStockCount++;
                    }
                });
                totalSharesEl.textContent = new Intl.NumberFormat().format(portfolioStockCount);
            }

            addBuyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const symbol = document.getElementById('buy-symbol').value.trim().toUpperCase();
                const name = stockNameMap[symbol] || '';
                const date = document.getElementById('buy-date').value;
                const shares = parseFloat(document.getElementById('buy-shares').value);
                if (!symbol) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚'); return; }
                if (isNaN(shares) || shares <= 0) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹æª¢æŸ¥è‚¡æ•¸æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ­£æ•¸ã€‚'); return; }
                // [æ–°å¢åŠŸèƒ½] æ–°äº¤æ˜“é è¨­ reviewed ç‚º false
                appData.accounts[appData.currentAccount].push({ id: Date.now(), type: 'BUY', symbol, name, date, shares, reviewed: false });
                saveDataToFirebase();
                addBuyForm.reset();
                setDateToToday();
                updateStockFilterOptions();
                stockFilter.value = symbol;
                currentPage = 1;
                render();
            });
            
            addSellForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const symbol = document.getElementById('sell-symbol').value.trim().toUpperCase();
                const name = stockNameMap[symbol] || '';
                const date = document.getElementById('sell-date').value;
                const sharesToSell = parseFloat(document.getElementById('sell-shares').value);
                const currentTransactions = appData.accounts[appData.currentAccount];
                if (!symbol) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿã€‚'); return; }
                if (isNaN(sharesToSell) || sharesToSell <= 0) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹æª¢æŸ¥è‚¡æ•¸æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ­£æ•¸ã€‚'); return; }
                
                const holdings = getCurrentHoldings(symbol, currentTransactions);
                const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                if (sharesToSell > currentShares) {
                    showModal(messageModal, 'è³£å‡ºå¤±æ•—', `æ‚¨åªæœ‰ ${currentShares.toLocaleString('en-US', {maximumFractionDigits: 8})} è‚¡ï¼Œç„¡æ³•è³£å‡º ${sharesToSell} è‚¡ã€‚`);
                    return;
                }
                // [æ–°å¢åŠŸèƒ½] æ–°äº¤æ˜“é è¨­ reviewed ç‚º false
                currentTransactions.push({ id: Date.now(), type: 'SELL', symbol, name, date, shares: sharesToSell, reviewed: false });
                saveDataToFirebase();
                addSellForm.reset();
                setDateToToday();

                const updatedHoldings = getCurrentHoldings(symbol, currentTransactions);
                const remainingShares = updatedHoldings.reduce((sum, tx) => sum + tx.shares, 0);
                if (remainingShares === 0) {
                    symbolToClear = symbol;
                    clearHistoryMessage.textContent = `è‚¡ç¥¨ ${symbol} çš„åº«å­˜å·²ç‚ºé›¶ï¼Œæ˜¯å¦è¦æ¸…é™¤å…¶æ‰€æœ‰ç›¸é—œäº¤æ˜“æ­·å²ç´€éŒ„ï¼Ÿ`;
                    showModal(clearHistoryModal);
                } else {
                    updateStockFilterOptions();
                    stockFilter.value = symbol;
                    currentPage = 1;
                    render();
                }
            });

            transactionList.addEventListener('click', (e) => {
                const target = e.target;
                if (!target.dataset.action) return;

                const action = target.dataset.action;
                const id = parseInt(target.dataset.id, 10);
                const currentTransactions = appData.accounts[appData.currentAccount];

                if (action === 'delete') {
                    appData.accounts[appData.currentAccount] = currentTransactions.filter(tx => tx.id !== id);
                    saveDataToFirebase();
                    updateStockFilterOptions();
                    currentPage = 1;
                    render();
                } else if (action === 'edit') {
                    const tx = currentTransactions.find(t => t.id === id);
                    if (tx) {
                        document.getElementById('edit-transaction-id').value = tx.id;
                        document.getElementById('edit-symbol').value = tx.symbol;
                        document.getElementById('edit-date').value = tx.date;
                        document.getElementById('edit-shares').value = tx.shares;
                        editModalTitle.textContent = `ç·¨è¼¯ ${tx.symbol} (${tx.type === 'BUY' ? 'è²·å…¥' : 'è³£å‡º'})`;
                        document.getElementById('edit-symbol').dispatchEvent(new Event('input'));
                        showModal(editTransactionModal);
                    }
                } else if (action === 'toggle-status') {
                    // [æ–°å¢åŠŸèƒ½] åˆ‡æ› reviewed ç‹€æ…‹
                    const txToUpdate = currentTransactions.find(t => t.id === id);
                    if (txToUpdate) {
                        txToUpdate.reviewed = !txToUpdate.reviewed; // åˆ‡æ›å¸ƒæ—å€¼
                        saveDataToFirebase();
                        // ä¸éœ€è¦æ‰‹å‹• renderï¼ŒFirebase çš„ on('value') æœƒè‡ªå‹•æ›´æ–°ç•«é¢
                    }
                }
            });

            accountFilter.addEventListener('change', (e) => {
                appData.currentAccount = e.target.value;
                saveDataToFirebase();
                stockSearch.value = '';
                updateStockFilterOptions();
                currentPage = 1;
                render();
            });
            
            stockFilter.addEventListener('change', () => {
                currentPage = 1;
                render();
            });
            
            stockSearch.addEventListener('input', () => {
                updateStockFilterOptions();
                render();
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    render();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                currentPage++;
                render();
            });
            
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newAccountNameInput = document.getElementById('new-account-name');
                const newAccountName = newAccountNameInput.value.trim();
                if (!newAccountName) {
                    showModal(messageModal, 'éŒ¯èª¤', 'å¸³æˆ¶åç¨±ä¸èƒ½ç‚ºç©ºã€‚');
                    return;
                }
                if (appData.accounts[newAccountName]) {
                    showModal(messageModal, 'éŒ¯èª¤', 'è©²å¸³æˆ¶åç¨±å·²å­˜åœ¨ã€‚');
                    return;
                }
                appData.accounts[newAccountName] = '';
                appData.currentAccount = newAccountName;
                saveDataToFirebase();
                newAccountNameInput.value = '';
                hideModal(addAccountModal);
                updateAccountFilterOptions();
                updateStockFilterOptions();
                currentPage = 1;
                render();
            });
            
            editAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const oldAccountName = appData.currentAccount;
                const newAccountName = editAccountNameInput.value.trim();
                if (!newAccountName) {
                    showModal(messageModal, 'éŒ¯èª¤', 'å¸³æˆ¶åç¨±ä¸èƒ½ç‚ºç©ºã€‚');
                    return;
                }
                if (newAccountName !== oldAccountName && appData.accounts[newAccountName]) {
                     showModal(messageModal, 'éŒ¯èª¤', 'è©²å¸³æˆ¶åç¨±å·²å­˜åœ¨ã€‚');
                    return;
                }
                if (newAccountName !== oldAccountName) {
                    appData.accounts[newAccountName] = appData.accounts[oldAccountName];
                    delete appData.accounts[oldAccountName];
                    appData.currentAccount = newAccountName;
                    saveDataToFirebase();
                    updateAccountFilterOptions();
                    render();
                }
                hideModal(editAccountModal);
            });

            deleteAccountConfirmBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount;
                if (Object.keys(appData.accounts).length <= 1) {
                    showModal(messageModal, 'éŒ¯èª¤', 'ç„¡æ³•åˆªé™¤æœ€å¾Œä¸€å€‹å¸³æˆ¶ã€‚');
                    hideModal(deleteAccountModal);
                    return;
                }
                delete appData.accounts[accountToDelete];
                appData.currentAccount = Object.keys(appData.accounts)[0];
                saveDataToFirebase();
                hideModal(deleteAccountModal);
                updateAccountFilterOptions();
                updateStockFilterOptions();
                render();
                showModal(messageModal, 'æˆåŠŸ', `å¸³æˆ¶ã€Œ${accountToDelete}ã€å·²æˆåŠŸåˆªé™¤ã€‚`);
            });
            
            clearHistoryNowBtn.addEventListener('click', () => {
                if (symbolToClear) {
                    appData.accounts[appData.currentAccount] = appData.accounts[appData.currentAccount].filter(tx => tx.symbol !== symbolToClear);
                    saveDataToFirebase();
                    hideModal(clearHistoryModal);
                    updateStockFilterOptions();
                    render();
                    showModal(messageModal, 'ç´€éŒ„å·²æ¸…é™¤', `è‚¡ç¥¨ ${symbolToClear} çš„æ‰€æœ‰äº¤æ˜“ç´€éŒ„å·²è¢«ç§»é™¤ã€‚`);
                    symbolToClear = null;
                }
            });

            clearHistoryLaterBtn.addEventListener('click', () => {
                if (symbolToClear) {
                    const tenDaysInMillis = 3 * 24 * 60 * 60 * 1000;
                    const deletionTimestamp = Date.now() + tenDaysInMillis;
                    const activeTransactionsForSymbol = appData.accounts[appData.currentAccount]
                        .filter(tx => tx.symbol === symbolToClear && !tx.deletionTimestamp);

                    activeTransactionsForSymbol.forEach(tx => {
                       const originalTx = appData.accounts[appData.currentAccount].find(t => t.id === tx.id);
                       if(originalTx) {
                           originalTx.deletionTimestamp = deletionTimestamp;
                       }
                    });
                    saveDataToFirebase();
                    hideModal(clearHistoryModal);
                    updateStockFilterOptions();
                    stockFilter.value = symbolToClear;
                    render();
                    showModal(messageModal, 'å·²æ’ç¨‹æ¸…é™¤', `è‚¡ç¥¨ ${symbolToClear} çš„ç´€éŒ„å°‡åœ¨3å¤©å¾Œè‡ªå‹•æ¸…é™¤ã€‚`);
                    symbolToClear = null;
                }
            });

            exportBtn.addEventListener('click', () => {
                if (Object.keys(appData.accounts).length === 0) { showModal(messageModal, 'æç¤º', 'æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ã€‚'); return; }
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_shares_tracker_data_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showModal(messageModal, 'åŒ¯å‡ºæˆåŠŸ', 'æ‚¨çš„æ‰€æœ‰å¸³æˆ¶ç´€éŒ„å·²æˆåŠŸåŒ¯å‡ºç‚º JSON æª”æ¡ˆã€‚');
            });

            importBtn.addEventListener('click', () => importFile.click());

            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.accounts && importedData.currentAccount) {
                            const firstAccountKey = Object.keys(importedData.accounts)[0];
                            const firstTransaction = (importedData.accounts[firstAccountKey] || [])[0];
                            if(firstTransaction && 'price' in firstTransaction) {
                                throw new Error('æª”æ¡ˆæ ¼å¼ä¸ç¬¦ (æ­¤ç‚ºæ—§ç‰ˆå«åƒ¹æ ¼è³‡æ–™çš„æª”æ¡ˆ)');
                            }
                            appData = importedData;
                            saveDataToFirebase();
                            currentPage = 1;
                            showModal(messageModal, 'åŒ¯å…¥æˆåŠŸ', 'æ‰€æœ‰å¸³æˆ¶ç´€éŒ„å·²æˆåŠŸåŒ¯å…¥ä¸¦åŒæ­¥è‡³é›²ç«¯ã€‚');
                        } else {
                            throw new Error('æª”æ¡ˆæ ¼å¼ä¸ç¬¦');
                        }
                    } catch (error) {
                         showModal(messageModal, 'åŒ¯å…¥å¤±æ•—', `æª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºæˆ–å·²ææ¯€ã€‚(${error.message})`);
                    }
                };
                reader.onerror = () => {
                    showModal(messageModal, 'åŒ¯å…¥å¤±æ•—', 'è®€å–æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ã€‚');
                };
                reader.readAsText(file);
                importFile.value = '';
            });
            
            editTransactionCancelBtn.addEventListener('click', () => hideModal(editTransactionModal));
            
            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-transaction-id').value, 10);
                const newSymbol = document.getElementById('edit-symbol').value.trim().toUpperCase();
                const newDate = document.getElementById('edit-date').value;
                const newShares = parseFloat(document.getElementById('edit-shares').value);
                
                const currentTransactions = appData.accounts[appData.currentAccount];
                const txIndex = currentTransactions.findIndex(t => t.id === id);
                if (txIndex === -1) return;
                
                const originalSymbol = currentTransactions[txIndex].symbol;

                if (!newSymbol) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è‚¡ç¥¨ä»£è™Ÿä¸èƒ½ç‚ºç©ºã€‚'); return; }
                if (isNaN(newShares) || newShares <= 0) { showModal(messageModal, 'è¼¸å…¥éŒ¯èª¤', 'è«‹æª¢æŸ¥è‚¡æ•¸æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ­£æ•¸ã€‚'); return; }

                const tempTransactions = JSON.parse(JSON.stringify(currentTransactions));
                const tempTxToUpdate = tempTransactions.find(t => t.id === id);
                tempTxToUpdate.symbol = newSymbol;
                tempTxToUpdate.date = newDate;
                tempTxToUpdate.shares = newShares;
                
                const affectedSymbols = new Set([originalSymbol, newSymbol]);
                for (const symbol of affectedSymbols) {
                    const symbolTxs = tempTransactions.filter(tx => tx.symbol === symbol);
                    const buyTxs = symbolTxs.filter(tx => tx.type === 'BUY');
                    const sellTxs = symbolTxs.filter(tx => tx.type === 'SELL');
                    const totalBought = buyTxs.reduce((sum, tx) => sum + tx.shares, 0);
                    const totalSold = sellTxs.reduce((sum, tx) => sum + tx.shares, 0);

                    if (totalSold > totalBought) {
                        showModal(messageModal, 'ç·¨è¼¯å¤±æ•—', `æ­¤ä¿®æ”¹æœƒå°è‡´è‚¡ç¥¨ ${symbol} çš„åº«å­˜è®Šç‚ºè² æ•¸ï¼Œè«‹é‡æ–°æª¢æŸ¥ã€‚`);
                        return; 
                    }
                }

                const transactionToUpdate = currentTransactions[txIndex];
                transactionToUpdate.symbol = newSymbol;
                transactionToUpdate.name = stockNameMap[newSymbol] || '';
                transactionToUpdate.date = newDate;
                transactionToUpdate.shares = newShares;
                saveDataToFirebase();
                hideModal(editTransactionModal);
                
                let zeroedOutSymbol = null;
                for (const symbol of affectedSymbols) {
                    const holdings = getCurrentHoldings(symbol, currentTransactions);
                    const remainingShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    if (remainingShares === 0) {
                        const hasActiveTxs = currentTransactions.some(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        if (hasActiveTxs) {
                           zeroedOutSymbol = symbol;
                           break; 
                        }
                    }
                }

                if (zeroedOutSymbol) {
                    symbolToClear = zeroedOutSymbol;
                    clearHistoryMessage.textContent = `ç·¨è¼¯å¾Œï¼Œè‚¡ç¥¨ ${zeroedOutSymbol} çš„åº«å­˜å·²ç‚ºé›¶ï¼Œæ˜¯å¦è¦æ¸…é™¤å…¶æ‰€æœ‰ç›¸é—œäº¤æ˜“æ­·å²ç´€éŒ„ï¼Ÿ`;
                    showModal(clearHistoryModal);
                } else {
                    updateStockFilterOptions();
                    render(); 
                }
            });

            function handleSymbolInput(e) {
                clearTimeout(debounceTimer);
                const symbol = e.target.value.trim().toUpperCase();
                const nameDisplayId = `${e.target.id}-name`;
                const nameDisplayEl = document.getElementById(nameDisplayId);
                if (!nameDisplayEl) return;

                debounceTimer = setTimeout(() => {
                    if (stockNameMap[symbol]) {
                        nameDisplayEl.textContent = stockNameMap[symbol];
                    } else {
                        nameDisplayEl.textContent = '';
                    }
                }, 300);
            }

            // --- ç¨‹å¼é€²å…¥é» ---
            setDateToToday();
            
            // --- äº‹ä»¶ç›£è½ç¶å®š ---
            collapsibleHeader.addEventListener('click', () => {
                if (collapsibleContent.style.maxHeight) {
                    collapsibleContent.style.maxHeight = null;
                    collapseIcon.style.transform = 'rotate(-90deg)';
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'true');
                } else {
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                    collapseIcon.style.transform = 'rotate(0deg)';
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'false');
                }
            });

            document.getElementById('buy-symbol').addEventListener('input', handleSymbolInput);
            document.getElementById('sell-symbol').addEventListener('input', handleSymbolInput);
            document.getElementById('edit-symbol').addEventListener('input', handleSymbolInput);
        });
    </script>
</body>
</html>
