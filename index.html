<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📈雲端儀表板📊</title>
    <link rel="icon" href="ElienOnly.ico" type="image/ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js 圖表庫已移除 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 莫蘭迪深色系配色 --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1c1917; 
            color: #f5f5f4; 
        }
        .table-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .table-scrollbar::-webkit-scrollbar-track {
            background: #292524;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb {
            background: #57534e;
            border-radius: 10px;
        }
        .table-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #78716c;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
             transition: transform 0.3s ease;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8); 
            cursor: pointer; 
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        input[type="date"]::-webkit-datetime-edit {
            font-size: 0.85rem; /* 等同於 Tailwind 的 text-xs */
        }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
</head>
<body class="antialiased">

    <!-- 登入/驗證區塊 -->
    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈雲端儀表板📊</h1>
        <p class="mt-4 text-stone-400">使用 Google 帳戶登入以跨裝置同步持股資料</p>
        <button id="login-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">使用 Google 登入</button>
    </div>

    <!-- 主應用程式容器 (登入後顯示) -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl hidden"> 
        <div class="flex justify-between items-center mb-6">
             <p id="user-display" class="text-sm text-stone-400"></p>
             <button id="logout-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">登出</button>
        </div>
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈雲端儀表板📊</h1>
            <p class="mt-2 text-lg text-stone-400">🇹🇼  🇺🇸 ➡️ 🥦 🔥</p>
        </header>

        <main class="space-y-8">
            <!-- 帳戶選擇區塊 -->
            <div class="bg-stone-800 p-4 rounded-2xl shadow-lg border border-stone-700">
                <label for="account-filter" class="block text-sm font-medium text-stone-300 mb-2">目前帳戶</label>
                <div class="flex items-center space-x-2">
                    <select id="account-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    <button id="add-account-btn" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">＋</button>
                    <button id="edit-account-btn" class="flex-shrink-0 bg-stone-500 hover:bg-stone-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">✏️</button>
                    <button id="delete-account-btn" class="flex-shrink-0 bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md hidden">－</button>
                </div>
            </div>

            <!-- 總覽與篩選區塊 -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700 space-y-4">
                <h2 id="view-title" class="text-2xl font-bold text-stone-100 tracking-tight">總覽</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="stock-search" class="block text-sm font-medium text-stone-300 mb-2">搜尋或選擇檢視項目</label>
                        <input type="text" id="stock-search" placeholder="輸入代號篩選..." class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                    </div>
                    <div>
                        <label for="stock-filter" class="block text-sm font-medium text-transparent mb-2 select-none">.</label>
                        <select id="stock-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div>
                        <label id="shares-title" class="block text-sm font-medium text-stone-300 mb-2">全部庫存檔數</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalShares" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 新增交易紀錄 (可摺疊) -->
            <div class="bg-stone-800 rounded-2xl shadow-lg border border-stone-700">
                <div id="collapsible-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-stone-100">新增交易紀錄</h2>
                    <span id="collapse-icon" class="text-stone-400 transform transition-transform duration-300">▼</span>
                </div>
                <div id="collapsible-content" class="collapsible-content">
                    <div class="p-4 pt-0 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 買入表單 -->
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-sky-800">
                            <h3 class="text-lg font-semibold mb-4 text-sky-300">買入</h3>
                            <form id="add-buy-form" class="space-y-4">
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label for="buy-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                                        <input type="text" id="buy-symbol" required placeholder="例如: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="buy-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="buy-date" class="block text-sm font-medium text-stone-300">日期</label>
                                        <input type="date" id="buy-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="buy-shares" class="block text-sm font-medium text-stone-300">股數</label>
                                        <input type="number" id="buy-shares" min="0" step="any" required placeholder="1000" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">買入</button>
                            </form>
                        </div>
                        <!-- 賣出表單 -->
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-rose-800">
                            <h3 class="text-lg font-semibold mb-4 text-rose-300">賣出</h3>
                            <form id="add-sell-form" class="space-y-4">
                                <div class="grid grid-cols-3 gap-4">
                                    <div>
                                        <label for="sell-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                                        <input type="text" id="sell-symbol" required placeholder="例如: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-rose-400 focus:border-rose-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="sell-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="sell-date" class="block text-sm font-medium text-stone-300">日期</label>
                                        <input type="date" id="sell-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-rose-400 focus:border-rose-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="sell-shares" class="block text-sm font-medium text-stone-300">股數</label>
                                        <input type="number" id="sell-shares" min="0" step="any" required placeholder="500" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-rose-400 focus:border-rose-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">賣出</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 持股佔比分析圖表區塊 (已移除) -->

            <!-- 交易歷史/庫存明細區塊 -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="history-title" class="text-xl font-semibold text-stone-100">交易歷史紀錄</h2>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <button id="import-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯入資料</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="export-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯出資料</button>
                    </div>
                </div>
                <div class="overflow-x-auto table-scrollbar">
                    <table class="min-w-full divide-y divide-stone-700">
                        <thead class="bg-stone-900">
                            </thead>
                        <tbody id="transaction-list" class="divide-y divide-stone-700">
                            </tbody>
                    </table>
                    <p id="no-data-msg" class="text-center py-8 text-stone-500">尚無交易紀錄</p>
                </div>
                 <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-stone-400 hidden">
                    <button id="prev-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">&lt; 上一頁</button>
                    <span id="page-info">第 1 / 1 頁</span>
                    <button id="next-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">下一頁 &gt;</button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 以下是各種彈出式視窗 (Modal) -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="message-modal-title" class="text-lg font-semibold text-stone-100">提示</h3>
            <p id="message-modal-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">確認</button>
            </div>
        </div>
    </div>

    <div id="add-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">新增帳戶</h3>
            <form id="add-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="new-account-name" class="block text-sm font-medium text-stone-300">帳戶名稱</label>
                    <input type="text" id="new-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">建立</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">修改帳戶名稱</h3>
            <form id="edit-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="edit-account-name" class="block text-sm font-medium text-stone-300">新帳戶名稱</label>
                    <input type="text" id="edit-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-4 rounded-lg transition">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-transaction-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="edit-modal-title" class="text-lg font-semibold text-stone-100">編輯交易紀錄</h3>
            <form id="edit-transaction-form" class="mt-4 space-y-4">
                <input type="hidden" id="edit-transaction-id">
                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="edit-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                        <input type="text" id="edit-symbol" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                        <small id="edit-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                    </div>
                    <div>
                         <label for="edit-date" class="block text-sm font-medium text-stone-300">日期</label>
                         <input type="date" id="edit-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div>
                         <label for="edit-shares" class="block text-sm font-medium text-stone-300">股數</label>
                         <input type="number" id="edit-shares" min="0" step="any" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-transaction-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">儲存變更</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-rose-400">確認刪除帳戶</h3>
            <p id="delete-account-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="delete-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                <button type="button" id="delete-account-confirm" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">確認刪除</button>
            </div>
        </div>
    </div>
    
    <div id="clear-history-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-amber-400">確認清除紀錄</h3>
            <p id="clear-history-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="clear-history-later-btn" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">否 (10天後清除)</button>
                <button type="button" id="clear-history-now-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition">是 (立即清除)</button>
            </div>
        </div>
    </div>

    <script>
        // 當整個 HTML 文件被載入和解析完成後，執行此腳本
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase 設定 (請貼上您自己的設定) ---
            // 這是您 Firebase 專案的憑證，讓這個網頁應用程式知道要連接到哪個雲端專案
            const firebaseConfig = {
                apiKey: "AIzaSyBNA20afPELKWGlKHkQfdNhk5Z1wjlTYfs",
                authDomain: "stock-tracker-940de.firebaseapp.com",
                databaseURL: "https://stock-tracker-940de-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "stock-tracker-940de",
                storageBucket: "stock-tracker-940de.firebasestorage.app",
                messagingSenderId: "546233071753",
                appId: "1:546233071753:web:c95d9bece5dd10aa83ae58"
                };

            // --- Firebase 初始化 ---
            // 使用上面的設定資訊來初始化 Firebase 服務
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth(); // 取得驗證服務的實體
            const db = firebase.database(); // 取得即時資料庫服務的實體
            let user = null; // 用來存放當前登入使用者的資訊
            let dbRef = null; // 用來存放指向使用者資料庫位置的參考

            // --- DOM 元素宣告 ---
            // 這裡將 HTML 頁面上的各個元素 (按鈕、輸入框、表格等) 與 JavaScript 變數連結起來，方便後續操作
            const addBuyForm = document.getElementById('add-buy-form');
            const addSellForm = document.getElementById('add-sell-form');
            const addAccountForm = document.getElementById('add-account-form');
            const editAccountForm = document.getElementById('edit-account-form');
            const transactionList = document.getElementById('transaction-list');
            const totalSharesEl = document.getElementById('totalShares');
            const exportBtn = document.getElementById('export-btn');
            const importBtn = document.getElementById('import-btn');
            const importFile = document.getElementById('import-file');
            const noDataMsg = document.getElementById('no-data-msg');
            const accountFilter = document.getElementById('account-filter');
            const stockFilter = document.getElementById('stock-filter');
            const stockSearch = document.getElementById('stock-search');
            const viewTitle = document.getElementById('view-title');
            const sharesTitle = document.getElementById('shares-title');
            const historyTitle = document.getElementById('history-title');
            const messageModal = document.getElementById('message-modal');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalMessage = document.getElementById('message-modal-message');
            const messageModalClose = document.getElementById('message-modal-close');
            const addAccountModal = document.getElementById('add-account-modal');
            const addAccountBtn = document.getElementById('add-account-btn');
            const addAccountCancelBtn = document.getElementById('add-account-cancel');
            const editAccountModal = document.getElementById('edit-account-modal');
            const editAccountBtn = document.getElementById('edit-account-btn');
            const editAccountCancelBtn = document.getElementById('edit-account-cancel');
            const editAccountNameInput = document.getElementById('edit-account-name');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const deleteAccountModal = document.getElementById('delete-account-modal');
            const deleteAccountMessage = document.getElementById('delete-account-message');
            const deleteAccountCancelBtn = document.getElementById('delete-account-cancel');
            const deleteAccountConfirmBtn = document.getElementById('delete-account-confirm');
            const clearHistoryModal = document.getElementById('clear-history-modal');
            const clearHistoryMessage = document.getElementById('clear-history-message');
            const clearHistoryLaterBtn = document.getElementById('clear-history-later-btn');
            const clearHistoryNowBtn = document.getElementById('clear-history-now-btn');
            const paginationControls = document.getElementById('pagination-controls');
            const prevPageBtn = document.getElementById('prev-page-btn');
            const nextPageBtn = document.getElementById('next-page-btn');
            const pageInfo = document.getElementById('page-info');
            const collapsibleHeader = document.getElementById('collapsible-header');
            const collapsibleContent = document.getElementById('collapsible-content');
            const collapseIcon = document.getElementById('collapse-icon');
            const editTransactionModal = document.getElementById('edit-transaction-modal');
            const editTransactionForm = document.getElementById('edit-transaction-form');
            const editModalTitle = document.getElementById('edit-modal-title');
            const editTransactionCancelBtn = document.getElementById('edit-transaction-cancel');
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            // --- 應用程式資料結構與狀態 ---
            // 這些變數用來管理整個應用程式的狀態
            let appData = {}; // 存放從 Firebase 載入的所有帳戶與交易資料
            let currentPage = 1; // 紀錄交易歷史紀錄的目前頁碼
            let symbolToClear = null; // 暫存等待被清除歷史紀錄的股票代號
            let debounceTimer; // 用於輸入時延遲觸發搜尋的計時器

            // 手動輸入的股票代號與名稱對應表，方便顯示
            const stockNameMap = {
				"0050": "元大台灣50", "0051": "元大中型100", "0052": "富邦科技", "0053": "元大電子", "0055": "元大MSCI金融", "0056": "元大高股息", "0057": "富邦摩台", "0061": "元大寶滬深", "006201": "元大寶櫃50", "006203": "元大MSCI台灣", "006204": "永豐臺灣加權", "006205": "富邦上証", "006206": "元大上證50", "006207": "復華滬深", "006208": "富邦台50", "00631L": "元大台灣50正2", "00632R": "元大台灣50反1", "00633L": "富邦上証正2", "00634R": "富邦上証反1", "00635U": "期元大S&P黃金", "00636": "國泰中國A50", "00637L": "元大滬深300正2", "00638R": "元大滬深300反1", "00639": "富邦深100", "00640L": "富邦日本正2", "00641R": "富邦日本反1", "00642U": "期元大S&P石油", "00643": "群益深証中小", "00645": "富邦日本", "00646": "元大S&P500", "00647L": "元大S&P500正2", "00648R": "元大S&P500反1", "00650L": "復華香港正2", "00651R": "復華香港反1", "00652": "富邦印度", "00653L": "富邦印度正2", "00654R": "富邦印度反1", "00655L": "國泰中國A50正2", "00656R": "國泰中國A50反1", "00657": "國泰日經225", "00660": "元大歐洲50", "00661": "元大日經225", "00662": "富邦NASDAQ", "00663L": "國泰臺灣加權正2", "00664R": "國泰臺灣加權反1", "00665L": "富邦恒生國企正2", "00666R": "富邦恒生國企反1", "00668": "國泰美國道瓊", "00669R": "國泰美國道瓊反1", "00670L": "富邦NASDAQ正2", "00671R": "富邦NASDAQ反1", "00673R": "期元大S&P原油反1", "00674R": "期元大S&P黃金反1", "00675L": "富邦臺灣加權正2", "00676R": "富邦臺灣加權反1", "00678": "群益那斯達克生技", "00679B": "元大美債20年", "00680L": "元大美債20正2", "00681R": "元大美債20反1", "00682U": "期元大美元指數", "00683L": "期元大美元指正2", "00684R": "期元大美元指反1", "00685L": "群益臺灣加權正2", "00686R": "群益臺灣加權反1", "00687B": "國泰20年美債", "00688L": "國泰20年美債正2", "00689R": "國泰20年美債反1", "00690": "兆豐台灣藍籌30", "00692": "富邦公司治理", "00693U": "期街口S&P黃豆", "00695B": "富邦美債7-10年", "00696B": "富邦美債20年", "00697B": "元大美債7-10", "00700": "富邦恆生國企", "00701": "國泰股利精選30", "00702": "國泰標普低波高息", "00703": "台新MSCI中國", "00706L": "期元大S&P日圓正2", "00707R": "期元大S&P日圓反1", "00708L": "期元大S&P黃金正2", "00709": "富邦歐洲", "00710B": "復華彭博非投等債", "00711B": "復華彭博新興債", "00712": "復華富時不動產", "00713": "元大台灣高息低波", "00714": "群益道瓊美國地產", "00715L": "期街口布蘭特正2", "00717": "富邦美國特別股", "00719B": "元大美債1-3", "00720B": "元大投資級公司債", "00722B": "群益投資級電信債", "00723B": "群益投資級科技債", "00724B": "群益投資級金融債", "00725B": "國泰投資級公司債", "00726B": "國泰新興投等債", "00727B": "國泰優選投頭等債", "00728": "第一金工業30", "00730": "富邦臺灣優質高息", "00731": "復華富時高息低波", "00733": "富邦臺灣中小", "00734B": "台新JPM新興債", "00735": "國泰臺韓科技", "00736": "國泰新興市場", "00737": "國泰AI機器人", "00738U": "期元大道瓊白銀", "00739": "元大MSCI A股", "00740B": "富邦全球投等債", "00741B": "富邦全球非投等債", "00746B": "富邦A級公司債", "00749B": "凱基新興債10+", "00750B": "凱基科技債10+", "00751B": "元大AAA至A公司債", "00752": "中信中國5G", "00753L": "中信中國5G正2", "00757": "統一FANG+", "00758B": "復華能源債", "00759B": "復華製藥債", "00760B": "復華新興企業債", "00761B": "國泰A級公司債", "00762": "元大全球AI", "00764B": "復華20年美債", "00770": "國泰北美科技", "00771": "元大US高息特別股", "00772B": "中信高評級公司債", "00773B": "中信優先金融債", "00775B": "新光投等債15+", "00777B": "凱基AAA至A公司債", "00778B": "凱基金融債20+", "00779B": "凱基美債25+", "00780B": "國泰A級金融債", "00781B": "國泰A級科技債", "00782B": "國泰A級公用債", "00783": "富邦中証500", "00785B": "富邦金融投等債", "00786B": "元大10年IG銀行債", "00787B": "元大10年IG醫療債", "00788B": "元大10年IG電能債", "00789B": "復華公司債A3", "00791B": "復華信用債1-5", "00792B": "群益A級公司債", "00793B": "群益AAA-A醫療債", "00795B": "中信美國公債20年", "00799B": "國泰A級醫療債", "00830": "國泰費城半導體", "00834B": "第一金融債10+", "00836B": "永豐10年A公司債", "00850": "元大臺灣ESG永續", "00851": "台新全球AI", "00858": "永豐美國500大", "00861": "元大全球未來通訊", "00870B": "元大15年EM主權債", "00875": "國泰網路資安", "00876": "元大全球5G", "00877": "復華中國5G", "00878": "國泰永續高股息", "00881": "國泰台灣科技龍頭", "00882": "中信中國高股息", "00885": "富邦越南", "00886": "永豐美國科技", "00888": "永豐台灣ESG", "00891": "中信關鍵半導體", "00892": "富邦台灣半導體", "00893": "國泰智能電動車", "00894": "中信小資高價30", "00895": "富邦未來車", "00896": "中信綠能及電動車", "00897": "富邦基因免疫生技", "00898": "國泰基因免疫革命", "00899": "FT潔淨能源", "00900": "富邦特選高股息30", "00901": "永豐智能車供應鏈", "00902": "中信電池及儲能", "00903": "富邦元宇宙", "00904": "新光臺灣半導體30", "00905": "FT臺灣Smart", "00907": "永豐優息存股", "00908": "富邦入息REITs+", "00909": "國泰數位支付服務", "00910": "第一金太空衛星", "00911": "兆豐洲際半導體", "00912": "中信臺灣智慧50", "00913": "兆豐台灣晶圓製造", "00915": "凱基優選高股息30", "00917": "中信特選金融", "00918": "大華優利高填息30", "00919": "群益台灣精選高息", "00920": "富邦ESG綠色電力", "00921": "兆豐龍頭等權重", "00922": "國泰台灣領袖50", "00923": "群益台灣ESG低碳", "00924": "復華S&P500成長", "00926": "凱基全球菁英55", "00927": "群益半導體收益", "00928": "中信上櫃ESG 30", "00929": "復華台灣科技優息", "00930": "永豐ESG低碳高息", "00932": "兆豐永續高息等權", "00933B": "國泰10Y+金融債", "00934": "中信成長高股息", "00935": "野村臺灣新科技50", "00936": "台新永續高息中小", "00937B": "群益ESG投等債20+", "00938": "凱基優選30", "00939": "統一台灣高息動能", "00940": "元大台灣價值高息", "00941": "中信上游半導體", "00943": "兆豐電子高息等權", "00944": "野村趨勢動能高息", "00946": "群益科技高息成長", "00947": "台新台灣IC設計", "00949": "復華日本龍頭", "00951": "台新日本半導體", "00952": "凱基台灣AI50", "00954": "中信日本半導體", "00955": "中信日本商社", "00956": "中信日經高股息", "00960": "野村全球航運龍頭", "00961": "FT台灣永續高息", "00962": "台新AI優息動能", "00963": "中信全球高股息", "00964": "中信亞太高股息", "00965": "元大航太防衛科技", "00971": "野村美國研發龍頭", "00972": "野村日本動能高息", "009800": "中信NASDAQ", "009801": "中信美國創新科技", "009802": "富邦旗艦50", "009803": "保德信市值動能50", "009804": "聯邦台精彩50", "009805": "新光美國電力基礎", "009806": "台新標普500", "009807": "台新標普科技精選", "009808": "華南永昌優選50", "00980A": "主動野村臺灣優選", "009810": "保德信全球藍籌", "009811": "統一美國50", "009812": "野村日本東証", "00981A": "主動統一台股增長", "00982A": "主動群益臺灣強棒", "00983A": "主動中信ARK創新", "00984A": "主動安聯臺灣高息", "00985A": "主動野村臺灣50", "00986A": "主動台新龍頭成長",
			};
            
            // --- Firebase 核心功能 ---

            /**
             * 監聽使用者登入狀態的變化。
             * 這是整個應用程式的入口點。
             */
            auth.onAuthStateChanged(currentUser => {
                if (currentUser) {
                    // 如果使用者已登入
                    user = currentUser; // 保存使用者資訊
                    userDisplay.textContent = `歡迎, ${user.displayName || user.email}`; // 顯示歡迎訊息
                    dbRef = db.ref(`users/${user.uid}`); // 設定資料庫參考位置，指向該使用者的專屬資料夾
                    
                    // 顯示主應用程式介面，隱藏登入畫面
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    
                    // 開始監聽雲端資料庫的即時變化
                    listenForDataChanges();
                } else {
                    // 如果使用者已登出
                    user = null; // 清除使用者資訊
                    dbRef = null; // 清除資料庫參考
                    appData = {}; // 清空本地資料
                    
                    // 顯示登入畫面，隱藏主應用程式介面
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });
            
            /**
             * 監聽 Firebase Realtime Database 的資料變化。
             * 當雲端資料有任何新增、修改、刪除時，這個函式會被自動觸發，並更新整個畫面。
             * 這是實現「即時同步」的核心。
             */
            function listenForDataChanges() {
                if (!dbRef) return; // 如果沒有資料庫參考 (未登入)，則不執行
                
                // .on('value', ...) 是 Firebase 的監聽器，只要指定路徑的資料有變動就會觸發
                dbRef.on('value', (snapshot) => {
                    const storedData = snapshot.val(); // 取得雲端上的最新資料快照
                    
                    // 檢查雲端是否有資料，若無 (例如新用戶)，則建立一個初始的資料結構
                    if (storedData && storedData.accounts) {
                        appData = storedData;
                    } else {
                        // 為新用戶設定一個預設帳戶，值為空字串佔位符
                        appData = { accounts: { '預設帳戶': '' }, currentAccount: '預設帳戶' };
                    }
                    
                    // 確保 currentAccount 是一個有效的帳戶，避免出錯
                     if (!appData.accounts[appData.currentAccount]) {
                        appData.currentAccount = Object.keys(appData.accounts)[0] || '預設帳戶';
                        if (!appData.accounts[appData.currentAccount]) {
                             appData.accounts['預設帳戶'] = '';
                        }
                    }
                    
                    // [資料遷移與清理]
                    // 這個迴圈的目的是處理從 Firebase 讀取下來的資料，使其符合前端的需要
                    for (const accountName in appData.accounts) {
                        if(appData.accounts[accountName] && Array.isArray(appData.accounts[accountName])){
                            // 如果帳戶資料是個陣列 (代表有交易紀錄)
                            appData.accounts[accountName].forEach(tx => {
                                // 為舊資料補上股票名稱
                                if (!tx.name) tx.name = stockNameMap[tx.symbol] || '';
                                // 為舊資料補上 'reviewed' 屬性，預設為 false
                                if (tx.reviewed === undefined) {
                                    tx.reviewed = false;
                                }
                            });
                        } else {
                            // 如果不是陣列 (可能是空帳戶的佔位符 '')
                             if (appData.accounts[accountName] === '') {
                                 appData.accounts[accountName] = []; // 將佔位符轉換回前端需要的空陣列
                             } else {
                                 appData.accounts[accountName] = []; // 處理其他異常情況
                             }
                        }
                    }
                    
                    cleanupExpiredTransactions(); // 執行過期交易紀錄的清理
                    
                    // 讀取本地儲存的摺疊狀態，並應用到畫面上
                    const isCollapsed = localStorage.getItem('isFormCollapsed_SharesOnly') === 'true';
                    if (isCollapsed) {
                        collapsibleContent.style.maxHeight = null;
                        collapseIcon.style.transform = 'rotate(-90deg)';
                    } else {
                        collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                        collapseIcon.style.transform = 'rotate(0deg)';
                    }
                    
                    // 更新所有下拉選單並重新渲染整個畫面
                    updateAccountFilterOptions();
                    updateStockFilterOptions();
                    render();
                });
            }

            /**
             * 將本地的 appData 儲存到 Firebase。
             * 這個函式是所有「寫入」操作的最後一關。
             */
            function saveDataToFirebase() {
                if (!dbRef) return; // 如果未登入，則不執行
                
                // 建立一個 appData 的深層複製，避免直接修改到記憶體中的 appData
                const dataToSave = JSON.parse(JSON.stringify(appData));
                
                // [重要] 在儲存前，將所有空的交易紀錄陣列 `[]` 轉換回佔位符 `''`
                // 這是為了防止 Firebase 因值為空而自動刪除該帳戶節點
                for (const accountName in dataToSave.accounts) {
                    const transactions = dataToSave.accounts[accountName];
                    if (Array.isArray(transactions) && transactions.length === 0) {
                        dataToSave.accounts[accountName] = ''; 
                    }
                }
                
                // 使用 .set() 方法將整個處理過的資料物件寫入 Firebase，這會覆蓋雲端上的舊資料
                dbRef.set(dataToSave)
                    .catch(error => console.error("資料儲存失敗:", error));
            }

            // 登入按鈕的點擊事件
            loginBtn.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider(); // 建立 Google 登入提供者
                auth.signInWithPopup(provider); // 觸發彈出式視窗登入流程
            });

            // 登出按鈕的點擊事件
            logoutBtn.addEventListener('click', () => {
                auth.signOut(); // 觸發登出
            });

            // --- 輔助函式定義 ---

            /**
             * 將日期輸入欄位的預設值設為今天。
             */
            function setDateToToday() {
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('buy-date').value = today;
                document.getElementById('sell-date').value = today;
            }

            /**
             * 清理過期的「待刪除」交易紀錄。
             * 當使用者選擇 10 天後清除時，會設定一個 deletionTimestamp，此函式會檢查時間戳是否已過期。
             */
            function cleanupExpiredTransactions() {
                let changed = false;
                const now = Date.now();
                for (const accountName in appData.accounts) {
                    const transactions = appData.accounts[accountName];
                    if (!Array.isArray(transactions)) continue;

                    const symbolsWithExpiredTimestamp = [...new Set(
                        transactions
                            .filter(tx => tx.deletionTimestamp && tx.deletionTimestamp <= now)
                            .map(tx => tx.symbol)
                    )];

                    symbolsWithExpiredTimestamp.forEach(symbol => {
                        const holdings = getCurrentHoldings(symbol, transactions);
                        const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);

                        if (currentShares === 0) {
                            appData.accounts[accountName] = transactions.filter(tx => tx.symbol !== symbol);
                        } else {
                            appData.accounts[accountName].forEach(tx => {
                                if (tx.symbol === symbol) {
                                    delete tx.deletionTimestamp;
                                }
                            });
                        }
                        changed = true;
                    });
                }
                if (changed) saveDataToFirebase();
            }
            
            /**
             * 更新「帳戶」下拉選單的選項。
             */
            function updateAccountFilterOptions() {
                const accountNames = Object.keys(appData.accounts);
                accountFilter.innerHTML = '';
                accountNames.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    accountFilter.appendChild(option);
                });
                accountFilter.value = appData.currentAccount;
                deleteAccountBtn.classList.toggle('hidden', accountNames.length <= 1);
            }

            /**
             * 更新「股票」下拉選單的選項。
             */
            function updateStockFilterOptions() {
                const currentTransactions = appData.accounts[appData.currentAccount] || [];
                const selectedValue = stockFilter.value;
                const searchTerm = stockSearch.value.trim().toUpperCase();
                
                if (!Array.isArray(currentTransactions)) return;

                let symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                
                if (searchTerm) {
                    symbols = symbols.filter(symbol => symbol.toUpperCase().includes(searchTerm));
                }

                symbols.sort();
                
                const isCurrentSelectionValid = symbols.includes(selectedValue) || selectedValue === '__ALL__';

                stockFilter.innerHTML = '';
                const allOption = document.createElement('option');
                allOption.value = '__ALL__';
                allOption.textContent = '全部庫存';
                stockFilter.appendChild(allOption);

                if (symbols.length > 0) {
                    symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = `${symbol} (${stockNameMap[symbol] || '未知'})`;
                        stockFilter.appendChild(option);
                    });
                }
                if (isCurrentSelectionValid) {
                     stockFilter.value = selectedValue;
                } else {
                     stockFilter.value = '__ALL__';
                }
            }
            
            /**
             * 顯示彈出式視窗 (Modal) 的通用函式。
             * @param {HTMLElement} modalElement - 要顯示的 Modal 元素。
             * @param {string} [title] - (可選) Modal 的標題。
             * @param {string} [message] - (可選) Modal 的訊息內容。
             */
            function showModal(modalElement, title, message) {
                 if (modalElement === messageModal) {
                     messageModalTitle.textContent = title;
                     messageModalMessage.textContent = message;
                 }
                 modalElement.classList.remove('opacity-0', 'pointer-events-none');
                 modalElement.querySelector('.modal-content').classList.remove('scale-95');
            }
            
            /**
             * 隱藏彈出式視窗 (Modal) 的通用函式。
             * @param {HTMLElement} modalElement - 要隱藏的 Modal 元素。
             */
            function hideModal(modalElement) {
                modalElement.classList.add('opacity-0', 'pointer-events-none');
                modalElement.querySelector('.modal-content').classList.add('scale-95');
            }
            
            // 為各個 Modal 的關閉按鈕綁定事件
            messageModalClose.addEventListener('click', () => hideModal(messageModal));
            addAccountBtn.addEventListener('click', () => showModal(addAccountModal));
            addAccountCancelBtn.addEventListener('click', () => hideModal(addAccountModal));
            
            editAccountBtn.addEventListener('click', () => {
                editAccountNameInput.value = appData.currentAccount;
                showModal(editAccountModal);
            });
            editAccountCancelBtn.addEventListener('click', () => hideModal(editAccountModal));
            
            deleteAccountBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount;
                deleteAccountMessage.textContent = `您確定要刪除「${accountToDelete}」帳戶嗎？此帳戶內的所有交易紀錄將被永久移除，此操作無法復原。`;
                showModal(deleteAccountModal);
            });
            deleteAccountCancelBtn.addEventListener('click', () => hideModal(deleteAccountModal));
            
            /**
             * 根據 FIFO (先進先出) 原則計算目前持股。
             * @param {string} symbol - 股票代號。
             * @param {Array} transactions - 該帳戶的所有交易紀錄。
             * @returns {Array} - 計算後剩餘的持股部位 (買入紀錄)。
             */
            function getCurrentHoldings(symbol, transactions) {
                if (!Array.isArray(transactions)) return [];
                const activeTransactions = transactions.filter(tx => !tx.deletionTimestamp);
                const symbolTxs = activeTransactions.filter(tx => tx.symbol === symbol);
                const buyTxs = symbolTxs.filter(tx => tx.type === 'BUY').sort((a, b) => new Date(a.date) - new Date(b.date));
                const sellTxs = symbolTxs.filter(tx => tx.type === 'SELL');
                let sharesSold = sellTxs.reduce((sum, tx) => sum + tx.shares, 0);
                
                const holdings = [];
                for (const buyTx of buyTxs) {
                    if (sharesSold <= 0) {
                        holdings.push({...buyTx});
                        continue;
                    }
                    if (buyTx.shares > sharesSold) {
                        holdings.push({...buyTx, shares: buyTx.shares - sharesSold});
                        sharesSold = 0;
                    } else {
                        sharesSold -= buyTx.shares;
                    }
                }
                return holdings;
            }

            /**
             * 核心渲染函式，根據當前的篩選條件更新畫面。
             * 這個函式會決定要顯示「全部庫存」總覽還是「個別股票」的交易歷史。
             */
            function render() {
                const currentTransactions = appData.accounts[appData.currentAccount] || [];
                if (!Array.isArray(currentTransactions)) return;
                
                const selectedValue = stockFilter.value;
                const tableHead = transactionList.parentElement.querySelector('thead');
                transactionList.innerHTML = ''; // 清空舊的列表內容

                // --- 情況一：顯示「全部庫存」總覽 ---
                if (selectedValue === '__ALL__') {
                    paginationControls.classList.add('hidden'); // 隱藏分頁控制器
                    viewTitle.textContent = '投資組合總覽';
                    sharesTitle.textContent = '全部庫存檔數';
                    historyTitle.textContent = '庫存明細';
                    calculatePortfolioSummary(currentTransactions); // 計算總庫存檔數
                    
                    // 設定表格標頭
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股票代號</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股票名稱</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">持有股數</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">更新日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">更新狀態</th>
                        </tr>
                    `;
                    
                    const symbols = [...new Set(currentTransactions.map(tx => tx.symbol))];
                    let portfolioDetails = symbols.map(symbol => {
                        const holdings = getCurrentHoldings(symbol, currentTransactions);
                        const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                        if (totalShares <= 0) return null; // 如果持有股數為 0，則不顯示

                        const symbolTransactions = currentTransactions.filter(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        const lastUpdateDate = symbolTransactions.reduce((max, tx) => (tx.date > max ? tx.date : max), '0000-00-00');
                        const name = (symbolTransactions.find(tx => tx.name) || {}).name || '';
                        
                        // 計算該股票是否所有交易都已覆盤
                        const isFullyReviewed = symbolTransactions.length > 0 && symbolTransactions.every(tx => tx.reviewed === true);

                        return { symbol, name, totalShares, lastUpdateDate, isFullyReviewed };
                    }).filter(Boolean); // 過濾掉為 null 的項目

                    // 根據最後更新日期排序
                    portfolioDetails.sort((a, b) => new Date(b.lastUpdateDate) - new Date(a.lastUpdateDate));

                    // 產生表格的每一列
                    if (portfolioDetails.length > 0) {
                        portfolioDetails.forEach(detail => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-stone-700/50';

                            // 根據覆盤狀態產生對應的按鈕樣式
                            const statusText = detail.isFullyReviewed ? '是' : '否';
                            const statusColor = detail.isFullyReviewed ? 'bg-emerald-800 text-emerald-100 hover:bg-emerald-700' : 'bg-stone-600 text-stone-200 hover:bg-stone-500';
                            const statusButtonHTML = `
                                <button class="px-3 py-1 text-xs font-semibold rounded-full transition-colors duration-200 ${statusColor}" data-symbol="${detail.symbol}" data-action="toggle-status-all">
                                    ${statusText}
                                </button>
                            `;

                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-stone-100">${detail.symbol}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${detail.totalShares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-400">${detail.lastUpdateDate}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">${statusButtonHTML}</td>
                            `;
                            transactionList.appendChild(row);
                        });
                    }
                    noDataMsg.textContent = '尚無任何庫存';
                    noDataMsg.classList.toggle('hidden', portfolioDetails.length > 0);
                
                // --- 情況二：顯示「個別股票」的交易歷史 ---
                } else {
                    const stockName = (currentTransactions.find(tx => tx.symbol === selectedValue) || {}).name || '';
                    viewTitle.textContent = `個別檢視: ${selectedValue} ${stockName}`;
                    sharesTitle.textContent = '持有股數';
                    historyTitle.textContent = '交易歷史紀錄';
                    calculateSummary(selectedValue, currentTransactions); // 計算單一股票的持有股數
                    
                    // 設定表格標頭 (此模式下沒有「更新狀態」欄位)
                    tableHead.innerHTML = `
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">日期</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">類型</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-400 uppercase tracking-wider">股數</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">操作</span></th>
                        </tr>
                    `;
                    const displayTransactions = currentTransactions.filter(tx => tx.symbol === selectedValue);
                    const sortedTransactions = [...displayTransactions].sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
                    
                    // 分頁邏輯
                    const itemsPerPage = 10;
                    const totalPages = Math.ceil(sortedTransactions.length / itemsPerPage) || 1;
                    if (currentPage > totalPages) currentPage = totalPages;
                    const paginatedTransactions = sortedTransactions.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
                    paginationControls.classList.toggle('hidden', sortedTransactions.length <= itemsPerPage);
                    pageInfo.textContent = `第 ${currentPage} / ${totalPages} 頁`;
                    prevPageBtn.disabled = currentPage === 1;
                    nextPageBtn.disabled = currentPage === totalPages;
                    
                    // 產生表格的每一列
                    paginatedTransactions.forEach(tx => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-stone-700/50 transition-colors duration-200';
                        
                        const typeCell = tx.type === 'BUY' 
                            ? `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-sky-900 text-sky-200">買入</span>`
                            : `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-rose-900 text-rose-200">賣出</span>`;

                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.date}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${typeCell}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-300">${tx.shares.toLocaleString('en-US', {maximumFractionDigits: 8})}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                <button class="text-stone-400 hover:text-stone-200" data-id="${tx.id}" data-action="edit">編輯</button>
                                <button class="text-rose-400 hover:text-rose-500" data-id="${tx.id}" data-action="delete">刪除</button>
                            </td>
                        `;
                        transactionList.appendChild(row);
                    });
                    noDataMsg.textContent = '尚無交易紀錄';
                    noDataMsg.classList.toggle('hidden', displayTransactions.length > 0);
                }
            }

            /**
             * 計算單一股票的總持有股數。
             */
            function calculateSummary(symbol, transactions) {
                if (!Array.isArray(transactions)) {
                    totalSharesEl.textContent = '0';
                    return;
                }
                const holdings = getCurrentHoldings(symbol, transactions);
                const totalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                totalSharesEl.textContent = totalShares.toLocaleString('en-US', {maximumFractionDigits: 8});
            }
            
            /**
             * 計算總庫存中有多少支不同的股票。
             */
            function calculatePortfolioSummary(transactions) {
                if (!Array.isArray(transactions)) {
                    totalSharesEl.textContent = '0';
                    return;
                }
                const symbols = [...new Set(transactions.map(tx => tx.symbol))];
                let portfolioStockCount = 0;
                symbols.forEach(symbol => {
                    const holdings = getCurrentHoldings(symbol, transactions);
                    const symbolTotalShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    if (symbolTotalShares > 0) {
                        portfolioStockCount++;
                    }
                });
                totalSharesEl.textContent = new Intl.NumberFormat().format(portfolioStockCount);
            }

            // --- 事件監聽器 ---

            // 處理「買入」表單提交
            addBuyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const symbol = document.getElementById('buy-symbol').value.trim().toUpperCase();
                const name = stockNameMap[symbol] || '';
                const date = document.getElementById('buy-date').value;
                const shares = parseFloat(document.getElementById('buy-shares').value);
                if (!symbol) { showModal(messageModal, '輸入錯誤', '請輸入股票代號。'); return; }
                if (isNaN(shares) || shares <= 0) { showModal(messageModal, '輸入錯誤', '請檢查股數是否為有效的正數。'); return; }
                
                // 新增的交易紀錄，reviewed 狀態預設為 false
                appData.accounts[appData.currentAccount].push({ id: Date.now(), type: 'BUY', symbol, name, date, shares, reviewed: false });
                
                saveDataToFirebase();
                addBuyForm.reset();
                setDateToToday();
                updateStockFilterOptions();
                stockFilter.value = symbol;
                currentPage = 1;
                render();
            });
            
            // 處理「賣出」表單提交
            addSellForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const symbol = document.getElementById('sell-symbol').value.trim().toUpperCase();
                const name = stockNameMap[symbol] || '';
                const date = document.getElementById('sell-date').value;
                const sharesToSell = parseFloat(document.getElementById('sell-shares').value);
                const currentTransactions = appData.accounts[appData.currentAccount];
                if (!symbol) { showModal(messageModal, '輸入錯誤', '請輸入股票代號。'); return; }
                if (isNaN(sharesToSell) || sharesToSell <= 0) { showModal(messageModal, '輸入錯誤', '請檢查股數是否為有效的正數。'); return; }
                
                const holdings = getCurrentHoldings(symbol, currentTransactions);
                const currentShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                if (sharesToSell > currentShares) {
                    showModal(messageModal, '賣出失敗', `您只有 ${currentShares.toLocaleString('en-US', {maximumFractionDigits: 8})} 股，無法賣出 ${sharesToSell} 股。`);
                    return;
                }
                
                currentTransactions.push({ id: Date.now(), type: 'SELL', symbol, name, date, shares: sharesToSell, reviewed: false });
                
                saveDataToFirebase();
                addSellForm.reset();
                setDateToToday();

                const updatedHoldings = getCurrentHoldings(symbol, currentTransactions);
                const remainingShares = updatedHoldings.reduce((sum, tx) => sum + tx.shares, 0);
                if (remainingShares === 0) {
                    symbolToClear = symbol;
                    clearHistoryMessage.textContent = `股票 ${symbol} 的庫存已為零，是否要清除其所有相關交易歷史紀錄？`;
                    showModal(clearHistoryModal);
                } else {
                    updateStockFilterOptions();
                    stockFilter.value = symbol;
                    currentPage = 1;
                    render();
                }
            });

            /**
             * 使用事件代理處理表格中所有按鈕的點擊事件。
             * 這樣就不需要為每一個按鈕單獨綁定事件。
             */
            transactionList.addEventListener('click', (e) => {
                const target = e.target.closest('button'); // 確保點擊按鈕內部也能觸發
                if (!target || !target.dataset.action) return;

                const action = target.dataset.action;
                const currentTransactions = appData.accounts[appData.currentAccount];

                if (action === 'delete' || action === 'edit') {
                    const id = parseInt(target.dataset.id, 10);
                    if (action === 'delete') {
                        appData.accounts[appData.currentAccount] = currentTransactions.filter(tx => tx.id !== id);
                        saveDataToFirebase();
                        updateStockFilterOptions();
                        render();
                    } else if (action === 'edit') {
                        const tx = currentTransactions.find(t => t.id === id);
                        if (tx) {
                            document.getElementById('edit-transaction-id').value = tx.id;
                            document.getElementById('edit-symbol').value = tx.symbol;
                            document.getElementById('edit-date').value = tx.date;
                            document.getElementById('edit-shares').value = tx.shares;
                            editModalTitle.textContent = `編輯 ${tx.symbol} (${tx.type === 'BUY' ? '買入' : '賣出'})`;
                            document.getElementById('edit-symbol').dispatchEvent(new Event('input'));
                            showModal(editTransactionModal);
                        }
                    }
                } else if (action === 'toggle-status-all') {
                    // 處理「全部庫存」總覽中的狀態切換
                    const symbol = target.dataset.symbol;
                    const transactionsForSymbol = currentTransactions.filter(tx => tx.symbol === symbol);
                    if (transactionsForSymbol.length > 0) {
                        const isCurrentlyFullyReviewed = transactionsForSymbol.every(tx => tx.reviewed === true);
                        const newStatus = !isCurrentlyFullyReviewed; // 新狀態是目前狀態的反向 (是 -> 否, 否 -> 是)
                        
                        // 將該股票的所有交易紀錄狀態都設為新狀態
                        transactionsForSymbol.forEach(tx => {
                            tx.reviewed = newStatus;
                        });
                        
                        saveDataToFirebase();
                        // 不需要手動 render，因為 Firebase 的 .on('value') 監聽器會自動收到更新並重繪畫面
                    }
                }
            });

            // 處理「帳戶」下拉選單切換
            accountFilter.addEventListener('change', (e) => {
                appData.currentAccount = e.target.value;
                saveDataToFirebase();
                stockSearch.value = '';
                updateStockFilterOptions();
                currentPage = 1;
                render();
            });
            
            // 處理「股票」下拉選單切換
            stockFilter.addEventListener('change', () => {
                currentPage = 1;
                render();
            });
            
            // 處理股票搜尋框輸入
            stockSearch.addEventListener('input', () => {
                updateStockFilterOptions();
                render();
            });

            // 處理分頁按鈕
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    render();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                currentPage++;
                render();
            });
            
            // 處理「新增帳戶」表單提交
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const newAccountNameInput = document.getElementById('new-account-name');
                const newAccountName = newAccountNameInput.value.trim();
                if (!newAccountName) {
                    showModal(messageModal, '錯誤', '帳戶名稱不能為空。');
                    return;
                }
                if (appData.accounts[newAccountName]) {
                    showModal(messageModal, '錯誤', '該帳戶名稱已存在。');
                    return;
                }
                appData.accounts[newAccountName] = '';
                appData.currentAccount = newAccountName;
                saveDataToFirebase();
                newAccountNameInput.value = '';
                hideModal(addAccountModal);
                updateAccountFilterOptions();
                updateStockFilterOptions();
                currentPage = 1;
                render();
            });
            
            // 處理「修改帳戶名稱」表單提交
            editAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const oldAccountName = appData.currentAccount;
                const newAccountName = editAccountNameInput.value.trim();
                if (!newAccountName) {
                    showModal(messageModal, '錯誤', '帳戶名稱不能為空。');
                    return;
                }
                if (newAccountName !== oldAccountName && appData.accounts[newAccountName]) {
                     showModal(messageModal, '錯誤', '該帳戶名稱已存在。');
                    return;
                }
                if (newAccountName !== oldAccountName) {
                    appData.accounts[newAccountName] = appData.accounts[oldAccountName];
                    delete appData.accounts[oldAccountName];
                    appData.currentAccount = newAccountName;
                    saveDataToFirebase();
                    updateAccountFilterOptions();
                    render();
                }
                hideModal(editAccountModal);
            });

            // 處理「刪除帳戶」確認
            deleteAccountConfirmBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount;
                if (Object.keys(appData.accounts).length <= 1) {
                    showModal(messageModal, '錯誤', '無法刪除最後一個帳戶。');
                    hideModal(deleteAccountModal);
                    return;
                }
                delete appData.accounts[accountToDelete];
                appData.currentAccount = Object.keys(appData.accounts)[0];
                saveDataToFirebase();
                hideModal(deleteAccountModal);
                updateAccountFilterOptions();
                updateStockFilterOptions();
                render();
                showModal(messageModal, '成功', `帳戶「${accountToDelete}」已成功刪除。`);
            });
            
            // 處理「立即清除」庫存歸零的紀錄
            clearHistoryNowBtn.addEventListener('click', () => {
                if (symbolToClear) {
                    appData.accounts[appData.currentAccount] = appData.accounts[appData.currentAccount].filter(tx => tx.symbol !== symbolToClear);
                    saveDataToFirebase();
                    hideModal(clearHistoryModal);
                    updateStockFilterOptions();
                    render();
                    showModal(messageModal, '紀錄已清除', `股票 ${symbolToClear} 的所有交易紀錄已被移除。`);
                    symbolToClear = null;
                }
            });

            // 處理「10天後清除」庫存歸零的紀錄
            clearHistoryLaterBtn.addEventListener('click', () => {
                if (symbolToClear) {
                    const tenDaysInMillis = 10 * 24 * 60 * 60 * 1000;
                    const deletionTimestamp = Date.now() + tenDaysInMillis;
                    const activeTransactionsForSymbol = appData.accounts[appData.currentAccount]
                        .filter(tx => tx.symbol === symbolToClear && !tx.deletionTimestamp);

                    activeTransactionsForSymbol.forEach(tx => {
                       const originalTx = appData.accounts[appData.currentAccount].find(t => t.id === tx.id);
                       if(originalTx) {
                           originalTx.deletionTimestamp = deletionTimestamp;
                       }
                    });
                    saveDataToFirebase();
                    hideModal(clearHistoryModal);
                    updateStockFilterOptions();
                    stockFilter.value = symbolToClear;
                    render();
                    showModal(messageModal, '已排程清除', `股票 ${symbolToClear} 的紀錄將在10天後自動清除。`);
                    symbolToClear = null;
                }
            });

            // 處理「匯出資料」
            exportBtn.addEventListener('click', () => {
                if (Object.keys(appData.accounts).length === 0) { showModal(messageModal, '提示', '沒有可匯出的資料。'); return; }
                const dataStr = JSON.stringify(appData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_shares_tracker_data_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showModal(messageModal, '匯出成功', '您的所有帳戶紀錄已成功匯出為 JSON 檔案。');
            });

            // 處理「匯入資料」
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData.accounts && importedData.currentAccount) {
                            const firstAccountKey = Object.keys(importedData.accounts)[0];
                            const firstTransaction = (importedData.accounts[firstAccountKey] || [])[0];
                            if(firstTransaction && 'price' in firstTransaction) {
                                throw new Error('檔案格式不符 (此為旧版含價格資料的檔案)');
                            }
                            appData = importedData;
                            saveDataToFirebase();
                            currentPage = 1;
                            showModal(messageModal, '匯入成功', '所有帳戶紀錄已成功匯入並同步至雲端。');
                        } else {
                            throw new Error('檔案格式不符');
                        }
                    } catch (error) {
                         showModal(messageModal, '匯入失敗', `檔案格式不正確或已損毀。(${error.message})`);
                    }
                };
                reader.onerror = () => {
                    showModal(messageModal, '匯入失敗', '讀取檔案時發生錯誤。');
                };
                reader.readAsText(file);
                importFile.value = '';
            });
            
            // 處理「編輯交易」表單
            editTransactionCancelBtn.addEventListener('click', () => hideModal(editTransactionModal));
            editTransactionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-transaction-id').value, 10);
                const newSymbol = document.getElementById('edit-symbol').value.trim().toUpperCase();
                const newDate = document.getElementById('edit-date').value;
                const newShares = parseFloat(document.getElementById('edit-shares').value);
                
                const currentTransactions = appData.accounts[appData.currentAccount];
                const txIndex = currentTransactions.findIndex(t => t.id === id);
                if (txIndex === -1) return;
                
                const originalSymbol = currentTransactions[txIndex].symbol;

                if (!newSymbol) { showModal(messageModal, '輸入錯誤', '股票代號不能為空。'); return; }
                if (isNaN(newShares) || newShares <= 0) { showModal(messageModal, '輸入錯誤', '請檢查股數是否為有效的正數。'); return; }

                // 建立一個臨時副本來驗證修改後是否會導致庫存變為負數
                const tempTransactions = JSON.parse(JSON.stringify(currentTransactions));
                const tempTxToUpdate = tempTransactions.find(t => t.id === id);
                tempTxToUpdate.symbol = newSymbol;
                tempTxToUpdate.date = newDate;
                tempTxToUpdate.shares = newShares;
                
                const affectedSymbols = new Set([originalSymbol, newSymbol]);
                for (const symbol of affectedSymbols) {
                    const symbolTxs = tempTransactions.filter(tx => tx.symbol === symbol);
                    const buyTxs = symbolTxs.filter(tx => tx.type === 'BUY');
                    const sellTxs = symbolTxs.filter(tx => tx.type === 'SELL');
                    const totalBought = buyTxs.reduce((sum, tx) => sum + tx.shares, 0);
                    const totalSold = sellTxs.reduce((sum, tx) => sum + tx.shares, 0);

                    if (totalSold > totalBought) {
                        showModal(messageModal, '編輯失敗', `此修改會導致股票 ${symbol} 的庫存變為負數，請重新檢查。`);
                        return; 
                    }
                }

                // 驗證通過，正式更新資料
                const transactionToUpdate = currentTransactions[txIndex];
                transactionToUpdate.symbol = newSymbol;
                transactionToUpdate.name = stockNameMap[newSymbol] || '';
                transactionToUpdate.date = newDate;
                transactionToUpdate.shares = newShares;
                saveDataToFirebase();
                hideModal(editTransactionModal);
                
                // 檢查修改後是否有股票庫存歸零
                let zeroedOutSymbol = null;
                for (const symbol of affectedSymbols) {
                    const holdings = getCurrentHoldings(symbol, currentTransactions);
                    const remainingShares = holdings.reduce((sum, tx) => sum + tx.shares, 0);
                    if (remainingShares === 0) {
                        const hasActiveTxs = currentTransactions.some(tx => tx.symbol === symbol && !tx.deletionTimestamp);
                        if (hasActiveTxs) {
                           zeroedOutSymbol = symbol;
                           break; 
                        }
                    }
                }

                if (zeroedOutSymbol) {
                    symbolToClear = zeroedOutSymbol;
                    clearHistoryMessage.textContent = `編輯後，股票 ${zeroedOutSymbol} 的庫存已為零，是否要清除其所有相關交易歷史紀錄？`;
                    showModal(clearHistoryModal);
                } else {
                    updateStockFilterOptions();
                    render(); 
                }
            });

            /**
             * 處理股票代號輸入，延遲顯示對應的股票名稱。
             * 使用 debounce 技巧避免頻繁觸發。
             */
            function handleSymbolInput(e) {
                clearTimeout(debounceTimer);
                const symbol = e.target.value.trim().toUpperCase();
                const nameDisplayId = `${e.target.id}-name`;
                const nameDisplayEl = document.getElementById(nameDisplayId);
                if (!nameDisplayEl) return;

                debounceTimer = setTimeout(() => {
                    if (stockNameMap[symbol]) {
                        nameDisplayEl.textContent = stockNameMap[symbol];
                    } else {
                        nameDisplayEl.textContent = '';
                    }
                }, 300);
            }

            // --- 程式進入點 ---
            setDateToToday(); // 將日期欄位預設為今天
            
            // --- 其他事件監聽綁定 ---
            // 處理「新增交易紀錄」區塊的摺疊/展開
            collapsibleHeader.addEventListener('click', () => {
                if (collapsibleContent.style.maxHeight) {
                    collapsibleContent.style.maxHeight = null;
                    collapseIcon.style.transform = 'rotate(-90deg)';
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'true');
                } else {
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                    collapseIcon.style.transform = 'rotate(0deg)';
                    localStorage.setItem('isFormCollapsed_SharesOnly', 'false');
                }
            });

            // 為所有代號輸入框綁定事件，以便輸入時顯示名稱
            document.getElementById('buy-symbol').addEventListener('input', handleSymbolInput);
            document.getElementById('sell-symbol').addEventListener('input', handleSymbolInput);
            document.getElementById('edit-symbol').addEventListener('input', handleSymbolInput);
        });
    </script>
</body>
</html>

