<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>📈雲端儀表板 📊</title>
    <link rel="icon" href="ElienOnly.ico" type="image/ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- 莫蘭迪深色系配色 --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #1c1917; /* 石墨棕 */
            color: #f5f5f4; /* 暖石灰 */
        }
        .table-scrollbar::-webkit-scrollbar { width:6px; height:6px; }
        .table-scrollbar::-webkit-scrollbar-track { background:#292524; border-radius:10px; }
        .table-scrollbar::-webkit-scrollbar-thumb { background:#57534e; border-radius:10px; }
        .table-scrollbar::-webkit-scrollbar-thumb:hover { background:#78716c; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor:pointer; }
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        input[type="date"]::-webkit-datetime-edit { font-size: 0.85rem; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin:0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="antialiased">

    <!-- 登入/驗證區塊 (隱藏) -->
    <div id="auth-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl text-center hidden">
        <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈雲端儀表板📊</h1>
        <p class="mt-4 text-stone-400">使用 Google 帳戶登入以跨裝置同步持股資料</p>
        <button id="login-btn" class="mt-6 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-8 rounded-lg transition duration-300 shadow-lg">使用 Google 登入</button>
    </div>

    <!-- 主應用程式容器 (顯示) -->
    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl" style="display:none;">
        <div class="flex justify-between items-center mb-6 hidden">
             <p id="user-display" class="text-sm text-stone-400"></p>
             <button id="logout-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">登出</button>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-stone-100 tracking-tight">📈成本紀錄儀表板📊</h1>
            <p class="mt-2 text-lg text-stone-400">🇹🇼  🇺🇸 ➡️ 🥦 🔥 (雲端版)</p>
        </header>

        <main class="space-y-8">
            <!-- 帳戶選擇區塊 -->
            <div class="bg-stone-800 p-4 rounded-2xl shadow-lg border border-stone-700 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <div class="md:col-span-5">
                        <label for="account-filter" class="block text-sm font-medium text-stone-300 mb-1">目前帳戶</label>
                        <select id="account-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="account-market-type" class="block text-sm font-medium text-stone-300 mb-1">市場</label>
                        <select id="account-market-type" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                            <option value="TW">台股 🇹🇼</option>
                            <option value="US">美股 🇺🇸</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="account-fee-discount" class="block text-sm font-medium text-stone-300 mb-1">手續費折數/費率</label>
                        <input type="number" id="account-fee-discount" min="0" step="any" required value="0.28" class="block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                    </div>
                    <div class="flex items-center space-x-2 self-end md:col-span-3">
                            <button id="add-account-btn" title="新增帳戶" class="flex-shrink-0 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">＋</button>
                            <button id="edit-account-btn" title="編輯帳戶" class="flex-shrink-0 bg-stone-500 hover:bg-stone-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">✏️</button>
                            <button id="delete-account-btn" title="刪除帳戶" class="flex-shrink-0 bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md hidden">－</button>
                    </div>
                </div>
            </div>

            <!-- 總覽與篩選區塊 -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700 space-y-4">
                <h2 id="view-title" class="text-2xl font-bold text-stone-100 tracking-tight">總覽</h2>
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                    <div class="md:col-span-1">
                        <label for="stock-search" class="block text-sm font-medium text-stone-300 mb-2">搜尋或選擇檢視項目</label>
                        <input type="text" id="stock-search" placeholder="輸入代號篩選..." class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition">
                    </div>
                    <div class="md:col-span-2">
                        <label for="stock-filter" class="block text-sm font-medium text-transparent mb-2 select-none">.</label>
                        <select id="stock-filter" class="w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5 transition"></select>
                    </div>
                    <div class="md:col-span-1">
                        <label id="shares-title" class="block text-sm font-medium text-stone-300 mb-2">全部庫存檔數</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalShares" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="avg-cost-box" class="md:col-span-1">
                        <label id="avg-cost-title" class="block text-sm font-medium text-stone-300 mb-2">平均成本</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="avgCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                    <div id="total-cost-box" class="md:col-span-1">
                        <label id="total-cost-title" class="block text-sm font-medium text-stone-300 mb-2">總成本</label>
                        <div class="bg-stone-900 px-4 py-2 rounded-lg border border-stone-700">
                            <p id="totalCost" class="text-xl font-bold text-sky-400 text-center">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 合併新增交易紀錄 -->
            <div class="bg-stone-800 rounded-2xl shadow-lg border border-stone-700">
                <div id="collapsible-header" class="p-4 cursor-pointer flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-stone-100">新增交易紀錄</h2>
                    <span id="collapse-icon" class="text-stone-400 transform transition-transform duration-300">▼</span>
                </div>
                <div id="collapsible-content" class="collapsible-content">
                    <div class="p-4 pt-0">
                        <div class="bg-stone-800 p-4 rounded-2xl shadow-inner border border-stone-700">
                            <form id="add-transaction-form" class="space-y-4">
                                <div class="grid grid-cols-4 gap-4">
                                    <div>
                                        <label for="tx-symbol" class="block text-sm font-medium text-stone-300">股票代號</label>
                                        <input type="text" id="tx-symbol" required placeholder="例如: 2330" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5" style="text-transform:uppercase">
                                        <small id="tx-symbol-name" class="text-stone-400 h-4 block mt-1 text-xs"></small>
                                    </div>
                                    <div>
                                        <label for="tx-date" class="block text-sm font-medium text-stone-300">日期</label>
                                        <input type="date" id="tx-date" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-shares" class="block text-sm font-medium text-stone-300">股數</label>
                                        <input type="number" id="tx-shares" min="0" step="any" required placeholder="1000" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                    <div>
                                        <label for="tx-price" class="block text-sm font-medium text-stone-300">價格(均價)</label>
                                        <input type="number" id="tx-price" min="0" step="any" required placeholder="600.5" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                                    </div>
                                </div>
                            </form>
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <button type="button" id="add-buy-btn" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">買入</button>
                                <button type="button" id="add-sell-btn" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-2.5 px-4 rounded-lg transition duration-300 shadow-md">賣出</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 交易歷史/庫存明細區塊 -->
            <div class="bg-stone-800 p-6 rounded-2xl shadow-lg border border-stone-700">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                    <h2 id="history-title" class="text-xl font-semibold text-stone-100">交易歷史紀錄</h2>
                    <div class="mt-3 sm:mt-0 flex space-x-2">
                        <button id="import-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯入資料</button>
                        <input type="file" id="import-file" class="hidden" accept=".json">
                        <button id="export-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg text-sm transition duration-300">匯出資料</button>
                    </div>
                </div>
                <div class="overflow-x-auto table-scrollbar">
                    <table class="min-w-full divide-y divide-stone-700">
                        <thead class="bg-stone-900"></thead>
                        <tbody id="transaction-list" class="divide-y divide-stone-700"></tbody>
                    </table>
                    <p id="no-data-msg" class="text-center py-8 text-stone-500">尚無交易紀錄</p>
                </div>
                <div id="pagination-controls" class="mt-4 flex justify-between items-center text-sm text-stone-400 hidden">
                    <button id="prev-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">&lt; 上一頁</button>
                    <span id="page-info">第 1 / 1 頁</span>
                    <button id="next-page-btn" class="bg-stone-600 hover:bg-stone-700 text-stone-100 font-medium py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">下一頁 &gt;</button>
                </div>
            </div>
        </main>
    </div>

    <!-- message modal (simple) -->
    <div id="message-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 id="message-modal-title" class="text-lg font-semibold text-stone-100">提示</h3>
            <p id="message-modal-message" class="mt-2 text-sm text-stone-300"></p>
            <div class="mt-6 text-right">
                <button id="message-modal-close" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">確認</button>
            </div>
        </div>
    </div>

    <!-- account modals (simple) -->
    <div id="add-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">新增帳戶</h3>
            <form id="add-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="new-account-name" class="block text-sm font-medium text-stone-300">帳戶名稱</label>
                    <input type="text" id="new-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div>
                    <label for="new-account-market-type" class="block text-sm font-medium text-stone-300">市場類型</label>
                    <select id="new-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                        <option value="TW">台股 (TW)</option>
                        <option value="US">美股 (US)</option>
                    </select>
                </div>
                <div>
                    <label for="new-account-fee-discount" class="block text-sm font-medium text-stone-300">手續費折數/費率</label>
                    <input type="number" id="new-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-sky-400 focus:border-sky-400 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-4 rounded-lg transition">建立</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-account-modal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 opacity-0 pointer-events-none">
        <div class="modal-content bg-stone-800 border border-stone-700 rounded-2xl p-6 max-w-sm w-full shadow-2xl transform scale-95">
            <h3 class="text-lg font-semibold text-stone-100">修改帳戶</h3>
            <form id="edit-account-form" class="mt-4 space-y-4">
                <div>
                    <label for="edit-account-name" class="block text-sm font-medium text-stone-300">新帳戶名稱</label>
                    <input type="text" id="edit-account-name" required class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div>
                    <label for="edit-account-market-type" class="block text-sm font-medium text-stone-300">市場類型</label>
                    <select id="edit-account-market-type" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                        <option value="TW">台股 (TW)</option>
                        <option value="US">美股 (US)</option>
                    </select>
                </div>
                <div>
                    <label for="edit-account-fee-discount" class="block text-sm font-medium text-stone-300">手續費折數/費率</label>
                    <input type="number" id="edit-account-fee-discount" min="0" step="any" required value="0.28" class="mt-1 block w-full bg-stone-900 border-stone-700 rounded-lg shadow-sm focus:ring-stone-500 focus:border-stone-500 text-stone-300 p-2.5">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-account-cancel" class="bg-stone-600 hover:bg-stone-700 text-white font-bold py-2 px-4 rounded-lg transition">取消</button>
                    <button type="submit" class="bg-stone-500 hover:bg-stone-600 text-white font-bold py-2 px-4 rounded-lg transition">儲存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase 初始化模組（模組化引入，並把必要 API 暴露在 window.firebaseApi） -->
    <script type="module">
        // 這段會使用 Firebase modular SDK。請把下方 firebaseConfig 填上你的專案設定。
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.11.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.11.0/firebase-auth.js";
        import { getDatabase, ref, set, get, child, onValue, update } from "https://www.gstatic.com/firebasejs/11.11.0/firebase-database.js";

        // --------- TODO: 在此填入你的 Firebase 設定 ----------
        const firebaseConfig = {
            apiKey: "AIzaSyBNA20afPELKWGlKHkQfdNhk5Z1wjlTYfs",
            authDomain: "stock-tracker-940de.firebaseapp.com",
            databaseURL: "https://stock-tracker-940de-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "stock-tracker-940de",
            storageBucket: "stock-tracker-940de.firebasestorage.app",
            messagingSenderId: "546233071753",
            appId: "1:546233071753:web:c95d9bece5dd10aa83ae58"
        };
        // ---------------------------------------------------

        // 初始化 Firebase（若沒填 config，initializeApp 會失敗 -> 會觸發 catch）
        let firebaseApp = null;
        let auth = null;
        let db = null;
        try {
            firebaseApp = initializeApp(firebaseConfig);
            auth = getAuth(firebaseApp);
            db = getDatabase(firebaseApp);
        } catch (e) {
            console.warn("Firebase 初始化失敗（可能未填 config 或網路問題）:", e);
            // 不中斷：接下來主程式會回退到 localStorage
        }

        // 暴露簡易介面到 window，主程式可以用它與 Firebase 互動
        window.firebaseApi = {
            available: !!(auth && db),
            auth,
            db,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            onAuthStateChanged,
            dbMethods: {
                getUserData: async (uid) => {
                    if (!db) throw new Error("Realtime Database 未初始化");
                    const userRef = ref(db, `users/${uid}`);
                    const snap = await get(userRef);
                    return snap.exists() ? snap.val() : null;
                },
                saveUserData: async (uid, data) => {
                    if (!db) throw new Error("Realtime Database 未初始化");
                    const userRef = ref(db, `users/${uid}`);
                    // 這裡採用 set（替換），如果你想要 merge 可改用 update
                    await set(userRef, data);
                },
                attachListener: (uid, onChange) => {
                    if (!db) throw new Error("Realtime Database 未初始化");
                    const userRef = ref(db, `users/${uid}`);
                    return onValue(userRef, (snapshot) => {
                        onChange(snapshot.val());
                    }, (err) => {
                        console.error("Realtime DB listener error:", err);
                    });
                },
                detachListener: (listener) => {
                    // onValue 傳回一個取消函式（在 modular 版本中不用 detach），
                    // 使用者呼叫返回的 unsubscribe() 即可停止監聽。
                }
            }
        };
    </script>

    <!-- 主程式：保留原 UI ID 與大部分邏輯，但儲存/載入改為使用 firebaseApi 優先，否則 localStorage -->
    <script>
        // IMPORTANT: 我們假設 firebaseApi 可能在上面模組已經初始化。
        // 若 firebaseApi.available === true -> 使用 Realtime DB，同時掛監聽。
        // 若不可用 -> 使用 localStorage。

        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM 元素 ---
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const userDisplay = document.getElementById('user-display');

            const accountFilter = document.getElementById('account-filter');
            const accountFeeDiscountInput = document.getElementById('account-fee-discount');
            const accountMarketTypeInput = document.getElementById('account-market-type');
            const addAccountBtn = document.getElementById('add-account-btn');
            const editAccountBtn = document.getElementById('edit-account-btn');
            const deleteAccountBtn = document.getElementById('delete-account-btn');
            const addAccountModal = document.getElementById('add-account-modal');
            const addAccountCancelBtn = document.getElementById('add-account-cancel');
            const newAccountFeeDiscountInput = document.getElementById('new-account-fee-discount');
            const newAccountMarketTypeInput = document.getElementById('new-account-market-type');
            const addAccountForm = document.getElementById('add-account-form');
            const editAccountModal = document.getElementById('edit-account-modal');
            const editAccountCancelBtn = document.getElementById('edit-account-cancel');
            const editAccountNameInput = document.getElementById('edit-account-name');
            const editAccountFeeDiscountInput = document.getElementById('edit-account-fee-discount');
            const editAccountMarketTypeInput = document.getElementById('edit-account-market-type');

            const stockFilter = document.getElementById('stock-filter');
            const stockSearch = document.getElementById('stock-search');
            const transactionList = document.getElementById('transaction-list');
            const totalSharesEl = document.getElementById('totalShares');
            const avgCostEl = document.getElementById('avgCost');
            const totalCostEl = document.getElementById('totalCost');
            const noDataMsg = document.getElementById('no-data-msg');
            const importBtn = document.getElementById('import-btn');
            const exportBtn = document.getElementById('export-btn');
            const importFile = document.getElementById('import-file');

            const addBuyBtn = document.getElementById('add-buy-btn');
            const addSellBtn = document.getElementById('add-sell-btn');
            const addTransactionForm = document.getElementById('add-transaction-form');
            const txSymbolInput = document.getElementById('tx-symbol');
            const txDateInput = document.getElementById('tx-date');
            const txSharesInput = document.getElementById('tx-shares');
            const txPriceInput = document.getElementById('tx-price');

            const messageModal = document.getElementById('message-modal');
            const messageModalClose = document.getElementById('message-modal-close');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalMessage = document.getElementById('message-modal-message');

            // collapsible
            const collapsibleHeader = document.getElementById('collapsible-header');
            const collapsibleContent = document.getElementById('collapsible-content');
            const collapseIcon = document.getElementById('collapse-icon');

            // --- 內部狀態 ---
            let appData = {}; // { accounts: { name: { transactions: [], feeDiscount, marketType } }, currentAccount: '...' }
            let currentUser = null; // firebase user object when logged in
            let firebaseListenerUnsubscribe = null; // 若有雲端監聽則存放函式
            const LOCAL_KEY = 'stockTrackerData_LocalTest';

            // 一些常數
            const FEE_RATE = 0.001425;
            const TAX_RATE = 0.003;

            /** ---------- helper: show / hide modal ---------- */
            function showModal(modalEl, title, message) {
                if (modalEl === messageModal) {
                    if (title) messageModalTitle.textContent = title;
                    if (message) messageModalMessage.textContent = message;
                }
                modalEl.classList.remove('opacity-0', 'pointer-events-none');
                modalEl.querySelector('.modal-content')?.classList.remove('scale-95');
            }
            function hideModal(modalEl) {
                modalEl.classList.add('opacity-0', 'pointer-events-none');
                modalEl.querySelector('.modal-content')?.classList.add('scale-95');
            }
            messageModalClose.addEventListener('click', () => hideModal(messageModal));

            /** ---------- localStorage helpers ---------- */
            function loadFromLocalStorage() {
                try {
                    const raw = localStorage.getItem(LOCAL_KEY);
                    if (!raw) return null;
                    return JSON.parse(raw);
                } catch (e) {
                    console.error("讀取 localStorage 失敗：", e);
                    return null;
                }
            }
            function saveToLocalStorage() {
                try {
                    localStorage.setItem(LOCAL_KEY, JSON.stringify(appData));
                } catch (e) {
                    console.error("寫入 localStorage 失敗：", e);
                    showModal(messageModal, '儲存失敗', '瀏覽器本機儲存失敗。');
                }
            }

            /** ---------- firebase wrapper helpers ---------- */
            async function loadFromFirebase(uid) {
                if (!window.firebaseApi || !window.firebaseApi.available) throw new Error("firebase not available");
                try {
                    const data = await window.firebaseApi.dbMethods.getUserData(uid);
                    return data;
                } catch (e) {
                    console.error("從 Firebase 載入失敗：", e);
                    throw e;
                }
            }
            async function saveToFirebase(uid) {
                if (!window.firebaseApi || !window.firebaseApi.available) throw new Error("firebase not available");
                try {
                    await window.firebaseApi.dbMethods.saveUserData(uid, appData);
                } catch (e) {
                    console.error("儲存至 Firebase 失敗：", e);
                    throw e;
                }
            }
            function attachFirebaseListener(uid) {
                if (!window.firebaseApi || !window.firebaseApi.available) return null;
                // onValue returns an unsubscribe function in modular SDK -> simulate by returning the unsubscribe
                const unsubscribe = window.firebaseApi.dbMethods.attachListener(uid, (val) => {
                    if (!val) return;
                    // 當雲端資料變更時更新本地 appData（並重新 render）
                    appData = val;
                    render();
                });
                // NOTE: modular onValue returns a function? In our helper we didn't return unsubscribe; but the modular onValue's return is the unsubscribe.
                // 鑒於我們的 window.firebaseApi.dbMethods.attachListener 沒有回傳 unsubscribe，無法直接取消。本範例假設 attachListener 回傳 unsubscribe（若需，請修改上方 module 以回傳 onValue 的 unsubscribe）。
                return unsubscribe;
            }

            /** ---------- save strategy wrapper ---------- */
            // 儲存：若登入且 firebase 可用 -> 優先同步到 firebase（並存 local 做離線備援）；否則只存 local
            async function saveData() {
                // always update local copy
                saveToLocalStorage();
                if (currentUser && window.firebaseApi && window.firebaseApi.available) {
                    try {
                        await saveToFirebase(currentUser.uid);
                        // no visual prompt requested by user
                    } catch (e) {
                        console.warn("同步到雲端失敗，資料已保存在 localStorage。");
                    }
                }
            }

            /** ---------- initialize appData default & migration ---------- */
            function ensureAppDataStructure(d) {
                if (!d || typeof d !== 'object') {
                    return { accounts: { '預設帳戶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } }, currentAccount: '預設帳戶' };
                }
                if (!d.accounts || typeof d.accounts !== 'object') d.accounts = { '預設帳戶': { transactions: [], feeDiscount: 0.28, marketType: 'TW' } };
                if (!d.currentAccount || !d.accounts[d.currentAccount]) d.currentAccount = Object.keys(d.accounts)[0] || '預設帳戶';
                // migrate each account
                for (const name of Object.keys(d.accounts)) {
                    const acc = d.accounts[name];
                    if (Array.isArray(acc)) {
                        // old format => convert
                        d.accounts[name] = { transactions: acc, feeDiscount: 0.28, marketType: 'TW' };
                    } else {
                        if (!Array.isArray(acc.transactions)) acc.transactions = [];
                        if (acc.feeDiscount === undefined) acc.feeDiscount = 0.28;
                        if (!acc.marketType) acc.marketType = 'TW';
                    }
                }
                return d;
            }

            /** ---------- render UI ---------- */
            function updateAccountFilterOptions() {
                accountFilter.innerHTML = '';
                const names = Object.keys(appData.accounts || {});
                names.forEach(n => {
                    const opt = document.createElement('option');
                    opt.value = n; opt.textContent = n;
                    accountFilter.appendChild(opt);
                });
                accountFilter.value = appData.currentAccount || names[0];
                deleteAccountBtn.classList.toggle('hidden', names.length <= 1);
                updateAccountFeeDiscountDisplay();
                updateAccountMarketTypeDisplay();
            }
            function updateAccountFeeDiscountDisplay() {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    accountFeeDiscountInput.value = appData.accounts[appData.currentAccount].feeDiscount;
                } else accountFeeDiscountInput.value = 0.28;
            }
            function updateAccountMarketTypeDisplay() {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    accountMarketTypeInput.value = appData.accounts[appData.currentAccount].marketType || 'TW';
                } else accountMarketTypeInput.value = 'TW';
            }

            function updateStockFilterOptions() {
                const currentTransactions = (appData.accounts[appData.currentAccount] && appData.accounts[appData.currentAccount].transactions) || [];
                const selectedValue = stockFilter.value;
                const searchTerm = (stockSearch.value || '').trim().toUpperCase();
                let symbols = [...new Set(currentTransactions.map(tx => tx.symbol || ''))].filter(Boolean);
                if (searchTerm) symbols = symbols.filter(s => s.toUpperCase().includes(searchTerm));
                symbols.sort();
                stockFilter.innerHTML = '';
                const allOption = document.createElement('option'); allOption.value='__ALL__'; allOption.textContent='全部庫存';
                stockFilter.appendChild(allOption);
                symbols.forEach(sym => {
                    const opt = document.createElement('option'); opt.value = sym; opt.textContent = sym;
                    stockFilter.appendChild(opt);
                });
                if ([...stockFilter.options].some(o => o.value === selectedValue)) {
                    stockFilter.value = selectedValue;
                } else stockFilter.value = '__ALL__';
            }

            function renderTransactionsList() {
                transactionList.innerHTML = '';
                const txs = (appData.accounts[appData.currentAccount] && appData.accounts[appData.currentAccount].transactions) || [];
                if (!txs.length) {
                    noDataMsg.style.display = 'block';
                } else {
                    noDataMsg.style.display = 'none';
                }
                // simple listing: show date, symbol, shares, price, type, fee
                txs.slice().reverse().forEach((tx, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = 'bg-stone-900';
                    const td = (html) => { const tdEl = document.createElement('td'); tdEl.className='px-4 py-3 text-sm text-stone-200'; tdEl.innerHTML = html; return tdEl; };
                    tr.appendChild(td(`<strong>${tx.symbol || ''}</strong><div class="text-xs text-stone-400">${tx.name||''}</div>`));
                    tr.appendChild(td(`${tx.type || ''}`));
                    tr.appendChild(td(`${tx.shares || 0}`));
                    tr.appendChild(td(`${tx.price || 0}`));
                    tr.appendChild(td(`${(tx.fee||0).toFixed ? (tx.fee||0).toFixed(2) : tx.fee}`));
                    transactionList.appendChild(tr);
                });
            }

            function recalcOverview() {
                const txs = (appData.accounts[appData.currentAccount] && appData.accounts[appData.currentAccount].transactions) || [];
                let totalCost = 0, totalShares = 0, weightedSum = 0;
                txs.forEach(tx => {
                    if (tx.type === 'BUY') {
                        const amount = (tx.price || 0) * (tx.shares || 0);
                        totalCost += amount + (tx.fee || 0);
                        totalShares += (tx.shares || 0);
                    } else if (tx.type === 'SELL') {
                        // 賣出不列入持有成本計算（此處示範性簡化）
                        totalShares += (tx.shares || 0); // for counting records only
                    }
                });
                avgCostEl.textContent = totalShares ? (totalCost / totalShares).toFixed(2) : '0';
                totalCostEl.textContent = totalCost.toFixed(2);
                totalSharesEl.textContent = txs.length;
            }

            function render() {
                updateAccountFilterOptions();
                updateStockFilterOptions();
                renderTransactionsList();
                recalcOverview();
            }

            /** ---------- UI interactions (accounts) ---------- */
            addAccountBtn.addEventListener('click', () => {
                newAccountFeeDiscountInput.value = 0.28;
                newAccountMarketTypeInput.value = 'TW';
                showModal(addAccountModal);
            });
            addAccountCancelBtn.addEventListener('click', () => hideModal(addAccountModal));
            addAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('new-account-name').value.trim() || `帳戶 ${Date.now()}`;
                const fee = parseFloat(newAccountFeeDiscountInput.value) || 0.28;
                const market = newAccountMarketTypeInput.value || 'TW';
                if (!appData.accounts) appData.accounts = {};
                appData.accounts[name] = { transactions: [], feeDiscount: fee, marketType: market };
                appData.currentAccount = name;
                hideModal(addAccountModal);
                saveData().then(render);
            });

            editAccountBtn.addEventListener('click', () => {
                editAccountNameInput.value = appData.currentAccount;
                editAccountFeeDiscountInput.value = appData.accounts[appData.currentAccount]?.feeDiscount || 0.28;
                editAccountMarketTypeInput.value = appData.accounts[appData.currentAccount]?.marketType || 'TW';
                showModal(editAccountModal);
            });
            editAccountCancelBtn.addEventListener('click', () => hideModal(editAccountModal));
            document.getElementById('edit-account-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newName = editAccountNameInput.value.trim();
                const fee = parseFloat(editAccountFeeDiscountInput.value) || 0.28;
                const market = editAccountMarketTypeInput.value || 'TW';
                const oldName = appData.currentAccount;
                if (newName !== oldName) {
                    appData.accounts[newName] = appData.accounts[oldName];
                    delete appData.accounts[oldName];
                    appData.currentAccount = newName;
                }
                appData.accounts[appData.currentAccount].feeDiscount = fee;
                appData.accounts[appData.currentAccount].marketType = market;
                hideModal(editAccountModal);
                saveData().then(render);
            });

            deleteAccountBtn.addEventListener('click', () => {
                const accountToDelete = appData.currentAccount;
                if (confirm(`確定要刪除帳戶 ${accountToDelete} ?`)) {
                    delete appData.accounts[accountToDelete];
                    const remaining = Object.keys(appData.accounts || {});
                    appData.currentAccount = remaining[0] || '預設帳戶';
                    saveData().then(render);
                }
            });

            accountFilter.addEventListener('change', (e) => {
                appData.currentAccount = accountFilter.value;
                render();
            });
            accountFeeDiscountInput.addEventListener('change', (e) => {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    appData.accounts[appData.currentAccount].feeDiscount = parseFloat(e.target.value) || 0.28;
                    saveData();
                }
            });
            accountMarketTypeInput.addEventListener('change', (e) => {
                if (appData.accounts && appData.accounts[appData.currentAccount]) {
                    appData.accounts[appData.currentAccount].marketType = e.target.value || 'TW';
                    saveData();
                }
            });

            /** ---------- transactions add (buy/sell) ---------- */
            function buildTransactionObject(type) {
                return {
                    id: 'tx_' + Date.now(),
                    symbol: (txSymbolInput.value || '').toUpperCase(),
                    name: '',
                    date: txDateInput.value || new Date().toISOString().slice(0,10),
                    shares: parseFloat(txSharesInput.value) || 0,
                    price: parseFloat(txPriceInput.value) || 0,
                    type: type,
                    fee: 0,
                    totalTxCost: 0
                };
            }
            addBuyBtn.addEventListener('click', async () => {
                const tx = buildTransactionObject('BUY');
                // compute fee based on account settings
                const acc = appData.accounts[appData.currentAccount];
                const amount = tx.price * tx.shares;
                if (acc && acc.marketType === 'TW') {
                    tx.fee = amount * FEE_RATE * (acc.feeDiscount || 0.28);
                } else {
                    tx.fee = amount * (acc?.feeDiscount || 0.0);
                }
                tx.totalTxCost = amount + tx.fee;
                tx.name = ''; // could map from stockNameMap if available
                acc.transactions.push(tx);
                await saveData();
                render();
                addTransactionForm.reset();
            });
            addSellBtn.addEventListener('click', async () => {
                const tx = buildTransactionObject('SELL');
                const acc = appData.accounts[appData.currentAccount];
                const amount = tx.price * tx.shares;
                if (acc && acc.marketType === 'TW') {
                    tx.fee = amount * FEE_RATE * (acc.feeDiscount || 0.28) + amount * TAX_RATE; // include tax for sell
                } else {
                    tx.fee = amount * (acc?.feeDiscount || 0.0);
                }
                tx.totalTxCost = amount - tx.fee;
                acc.transactions.push(tx);
                await saveData();
                render();
                addTransactionForm.reset();
            });

            /** ---------- import / export ---------- */
            exportBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(appData, null, 2);
                const blob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'stocktracker_export.json'; a.click();
                URL.revokeObjectURL(url);
            });
            importBtn.addEventListener('click', () => importFile.click());
            importFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const parsed = JSON.parse(ev.target.result);
                        appData = ensureAppDataStructure(parsed);
                        saveData().then(render);
                    } catch (err) {
                        showModal(messageModal, '匯入失敗', '檔案格式錯誤');
                    }
                };
                reader.readAsText(file);
            });

            /** ---------- collapsible ---------- */
            collapsibleHeader.addEventListener('click', () => {
                if (collapsibleContent.style.maxHeight) {
                    collapsibleContent.style.maxHeight = null;
                    collapseIcon.style.transform = 'rotate(-90deg)';
                } else {
                    collapsibleContent.style.maxHeight = collapsibleContent.scrollHeight + "px";
                    collapseIcon.style.transform = 'rotate(0deg)';
                }
            });

            /** ---------- Auth flow ---------- */
            function showAppForLoggedIn(user) {
                currentUser = user;
                authContainer.style.display = 'none';
                appContainer.style.display = 'block';
                if (userDisplay) userDisplay.textContent = `已登入：${user.displayName || user.email}`;
            }
            function showAuthPrompt() {
                currentUser = null;
                authContainer.style.display = 'block';
                appContainer.style.display = 'none';
                if (userDisplay) userDisplay.textContent = '';
            }

            async function initializeApp() {
                // 1) 嘗試從 firebaseApi 取得使用者狀態（如果 firebase 可用）
                const fb = window.firebaseApi;
                if (fb && fb.available && fb.auth) {
                    // 綁定 onAuthStateChanged（若 firebase 未配置或失敗，此段會跳到 else）
                    fb.onAuthStateChanged(fb.auth, async (user) => {
                        if (user) {
                            // 已登入
                            showAppForLoggedIn(user);
                            // load user data from realtime db
                            try {
                                const remote = await loadFromFirebase(user.uid);
                                if (remote) {
                                    appData = ensureAppDataStructure(remote);
                                } else {
                                    // if remote empty but local exists, push local -> remote
                                    const local = loadFromLocalStorage();
                                    if (local) {
                                        appData = ensureAppDataStructure(local);
                                        await saveToFirebase(user.uid);
                                    } else {
                                        appData = ensureAppDataStructure(appData);
                                        await saveToFirebase(user.uid);
                                    }
                                }
                                // attach realtime listener to keep in sync
                                try {
                                    if (firebaseListenerUnsubscribe && typeof firebaseListenerUnsubscribe === 'function') {
                                        firebaseListenerUnsubscribe();
                                        firebaseListenerUnsubscribe = null;
                                    }
                                    // Our attachFirebaseListener might not return unsubscribe depending on implementation,
                                    // so we attempt to call dbMethods.attachListener which in our module calls onValue.
                                    if (fb.dbMethods && typeof fb.dbMethods.attachListener === 'function') {
                                        // attachListener returns nothing in the provided module, but onValue returns an unsubscribe normally.
                                        // To be safe, we don't rely on unsub. (If you want to be able to unsubscribe, modify the module script to return the unsubscribe.)
                                        fb.dbMethods.attachListener(user.uid, (val) => {
                                            if (!val) return;
                                            appData = ensureAppDataStructure(val);
                                            render();
                                        });
                                    }
                                } catch (err) { console.warn("無法附加雲端監聽：", err); }
                                saveToLocalStorage(); // keep local backup
                                render();
                            } catch (err) {
                                console.warn("從雲端載入失敗，改用 localStorage：", err);
                                const local = loadFromLocalStorage();
                                appData = ensureAppDataStructure(local);
                                render();
                            }
                        } else {
                            // 未登入 -> 顯示登入畫面，並使用 local data
                            showAuthPrompt();
                            const local = loadFromLocalStorage();
                            appData = ensureAppDataStructure(local);
                            render();
                        }
                    });
                    // login/logout handlers
                    loginBtn.addEventListener('click', async () => {
                        const provider = new fb.GoogleAuthProvider();
                        try {
                            await fb.signInWithPopup(fb.auth, provider);
                        } catch (err) {
                            console.error("登入失敗：", err);
                            showModal(messageModal, '登入失敗', '無法使用 Google 登入');
                        }
                    });
                    logoutBtn.addEventListener('click', async () => {
                        try {
                            await fb.signOut(fb.auth);
                            // 清掉本地使用者資訊（UI already handled by auth listener）
                        } catch (err) {
                            console.error("登出失敗：", err);
                        }
                    });
                } else {
                    // firebase not available -> fallback to local-only mode
                    console.warn("Firebase not available, fallback to localStorage only.");
                    showAuthPrompt();
                    const local = loadFromLocalStorage();
                    appData = ensureAppDataStructure(local);
                    render();
                    // disable login button (no firebase)
                    loginBtn.addEventListener('click', () => {
                        showModal(messageModal, 'Firebase 未設定', '請先在程式中填入 Firebase 設定後啟用雲端功能。');
                    });
                }
            }

            // 初始化 tx date 為今天
            function setDateToToday() { txDateInput.value = new Date().toISOString().slice(0,10); }
            setDateToToday();

            // 最後呼叫初始化
            initializeApp();

        }); // DOMContentLoaded end
    </script>
</body>
</html>
